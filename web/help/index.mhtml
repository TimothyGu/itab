<%args>
	$account => undef
	$page_view => undef
	$edit => undef
	$add => undef
</%args>
<%init>

	my @pages = sort {$a->page_order <=> $b->page_order} Tab::Webpage->search( help => 1 );

	my %children_of = ();
	my @top_level;

	foreach my $page (@pages) { 

		Tab::debuglog("Page is ".$page->id." and parent is ".$page->parent);
		if ($page->parent && $page->parent->id) { 
			push @{$children_of{$page->parent->id}}, $page;
		} else { 
			push @top_level, $page;
		}
	}

</%init>

	<div class="right small">

		<div class="sidenote">

			<h4>Tabroom Manual</h4>

%			if ($account->help_admin || $account->site_admin) { 
				<a class="yellow block" href="index.mhtml?add=1">
					Add new help page
				</a>
%			}

%			my $counter = 1;

%			foreach my $page (@top_level) { 

				<a class="<% $page_view == $page->id ? "dk" : "" %> help" href="index.mhtml?page_view=<% $page->id %>">
					<span class="helpnumber padno">
						<% $counter++ %>
					</span>
					<% $page->title %>
				</a>

%				my $child_counter = 1;

%				foreach my $child (@{$children_of{$page->id}}) { 
					<a class="<% $page_view == $child->id ? "dk" : "" %> helpchild" href="index.mhtml?page_view=<% $child->id %>">
						<span class="helpnumber padno">
							<% $child_counter++ %>.<% $counter++ %>
						</span>
						<% $child->title %>
					</a>
%				}

%			}

		</div>

	</div>

	<div class="left huge about">

%		my $page = Tab::Webpage->retrieve($page_view);

%		if (($edit || $add) && ($account->help_admin || $account->site_admin)) { 

%			if ($edit) { 

				<div class="block">
					<span class="hugespan padno" style="width: 590px;">
						<h4>Edit Page</h4>
					</span>
					<span>
						<a class="dkgreen inline centeralign" href="index.mhtml?page_view=".$page_view> View Page </a>
					</span>
				</div>

%			} elsif ($add) { 
				<h4>Add New Page</h4>
%			}

			<& "/funclib/editor.mas" &>

			<form action="help_save.mhtml" method="post">
			<input type="hidden" name="page_id" value="<% $page ? $page->id : "" %>">
			
			<div class="block evenrow">
				<span class="huntwofive">
					<h5>Title</h5>
				</span>
				<span>
					<input type="text" name="title" size="46" value="<% $page ? $page->title : "" %>">
				</span>
			</div>

			<div class="block addrow">
				<span class="huntwofive">
					<h5>Parent page:</h5>
				</span>
				<span>
					<select class="fixed" name="parent_id">
						<option value="">Top Level Page</option>
%						foreach my $parent (@top_level) { 
							<option value="<% $parent->id %>">
								- <% $parent->title %>
							</option>
%						}
					</select>
				</span>
			</div>

			<h5>Content:</h5>

			<div class="block evenrow" style="padding-left: 20px;" >
				<textarea name="content" rows="20" cols="60"><% $page ? $page->content : "" %></textarea>
			</div>

			<div class="block liblrow rightalign">
				<input type="submit" value="Save Page">
				</form>
			</div>

%		} elsif ($page) { 

%			if ($account->site_admin || $account->help_admin) { 
				<div class="block">
					<span class="hugespan padno" style="width: 590px;">
%			}
						<h2 class="underline"><% $page->title %></h2>
%			if ($account->site_admin || $account->help_admin) { 
					</span>

					<span>
						<a class="dkgreen inline centeralign" href="index.mhtml?page_view=<% $page->id %>&edit=1"> Edit Page </a>
					</span>

				</div>
%			}

			<% $page->content %>

%		}


	</div>


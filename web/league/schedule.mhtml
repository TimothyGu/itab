<%args> 
	$circuit
	$account
	$year => undef
</%args>
<%init>

	my $err;

	my $now = DateTime->now(time_zone => $circuit->timezone);
		
	my $foo++ unless $year;

	$year = $now->year unless $year;

	if ($now->month > 6 && $foo)  {
		$year++;
	}

	my $begin = DateTime->new( 
		year => $year - 1,
		month => 7,
		day  => 01 );

	my $stop = DateTime->new(
		year => $year,
		month => 6,
		day => 30 );

	my @all_schedules = Tab::Schedule->search( circuit => $circuit->id );

	my @schedules;

	foreach my $at (@all_schedules) { 
		push (@schedules, $at) if ($at->start > $begin && $at->end < $stop);
	}

	@schedules = sort {$a->start <=> $b->start } @schedules;

</%init>

	<table width="100%">

		<tr>

			<td width="100%">
				<h2>Non-Tournament Schedule</h2>
			</td>

			<td>
				<form action="schedule_edit.mhtml" method="post">
				<input class="grey" type="submit" value="Add New">
				</form>
			</td>

		</tr>

	<table cellpadding="5" cellspacing="1" border="0" width="100%">

		<tr class="lirdrow">

			<th>Name</th>

			<th>Location</th>

			<th>Dates</th>

			<th></th>
			<th></th>

		</tr>

%		my $switch;

%		foreach my $schedule (@schedules) { 

% 			my $start = $schedule->start;
% 			my $end = $schedule->end;
%			$start->set_time_zone($circuit->timezone);
%			$end->set_time_zone($circuit->timezone);

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<td>
					<% $schedule->name %>
				</td>

				<td>
					<% $schedule->location %>
				</td>

				<td>
					<% $start->mdy('/') %>
					<% ($start->mdy != $end->mdy) ? " - ".$end->mdy('/') : "" %>
				</td>

				<td class="center">
					<form action="schedule_edit.mhtml" method="post">
					<input type="hidden" name="schedule_id" value="<% $schedule->id %>".>
					<input type="submit" class="skinny" value="Edit">
					</form>
				</td>

				<td class="center">
					<form action="schedule_rm.mhtml" method="post">
					<input type="hidden" name="schedule_id" value="<% $schedule->id %>".>
					<input type="submit" class="skinny" value="Delete">
					</form>
				</td>

			</tr>

%		}

		<tr>
			<td colspan="5">
				<h4></h4>
			</td>
		</tr>

		<tr class="liblrow">

			<td colspan="2">
				<form action="schedule.mhtml" method="post">
				View School Year ending:
			</td>
			
			<td class="center">
				<input type="text" name="year" size="5" value="<% $year %>"> 
			</td>
			
			<td class="right" colspan="2">
				<input class="blue" type="submit" value="  View Year  ">
				</form>
			</td>

		</tr>

	</table>

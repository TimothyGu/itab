<%args>
	$event
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main(); 
	
	my $sth = $dbh->prepare('

	    select entry.id, count(distinct panel.id) as wins

        from round, panel, entry, ballot exist
        where entry.event = '.$event->id.'
        and entry.id = exist.entry
        and panel.id = exist.panel
		and panel.round = round.id
		and round.type != "elim"
		and round.type != "final"

        and (select count(distinct winner.id) as winner
            from ballot as winner, ballot_value
            where winner.entry = entry.id
            and winner.panel = panel.id
            and ballot_value.ballot = winner.id
            and ballot_value.tag = "ballot"
            and ballot_value.value = 1 ) 
        >
         (select count(distinct loser.id) as loser
            from ballot as loser, ballot_value
            where loser.entry = entry.id
            and loser.panel = panel.id
            and ballot_value.ballot = loser.id
            and ballot_value.tag = "ballot"
            and ballot_value.value = 0 ) 

        group by entry.id
        order by entry.code
	');

	$sth->execute();

	my %entry_wins = ();

	while( my ($entry_id, $wins) = $sth->fetchrow_array() ) {
		$entry_wins{$entry_id} = $wins;
	}

	return %entry_wins;

</%init>

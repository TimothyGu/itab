<%args>
	$tourn
	$account
	$session
	$timeslot_id => undef
	$entry_only => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	my $ncfl++ if $tourn->setting("ncfl");

	my $session_group = $session->judge_group;

    if ($session_group && $session_group->tourn != $tourn) { 
        $session->judge_group("");
        $session->update;
        undef $session_group;
    }   

    unless ($session_group) { 
        $session_group = $tourn->groups->first;
		$session->judge_group($session_group->id);
        $session->update;
    }   


</%init>

	<div class="right small">
	
		<div class="plainnote">

%			if ($entry_only) {
				<a href="/tabbing/entry/index.mhtml" class="yellow full">Return to Ballot Entry</a>
				<br />
%			}

			<span class="bluenohover full centeralign" style="margin-bottom: 2px;">
				<form action="limit.mhtml" method="post">
				<input type="hidden" name="from" value="collect">
				<input type="hidden" name="timeslot" value="<% $timeslot_id %>">
				<select name="group_id" onchange='this.form.submit()' class="fixedmed notfirst chosen">
					<option value="">Choose judge group:</option>
%					foreach my $other_group ($tourn->groups) { 
						<option value="<% $other_group->id %>" <% ($session_group && $other_group->id == $session_group->id) ? "selected" : "" %>>
							<% $other_group->name %>
						</option>
%					}
				</select>
				</form>
			</span>

%			my @timeslots = $m->comp("/funclib/group_timeslots.mas", group => $session_group) if $session_group;

			<h4>Timeslots:</h4>

%			foreach my $ts (sort {$a->start->epoch <=> $b->start->epoch} @timeslots) {

%				my @outstanding = $m->comp("/funclib/timeslot_judges.mas", timeslot => $ts, status => "uncollected");
%				$timeslot = $ts if @outstanding && not defined $timeslot;
%				$timeslot_id = $timeslot->id if $timeslot;

				<a href="collect.mhtml?timeslot_id=<% $ts->id %>" class="<% $ts->id == $timeslot_id ? "dk" : ""%><%(@outstanding) ? "yellow" : "green" %> full martop">
					<span class="half">
						<% $ts->name %>:
					</span>
					<span class="quarter rightalign">
						<% scalar @outstanding %>
					</span>
					<span class="quarter">
						left
					</span>
				</a>

%			}

%			$timeslot = $timeslots[0] unless $timeslot;
%			$timeslot_id = $timeslot->id if $timeslot;

		</div>

	</div>

	<div class="left huge">

		<h2><% $tourn->name %></h2>

		<& "tabbar.mas", whoami => 'collect', tourn => $tourn &>

%		if ($timeslot) { 
		
			<h4 class="centeralign">Ballots Collected in <% $timeslot->name %></h4>

<%perl>

			my $flighted;
		
			my $dbh = Tab::DBI->db_Main();

			my $uncollected_sth = $dbh->prepare("
				select distinct panel.id, judge.id, judge.code, judge.first, judge.last, panel.flight, event.abbr
				from panel, ballot, judge, round, event
				where round.timeslot = $timeslot_id
				and panel.round = round.id
				and panel.id = ballot.panel
				and ballot.judge = judge.id
				and event.type != \"wudc\"
				and ballot.collected_by = 0
				and ballot.audit = 0
				and round.event = event.id
				group by panel.id, judge.id
				order by judge.code, judge.last, panel.flight
			");

			$uncollected_sth->execute();

			my @uncollected_panels;
			my %panel_flight;
			my %panel_judgecode;
			my %panel_judgename;
			my %panel_event;

			while (my ($panel, $judge, $code, $first, $last, $flight, $abbr)  = $uncollected_sth->fetchrow_array() ) {
				my $key = $panel."-".$judge;
				push @uncollected_panels, $key;
				$panel_flight{$key} = $flight;
				$panel_event{$key} = $abbr;
				$panel_judgecode{$key} = $code;
				$panel_judgename{$key} = $first." ".$last;

				$flighted++ if $flight > 1;
			}

			my $collected_sth = $dbh->prepare("
				select distinct panel.id, judge.id, judge.code, judge.first, judge.last, panel.flight, event.abbr
				from panel, ballot, judge, round, event
				where round.timeslot = $timeslot_id
				and panel.round = round.id
				and panel.id = ballot.panel
				and ballot.judge = judge.id
				and event.type != \"wudc\"
				and ballot.collected_by != 0
				and ballot.audit = 0
				and round.event = event.id
				group by panel.id, judge.id
				order by judge.code, judge.last, panel.flight
			");

			$collected_sth->execute();

			my @collected_panels;

			while (my ($panel, $judge, $code, $first, $last, $flight, $abbr)  = $collected_sth->fetchrow_array() ) {
				my $key = $panel."-".$judge;
				push @collected_panels, $key;
				$panel_flight{$key} = $flight;
				$panel_judgecode{$key} = $code;
				$panel_judgename{$key} = $first." ".$last;
				$panel_event{$key} = $abbr;
				$flighted++ if $flight > 1;
			}


			my $rooms_sth = $dbh->prepare("
				select distinct panel.id, room.name
				from panel, room, round
				where round.timeslot = $timeslot_id
				and panel.round = round.id
				and panel.room = room.id
				order by panel.id
			");

			$rooms_sth->execute();

			my %panel_room;

			while (my ($panel, $room)  = $rooms_sth->fetchrow_array() ) {
				$panel_room{$panel} = $room;
			}

</%perl>


			<div class="half top">

				<h5><% scalar @uncollected_panels %> Out:</h5>

%				foreach my $panel (@uncollected_panels) { 

%					my ($panel_id, $judge_id) = split (/-/, $panel);

					<a class="martop full yellow smallish nowrap" href="collect_switch.mhtml?judge_id=<% $judge_id %>&panel_id=<% $panel_id %>">

						<span class="third nowrap">
							<% $panel_room{$panel_id} %>
						</span>

						<span class="third nowrap">
							<% $panel_judgename{$panel} %>
						</span>

						<span class="third rightalign">
							<% $flighted ? "Flt ".$panel_flight{$panel}."-" : "" %>
							<% $panel_event{$panel} %>
						</span>

					</a>
%				}

			</div>

			<div class="half top">

				<h5><% scalar @collected_panels %> Collected & Unentered:</h5>

%				foreach my $panel (@collected_panels) { 

%					my ($panel_id, $judge_id) = split (/-/, $panel);

					<a class="martop green full smallish nowrap" href="collect_switch.mhtml?judge_id=<% $judge_id %>&panel_id=<% $panel_id %>">

						<span class="third nowrap">
							<% $panel_room{$panel_id} %>
						</span>

						<span class="third nowrap">
							<% $panel_judgename{$panel} %>
						</span>

						<span class="third rightalign">
							<% $flighted ? "Flt ".$panel_flight{$panel}."-" : "" %>
							<% $panel_event{$panel} %>
						</span>

					</a>
%				}

			</div>

%		}

	</div>


<%args>
	$tourn
	$account
	$session
	$ndt         => undef
	$timeslot_id => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;

</%init>

	<div class="left huge">

%		if ($timeslot) { 

%			my @panels = $m->comp('/funclib/timeslot_panels.mas', timeslot => $timeslot);

%    		@panels = map  { $_->[0] } sort { $a->[1] <=> $b->[1] } map  { [$_, $_->room->name=~/(\d+)/] } @panels;
%			@panels = map  { $_->[0] } sort { $a->[1] cmp $b->[1] } map  { [$_, $_->room->name=~/(\w+)/] } @panels;

%			my %panels_by_id =();
%			foreach my $panel (@panels) { 
%				$panels_by_id{$panel->id} = $panel;
%			}


		<h2>Ballots in timeslot <% $timeslot->name %></h2>

			<div class="half left">

				<h4>Not Started:</h4>

%				foreach my $panel (@panels) { 

%					next if $panel->confirmed;
%					next if $panel->started &! $ndt;

					<a class="noline ltyellow block smallish nowrap" href="confirm_switch.mhtml?ndt=<% $ndt %>&panel_id=<% $panel->id %>">

						<span class="huntwofive padno wrap">
							<% $panel->room->name %>
						</span>

%						my $notfirst;

						<span class="medbigspan padno inline wrap">
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
								<% $notfirst++ ? "<br />" : "" %>
								<% $judge->last %>, <% $judge->first %>
%							}
						</span>
					</a>

%				}

			</div>

			<div class="half right">

				<h4>Started:</h4>

%				@panels = sort {$a->confirmed <=> $b->confirmed} @panels;
%				@panels = sort {$a->started <=> $b->started} @panels unless $ndt;

%				foreach my $panel (@panels) { 

%					my $confirmed = $panel->confirmed;
%					my $started = $panel->started;

%					next if $ndt && not defined $confirmed;
%					next unless $started;

%					$started->set_time_zone($tz);
%					$confirmed->set_time_zone($tz) if $confirmed;

					<a class="noline green block smallish wrap" href="confirm_switch.mhtml?ndt=<% $ndt %>&panel_id=<% $panel->id %>">

						<span class="huntwofive padno wrap">
							<% $panel->room->name %>
						</span>

						<span class="onesixty padno inline wrap">
							<% $started &! $ndt? "Started at ".Tab::nicetime($started) : "" %>
							<% $confirmed ? "Confirmed at ".Tab::nicetime($confirmed) : "" %>
						</span>
					</a>

%				}

			</div>

%		}

	</div>

	<div class="right small">
	
		<div class="sidenote">

			<h4>Timeslots:</h4>

%			foreach my $ts (sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots) {

%				my @unconfirmed = $m->comp('/funclib/timeslot_panels.mas', timeslot => $ts, unconfirmed => "no");

				<a href="confirm.mhtml?ndt=<% $ndt %>&timeslot_id=<% $ts->id %>" class="<% $ts->id == $timeslot_id ? "dk" : ""%><% (@unconfirmed) ? "yellow" : "green" %> block nohover">
					<span class="huntwofive padno">
						<% $ts->name %>
					</span>
%					if (@unconfirmed) {
						<span class="microspan padno">
							<% scalar @unconfirmed %>
						</span>
						<span class="microspan padno">
							left
						</span>
%					} else { 
%					}
				</a>

%			}

			<h4>Mode</h4>

			<a class="<% $ndt ? "dk" : "" %>yellow block" href="confirm.mhtml?ndt=<% $ndt ? "" : "yah" %>&timeslot_id=<% $timeslot_id %>">
				Confirm separately from online ballot starts (NDT)
			</a>

		</div>

	</div>


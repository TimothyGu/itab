<%args>
	$tourn
	$account
	$session
	$timeslot_id => undef
	$entry_only  => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	my $session_group = $session->judge_group;

    if ($session_group && $session_group->tourn != $tourn) { 
        $session->judge_group("");
        $session->update;
        undef $session_group;
    }   

    unless ($session_group) { 
        my @all_groups = $tourn->groups;
        if (scalar @all_groups == 1) { 
            $session_group = shift @all_groups;
            $session->judge_group($session_group->id);
            $session->update;
        }   
    }   

	my $ndt++ if $session_group && $session_group->setting("separate_confirm_starts");

</%init>

	<div class="left huge">

%		if ($timeslot) { 

%			my @panels = $m->comp('/funclib/timeslot_panels.mas', timeslot => $timeslot);

%    		@panels = map  { $_->[0] } sort { $a->[1] <=> $b->[1] } map  { [$_, $_->room->name=~/(\d+)/] } @panels;
%			@panels = map  { $_->[0] } sort { $a->[1] cmp $b->[1] } map  { [$_, $_->room->name=~/(\w+)/] } @panels;

%			my %panels_by_id =();
%			foreach my $panel (@panels) { 
%				$panels_by_id{$panel->id} = $panel;
%			}


		<h2>Ballots in timeslot <% $timeslot->name %></h2>

			<div class="half">

				<h4>Not Started:</h4>

%				foreach my $panel (@panels) { 
%					next if $panel->confirmed;
%					next if $panel->started &! $ndt;
					<div class="full smallish padless marno">
						<a class="full padmore yellow" href="confirm_switch.mhtml?ndt=<% $ndt %>&panel_id=<% $panel->id %>">
							<span class="quarter nospace">
								<% $panel->room->name %>
							</span>

							<span class="threequarter nospace">
%								foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
									<div>
										<% $judge->last %>, <% $judge->first %>
									</div>
%								}
							</span>
						</a>
					</div>
%				}

			</div>

			<div class="half top">

				<h4>Started:</h4>

%				@panels = sort {$a->confirmed <=> $b->confirmed} @panels;
%				@panels = sort {$a->started <=> $b->started} @panels unless $ndt;

%				foreach my $panel (@panels) { 

%					my $confirmed = $panel->confirmed;
%					my $started = $panel->started;

%					next if $ndt && not defined $confirmed;
%					next unless $started;

%					$started->set_time_zone($tz);
%					$confirmed->set_time_zone($tz) if $confirmed;

					<div class="full smallish padless marno">
						<a class="full padmore green" href="confirm_switch.mhtml?ndt=<% $ndt %>&panel_id=<% $panel->id %>">
							<span class="quarter nospace">
								<% $panel->room->name %>
							</span>

							<span class="half nospace">
%								foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
									<div>
										<% $judge->last %>, <% $judge->first %>
									</div>
%								}
							</span>

							<span class="quarter nospace">
								<% $started &! $ndt? Tab::nicetime($started) : "" %>
								<% $confirmed ? Tab::nicetime($confirmed) : "" %>
							</span>
						</a>
					</div>

%				}

			</div>

%		}

	</div>

	<div class="right small">
	
		<div class="plainnote">

%			if ($entry_only) {
				<a href="confirm.mhtml" class="dkblue block">Confirm Round Starts</a>
				<a href="checkin.mhtml" class="blue block">Collect Ballots</a>
				<a href="index.mhtml" class="blue block">Enter Ballots</a>
				<br />
%			}


			<span class="bluenohover block centeralign" style="margin-bottom: 2px;">
				<form action="limit.mhtml" method="post">
				<input type="hidden" name="from" value="confirm">
				<input type="hidden" name="timeslot" value="<% $timeslot_id %>">
				<select name="group_id" onchange='this.form.submit()' class="fixedsmall notfirst">
					<option value="">Choose judge group:</option>
%					foreach my $other_group ($tourn->groups) { 
						<option value="<% $other_group->id %>" <% ($session_group && $other_group->id == $session_group->id) ? "selected" : "" %>>
							<% $other_group->name %>
						</option>
%					}
				</select>
				</form>
			</span>

%			if ($session_group) { 

				<h4>Timeslots:</h4>

%				foreach my $ts ($m->comp("/funclib/group_timeslots.mas", group => $session_group)) { 

%					my @unconfirmed = $m->comp('/funclib/timeslot_panels.mas', timeslot => $ts, unconfirmed => "no");

					<a href="confirm.mhtml?ndt=<% $ndt %>&timeslot_id=<% $ts->id %>" class="<% $ts->id == $timeslot_id ? "dk" : ""%><% (@unconfirmed) ? "yellow" : "green" %> block">
						<span class="half padno">
							<% $ts->name %>
						</span>
%						if (@unconfirmed) {
							<span class="quarter padno rightalign">
								<% scalar @unconfirmed %>
							</span>
							<span class="quarter padno padleft">
								left
							</span>
%						} else { 
%						}
					</a>

%				}
%			}

		</div>

	</div>


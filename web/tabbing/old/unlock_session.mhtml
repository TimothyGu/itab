<%args>
	$session
	$account
	$timeslot_id => undef
	$passw => undef
</%args>

%	unless ($passw) { 

		<div class="left huge">

			<h2>Unlock session</h2>

			<table cellpadding="15" cellspacing="1" width="100%">

				<tr>
					<th align="center">
						<form action="unlock_session.mhtml" method="post">
						Please enter the password for <% $account->email %>:
					</th>
				</tr>

				<tr class="redrow">
					<td align="center">
						<input type="password" name="passw">
					</td>
				</tr>
	
				<tr>
					<td align="center">
						<input  type="submit" value="     Unlock Session     ">
						</form>
					</td>
				</tr>
	
%	} else { 

<%perl>

		use Crypt::PasswdMD5;

		$passw =~ s/\s+$//g;
	
		unless ($passw) { 
			my $err = "You must enter a password.  Please try again.";
			$m->redirect("$Tab::url_prefix/tabbing/unlock_session.mhtml?timeslot_id=$timeslot_id&err=$err");
		}

		my $db_password = $account->passhash;
		my $verify_password = unix_md5_crypt($passw,$db_password);
		
		unless ($verify_password eq $db_password) { 
	
			my $err = "Your password was not correct";
			$m->redirect("$Tab::url_prefix/tabbing/unlock_session.mhtml?timeslot_id=$timeslot_id&err=$err");

		}

#   	Remove existing sessions to prevent dual logins
    	my $allowed_sessions = $account->multiple;
    	$allowed_sessions = 1 unless $allowed_sessions;

    	foreach my $sess ( sort {$b->id <=> $a->id} $account->sessions) {
    	    next if $sess->limited;
			next if $sess->id == $session->id;
    	    $sess->delete unless $allowed_sessions;
    	    $allowed_sessions--;
    	}

		$session->limited("");
		$session->update;

		my $msg = "Session unlocked";
		$m->redirect("$Tab::url_prefix/tabbing/rank.mhtml?timeslot_id=$timeslot_id&msg=$msg");

</%perl>

%	}





<%args>
	$tourn
	$league
	$event_id => undef
	$debug => 0
</%args>
<%init>

	my @events = $tourn->events;

	my @ready_events = Tab::Event->search_ok_to_break( $tourn->id );

	my @sites = $tourn->sites;

</%init>

	<table cellpadding="1" width="100%">

		<tr>
			<td width="100%">
				<h2>Advance competitors:</h2>
			</td>

			<td>
				<form action="rebreak_event.mhtml" method="post">
				<input type="submit" value="Clear elim rounds for re-breaking">
				</form>
			</td>

		</tr>
	
	</table>

	<table cellpadding="3" width="100%">

		<tr>
			<td width="40%" valign="top">

				<h4>Events ready to break:</h4>

				<table cellpadding="5" cellspacing="1" width="100%">

% 					my $switch;

% 		foreach my $re (sort {$a->name cmp $b->name} @ready_events) {

%			my $last_round_name = $re->last_non_preset;
%			my @rounds = Tab::Round->retrieve( event => $re->id, name => $last_round_name );
%			my $last = shift @rounds if @rounds;
%			next if $last->type eq "final";

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td style="padding-left: 35px;">
					<form action="do_breaks.mhtml" method="post">
					<input type="hidden" name="event_id" value="<% $re->id %>">
					<input type="submit" style="font: 13px Courier, mono;
					<% ($re->id == $event_id) ? " background-color: #8f2727;\"" : "\" class=\"blue\"" %>"
						value="  Break <% $re->name %><%perl>
							if ($re->id == $event_id) { 
								foreach ( length($re->name) .. 20) { $m->print("-"); }
								$m->print(">");
							} else { 
								foreach ( length($re->name) .. 20) { $m->print(" "); }
							}
</%perl>">
					</form>
				</td>   

			</tr>

%		}

		</table>

%	$switch = 1;

	</td>
	<td valign="top" align="center" <% ($event_id) ? "style=\"border: 1px dotted red; padding-bottom: 15px;\"" : "" %>>

<%perl> 
	
	if ($event_id) { 
	
		my $event = Tab::Event->retrieve($event_id);
		my $last_round_name = $event->last_non_preset;
		my @rounds = Tab::Round->retrieve( event => $event->id, name => $last_round_name);
		my $last_round = shift @rounds if @rounds;
	
		my @elims = sort {$b->name <=> $a->name} $event->rounds( type => "elim", preset => 0);
		my $last_elim = shift @elims if @elims;

		my @presets = sort {$a->name <=> $b->name} $event->rounds(preset => 1);
		my $first_preset = $presets[0] if @presets;
	
		my $default_timeslot = $first_preset->timeslot if $first_preset;
	
		unless ($default_timeslot) { 
	
			my $last_ends = $last_round->timeslot->end;
	
			foreach my $ts (sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots) { 
				
				$default_timeslot = $ts if $ts->start->epoch > $last_ends->epoch;
				last if $default_timeslot;
	
			}
		
		}
	
		my $tier;
	
		system "/usr/bin/logger There are ".scalar @presets." presets " if $debug;
	
		foreach my $preset (@presets) { $tier++ if $preset->name > $last_round->name;  }

		system "/usr/bin/logger Tier is $tier " if $debug;

		$tier-- if $tier;
		$tier = 2**($tier);
		$tier = scalar $first_preset->panels if $first_preset;

		my $break_num = $tier * 6;

		$break_num = $event->count_active_comps if $event->count_active_comps < $break_num;

		system "/usr/bin/logger Tier is $tier after all is done " if $debug;
	
		my $default = "Final" if $tier == 1;
		$default = "Semis" if $tier == 2;
		$default = "Quarters" if $tier == 4;
		$default = "Octos" if $tier == 8;
		$default = "Double Octos" if $tier == 16;
	
</%perl>

		<h4 style="margin-bottom: 25px;">Break <% $event->name %></h4>
	
		<table cellpadding="6" width="90%" cellspacing="1">
	
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					<form action="panel_elims.mas#tied" method="post">
					<input type="hidden" name="event_id" value="<% $event_id %>">
					Break out of:
				</td>

				<td colspan="4">
					<select name="basis">
						<option value="prelim" 
						<% ($last_round->type eq "prelim") ? "selected" : "" %>>Prelim Rounds</option>

%						if ($last_elim) { 
							<option value="elim" <% ($last_round->type eq "elim") ? "selected" : "" %>>
								Elimination: <% ($last_elim->label) ? $last_elim->label : $last_elim->name %> </option>
%						}

						<option  value="">-----------------------</option>
					</select>
				</td>
			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
				<td>Break to:</td>
		
				<td colspan="4">
					<select name="type">
%						foreach my $preset (@presets) { 
					    	<option value="<% $preset->id %>">Preset 
							<% ($preset->label) ? $preset->label : "Round: ".$preset->name %></option>
%						}

					    <option value="final">New Final Round</option>
					    <option value="elim">New Elim Round</option>
						<option  value="">-----------------------</option>
					</select>
				</td>
		
			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Advance Competitors:
				</td>

				<td>
					<input type="text" name="min" size="5" value="1">
				</td>

				<td>
					through
				</td>

				<td>
					<input type="text" name="max" size="5" value="<% $break_num %>">
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Number of Sections:
				</td>

				<td>
					<input type="text" name="numpanels" size="5" value="<% $tier %>">
				</td>

				<td>
					Label:
				</td>

				<td>
					<input type="text" name="label" size="5" value="<% $default %>">
				</td>

			</tr>

% 			my $now = DateTime->now(time_zone => $league->timezone);
% 			my @timeslots = Tab::Timeslot->search( tournament => $tourn->id, {order_by => "start"});

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				<td>Scheduled in</td>
				<td colspan="4">
					<select name="timeslot_id">

% 						foreach my $ts (@timeslots) {
   							<option value="<% $ts->id %>"
   							<% ( $default_timeslot && $ts->id == $default_timeslot->id ) ? "selected " : "" %>
   							><% $ts->name %></option>
% 						}	

						<option  value="">-----------------------</option>
					</select>
				</td>
			</tr>

% 			if (scalar @sites > 1) { 
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
					<td>Site:</td>
					<td colspan="4">
						<select name="site_id">
% 							foreach my $site (@sites) {
   								<option value="<% $site->id %>" 
									<% ($first_preset && $first_preset->site->id == $site->id) ? "selected" : ""%> >
									<% $site->name %></option>
% 							}
							<option  value="">-----------------------</option>
						</select>
					</td>
				</tr>

% 			} else { 
				<input type="hidden" name="site_id" value="<% (@sites) ? $sites[0]->id : ""%>">
% 			}

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				<td>View rankings?</td>
				<td colspan="4">
					<input type="checkbox" name="display" value="controlfreak" checked>
				</td>
			</tr>
	
			<tr class="liblrow">
				<td colspan="4" align="right" style="padding-top: 15px; padding-bottom: 15px; padding-right: 15px;">
					<input 	class="blue" style="#8f2727;" type="submit" value="       Do Breaks      ">
					</form>
				</td>
			</tr>

		</table>

% 		if ($tourn->method->mfl_flex_finals) {

			<p>
				The system will advance n+1 competitors to final rounds if n
				and n+1st places are tied on ranks going into finals, and not
				tied with n+2nd place.  Otherwise, tiebreakers will be used.  
			</p>

%		}

%	}

</td>
</tr>
</table>

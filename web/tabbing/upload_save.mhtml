<%args>
	$tourn
	$event_id
	$label => "File Upload"
</%args>
<%init>

	my $now = DateTime->now();

	my $event = Tab::Event->retrieve($event_id);

   	my $req = Apache2::Request->new($r);

	my $count;

	foreach my $school ($event->schools) { 

		next unless $req->upload($school->id);
		$count++;

		# Get the upload and create the file handle.
		my $upload 	= $req->upload($school->id);
        my $filename  = $upload->filename;
        $filename =~ s/.*[\/\\](.*)/$1/;
        $filename =~ s/\ //g;
        $filename =~ s/\'//g;  # '  stupid vim

		my $file = Tab::File->create({
			tournament => $tourn->id,
			label => $label,
			name => $filename,
			school => $school->id,
			event => $event_id,
			uploaded => $now
		});

        my $filepath = "$Tab::file_root/files/".$tourn->league->id."/tournaments/".$tourn->id."/ballots/".$school->id."/".$file->id;

  		`mkdir -p $filepath`;

        my $filetemp = $upload->tempname;
		`cp $filetemp $filepath/$filename`;


	}

	my $msg = $count." files uploaded to schools";

	$m->redirect("$Tab::url_prefix/tabbing/upload_ballots.mhtml?event_id=$event_id&msg=$msg");

</%init>



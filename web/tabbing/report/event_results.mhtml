<%args>
	$tourn
	$session
	$event_id => undef
	$report => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id && $event_id ne "all";

	my $novice++ if $event->setting("top_novice") ne "none";
	my $ncfl++ if $tourn->setting("ncfl");
	my $ncflcongress++ if $ncfl && $event->type eq "congress";

	my $switch = 1;
    my $now = DateTime->now;    

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    $now->set_time_zone($tz);

	my $name = $tourn->name if $event_id eq "all";
    $name = $event->name if $event && not defined $name;
    $name =~ s/[\W_]//g;

	my @events;
	push @events, $event;
	@events = sort {$a->name cmp $b->name} $tourn->events if $event_id eq "all";

    my $filename = "Results-$name-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 
    
    $m->comp("/funclib/printout.mas", filename => $filename, head => 1 );

    open (TEXOUT, ">>$filepath.tex");

	foreach my $event (@events) { 

		my $top_novice = $m->comp("/tabbing/results/top_novice.mas", event => $event) if $novice;

		my %id_entry = map {$_->id => $_} $event->entries;

		my @values;
		if ($report eq "prelim_ballots" || $report eq "prelims") { 
			@values = $m->comp("/funclib/event_values.mas", event => $event, prelim => "prelim");
		} elsif ($report eq "elims") { 
			@values = $m->comp("/funclib/event_values.mas", event => $event, elim => "elim");
		} else { 
			@values = $m->comp("/funclib/event_values.mas", event => $event);
		}
		my %values_by_entry = ();
		my %values_by_student = ();

		foreach my $value (@values) { 
			push @{$values_by_entry{$value->entryid}}, $value;
			push @{$values_by_student{$value->student->id}}, $value if $value->tag eq "points" and $value->student;
		}
	
		my @rounds = sort {$b->name <=> $a->name} $m->comp("/funclib/event_rounds.mas", event => $event, done => "yes");
		@rounds = sort {$b->name <=> $a->name} $m->comp("/funclib/event_rounds.mas", event => $event) if $report eq "prelim_ballots"; 

		my %id_roundname = map {$_->id => $_->realname} @rounds;

		my $final;
		my @elims;
		my $last_prelim;

		my $ranks;
		my $points;
		my $wins;

		foreach my $round (@rounds) { 

			$final = $round if $round->type eq "final";
			push (@elims, $round) if $round->type eq "elim";
			$last_prelim = $round if $round->type ne "elim" && $round->type ne "final" && not defined $last_prelim;

			foreach my $tb ($round->tb_set->tiebreaks) { 
				$points++ if ($tb->name eq "points" || $tb->name eq "competition" || $tb->name eq "opp_points");
				$ranks++ if ($tb->name eq "ranks" || $tb->name eq "reciprocals");
				$wins++ if ($tb->name eq "opp_wins" || $tb->name eq "winloss");
			}

		}

		my @print_rounds;

		if ($report eq "all" || $report eq "elims" || $report eq "final") { 
			push (@print_rounds, $final) if $final;
		}

		if ($report eq "all" || $report eq "elims") { 
			push (@print_rounds, @elims) if @elims;
		}

		if ($report eq "all" || $report eq "prelims" || $report eq "speakers" || $report eq "prelim_ballots") { 
			push (@print_rounds, $last_prelim) if $last_prelim;
		}

		my %used;

		print TEXOUT "\\medskip\n";
		print TEXOUT "\\noindent\n";
		print TEXOUT "{\\LARGE \\bf ". Tab::texify($tourn->name)."} \\hfill {\\LARGE \\bf ".Tab::texify($event->name)." Results} \\\\ \n";
		print TEXOUT "\\newline\n";
		
		foreach my $round (@print_rounds) { 

			my $type = $round->type;
			my $label = substr($round->label, 0, 3);
			my $event_type = $round->event->type;
			
			my $entries_ref;
			my $students_ref;
			my $tbs_ref;
			my $noshow_ref;
			my $desc_ref;

			unless ($report eq "prelim_ballots") { 
				($entries_ref, $tbs_ref, $desc_ref, $noshow_ref) = $m->comp("/tabbing/results/order_entries.mas", round => $round);
			}

			print TEXOUT "{\\bf \\large ".Tab::texify($round->realname)."} \n" unless $round->type eq "prelim" || $report eq "speakers" || $report eq "prelims" || $report eq "prelim_ballots";
			print TEXOUT "{\\bf \\large Prelim Results } \n" if $report eq "prelims" || $round->type eq "prelim";
			print TEXOUT "{\\bf \\large Prelim Scores } \n" if $report eq "prelim_ballots";
			print TEXOUT "{\\bf \\large Top Speakers:". Tab::texify($round->realname)."} \n" if $report eq "speakers";
			print TEXOUT "\\smallskip\n";
			print TEXOUT "\\newline\n";

			my $ballot_space = 3.75;
			$ballot_space = 2.5 if $report eq "speakers";

			my $tabular = "\\begin{tabular}{p{.25in}p{1.5in}p{1.1in}";
			$tabular = "\\begin{tabular}{p{.5in}p{2.0in}p{1.25in}" if $report eq "speakers";

			foreach my $key (keys %{$desc_ref}) {
				$tabular .= "p{.22in}";
				$ballot_space -= .38;
			}

			$tabular .= "p{".$ballot_space."in}}\n";

			$tabular = "\\begin{tabular}{p{1.75in}p{1.75in}p{2.5in}}\n" if $report eq "prelim_ballots";
			$tabular = "\\begin{tabular}{p{1.75in}p{1.75in}p{1.25in}p{1.5in}}\n" if $report eq "prelim_ballots" && $ncfl;
			$tabular = "\\begin{tabular}{p{2.5in}p{1.25in}p{3in}}\n" if $report eq "prelim_ballots" && $ncflcongress;

			print TEXOUT $tabular;
			print TEXOUT "\\rowcolor[rgb]{1,.95,.66}\[5.5pt\]\[5.5pt\]\n";
			print TEXOUT "\\noindent\n";
			print TEXOUT "  & " unless $report eq "prelim_ballots";
			print TEXOUT " Entry & Team & " unless $ncflcongress;
			print TEXOUT " Entry & " if $ncflcongress;

			print TEXOUT " Diocese & " if $report eq "prelim_ballots" && $ncfl;

			unless ($report eq "prelim_ballots") { 
				foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) {
					print TEXOUT "\\scriptsize ".Tab::texify(${$desc_ref}{$key})." & ";
				}
			}

			print TEXOUT "  Prelim " if $report eq "prelim" || $report eq "prelim_ballots";
			print TEXOUT "  Elim " if $report eq "elims";

			print TEXOUT "  Scores \\\\ \n" if $ncflcongress;
			print TEXOUT "  Ballots \\\\ \n" unless $ncflcongress;

			print TEXOUT "\\end{tabular}\n";
			print TEXOUT "\\newline\n";

			if ($students_ref) { 

				foreach my $key (sort {$a <=> $b} keys %{$students_ref}) {
				
					my $tie++ if scalar @{${$students_ref}{$key}} > 1;

					foreach my $student (@{${$students_ref}{$key}}) {

						next unless $values_by_student{$student->id} && @{$values_by_student{$student->id}};

						print TEXOUT $tabular;
						print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

						print TEXOUT Tab::texify(Lingua::EN::Numbers::Ordinate::ordinate($key));
						print TEXOUT " -T " if $tie;

						print TEXOUT " ".Tab::texify($student->code)." & ";
						print TEXOUT " & ". Tab::texify($student->first." ".$student->last)." & ";

						foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) {
							print TEXOUT Tab::texify(${$tbs_ref}{$student->id."-".$key}." ");
							print TEXOUT " & ";
						}

						my $last_tag;

						foreach my $value (@{$values_by_student{$student->id}}) { 
							print TEXOUT $value->value." ";
						}

						print TEXOUT "\\\\ \n";
						print TEXOUT "\\end{tabular}\n";
						print TEXOUT "\\newline\n";
					}

				}

			} elsif ($entries_ref) {

				foreach my $key (sort {$a <=> $b} keys %{$entries_ref}) {
					
					my $tie++ if scalar @{${$entries_ref}{$key}} > 1;

					foreach my $entry (@{${$entries_ref}{$key}}) {

						next if $used{$entry}++;

						my $entry = $id_entry{$entry};

						print TEXOUT $tabular;
						print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

						print TEXOUT Tab::texify(Lingua::EN::Numbers::Ordinate::ordinate($key)) if $type eq "final" || $event_type eq "wudc";
						print TEXOUT Tab::texify($label) if $type eq "elim";
						print TEXOUT Tab::texify("-T") if $tie && $type eq "final";
						if ($novice && $top_novice == $entry) { 
							print TEXOUT "\\newline\n " if $type eq "elim" || $type eq "final" || $type eq "wudc";
							print TEXOUT "\\scriptsize{TopNov} ";
						}

						my $name = $entry->name;
						$name =~ s/amp;//g;

						my $code = $entry->code;
						$code =~ s/amp;//g;
						$code = substr($code, 0, 8);

						print TEXOUT " & ";
						print TEXOUT Tab::texify($code)." ";
						print TEXOUT Tab::texify($name)." & ";
						print TEXOUT " ".substr(Tab::texify($entry->school->short_name), 0, 18)." & ";

						foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) {
							print TEXOUT Tab::texify(${$tbs_ref}{$entry."-".$key}." ");
							print TEXOUT " & ";
						}

						my $last_tag;

						print TEXOUT "{\\scriptsize " unless ($report eq "prelim" || $report eq "prelim_ballot" || $report eq "elims" || $ballot_space > 2);


						foreach my $value (@{$values_by_entry{$entry}}) { 

							next if $value->tag eq "rank" && not defined $ranks;
							next if $value->tag eq "points" && not defined $points;
							next if $value->tag eq "ballot" && not defined $wins;

							if ($value->tag eq "rank") { 
								print TEXOUT " ";
							} else { 
								print TEXOUT "/" if $last_tag eq "ballot";
								print TEXOUT "/" if $last_tag eq "rank";
								print TEXOUT " " if $last_tag eq "points";
							}

							print TEXOUT $value->value;
							$last_tag = $value->tag;
						}

						print TEXOUT " } " unless $report eq "prelim" || $report eq "prelim_ballot" || $report eq "elims" || $ballot_space > 2;
						print TEXOUT "\\\\ \n";
						print TEXOUT "\\end{tabular}\n";
						print TEXOUT "\\newline\n";
					}
				}

				print TEXOUT "\\medskip\n";
				print TEXOUT "\\newline\n";

			} elsif ($report eq "prelim_ballots") { 

				foreach my $entry ($event->entries( dropped => 0, waitlist => 0, unconfirmed => 0)) {;

					next if $entry->dq;

					print TEXOUT $tabular;
					print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

					my $name = $entry->name;
					$name =~ s/amp;//g;

					my $code = $entry->code;
					$code =~ s/amp;//g;

					$code = substr($code, 0, 8);

					print TEXOUT Tab::texify($code)." ";

					if ($ncflcongress) { 
						print TEXOUT Tab::texify($name)." ";
						print TEXOUT "\\newline \\hspace*{.28in} ".Tab::texify($entry->school->name)." & ";
					} else { 
						print TEXOUT Tab::texify($name)." & " unless $ncflcongress;
						print TEXOUT " ".substr(Tab::texify($entry->school->short_name), 0, 27)." & ";
					}

					print TEXOUT " ".substr(Tab::texify($entry->school->region->name), 0, 20)." & " if $ncfl;

					my $last_tag;

					my $lastround;

					foreach my $value (@{$values_by_entry{$entry}}) { 

						if ($ncflcongress && $lastround != $value->roundid) { 
							print TEXOUT "\n \\end{minipage}\n" if $lastround;
							print TEXOUT "\\begin{minipage}{1.45in}";
							print TEXOUT " {\\bf ".$id_roundname{$value->roundid}." }: ";
						}

						$lastround = $value->roundid;

						next if $value->tag eq "rank" && not defined $ranks;
						next if $value->tag eq "points" && not defined $points;
						next if $value->tag eq "ballot" && not defined $wins;

						if ($value->tag eq "rank") { 
							print TEXOUT " ";
						} else { 
							print TEXOUT "/" if $last_tag eq "ballot";
							print TEXOUT "/" if $last_tag eq "rank";
							print TEXOUT " " if $last_tag eq "points";
						}

						print TEXOUT $value->value;
						print TEXOUT " (PO)" if $value->chair && $ncflcongress;
						$last_tag = $value->tag;
					}

					print TEXOUT "\n \\end{minipage}\n" if $ncflcongress && $lastround;
					print TEXOUT "\\\\ \n";
					print TEXOUT "\\end{tabular}\n";
					print TEXOUT "\\newline\n";
					
				}

			}

		}

	}

	close TEXOUT;

    $m->comp("/funclib/printout.mas", filename => $filename, tail => 1 );

</%init>


<%args>
	$session
	$tourn
	$timeslot_id => undef
	$check_all => undef
	$account
</%args>
<%init>

	my @timeslots = $tourn->timeslots;
	@timeslots = sort {$a->start <=> $b->start} @timeslots; 

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;

	my @panels = $m->comp('/funclib/timeslot_panels.mas', timeslot => $timeslot) if $timeslot;
	my %panels_by_id =();
	foreach my $panel (@panels) { 
		$panels_by_id{$panel->id} = $panel;
	}

	my $ta = Tab::TournAdmin->search( account => $account->id, tourn => $tourn->id)->first;
	my $limited++ if $ta && $ta->entry_only;
	undef $limited if $account->site_admin;

</%init>

	<div class="right small">
	
		<div class="sidenote">

			<a class="blue block" href="/tabbing/entry/index.mhtml?timeslot_id=<% $timeslot_id %>">
				Return to Ballot Entry
			</a>

			<hr>

			<a class="<% $timeslot_id ? "" : "dk" %>blue block" href="status.mhtml">
				Full Dashboard
			</a>

			<hr>

			<h4>See Round Status:</h4>
		
% 			foreach my $ts (@timeslots) { 
%				my @unranked = $m->comp('/funclib/timeslot_judges.mas', timeslot => $ts, status => "full");
%				my @unaudited = $m->comp('/funclib/timeslot_judges.mas', timeslot => $ts, status => "half");

%				my $class = "green";
%				$class = "yellow" if @unaudited;
%				$class = "red" if @unranked;

				<a class="<% $ts->id == $timeslot_id ? "dk" : "" %><% $class %> block " href="status.mhtml?timeslot_id=<% $ts->id %>">
					<% $ts->name %>
				</a>
% 			}

		</div>

	</div>

	<div class="left huge">

%	if ($timeslot_id) {

%		my @unranked = $m->comp('/funclib/timeslot_judges.mas', timeslot => $timeslot, status => "full");
%		my @unaudited = $m->comp('/funclib/timeslot_judges.mas', timeslot => $timeslot, status => "half");

		<div class="left half">

			<h4><% scalar @unranked %> Unranked:</h4>

% 				foreach my $judge (@unranked) { 
					<a class="noline red block smallish nowrap" href="/tabbing/entry/index.mhtml?timeslot_id=<% $timeslot_id %>&judge_id=<% $judge->id %>">
						<span class="evensmallerspan padno inline">
							<% $panels_by_id{$judge->panelid} ? $panels_by_id{$judge->panelid}->round->event->abbr : "" %>
						</span>
						<span class="smallspan padno inline ">
							<% $judge->school && $judge->school->code ? $judge->school->code : "XX" %> <% $judge->code %>
						</span>
						<span class="editspan padno inline " style="margin-left: 6px;">
							<% $judge->first." ".$judge->last %>
						</span>
						<span class="schemat padno inline  nowrap" style="margin-left: 6px; width: 80px;">
							<% $panels_by_id{$judge->panelid} ?  $panels_by_id{$judge->panelid}->room->name : "" %>
						</span>
					</a>


%				}

		</div>


		<div class="right half">

			<h4><% scalar @unaudited %> Unaudited:</h4>

% 				foreach my $judge (@unaudited) { 
					<a class="noline yellow block smallish nowrap" href="/tabbing/entry/index.mhtml?timeslot_id=<% $timeslot_id %>&judge_id=<% $judge->id %>">
						<span class="evensmallerspan padno inline">
							<% $panels_by_id{$judge->panelid} ? $panels_by_id{$judge->panelid}->round->event->abbr : "" %>
						</span>
						<span class="smallspan padno inline ">
							<% $judge->school && $judge->school->code ? $judge->school->code : "XX" %> <% $judge->code %>
						</span>
						<span class="editspan padno inline " style="margin-left: 6px;">
							<% $judge->first." ".$judge->last %>
						</span>
						<span class="schemat padno inline  nowrap" style="margin-left: 6px; width: 80px;">
							<% $panels_by_id{$judge->panelid} ?  $panels_by_id{$judge->panelid}->room->name : "" %>
						</span>
					</a>

%				}

		</div>

%	}   else { 

<%perl>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my %event_status;
	my %event_round;
	my %event_done;

    my @unreggeds = sort {ucfirst($a->name) cmp ucfirst($b->name)}
			Tab::School->search_where( tourn => $tourn->id, registered => { '!=', 1 } );

    my @reggeds  = sort {ucfirst($a->name) cmp ucfirst($b->name)}
			Tab::School->search( tourn => $tourn->id, registered => 1); 

	my %ready_events = map {$_->id => $_} $m->comp('/funclib/event_breakable.mas', tourn => $tourn);

	foreach my $event ($tourn->events) { 

		my $current_round = $m->comp("/funclib/event_current_round.mas", event => $event);
		my $done_round = $m->comp("/funclib/event_current_round.mas", event => $event, done => 1);

		$event_done{$event->id}++ if $done_round && $done_round->type eq "final";

		my $switch;

		if ($current_round) { 
		
			my $timeslot = $current_round->timeslot;

			$event_round{$event->id} = $current_round;

			my $start = $current_round->start_time;
			$start = $timeslot->start unless $start;

			$start->set_time_zone($tz);

			$event_status{$event->id} .= '<div class="oddrow smallish"><span class="hundo"> Start Time </span><span class="smallishspan">';
			$event_status{$event->id} .= Tab::nicetime($start)."</span></div>";

			my $row;


			my @outstanding = $m->comp("/funclib/timeslot_judges.mas", timeslot => $timeslot, limit => $event, status => "uncollected");

			if (@outstanding) { 

				$row = "evenrow" unless $switch % 2;
				$row = "oddrow" if $switch++ % 2;
				
				$event_status{$event->id} .= '<div class="'.$row.' smallish"><span class="hundo"> Uncollected </span><span class="smallishspan">';
				$event_status{$event->id} .= scalar @outstanding."</span></div>";
			}


			my @unentered = $m->comp("/funclib/timeslot_judges.mas", timeslot => $timeslot, status => "full", limit => $event);
			if (@unentered) { 

				$row = "evenrow" unless $switch % 2;
				$row = "oddrow" if $switch++ % 2;
				
				$event_status{$event->id} .= '<div class="'.$row.' smallish"><span class="hundo"> Unentered </span><span class="smallishspan">';
				$event_status{$event->id} .= scalar @unentered."</span></div>";
			}

			my @half_entered = $m->comp("/funclib/timeslot_judges.mas", timeslot => $timeslot, status => "half", limit => $event);

			if (@half_entered) { 
				$row = "evenrow" unless $switch % 2;
				$row = "oddrow" if $switch++ % 2;
				$event_status{$event->id} .= '<div class="smallish '.$row.'"><span class="hundo"> Half-Entered </span><span class="smallishspan">';
				$event_status{$event->id} .= scalar @half_entered."</span></div>";
			}
		
		} else { 

		}

	}

</%perl>


		<h2>Tournament Dashboard</h2>

%		foreach my $event ($tourn->events) { 

%			next unless $event_status{$event->id} || $ready_events{$event->id};

			<span class="padmore thirdspan border" style="height: 135px; width: 200px;">
			
				<div>
					<span class="eighty">
						<h4><% $event->abbr %></h4>
					</span>
					<span class="huntwofive">
						<h5><% $event_round{$event->id} ? $event_round{$event->id}->realname : ""  %></h5>
					</span>
				</div>

				<% $event_status{$event->id} %>

%				if ($event_done{$event->id}) { 

					<div>
						<span class="dkgreen fullblock centeralign">
							All done!
						<span>
					</div>

%				} elsif ($ready_events{$event->id}) { 
				
					<div>
%						if ($limited) { 
							<span class="dkyellow centeralign smallish block">
%						} else { 
							<a class="dkyellow centeralign smallish block" href="/tabbing/break/index.mhtml?event_id=<% $event->id %>">
%						}
							Ready to advance
						</a>
						</span>
					</div>
%				}

			</span>

%		}
%	} 

	</div>


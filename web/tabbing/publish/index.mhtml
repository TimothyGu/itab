<%args>
	$tourn
</%args>
<%init>

	my @types;
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

</%init>

	<div class="left huge">

		<h2>Web Publish Final Results</h2>

		<& "/funclib/tablesorter.mas", table => "sortable" &>

		<table cellpadding="4" id="sortable">

			<thead>

				<tr class="yellowrow">

					<th class="smallish">
						Event
					</th>

					<th class="smallish">
						Result Sets
					</th>

					<th class="smallish">
						Public
					</th>

				</tr>

			</thead>

			<tbody>

%			my @events = sort {$a->name cmp $b->name} $tourn->events;
%			@events = sort {$a->type cmp $b->type} @events;

%			foreach my $event (@events) { 

%				push @types, $event->type;

% 				my $published = $event->setting("results_published");

				<tr>

					<td>
						<% $event->name %>
					</td>

					<td>
%						foreach my $result_set ($event->result_sets) { 

%							my $generated = $result_set->generated;
%							$generated->set_time_zone($tz);

							<div class="block smallish padless">
								<span class="medbiggerspan padless">
									<% $result_set->label %>
								</span>
								<span class="eighty padless">
									<% $generated ? Tab::niceshortdt($generated) : "" %>
								</span>
								<span class="microspan padno">
%									my $warn = "This will delete the result set ".$event->abbr." ".$result_set->label." from all public postings.  Continue?";
									<a class="dkred thin block" <& "/funclib/confirm.mas", warn => $warn &>  href="set_delete.mhtml?result_set_id=<% $result_set->id %>">
										X
									</a>
								</span>

							</div>
%						}

%						foreach my $file ($event->files( result => 1)) { 

							<div class="block smallish padless">
								<span class="medbiggerspan padless">
									<a href="/files/tourns/<% $tourn->id %>/results/<% $file->id %>/<% $file->name %>" class="padno white block">
										<% $file->label %>
									</a>
								</span>
								<span class="eighty padless">
									<% Tab::niceshortdt($file->uploaded) %>
								</span>
								<span class="microspan padno">
%									my $warn = "This will delete the file set ".$file->label." from all public postings.  Continue?";
									<a class="dkred thin block" <& "/funclib/confirm.mas", warn => $warn &>  href="file_delete.mhtml?file_id=<% $file->id %>">
										X
									</a>
								</span>

							</div>
%						}

					</td>

					<td class="centeralign smallish">
%						if ($published) { 
							<a class="dkgreen block centeralign" href="publish.mhtml?event_id=<% $event->id %>">
								PUBLIC
							</a>
%					   } else { 
							<a class="dkred block centeralign" href="publish.mhtml?event_id=<% $event->id %>">
								NOT PUBLIC
							</a>
%					   }
					</td>

				</tr>

%			}

			<tr class="liblrow">

				<td class="padmore">
					Tournament Wide
				</td>

				<td>

%					foreach my $result_set ($tourn->result_sets) { 

%						next if $result_set->event > 0;

%						my $generated = $result_set->generated;
%						$generated->set_time_zone($tz);

						<div class="block smallish padless">
							<span class="medbiggerspan padless">
								<% $result_set->label %>
							</span>
							<span class="eighty padless">
								<% $generated ? Tab::niceshortdt($generated) : "" %>
							</span>
							<span class="microspan padno">
%								my $warn = "This will delete the result set ".$result_set->label." from all public postings.  Continue?";
								<a class="dkred thin block" <& "/funclib/confirm.mas", warn => $warn &>  href="set_delete.mhtml?result_set_id=<% $result_set->id %>">
									X
								</a>
							</span>

						</div>
%					}

%					foreach my $file ($tourn->files( result => 1)) { 

%						next if $file->event && $file->event->id;

						<div class="block smallish padless">
							<span class="medbiggerspan padless">
								<a href="/files/tourns/<% $tourn->id %>/results/<% $file->id %>/<% $file->name %>" class="padno white block">
									<% $file->label %>
								</a>
							</span>
							<span class="eighty padless">
								<% Tab::niceshortdt($file->uploaded) %>
							</span>
							<span class="microspan padno">
%								my $warn = "This will delete the file set ".$file->label." from all public postings.  Continue?";
								<a class="dkred thin block" <& "/funclib/confirm.mas", warn => $warn &>  href="file_delete.mhtml?file_id=<% $file->id %>">
									X
								</a>
							</span>

						</div>
%					}

				</td>


				<td class="centeralign smallish">


				</td>

			</tr>

%		my %seen = (); 
%		@types = grep { ! $seen{$_} ++ } @types;

		</tbody>

		</table>

	</div>

	<div class="right small">

		<div class="sidenote">

			<h4>Calcuate results</h4>

			<form action="generate_results.mhtml" method="post">

			<div class="block evenrow">

				<span class="evensmallerspan">
					Event
				</span>

				<span class="huntwofive righalign">

					<select name="event_id" class="fixedsmaller">

						<option value="all">
							All events
						</option>

%						foreach my $type (@types) { 
							<option value="type_<% $type %>">
								All <% ucfirst($type) %> events
							</option>
%						}

%						foreach my $event (@events) { 
							<option value="<% $event->id %>">
								<% $event->abbr %>
							</option>
%						}



					</select>
				</span>
		
			</div>

			<div class="block">

				<span class="evensmallerspan">
					Type
				</span>

				<span class="huntwofive righalign">
					<select name="result_type" class="fixedsmaller">
						<option value="final">Final Places</option>
						<option value="prelim_seed">Prelim Seeds</option>
					</select>
				</span>
		
			</div>

			<div class="evenrow block">

				<span class="evensmallerspan">
					Public
				</span>

				<span class="huntwofive rightalign">
					<input type="radio" name="publish" value="1" class="padno marleft" id="one"> <label for="one">Yep</label>
					<input type="radio" name="publish" value="0" class="padno marleft" id="non"> <label for="non">Nope</label>
				</span>
		
			</div>

			<div class="block liblrow rightalign">
				<input type="submit" value="Calculate" class="thin">
				</form>
			</div>

		</div>

		<div class="sidenote">

			<h4>Upload Result Files</h4>

			<div class="block evenrow">
			
				<form enctype="multipart/form-data" action="upload_results.mhtml" method="post" onsubmit="return uploadThis()">

				<span class="evensmallerspan">
					Event
				</span>

				<span class="huntwofive righalign">

					<select name="event_id" class="fixedsmaller">

						<option value="type">
							Tournament Wide
						</option>

%						foreach my $event (@events) { 
							<option value="<% $event->id %>">
								<% $event->abbr %>
							</option>
%						}

					</select>
				</span>
			</div>

			<div class="block oddrow">
			
				<span class="evensmallerspan">
					Label
				</span>

				<span class="huntwofive righalign">
					<input type="name" name="label" size="13">
				</span>

			</div>

			<div class="block evenrow">
			
				<span class="evensmallerspan">
					File
				</span>

				<span class="huntwofive righalign">
					<input type="file" name="posting" value="Go" size="5">
				</span>

			</div>

			<div class="block liblrow rightalign">
				<input type="submit" value="Upload" class="thin">
				</form>
			</div>

		</div>

	</div>



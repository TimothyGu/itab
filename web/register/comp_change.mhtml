<%args>
	$entry_id
	$school_id
	$code => undef
</%args>
<%init>

	my $err;

	my $entry = Tab::Entry->retrieve($entry_id);

	if ($school_id && $school_id != $entry->school->id) { 
		$entry->school($school_id);
		$err .= "Entryetitor school changed <br />";
	}


	if ($code && $code != $entry->code) { 

		my @existing = Tab::Entry->search( code => $code, tournament => $entry->school->tournament->id );
	
		if (@existing) { 
	
			my $err = "A competitor with speaker code $code already exists";
			$m->redirect("$Tab::url_prefix/register/entry/edit.mhtml?err=$err&entry_id=$entry_id");
		
		} else { 
	
			$entry->code($code);
			$err .= "Entryetitor code changed to $code <br />";
	
		}

	}

	$entry->student($ARGS{$entry->student->id}) if $entry->student;
	$entry->partner($ARGS{$entry->partner->id}) if $entry->partner;

	$entry->partner($ARGS{"partner"}) if $entry->event->team == 2 && not defined $entry->partner;

	$entry->update;
	
	$m->redirect("$Tab::url_prefix/register/entry/edit.mhtml?err=$err&entry_id=$entry_id");
		
</%init>

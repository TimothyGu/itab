<%args>
	$circuit
	$tourn
	$session
	$debug => undef
</%args>
<%init>

	my @days = $tourn->days;

	my $filename = "judge-dancecards-".$tourn->id."-".$session->id;
	my $filepath= $Tab::file_root."/tmp/".$filename;
	my $garbage = `rm -f $filepath.*`;
	
	open (TEXOUT, ">$filepath.tex");

	print TEXOUT <<"EOF";
\\documentclass[10pt]{report}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{nopageno}
\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.75}
\\begin{document}

EOF

close TEXOUT;

	my $now =  DateTime->now;
	$now->set_time_zone($circuit->timezone);

	my @judges = $tourn->judges;
	@judges = sort {$a->code cmp $b->code} @judges;
	@judges = sort {$a->school->name cmp $b->school->name} @judges;

	foreach my $judge (@judges) { 

		open (TEXOUT, ">>$filepath.tex");

		print TEXOUT "\\begin{flushright}\n";
		print TEXOUT "\\Huge\n";
		print TEXOUT "{\\bf ".Tab::texify($judge->first." ".$judge->last)." (".$judge->code.")} \\\\ \n ";
		print TEXOUT "\\normalsize\n";
		print TEXOUT "\\end{flushright}\n \\begin{center}";

		print TEXOUT "\\begin{tabular}{p{.75in}p{2.25in}p{.75in}p{2.25in}} \n  ";
		print TEXOUT "\\hline\n  ";
		print TEXOUT "{\\bf Circuit:} & ".Tab::texify($circuit->name)." & ";
		print TEXOUT "{\\bf Tournament:} & ".Tab::texify($tourn->name)." \\\\ \n ";
		print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\n";
	
		my $congress;

		if ($judge->school) {

			print TEXOUT "{\\bf School:} & ".  $judge->school->chapter->name if $judge->school && $judge->school->chapter;
			print TEXOUT " (".$judge->school->code.") & " unless $circuit->diocese_based;
			print TEXOUT " (".$judge->school->region->code.") & " if $circuit->diocese_based;

		} else {
			print TEXOUT "{\\bf School:} & Hired Judge & \n";
		}

		print TEXOUT "{\\bf Code:} & ".$judge->code." \\\\ \n";
		print TEXOUT "\\hline \\\\ \n  ";
		print TEXOUT "\\end{tabular} \\\\ \n  ";

        my @panels = $judge->panels;
        @panels = sort {$a->round->timeslot->start->epoch <=> $b->round->timeslot->start->epoch} @panels;

		print TEXOUT "\\begin{tabular}{p{1.5in}p{.75in}p{1.0in}p{.75in}p{2.0in}} \n";
		print TEXOUT "\\multicolumn{5}{l}{\\large Judging Assignments: } \\\\ \\hline \n" if @panels;

        foreach my $panel (@panels) {
            my $start = $panel->round->timeslot->start;
            $start->set_time_zone($circuit->timezone);

			$congress++ if $panel->event->type eq "congress";

            print TEXOUT "{\\bf ".Tab::texify($panel->event->name)." } & ";
            print TEXOUT "{\\bf ".$panel->round->label." }" if $panel->round->label;
            print TEXOUT "{\\bf Round ".$panel->round->name." }" unless $panel->round->label;
			print TEXOUT " & ";
			print TEXOUT $start->day_abbr." "  if scalar @days > 1;
			print TEXOUT $start->hour_12.":".$start->strftime("%M")." ";
            print TEXOUT $start->strftime("%p");
            print TEXOUT " & ";
            print TEXOUT "Section: ".$panel->letter." & ";
            print TEXOUT "Room: ".Tab::texify($panel->room->name)." " if $panel->room;
			print TEXOUT "\\\\ \\hline \n";
        }

		print TEXOUT "\\end{tabular}\n";

		print TEXOUT "\\bigskip\n";

		print TEXOUT "\\begin{tabular}{p{1.75in}p{4.50in}} \n";

		print TEXOUT "\\multicolumn{2}{c}{\\large}\\\\ \n" if $judge->special;
		print TEXOUT "\\multicolumn{2}{l}{\\large Special Assignment: } \\\\ \\hline \n" if $judge->special;
		print TEXOUT "\\multicolumn{2}{l}{ ".$judge->special."} \\\\ \n" if $judge->special;

		print TEXOUT "\\multicolumn{2}{c}{\\large}\\\\ \n";
		print TEXOUT "\\multicolumn{2}{l}{\\large Additional Assignments: } \\\\ \\hline \n" if $judge->pools;

		foreach my $pool ($judge->pools) { 

			print TEXOUT "{\\bf ";
			print TEXOUT " STANDBY " if $pool->type eq "standby";
			print TEXOUT " PRELIMS " if $pool->type eq "prelim";
			print TEXOUT " IN POOL: " if $pool->type eq "elim";
			print TEXOUT $pool->name ." } & ";
			print TEXOUT $pool->message;
			print TEXOUT "\\\\ \\hline \n";

		}

		print TEXOUT "\\multicolumn{2}{c}{\\large}\\\\ \n";

		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\end{center}\n";
		print TEXOUT "\\newpage\n";
	
	}

	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filepath.tex; $Tab::dvipdfm_path $filepath.dvi`;

	`rm -f $filepath.tex $filepath.log $filepath.dvi $filepath.aux` unless $debug;

	my $tourn_id = $tourn->id;

	$m->redirect("$Tab::url_prefix/tmp/".$filename.".pdf");

</%init>

<div id="content">

<p><% $filename %></p>

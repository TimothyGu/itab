<%args>
	$tourn
	$group_id
	$class_id => undef
	$league
	$sort_by => "code"
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id); 

	my @judges = Tab::Judge->search( judge_group => $group_id );

	my @classes = $group->classes;

	my $class = $classes[0] if @classes;

	$class_id = $class->id if $class && not defined $class_id;

	my @events = $group->events;

	my @useless_judges;
	my @useful_judges;


	if ($group->tab_room) { 

		@useful_judges = @judges;

	} else { 

		JUDGE:
		foreach my $judge (@judges) { 

 		my @qual; 

 		if ($class_id && $tourn->method->judge_quality_system == 1 && $group->coach_ratings) {

 			@qual = Tab::JudgeClass->search( judge => $judge->id, class => $class_id);
			push (@useless_judges, $judge) unless @qual && $qual[0]->qual && $qual[0]->qual->useme;
			next JUDGE unless @qual && $qual[0]->qual && $qual[0]->qual->useme;
			push (@useful_judges, $judge);
			$judge->qual($qual[0]->qual->name) if @qual;

		} else {

			push (@useful_judges, $judge);

		}

		}
	}

	@useful_judges = sort {$a->last cmp $b->last} @useful_judges;
	@useful_judges = sort {$a->code cmp $b->code} @useful_judges unless $sort_by eq "last";
	@useful_judges = sort {$a->first cmp $b->first} @useful_judges if $sort_by eq "first";
	@useful_judges = sort {$a->school->name cmp $b->school->name} @useful_judges if $sort_by eq "schname"; 
	@useful_judges = sort {$a->region->name cmp $b->region->name} @useful_judges if $sort_by eq "regname"; 
	@useful_judges = sort {$a->region->code cmp $b->region->code} @useful_judges if $sort_by eq "regcode"; 
	@useful_judges = sort {$a->prelim_pool->name cmp $b->prelim_pool->name} @useful_judges if $sort_by eq "prelim_pool"; 

</%init>

	<table>

		<tr> 
	
			<td width="100%">
				<h3>Judges in group <% $group->name %></h3>
			</td>
		
			<td>
				<form action="judges.mhtml" method="post">
				<input class="blue" type="submit" value="Return to Judges">
				</form>
			</td> 

			<td width="30%" align="right">
				<form action="print_judges.mhtml" method="post">
				<input type="hidden" name="sort_by" value="<% $sort_by %>">
				<input type="hidden" name="group_id" value="<% $group_id %>">
				<input class="blue" type="submit" value="   Print List  ">
				</form>
			</td>
		
		</tr> 
		
	</table>

	<table cellpadding="5" cellspacing="1"  border="0" width="100%"> 
	
		<tr>

% 			if ($tourn->method->judge_quality_system == 1 && (scalar $group->classes) > 1) {

				<td>
					<form action="judge_groupview.mhtml" method="post">
					<input type="hidden" value="<% $group_id %>" name="group_id">
					Show Quals In:
				</td> 
				
				<td>
					<select name="class_id">

%						foreach my $class (@classes) { 

							<option value="<% $class->id %>" <% ($class_id) ? ($class_id == $class->id) ? "selected" : "" : "" %> >
								<% $class->name %>
							</option>

%						}

					</select>
				</td>
%			}


		</tr>

	</table>

	<table cellpadding="5" cellspacing="1"  border="0" width="100%">

		<tr class="liblrow">

			<th>
				<a class="whiteblock" href="judge_groupview.mhtml?group_id=<% $group->id %>&sort_by=code">
				Code
				</a>
			</th>

			<th>
				<a class="whiteblock" href="judge_groupview.mhtml?group_id=<% $group->id %>&sort_by=last">
				Last
				</a>
			</th>

			<th>
				<a class="whiteblock" href="judge_groupview.mhtml?group_id=<% $group->id %>&sort_by=first">
				First
				</a>
			</th>

			<th>
				<a class="whiteblock" href="judge_groupview.mhtml?group_id=<% $group->id %>&sort_by=schname">
				School
				</a>
			</th>

%			$m->print("<th>Regcode</th>") if $league->region_based;

%			$m->print("<th>Diocode</th>") if $league->diocese_based;

%			if ($group->tab_room) {

				<th colspan="4">
					Tab Preferences
				</th>

%			} else { 

%				$m->print("<th>Prelims</th>") if $league->diocese_based;
%				$m->print("<th>Elims</th>") if $league->diocese_based;
			
				<th>
					Notes/Special Job
				</th>

% 				if ($tourn->method->judge_quality_system == 1) {

					<th>
						Qual
					</th>
%				}
%			}

	</tr>

% 	my $switch;

%	foreach my $judge (@useful_judges) { 

%		if ($judge->active) { 
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""  %>> 
% 		} else { 
			<tr <% ($switch++ % 2) ? "class=\"bluerow\"" : "class=\"liblrow\""  %>> 
%		}

			<td class="smaller">
				(<a href="<%$Tab::url_prefix%>/register/judge_edit.mhtml?from=list&judge_id=<% $judge->id %>"><% ($judge->code) ? $judge->code : "Edit"%></a>)
			</td>

			<td class="smaller">
				<% $judge->last %>
			</td>

			<td class="smaller">
				<% $judge->first %>
			</td>

			<td class="smaller">
				<% ($judge->neutral) ? "NEUTRAL (" : "" %>
				<% ($judge->school->name) ? substr($judge->school->name,0,25) : "Hired" %>
				<% ($judge->neutral) ? " )" : "" %>
			</td>

				<% ($league->diocese_based && $judge->region) ? "<td class=\"smaller\" align=\"center\">".$judge->region->code."</td><td class=\"smaller\" align=\"center\">" : "" %>
				<% ($league->diocese_based &! $group->tab_room) ? ($judge->prelim_pool) ? $judge->prelim_pool->name : $judge->judge_group->abbr : "" %>
				<% ($league->diocese_based) ? "</td>" : "" %>

%			if ($group->tab_room) { 

%				if ($judge->special) { 

					<td colspan="3" class="smaller">
						<% $judge->special %>
					</td>

%				} else { 

					<td>
						<% $judge->cfl_tab_first %>
					</td>

					<td>
						<% $judge->cfl_tab_second %>
					</td>

					<td>
						<% $judge->cfl_tab_third %>
					</td>
%				}

%			} else { 

%				if ($league->diocese_based) {

					<td align="center">

%						if ($judge->elim_group) {
%							foreach ($judge->elim_group) { 
								<% $_->abbr %>
%							}
% 						}

					</td>
%				}

				<% ($league->region_based && $judge->region) ? "<td>".$judge->region->code."</td>" : ""  %>

				<td width="20%" class="smaller">
					<% $judge->notes %>
					<% ($judge->special) ? "Special:".$judge->special : "" %>
				</td>

% 				if ($group->blockable) {

					<td width="17%">

%						foreach my $event (@events) { 
%							if ($event->strike($judge)) { 
								No <% $event->abbr%>
%							}
%						}

					</td>
%				}

%  			}		


% 			if ($class_id && $tourn->method->judge_quality_system == 1) { 

				<td align="center">

%					foreach my $qual ($judge->quals) { 
						<% $qual->name %>
%					}

				</td>

% 			}

		</tr>

% 	} 


% if (@useless_judges) { 

<tr><td colspan="8">
<h4>Useless Judges</h4>
</td></tr>

% foreach my $judge (@useless_judges) { 
	<tr>
	<td>(<a href="<%$Tab::url_prefix%>/register/judge_edit.mhtml?judge_id=<% $judge->id %>">
% 	if ($league->diocese_based) { 
	View 
% 	} else { 
	J<% $judge->code %>
%  }
</a>)</td>

		<td>
			<% $judge->last %>
		</td>
		
		<td>
			<% ($judge->school->name) ? substr($judge->school->name,0,25) : "Hired" %>
		</td>

		<% ($league->diocese_based) ? "<td>".$judge->regname."</td>": "" %>

		<td width="25%">
			<% $judge->notes %>
		</td>
		
		<td width="25%">
			<% $judge->special %>
		</td>

% 		if ($class_id && $tourn->method->judge_quality_system == 1) { 
% 				my @qual = Tab::JudgeClass->search( judge => $judge->id, class => $class_id);
				<td>
					<% (@qual) ? $qual[0]->qual ? $qual[0]->qual->name : "No Qual" : ""%>
				</td>
% 		}

	</tr>

% } 

% }

</table>


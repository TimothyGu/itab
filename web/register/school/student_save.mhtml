<%args>
	$account
	$student_id => undef
	$first =>  undef
	$last => undef
	$gender => undef
	$novice => '0'
	$school_id
	$from => undef
</%args>
<%init> 

	my $err;
	my $now = DateTime->now;

	my $school = Tab::School->retrieve($school_id);

#	Remove leading spaces
	$first =~ s/^\s+//;
	$last =~ s/^\s+//;

#	Capitalize, bitches
	$first = ucfirst($first);
	$last = ucfirst($last);

	unless ($first) { 
		$err = "WARNING: You have not supplied a first name ";
	}

	unless ($last) { 
		$err = "WARNING: You have not supplied a last name " unless $err;
		$err .= " or last name " if $err;
	}

	if ($err) { 
		$err .= ". Student not saved.";
		$m->redirect("student_add.mhtml?school_id=$school_id&err=$err");
	}		

	if (Tab::Student->search(  first => $first, last => $last, chapter => $school->chapter->id )) { 
		$err = "Student not saved: a student with that name already exists.";
		$m->redirect("student_add.mhtml?school_id=$school_id&err=$err");
	}

	my $now_year = $now->year;
	$now_year++ if $now->month > 6;
	
	my $student = Tab::Student->create({ 	
		first => $first,
		last => $last,
		grad_year => $now_year,
		gender => $gender,
		novice => $novice,
		account => 0,
		chapter => $school->chapter->id
	});

	my $msg = $student->first." ".$student->last." added to roster";

	$m->redirect("student_add.mhtml?school_id=$school_id&msg=$msg");


</%init> 



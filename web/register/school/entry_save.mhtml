<%args>
	$tourn
	$event_id
	$school_id
	$account
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	my $school = Tab::School->retrieve($school_id);

	my $circuit = $tourn->circuit;
	
    my $now = DateTime->now;
    $now->set_time_zone($tourn->tz);

    my $fine_deadline = $tourn->setting("fine_deadline");
    $fine_deadline->set_time_zone($tourn->tz) if $fine_deadline;
	my $fine_amount = $tourn->setting("add_fine") if $now > $fine_deadline;

	my $minimum = $event->setting("min_entry");

	my @students;
	my %already;
	
	foreach my $slot (1 .. $event->max) { 

		if ($slot < $minimum) && not defined $ARGS{$slot}) { 
			my $err = "You did not enter enough students for a valid entry";
			$m->redirect("entry_add.mhtml?school_id=$school_id&event_id=$event_id&err=$err");
		}

		if ($already{$ARGS{$slot}}) { 
			my $err = "You entered the same student twice.  Please try again";
			$m->redirect("entry_add.mhtml?school_id=$school_id&event_id=$event_id&err=$err");
		}

	}

	my $entry;	
	
	if ($event->team == 1) { 
	
		$entry = Tab::Entry->create({ 
		
			tournament => $tourn->id,
			school => $school_id,
			event => $event_id,
			code => $code,
			student => $student_id,
			registered_at => $now,
			dropped => 0
		
		});
			
	} 
	
	if ($event->team == 2) { 
	
		$entry = Tab::Entry->create({ 
		
			tournament => $tourn->id,
			school => $school_id,
			event => $event_id,
			code => $code,
			student => $student_id,
			partner => $partner_id,
			registered_at => $now,
			dropped => 0
		
		});
	
	
	}
	
	if ($event->team == 3) { 
	
		$entry = Tab::Entry->create({ 
		
			tournament => $tourn->id,
			school => $school_id,
			event => $event_id,
			code => $code,
			registered_at => $now,
			name => $name
		
		});
	
	} 


	if ($now > $reg_end) { 

		my $add_reason = "Late Add ". $entry->code;

		my $fine = Tab::Fine->create({ 

			school => $school_id,
			amount => $fine_amount,
			reason => $add_reason,
			levied => $now

		}) if $fine_amount > 0;
		
	}

	
	
	my $msg = $name." ".$student->first." ".$student->last." has been entered in ". $event->name." with code $code" if $event->team == 1;
	$msg = $name." ".$student->last." and ".$partner->last." have been entered in ". $event->name." with code $code" if $event->team == 2;
	$msg = $name." has been entered in ". $event->name." with code $code " if $event->team == 3;

	$m->redirect("$Tab::url_prefix/register/event_listing.mhtml?msg=$msg&event_id=$event_id&show_schools=1") if $from eq "entry";

	$m->redirect("$Tab::url_prefix/register/entry_enter.mhtml?msg=$msg&school_id=$school_id&event_id=$event_id");

</%init>



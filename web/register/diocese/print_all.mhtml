<%args>
	$tourn
	$session
	$debug => 1
</%args>
<%init>

	my @dioceses = sort {$a->name cmp $b->name} $tourn->regions;

    my $filename = "dio-registrations-".$tourn->id."-".$session->id;
    my $filepath = $Tab::file_root."/tmp/";
    system "/bin/rm -rf $filepath"."$filename.*";

    open (TEXOUT, ">>$filepath"."$filename.tex");

	print TEXOUT <<"EOF";

\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[landscape]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields

\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}

\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.2}

\\setlength{\\oddsidemargin}{-.25in}     % default=0in
\\setlength{\\textwidth}{9.5in}       % default=9.5in

\\setlength{\\textheight}{7.0in}      % default=5.15in
\\setlength{\\topmargin}{-0.15in}     % default=0.20in
\\setlength{\\headsep}{0.15in}        % default=0.35in

\\setlength{\\parskip}{1.0ex}
\\setlength{\\parindent}{0mm}

\\addtolength{\\hoffset}{-.1in}
\\addtolength{\\voffset}{-.4in}

\\begin{document}
\\small

EOF

	foreach my $diocese (@dioceses) { 

		close TEXOUT;

		$m->comp("/funclib/ncfl/entries_print.mas", 
			diocese_id => $diocese->id, 
			filename => $filename, 
			filepath => $filepath, 
			nocodes => 1, 
			tourn_id => $tourn->id);

		$m->comp("/funclib/ncfl/judges_print.mas", 
			diocese_id => $diocese->id, 
			filename => $filename, 
			filepath => $filepath, 
			tourn_id => $tourn->id);

    	open (TEXOUT, ">>$filepath"."$filename.tex");
		print TEXOUT "\\newline\n";
		close TEXOUT;

		$m->comp("/funclib/ncfl/schools_print.mas", 
			diocese_id => $diocese->id, 
			filename => $filename, 
			filepath => $filepath, 
			tourn_id => $tourn->id);

    	open (TEXOUT, ">>$filepath"."$filename.tex");
		print TEXOUT "\\newpage\n";
		close TEXOUT;

	}

    open (TEXOUT, ">>$filepath"."$filename.tex");

	print TEXOUT "\\end{document}\n";
	close TEXOUT;

    `cd $filepath; $Tab::latex_path $filename.tex;`;
    `cd $filepath; $Tab::latex_path $filename.tex;`;
    `cd $filepath; $Tab::dvipdfm_path -l $filename.dvi;`;
    #system "cd $filepath; /bin/rm -rf $filename.tex $filename.log $filename.dvi $filename.aux" unless $debug;
    $m->redirect("$Tab::url_prefix/tmp/$filename.pdf");

</%init>

	<div id="content">

	<p><% $filename %></p>

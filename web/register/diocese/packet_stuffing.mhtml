<%args>
	$tourn
	$session
	$circuit
	$sort_by => "code"
</%args>
<%perl>

	my @events = sort {$a->abbr cmp $b->abbr} $m->comp("/funclib/tourn_events.mas", tourn => $tourn);
	my @groups = sort {$a->abbr cmp $b->abbr} $tourn->groups;


    my @dioceses = sort {$a->name cmp $b->name} $tourn->regions;

    if ($sort_by eq "code") {
        @dioceses = sort {$a->code cmp $b->code} @dioceses;
        @dioceses = sort {length($a->code) <=> length($b->code)} @dioceses;
    }

    if ($sort_by eq "quota") {
        @dioceses = sort {$b->quota cmp $a->quota} @dioceses;
    }

	my $comptotal;
	my $judgetotal;
	my $ubertotal;

</%perl>

<h3>Diocese stuffing counts</h3>

<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td width="25%" align="center">
    <form action="packet_stuffing.mhtml" method="post">
    <select name="sort_by">
        <option value="name" <% ($sort_by eq "name") ? "selected" : "" %>>Diocese Name</option>
        <option value="code" <% ($sort_by eq "code") ? "selected" : "" %>>Diocese Code</option>
        <option value="quota" <% ($sort_by eq "quota") ? "selected" : "" %>>Entry Quota</option>
    </select>
</td>
<td width="25%">
    <input  type="submit" value="Re-sort">
    </form>
</td>

<td align="right">
    <form action="packet_stuffing_print.mhtml" method="post">
    <input type="hidden" name="sort_by" value="<% $sort_by %>">
    <input  type="submit" value="  Print These Counts  ">
    </form>
</td>
</tr>
</table>

<br>

<table cellpadding="4" cellspacing="0" width="100%">

	<tr class="dkblrow"> 
		<th>Dio</th>
		<th>Diocese Name</th>
		<th>Kids</th>
%		foreach my $event (@events) { 
			<th><% $event->abbr %></th>
%		}
		<th>Judge</th>
%		foreach my $group (@groups) { 
			<th><% $group->abbr %></th>
%		}
		<th>Total</th>
	</tr>

%	my $switch; 

%	foreach my $diocese (@dioceses) { 

%		my @entries = $diocese->active_entries($tourn);
%		my @judges = $diocese->judges($tourn);

%		my %count_c_by_event = ();
%		my %count_j_by_group = ();	

%		my $comp_count = scalar @entries;

%		foreach (@entries) {    

%			$count_c_by_event{$_->event->id}++; 

%			if ($_->event->team == 2) { 
%				$count_c_by_event{$_->event->id}++;
%				$comp_count++;
%			}
%		}

%		foreach (@judges) {    $count_j_by_group{$_->judge_group->id}++; }

	<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

		<td><% $diocese->code %></td>
		<td><% $diocese->name %></td>

		<td style="text-align: center; border-left: 1px dotted black">
			<% $comp_count %></td>

%		my $intswitch = 1;

%		foreach my $event (@events) { 
			<td <% ($intswitch++ % 2) ? ($switch % 2) ?  "class=\"bluer\"" : "class=\"dkbluer\"" : "class=\"whiter\"" %>>	
				<% $count_c_by_event{$event->id} %>
			</td>
%		}

		<td style="text-align: center; border-left: 1px dotted black">
			<% scalar @judges %></td>

%		$intswitch = 1;
%		foreach my $group (@groups) { 
			<td <% ($intswitch++ % 2) ? ($switch % 2) ?  "class=\"bluer\"" : "class=\"dkbluer\"" : "class=\"whiter\"" %>>	
			<% $count_j_by_group{$group->id} %></td>
%		}

		<th style="text-align: center; border-left: 1px dotted black">
		<% $comp_count + scalar @judges  %></th>

%		$comptotal += $comp_count;	
%		$judgetotal += scalar @judges;	

%		$ubertotal += $comp_count;
%		$ubertotal += scalar @judges;

	</tr>

%	}


	<tr class="bluerow">

		<th colspan="2">TOTALS:</td>

		<td style="text-align: center; border-left: 1px dotted black">
		<% $comptotal %></td>

%		foreach my $event (@events) { 
			<td><% $event->count_active_entries %></td>
%		}

		<td style="text-align: center; border-left: 1px dotted black">
		<% $judgetotal %></td>

%		foreach my $group (@groups) { 
			<td><% $group->count_judges %></td>
%		}

		<th style="text-align: center; border-left: 1px dotted black">
		<% $ubertotal %></td>
		

	</tr>

	<tr class="dkblrow"> 
		<th>Dio</th>
		<th>Diocese Name</th>
		<th>Kids</th>
%		foreach my $event (@events) { 
			<th><% $event->abbr %></th>
%		}
		<th>Judge</th>
%		foreach my $group (@groups) { 
			<th><% $group->abbr %></th>
%		}
		<th>Total</th>
	</tr>


</table>


<%args>
	$circuit
	$tourn
	$account
	$session
	$event_id => 0
</%args>
<%init>

	my @events = $m->comp("/funclib/tourn_events.mas", tourn => $tourn) unless $event_id;
	push (@events, Tab::Event->retrieve($event_id)) if $event_id;

	@events = sort {$a->abbr cmp $b->abbr} @events;

	my $string = $events[0]->abbr if $event_id;
	$string = "all-events" unless $event_id;

	my $filename = $Tab::file_root."/tmp/entry-".$string."-".$session->id;
	my $garbage = `rm -f $filename.*`;

	open (CSVOUT, ">$filename.csv");

	print CSVOUT "Code,";
	print CSVOUT "Event," unless $event_id;
	print CSVOUT "DioCode,"  if $tourn->setting("ncfl");
	print CSVOUT "Schcode,"  unless $tourn->setting("ncfl");
	print CSVOUT "Student1First,Student1Last,";
	print CSVOUT "Student2First,Student2Last,";
	print CSVOUT "Diocese," if $tourn->setting("ncfl");
	print CSVOUT "Region," if $tourn->setting("regions");
	print CSVOUT "School \n";

	foreach my $event (@events) { 

	my @entries = sort {$a->code <=> $b->code} $event->entries;
	@entries = sort {$a->dropped <=> $b->dropped} @entries;
	@entries = sort {$a->waitlist <=> $b->waitlist} @entries;
	

foreach my $entry (@entries) { 

	if ($entry->dropped) { 
		print CSVOUT &Tab::texify("DROP").",";
	} elsif ($entry->waitlist) { 
		print CSVOUT &Tab::texify("WL").",";
	} else { 
		print CSVOUT &Tab::texify($entry->code).",";
	}

	print CSVOUT &Tab::texify($event->abbr)."," unless $event_id;

	if ($tourn->setting("ncfl")) { 
		print CSVOUT &Tab::texify($entry->school->region->code).",";
	} else { 
		print CSVOUT &Tab::texify($entry->school->code).",";
	}

	if ($event->team == 1) { 

		print CSVOUT &Tab::texify($entry->student->first).",".&Tab::texify($entry->student->last).",,,";

	} elsif ($event->team == 2) { 

		print CSVOUT &Tab::texify($entry->student->first).",".&Tab::texify($entry->student->last).",";
		print CSVOUT &Tab::texify($entry->partner->first).",".&Tab::texify($entry->partner->last).",";

	} else {
		print CSVOUT &Tab::texify($entry->name)."} ,,,,";
	}

	if ($tourn->setting("ncfl") || $tourn->setting("regions")) { 
		print CSVOUT &Tab::texify($entry->school->region->name).",";
	}

	print CSVOUT &Tab::texify($entry->school->name);
	print CSVOUT "\n";

	}

}

	close CSVOUT;

	$m->redirect("$Tab::url_prefix/tmp/entry-".$string."-".$session->id.".csv");

</%init>

<div id="content">

<p><% $filename %></p>

<%args>
	$tourn
	$account
	$judge_id
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	my $err;

	my $max = $judge->judge_group->setting("max_rounds");
	my $obligation = $ARGS{"obligation"};
	my $hired = $ARGS{"hired"};

	if (  ($obligation + $hired)  > $max && $max > 0) { 

		my $difference = $max - $obligation - $hired;
		$hired = $hired - $difference;

		if ($hired < 0) { 
			$obligation = $obligation + $hired;
			$hired = 0;
		}

		$err = "No judge can cover more than $max rounds of obligation.  Round burden reduced";
	}

	$judge->first($ARGS{"first"}) if $ARGS{"first"};
	$judge->last($ARGS{"last"}) if $ARGS{"last"};

	$judge->code($ARGS{"code"});
	$judge->covers($ARGS{"covers"});
	$judge->school($ARGS{"school"});
	$judge->judge_group($ARGS{"judge_group"});
	$judge->covers($ARGS{"covers"});

	$judge->hired($hired);
	$judge->obligation($obligation);

	$judge->alt_group($ARGS{"alt_group"});
	$judge->active($ARGS{"active"});
	$judge->dropped($ARGS{"dropped"});
	$judge->setting("neutral", $ARGS{"neutral"});
	$judge->setting("first_year", $ARGS{"first_year"});

	$judge->special($ARGS{"special"});
	$judge->notes($ARGS{"notes"});

	if ($ARGS{"phone"}) {
		$judge->account->phone($ARGS{"phone"}) if $judge->account;
		$judge->account->update if $judge->account;
	}

	$judge->update;

	my $msg = "Judge information saved";

	$m->redirect("edit.mhtml?judge_id=$judge_id&msg=$msg&err=$err");

</%init>

<%args>
	$session
	$account
	$tourn
	$debug => undef
	$rtf => undef
</%args>
<%perl>

	my @dioceses = sort {$a->name cmp $b->name} $tourn->regions;

	my $filename = $Tab::file_root."/tmp/booklet-".$tourn->id."-".$session->id;
	
	my $garbage = `rm -f $filename.*`;
	
	open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";

\\documentclass[letterpaper,9pt]{report}
\\usepackage{times}
\\usepackage{2up}
\\targetlayout{twosided}

\\setlength{\\oddsidemargin}{0.5in} 
\\setlength{\\evensidemargin}{0.5in} 
\\setlength{\\textwidth}{5.5in} 
\\setlength{\\textheight}{8.in} 
\\setlength{\\topmargin}{-0.35in}

\\begin{document}
\\pagestyle{empty}
\\pagenumbering{arabic}

EOF

	foreach my $diocese (@dioceses) { 

		close TEXOUT;

		next unless $diocese->events($tourn);

		$m->comp("/funclib/ncfl/print_diocese_book.mas", 
				diocese => $diocese, 
				filename => $filename, 
				tourn => $tourn
			);

	}

	open (TEXOUT, ">>$filename.tex");
	print TEXOUT "\\clearpage\n";
	print TEXOUT '\hbox{}\clearpage\hbox{}\cleardoublepage';
	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	if ($rtf) { 

		$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::latex2rtf_path -l $filename.dvi`;
		`rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;
		$m->redirect("$Tab::url_prefix/tmp/booklet-".$tourn->id."-".$session->id.".rtf");

	} else { 

		$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path -l $filename.dvi`;
		`rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;
		$m->redirect("$Tab::url_prefix/tmp/booklet-".$tourn->id."-".$session->id.".pdf");
	}

</%perl>

<div id="content">

<p><% $filename %></p>


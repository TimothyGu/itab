<%args>
	$tourn
	$entry_id => undef
	$err => undef
	$code => undef
	$circuit
</%args>
<%init>

	my $entry;

	if ($entry_id) { 
		$entry = Tab::Entry->retrieve($entry_id);
	}
	
</%init>

% 	if ($entry) {
    	
	<& /register/menubar.mas, school => $entry->school, whoami => "students", tourn => $tourn &>

	<div class="left huge">

		<h3>Entry in <% $entry->event->name %></h3>

		<table cellpadding="3" width="100%" cellspacing="1">

%		my $switch;

%		unless ($entry->event->setting("no_codes")) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Speaker Code
				</th>

				<td>
					<a class="whiteblock">
						<% $entry->code %>
					</a>
				</a>
				</td>

			</tr>

%		}

% 		foreach my $student ($m->comp("/funclib/entry_students.mas", entry => $entry)) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Name:
				</th>

				<td>
					<a class="whiteblock" href="/register/student_edit.mhtml?student_id=<%$student->id%>&entry_id=<% $entry->id %>">
						<% $student->first." ".$student->last %>
					</a>
				</td>

			</tr>

%		}


%		if ($entry->event->setting("ask_for_titles")) {

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Piece Title
				</th>
	
				<td>
					<% $entry->title %>
				</td>

			</tr>

%		}

%		if ($tourn->setting("ask_qualifying_tournament")) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
				<th>
					Qualified at:
				</th>
				
				<td>
					<% $entry->qualifier %>
				</td>

			</tr>

% 		}

% 	if ($tourn->setting("diocese_based")) { 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th>
				Diocese:
			</th>

			<td colspan="2">
				<a class="whiteblock" href="/register/diocese/entry.mhtml?diocese_id=<% $entry->school->region->id %>">
					<% $entry->school->region->name ." (".$entry->school->region->code .")" %>
				</a>
			</td>

		</tr>

% 	}

% 		if ($entry->ada) { 
			<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%		} else { 
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%		}

			<th>
				ADA Accomodations:
			</th>

			<td>
				<a class="whiteblock" href="/register/ada_switch.mhtml?entry_id=<% $entry->id %>"><% ($entry->ada) ? "Yes" : "No" %></a>
			</td>
	
		</tr>

% 	if ($tourn->setting("ask_qualifying_tournament")) {

		</table>

		<h4>Qualifying Information:</h4>

		<table cellpadding="5" width="100%" cellspacing="1">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Qualifier:
				</th>

				<td colspan="2">
					<form action="qual_save.mhtml" method="post">
					<input type="hidden" name="entry_id" value="<% $entry->id %>">
					<input type="name" name="qual" value="<% $entry->qualifier %>">
				</td>
			</tr> 
			
			<tr class="liblrow">
				<td colspan="3" align="right">
					<input type="submit"  value="    Save Qualifiers    "> 
					</form> 
				</td>
			</tr>
% 	}


% 	if ($tourn->setting("ask_two_quals")) {

		</table>

			<h4>
				Qualifying Information:
			</h4>


			<table cellpadding="5" width="100%" cellspacing="1">
		
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<th>
						1st Qual:
					</th>
					
					<td colspan="2">
						<form action="qual_save.mhtml" method="post">
						<input type="hidden" name="entry_id" value="<% $entry->id %>"> 
						<input type="name" size="30" name="qualifier" value="<% $entry->qualifier %>">
					</td>

				</tr> 
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						How Qualified:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qualexp" value="<% $entry->qualexp %>">
					</td>
					
				</tr> 
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						2nd Qual:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qual2" value="<% $entry->qual2 %>">
					</td>
				</tr> 
				
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						2nd How:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qual2exp" value="<% $entry->qual2exp %>">
					</td>
				</tr> 
				
				<tr class="liblrow">
					<td colspan="3" align="right">
						<input type="submit"  value="    Save Qualifiers    ">
						</form>
					</td>
				</tr>

% 	}

	</table>

<br>

%   if ($tourn->setting("housing")) {

<%perl>

    my $start = $tourn->start;
    my $end = $tourn->end;

    $start->set_time_zone($tourn->tz);
    $end->set_time_zone($tourn->tz);
    $end->truncate(to   => 'day');
    $start->truncate(to => 'day');

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $day_before = $days[0]->clone;
	$day_before->subtract( days => 1);
	push (@days, $day_before);

</%perl>

<h4>Housing</h4>

	<form action="housing_save.mhtml" method="post">
    <input type="hidden" name="entry_id" value="<% $entry->id %>">

	<table width="100%" cellpadding="5" cellspacing="1">
    
%	foreach my $student ($entry->members) { 

    <tr class="liblrow">

	    <td><% $student->first." ".$student->last %></td>

		<td align="center">Gender:</td>

	    <td align="center">
  	   		M
			<input 	type="radio" 
					name="gender_<%$student->id%>" 
					value="M" <% ($student->gender eq "M") ? "checked" : "" %> i
			>
		    F
			<input 	type="radio" 
					name="gender_<%$student->id%>" 
					value="F" <% ($student->gender eq "F") ? "checked" : "" %> 
			>
		</td>

	</tr>

%	foreach my $day (@days) { 

%		next unless Tab::HousingSlots->search( night => $day );

%		my $housing = $student->housing($tourn, $day);

		<tr>
			<th><% $day->day_name." ".$day->month."/".$day->day %></th>

			<td align="center">Request:
				<input 	type="checkbox" 
					name="request_<% $student->id."_".$day->ymd %>" 
					value="1" <% ($housing) ? "checked" : "" %> >
			</td>
   		
			<td align="center">Waitlisted:
				<input 	type="checkbox" 
					name="waitlist_<% $student->id."_".$day->ymd %>" 
					value="1" <% ($housing && $housing->waitlist) ? "checked" : "" %> >
			</td>
	    </tr>
%   }

%}

    <tr>
		<td colspan="4" align="right">
        	<input  type="submit" value="Save Housing Details">
    	</td>
	</tr>

    </form>
</table>

%	} # end of if housing.


%	unless ($entry->event->type eq "debate") { 

		<h3>Panel Assignments:</h3>

%  		my @rounds = sort { $a->name <=> $b->name } $entry->event->rounds;

		<table cellpadding="5" width="100%" cellspacing="1"> 

			<tr class="liblrow">
	
				<td class="smaller">
					Rnd
				</td>
		
				<td class="smaller">
					Start
				</td>
		
				<td class="smaller">
					Speaks
				</td>
		
				<td class="smaller">
					Sect/Room
				</td>
		
				<td class="smaller">
					Judges
				</td>
		
				<td class="smaller">
					Ranks
				</td>
		
				<td class="smaller">
				</td>
		
			</tr>
		
% 			foreach my $round (@rounds) { 

%				my @panels = $m->comp("/funclib/entry_panels.mas", round => $round, entry => $entry);
%				my $panel = shift @panels;

%				if ($panel) {
		
%					my @ballots = Tab::Ballot->search( entry => $entry_id, panel => $panel->id); 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

						<td>
							<% $round->name %>
						</td>


						<td class="smaller">
							<% &Tab::nicetime($panel->round->timeslot->start->set_time_zone($tourn->tz)) %>
						</td>

						<td class="smaller">
		                    <% Lingua::EN::Numbers::Ordinate::ordinate($m->comp("/funclib/entry_speakerorder.mas", entry => $entry, panel => $panel)) %> 
						</td>
	
						<td class="smaller">
							<a class="whiteblock" href="<%$Tab::url_prefix%>/panel/panel_view.mhtml?panel_id=<% $panel->id %>"><% $panel->letter %>:
							<% ($panel->room) ? $panel->room->name : "" %>
							</a>
						</td>

						<td class="smaller">

							<a class="whiteblock" href="<%$Tab::url_prefix%>/panel/panel_view.mhtml?panel_id=<% $panel->id %>">
%		 						foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 	
									<% $judge->code %>
% 								}	
							</a>

						</td>

						<td class="smaller" align="center">
							<a class="whiteblock" href="/tabbing/panel_card.mhtml?panel_id=<% $panel->id %>">
% 								foreach my $ballot (@ballots) { 
%									if ($ballot->judge) { 
										<% $ballot->real_rank %>
										<% ($ballot->tv) ? " TV " : "" %>
%									}
% 								}
							</a>

						</td> 
						
						<td class="smaller" align="center">
							<a class="whiteblock" href="/panel/entry/edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->id %>">Move</a>
						</td>

					</tr>
	
% 				} else { 
							
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

						<td>
							<% $round->name %>
						</td>
						
						<td colspan="8">
							<a class="whiteblock" href="/panel/entry/edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->id %>">
								Not scheduled in <% ($round->label) ? $round->label : "Round ".$round->name %>. Click to add manually.
							</a>
						</td>
					</tr>
% 				}

% 			}

		</table>

% 	}

%	$switch = 1;

	</div>

	<div class="right small">
	
		<table cellpadding="7" width="100%" cellspacing="1" border="0">

% 			if ($entry->dq == 1) { 

				<tr class="redrow">
				
					<td class="warning" colspan="3" align="center">
						DISQUALIFIED 
					</td>
						
				</tr>

%			} 

% 			if ($entry->dropped) { 

				<tr class="redrow">

					<td class="warning" colspan="4" align="center">

						DROPPED 

%						if ($entry->dropped_at) { 
							on <% &Tab::niceshortdt($entry->dropped_at->set_time_zone($tourn->tz)) %>
%						}
					</td>

				</tr>

%			} 

% 			if ($entry->waitlist) { 

				<tr class="redrow">
					<td class="warning" colspan="4" align="center">
						WAITLISTED
					</td>
				</tr>
%			} 

		</table>

		<hr>

		<a class="blue block" href="entry_print.mhtml?entry_id=<% $entry->id %>">Print Assignment Sheet</a>
		<a class="blue block" href="entry_card_print.mhtml?entry_id=<% $entry->id %>">Print Assignment Card</a>

%		foreach my $student ($entry->members) { 

			<a class="blue block" href="student_print.mhtml?student_id=<% $student->id %>">
				Print <% $student->first." ".$student->last %> Dance Card
			</a>
%		}


		<hr>

%		if ($entry->dropped) { 

			<a class="red block" href="entry_undrop.mas?entry_id=<% $entry->id %>">Un-Drop</a>
			<a class="red block" href="entry_rm.mas?entry_id=<% $entry->id %>">Entryletely Delete</a>

%		} else { 

			<a class="red block" href="entry_drop.mas?entry_id=<% $entry->id %>">Drop</a>
%		}

% 		if ($entry->event->waitlist) { 

%			if ($entry->waitlist) { 
			
				<a class="red block" href="entry_unwaitlist.mas?entry_id=<% $entry->id %>">Admit off waitlist</a>
			
%			} else { 

				<a class="red block" href="entry_waitlist.mas?entry_id=<% $entry->id %>">Place on waitlist</a>

%			}

%		}

%		if ($entry->dq) { 

			<a class="red block" href="entry_undq.mas?entry_id=<% $entry->id %>">Un-Disqualify</a>
			
%		} else { 

			<a class="red block" href="entry_dq.mas?entry_id=<% $entry->id %>">DISQUALIFY</a>
			<a class="red block" href="dq_selectively.mhtml?entry_id=<% $entry->id %>">DISQUALIFY SOME ROUNDS</a>
%		}

		<hr>

			<a class="red block" href="/tabbing/entry_card.mhtml?entry_id=<% $entry->id %>">View/Change Results Card</a>

		</hr>

		<h3>Changes:</h3>

		<table cellpadding="3" cellspacing="1" width="100%">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
				<th class="smaller">
					Code
				</th>

				<td align="right">
					<form action="entry_change.mhtml" method="post">
					<input type="hidden" name="entry_id" value="<% $entry_id %>">
					<input type="hidden" name="school_id" value="<% $entry->school->id %>">
					<input type="text" size="6" name="code" value="<% $entry->code %>">
				</td>
				
			</tr> 


<%perl>
			 my @students = $m->comp("/funclib/students_evententer.mas",
			 			circuit => $circuit,
						tourn => $tourn,
						event => $entry->event,
						chapter => $entry->school->chapter
			);

			my @entry_students = $entry->members;

</%perl>

%			my $count = 1;

%			foreach my $student (@entry_students) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
					<th class="smaller">
						Entry <% $count++ %>
					</th>
			
					<td> 
				
						<select name="<% $student->id %>">

    						<option value="<%	$student->id %>">
								<% substr($student->last.", ".$student->first,0,20) %>
							</option>

%							foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @students) {

% 		  						next if $other_student->id == $entry->student->id;
% 		  						next if $entry->partner && $other_student->id == $entry->partner->id;
	
    							<option value="<% $other_student->id %>">
									<% substr($other_student->last.", ".$other_student->first,0,20) %>
								</option>

%							}

						</select> 
					</td> 
				
				</tr>

%			} 

%			if ($entry->event->team == 2 && $count < 3) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
					<th class="smaller">
						Entry <% $count++ %>:
					</th>
			
					<td> 
				
						<select name="partner">

    						<option value="">
								PLEASE CHOOSE STUDENT
							</option>

%							foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @students) {

% 		  						next if $other_student->id == $entry->student->id;
% 		  						next if $entry->partner && $other_student->id == $entry->partner->id;
	
    							<option value="<% $other_student->id %>">
									<% substr($other_student->last.", ".$other_student->first,0,40) %>
								</option>

%							}

						</select> 
					</td> 
				
				</tr>

%			}

			<tr class="liblrow">

				<td colspan="2" align="right">
					<input type="submit" value="  Save Changes  ">
					</form>
				</td>

			</tr>


%			if ($circuit->diocese_based) { 


				<tr>
					<td colspan="2">
						<h4>Change School</h4>
						<form action="entry_school.mhtml" method="post">
						<input type="hidden" name="entry_id" value="<% $entry->id %>">
					</td>
				</tr>

				<tr class="evenrow">

					<td colspan="2">
						<select name="school_id">

%						foreach my $school (sort {$a->name cmp $b->name} $entry->school->region->schools(tournament => $tourn->id) ) { 
%							next if $school->id == $entry->school->id;
							<option value="<% $school->id %>">
								<% substr($school->name,0,32) %>
							</option>
%						}

					</td>

				</tr>

				<tr class="liblrow">

					<td align="right" colspan="2">
						<input type="submit" value=" Save School ">
						</form>
					</td>

				</tr>


%			}

		</table>

% 	} # end of if $entry 

	</div>

	<br style="clear: both;" />

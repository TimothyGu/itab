<%args>
	$event_id
	$codestart
	$sort_by
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);

	my @entries = $event->entries;

	@entries = sort {$a->school->name cmp $b->school->name} @entries if $sort_by eq "School" || $sort_by eq "Diocese" || $sort_by eq "Region";
	@entries = sort {$a->school->region->code cmp $b->school->region->code} @entries if $sort_by eq "Diocese";
	@entries = sort {length($a->school->region->code) <=> length($b->school->region->code)} @entries if $sort_by eq "Diocese";

	@entries = sort {$a->school->region->code cmp $b->school->region->code} @entries if $sort_by eq "Region";
	@entries = sort {length($a->school->region->code) <=> length($b->school->region->code)} @entries if $sort_by eq "Region";

	if ($sort_by eq "Initials") {

		my %used;

		foreach my $entry (@entries) { 

			my $code = $m->comp("/funclib/school_codename.mas", school => $entry->school);

			my $initials;
			my @students = $entry->students;

			if (scalar @students == 1 ) { 

				my $student = shift @students;

				$initials = uc(substr($student->first,0,1).substr($student->last,0,1));

				if ($used{$code." ".$initials}) { 
					$initials = ucfirst(susbtr($student->first,0,2).substr($student->last,0,2));
				}

				if ($used{$code." ".$initials}) { 
					$initials = "XX";
				}

				while ($used{$code." ".$initials}) { 
					$initials++;
				}

				$code = $code." ".$initials;

			} else { 

				foreach my $student (@students) { 
					$initials .= uc(substr($student->last,0,1));
				}

				if ($used{$code." ".$initials}) { 
					foreach my $student (@students) { 
						$initials .= ucfirst(substr($student->last,0,2));
					}
				}

				if ($used{$code." ".$initials}) { 
					$initials = "XX";
				}

				while ($used{$code." ".$initials}) { 
					$initials++;
				}

				$code = $code." ".$initials;

			}

			$entry->code($code);
			$entry->update;

		}

	} else { 
	
		if ($sort_by eq "Randomly") { 

			my $i = scalar(@entries);
			my $j;
			foreach my $item (@entries)
			{	 --$i;
				$j = int rand ($i+1);
				next if $i == $j;
				@entries [$i,$j] = @entries[$j,$i];
		   }
		}

		@entries = sort {$a->dropped <=> $b->dropped} @entries;

		my $codes = $event->setting("code_style");

		$event->setting("code_start", $codestart);
		$event->update;

		foreach my $entry (@entries) { 

			$codestart++ if $codestart == 69;
			$codestart++ if $codestart == 666;

			if ($codes eq "school_number") { 
				$entry->code($entry->school->code." ".$codestart) if ($codes eq "school_number");
			} else { 
				$entry->code($codestart);
			}

			$codestart++;
			$entry->update;
		}

	} 

	my $err = "Codes for ".$event->name." reshuffled by $sort_by";
	$m->redirect("/register/data/entry_recode.mhtml?err=$err");

</%init>

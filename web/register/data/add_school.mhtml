<%args>
	$tourn
	$err => undef
</%args>
<%init>

	my @schools = sort {ucfirst($a->name) cmp ucfirst($b->name)} $tourn->schools;

	my %used_schools = ();

	foreach my $school (@schools) {
		$used_schools{$school->chapter->id}++;
	}

	my @chapters;

	my %chapter_circuits = ();
	my %seen;

	foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 

		foreach my $chapter ($m->comp("/funclib/circuit_chapters.mas", circuit => $circuit)) {
			next if $used_schools{$chapter->id};
			next if $seen{$chapter->id};
			$seen{$chapter->id}++;
			$chapter_circuits{$chapter->id} .= ", " if $chapter_circuits{$chapter->id};
			$chapter_circuits{$chapter->id} .= $circuit->abbr;
			push (@chapters, $chapter);
		}
	}

	@chapters = sort {$a->name cmp $b->name} @chapters;
	
</%init>

	<& sidebar.mas, tourn => $tourn, whoami => "add_school" &>

	<div class="left huge">

		<h2>Add a school to <% $tourn->name %></h2>

		<table cellpadding="5" cellspacing="1">

			<tr>
				<td class="centeralign">
					Add new school:
				</td>
			</tr>

			<tr>
				<td class="centeralign">
				
					<form action="add_school_save.mhtml" method="post">

					<select name="chapter_id" size="15">

%						foreach my $chapter (@chapters) { 

%							my $name = substr($chapter->short_name,0,35);

%							foreach (length $name .. 35) { 
%								$name .= "&nbsp;";
%							}

    						<option value="<% $chapter->id %>">
								<% $name ." ". $chapter->state." "." (".$chapter_circuits{$chapter->id}.")" %>
							</option>
% 						}

					</select>

				</td>
			</tr> 
			
			
			<tr class="liblrow">
				<td class="rightalign">
					<input  type="submit" value="Add School">
					</form>
				</td>
			</tr>

		</table>

	</div>


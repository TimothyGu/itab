<%args>
	$circuit
	$tourn
</%args>
<%init>
	my $tourn_id = $tourn->id;

	#Make the directory, and clear out the crap

	`mkdir -p $Tab::file_root/tmp/tourn-$tourn_id`;
	`rm -f $Tab::file_root/tmp/tourn-$tourn_id/*.txt`;

	my @dioceses = Tab::Region->search( circuit => $circuit->id );

#	Diocese Codes.  Numerical ID from DB (which is canonical) and then
#   	the name of the diocese.

	open (DIOCODES, ">$Tab::file_root/tmp/tourn-$tourn_id/diocodes.txt");
	@dioceses = sort {$a->id <=> $b->id} @dioceses;
	foreach my $diocese (@dioceses) { 
		print DIOCODES $diocese->id.":".$diocese->name.":".$diocese->code;
		print DIOCODES "\r\n";

	}
	close DIOCODES;

	open (DIODIRS, ">$Tab::file_root/tmp/tourn-$tourn_id/diodirs.txt");

	foreach my $diocese (@dioceses) { 	
		print DIODIRS "Diocese: ".$diocese->id.": ".$diocese->code.": ".$diocese->name." \r\n";
		next unless $diocese->director;
		print DIODIRS "Name: ".$diocese->director->first." ".$diocese->director->last." \r\n";	
		print DIODIRS "Phone: ".$diocese->director->phone." ".($diocese->director->is_cell == 1) ? "Cell Phone " : "" . " \r\n";
		print DIODIRS "Hotel Info: ".$diocese->director->hotel." \r\n";
		print DIODIRS "\r\n";
	}

#	Diocese Schools.  The numerical Diocese code, plus the names of its member
#		schools.  

	open (DIOSCHOOLS, ">$Tab::file_root/tmp/tourn-$tourn_id/dio_schools.txt");
	my @schools;
	foreach my $diocese (@dioceses) { 
		my @dio_schools = Tab::School->search( region => $diocese->id, tournament => $tourn->id);
		foreach my $school (@dio_schools) {
			print DIOSCHOOLS $diocese->id.":".$school->name."\r\n";	
			push (@schools, $school);
		}
	}
	close DIOSCHOOLS;

#	Coaches.  These are the name credits that appear in the book.  Diocode, school
#		name, and then coach name. 

    open (COACHES, ">$Tab::file_root/tmp/tourn-$tourn_id/coaches.txt");
	foreach my $school (@schools) { 
		foreach my $coach ($school->chapter->credits) { 
			print COACHES $school->chapter->region($circuit)->id.":".$school->name.":".$coach->name."\r\n";
		}
	}
	close COACHES;

# 	Students.  this is a large file, but not a difficult one.  
#	Diocode, school, event, firstname, lastname, (partner firstname, partner lastname if team event).

    open (STUDENTS, ">$Tab::file_root/tmp/tourn-$tourn_id/students.txt");
	my @competitors = Tab::Entry->search( tournament => $tourn->id );
	foreach my $comp (@competitors) { 
		print STUDENTS $comp->code.":".$comp->school->region->id.":".$comp->school->name.":".$comp->event->name.":".$comp->student->first.":".$comp->student->last;
		print STUDENTS ":".$comp->partner->first.":".$comp->partner->last if ($comp->event->team == 2 && $comp->partner);
		print STUDENTS "\r\n";

	}
	close STUDENTS;

#  Judges.   Part 1 of a triology.
#  Diocode, school, group name, first name, last name. 

    open (JUDGES, ">$Tab::file_root/tmp/tourn-$tourn_id/judges.txt");
	my @judges = Tab::Judge->search( tournament => $tourn->id );
	foreach my $judge (@judges) { 
		print JUDGES $judge->code.":".$judge->school->region->id.":".$judge->school->name.":".$judge->judge_group->name.":".$judge->first.":".$judge->last.":";
		
		if ($judge->alt_group) { 
			print JUDGES $judge->alt_group->name;
		}
		print JUDGES ":",$judge->notes;

		my $pool = $judge->prelim_pool;

		print JUDGES ":".$pool->name if $pool;

		print JUDGES "\r\n";

	}
	close JUDGES;

#  Judge Quality Markers.   Part 2 of a triology.
#  Diocode, school,first name, last name, class name, qualification.

    open (JUDGEQUALS, ">$Tab::file_root/tmp/tourn-$tourn_id/judge_quals.txt");
	foreach my $judge (@judges) { 
		foreach my $jq ($judge->judge_classes) { 
			print JUDGEQUALS $judge->code.":".$judge->school->region->id.":".$judge->school->name.":".$judge->first.":".$judge->last;
			print JUDGEQUALS ":".$jq->class->name.":".$jq->qual->name."\r\n";
		}
	}
	close JUDGEQUALS;

#	Judge Elim Assignments.  Part 3 of a trilogy. 
#	Diocode, school, first name, last name, judge group, out round.

    open (JUDGEELIMS, ">$Tab::file_root/tmp/tourn-$tourn_id/outrounds.txt");
	foreach my $judge (@judges) { 
		foreach my $je ($judge->elim_pools) { 
			print JUDGEELIMS $judge->code.":".$judge->school->region->id.":".$judge->school->name.":".$judge->first.":".$judge->last;
			print JUDGEELIMS ":".$je->name."\r\n";
		}
	}
	close JUDGEELIMS;

#	Tab Room Preferences.  Part 4 of a ... trilogy.
#	Diocode, First name, Last name, 1st preference, 2nd preference, 3rd preference. 

    open (JUDGETABS, ">$Tab::file_root/tmp/tourn-$tourn_id/tabchoices.txt");
	foreach my $judge (@judges) { 
		next unless $judge->judge_group->name eq "Tab Room";
		print JUDGETABS $judge->school->region->id.":".$judge->school->name.":".$judge->first.":".$judge->last;
		print JUDGETABS ":".$judge->cfl_tab_first.":".$judge->cfl_tab_second.":".$judge->cfl_tab_third."\r\n";
	}
	close JUDGETABS;

	
</%init>

<h3>Export data files for <% $tourn->name %></h3>
<p align="center">All files are colon delimited</p>

<center>
<table width="90%" cellpadding="3">
<tr><td colspan="2"><tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/diocodes.txt">
	Dioceses
</a>)</td><td>
Lists numerical codes, Diocese names, Diocese codes
</p>
</td></tr>

<tr><td colspan="2"><tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
    (<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/diodirs.txt">
	Diocese Directors
</a>)</td><td>
	Lists directors, phone numbers and hotel information
</p>
</td></tr>

<tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/dio_schools.txt">
	Schools By Diocese
</a>)</td><td>
Lists Diocese numerical code,School name
</td></tr>

<tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/coaches.txt">
	Coaches by School
</a>)</td><td>
Lists Diocese number code, School name, and then Coach name for credit in the book
</td></tr>

<tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/students.txt">
	Student Entries
</a>)</td><td>
Lists Student code, Diocese number code, School name, Event, Student First, Student Last, Partner First, Partner Last. Partners are only listed in case of a two-person event.
</td></tr>

<tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/judges.txt">
	Judge Entries
</a>)</td>
<td>
Lists Judge code,Diocese number code, School name,  First name,  Last name, Judging Area,
Alternate Judging Area,Special Notes
</td></tr>

<tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/judge_quals.txt">
	Judge Qualifications
</a>)</td>
<td>
Lists Judge code, Diocese number code, School name,  First name,  Last name, Qualification Area, Qualification Letter
</td></tr>

<tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/outrounds.txt">
	Out Round Assignments
</a>)</td>
<td>
Lists Judge code, Diocese number code, School name,  First name,  Last name, Event Group, Out Round
</td></tr>

<tr><td colspan="2"><h4></h4></td>
<tr><td width="25%" valign="center">
	(<a href="<% $Tab::url_prefix %>/tmp/tourn-<% $tourn->id %>/tabchoices.txt">
	Tab Room Preferences
</a>)</td>
<td>
Lists Diocese number code, First name, Last name, 1st Choice, 2nd Choice, 3rd Choice
</td>
</tr>

<tr><td colspan="2"><h4></h4></td>


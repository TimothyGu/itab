<%args>
	$circuit
	$tourn
	$session
	$group_id
	$dome => undef
	$err => undef
	$debug => 1
</%args>
<%init>

	my $count;

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my @judges = $group->judges(active => 1);

	@judges = sort {$a->last cmp $b->last} @judges;

	my @ratings = $group->all_comp_ratings;

	my %ratings_by_comp_judge = ();

	foreach my $rating (@ratings) {
		$ratings_by_comp_judge{$rating->comp->id."-".$rating->judge->id} = $rating->qual->name;
	}

	my @strikes = $group->strikes;

	my %conflicts_by_comp = ();
	my %conflicts_by_school = ();

	foreach my $strike (@strikes) { 
		$conflicts_by_comp{$strike->comp->id."-".$strike->judge->id}++ if $strike->type eq "comp";
		$conflicts_by_school{$strike->school->id."-".$strike->judge->id}++ if $strike->type eq "school";
	}

	my @entries;

	my $tourn_id = $tourn->id;
	my $session_id = $session->id;

	open (EXPORT, ">$Tab::file_root/tmp/TRPC-MJP-".$group->id.".txt");

	foreach my $event ($group->events) { 

		foreach my $comp ($event->entries) { 

			next if $comp->school->noprefs;

			print EXPORT "-------------------------------------\r";

			print EXPORT "\$".$group->abbr." \*".$comp->code."    ".$comp->school->name."   ".$comp->team_name."\r\r";

			foreach my $judge (@judges) { 

				print EXPORT "\% ".$judge->code."\ \ \ ";
				print EXPORT "[";

				if ($conflicts_by_comp{$comp->id."-".$judge->id} || $conflicts_by_school{$comp->school->id."-".$judge->id} ) { 
					print EXPORT "6";
				} elsif ($ratings_by_comp_judge{$comp->id."-".$judge->id}) { 
					print EXPORT sprintf('%-1s',$ratings_by_comp_judge{$comp->id."-".$judge->id});
				} else {
					print EXPORT "1";
				}

				print EXPORT "]";
				print EXPORT " ".sprintf('%-30s',$judge->last.", ".$judge->first);
				print EXPORT $judge->school->name if $judge->school;
				print EXPORT "Tournament Hire" unless $judge->school;
				print EXPORT "\r";

			}

		}

	}

	close EXPORT;

	$m->redirect("$Tab::url_prefix/tmp/TRPC-MJP-".$group->id.".txt");

</%init>

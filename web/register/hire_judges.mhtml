<%args>
	$tourn
	$amount
	$school_id
	$group_id
</%args>
<%init>


	my @hires = Tab::JudgeHire->search( school => $school_id, judge_group => $group_id );


	my $hire;

	if (@hires) { 
	
		$hire = shift @hires;

	} else { 

		my $hire = Tab::JudgeHire->create({
			amount => 0,
			tournament	=> $tourn->id,
			judge_group => $group_id,
			school => $school_id });

	}

	my $already_hired = $hire->amount if $hire;
	my $difference = $amount - $already_hired;

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my $pool_size = $group->hired_pool;
	my $pool_already_hired = $group->hired_number;

	my $left = $pool_size - $pool_already_hired;

	my $err;


	$hire->amount($amount) if $difference < $left;
	$hire->amount($already_hired + $left) if $difference > $left;

	$err = "Judge pool limit reached: not all your hired judges came through" if $difference > $left;

	$hire->update;

	$m->redirect("$Tab::url_prefix/register/school_judges.mhtml?school_id=$school_id&err=$err");

</%init>



<%args>
	$league
	$tourn
	$school_id
	$err => undef
</%args>
<%init>

	$m->redirect("$Tab::url_prefix/register/registration.mhtml?school_id=$school_id&err=$err");


	my @schools = Tab::School->search(tournament => $tourn->id, { order_by => "name" });
	my $school = Tab::School->retrieve($school_id);
	my $sch_region = $school->chapter->region($league);
	my $sch_region_id;
	
	if ($sch_region) { 
	    $sch_region_id = $sch_region->id;
	} else {
		$sch_region_id = 0;
	}
		
	my @comps = $school->comps;
	my @judges = $school->judges;

    if ($tourn->method->judge_quality_system == 1) {
	    my @usable_judges;

        JUDGE:
        foreach my $judge (@judges) {

            foreach my $qual ($judge->quals) {
                push (@usable_judges, $judge) if $qual->useme;
                next JUDGE if $qual->useme;
            }

        }

        @judges = @usable_judges;
    }

	my @fines = $school->fines;
	my $paid_dues = $m->comp("/funclib/school_paid.mas", school_id => $school_id, tourn_id => $tourn->id, league => $league) if $league->track_dues;

	my @regions = $tourn->regions if ($league->region_based || $league->diocese_based);

</%init>

<p><font color="red"><% $err %> </font></p>

<table width="100%" cellpadding="5">

<tr>
<td valign="top" width="50%">

% my $membership = $school->chapter->full_member($league);

<h3><% $school->chapter->name %><% ($league->track_dues) ? ($paid_dues) ? ($membership)? "" :  " -has not paid dues" : "" : ""%></h3>

<table cellpadding="3" width="100%" border="0">
<form action="school_save.mas" method="post">
<input type="hidden" name="school_id" value="<% $school->id %>">
<tr>
<td>Name:</td>
<td><input type="text" name="name" value="<% $school->chapter->name %>" size="30"></td>

<td>
<input class="blue" type="submit" value="Save">
</td>


% if (@regions) { 
</tr>
<tr>
<td>
<% ($league->diocese_based) ? 'Dio: ' : 'Region: ' %>
</td>

<td>
<select name="region">

<option value="0">Select one</option>

%	foreach my $region (sort {$a->name cmp $b->name} @regions) { 
	<option value="<% $region->id %>"  <% ($region->id == $sch_region_id) ? 'selected' : '' %> ><% $region->name %></option>	
%	}

</select>
</td>
% }

</form>

<form action="drop_school.mas" method="post">
<input type="hidden" value="<% $school->id %>" name="school_id">
<td>
<input class="blue" type="submit" value="Drop">
</td>
</form>

</table>


</td>
<td valign="top">

<h3>See Another School:</h3>

<table width="100%">
<form action="school_view.mhtml" method="post">
<tr>
<td colspan="2">
<select name="school_id">
%foreach my $sch (@schools) { 
	<option value="<% $sch->id %>"
		<% ($sch->id == $school->id) ? "selected" : "" %>
		><% $sch->name %></option>
%} 
</select>
</td></tr>

<tr>
<td align="right">
<input class="blue" type="submit" value="View School">
</td>
</tr>
</form>
</table>

</td>
</tr>

<tr>
<td valign="top">

<table cellpadding="3" width="100%" border="0">
<tr><td colspan="4"><h3>Registration:</h3></td></tr>

<form action="register_save.mhtml" method="post">
<input type="hidden" value="<% $school_id %>" name="school_id">
<input type="hidden" name="from" value="school_view.mhtml"> 
<tr>
<th width="30%">Registered?</th>
<td align="right" colspan="1" align="left"><% ($school->registered) ? "YUP" : "NOPE" %>
</td>
<td colspan="2" align="right">
<input class="blue" type="submit" name="register" value="<% ($school->registered) ? "Deregister" : "Register"%>">
</td>

</form>

<tr>
<td colspan="2"><% scalar @comps %> students, <% scalar @judges %> judges</td>
<form action="entries.mhtml" method="post">
<input type="hidden" value="<% $school_id %>" name="school_id">
<td colspan="2" align="right"><input class="blue" type="submit" value="View/Change Entry"></td>
</form>
<tr>


<tr><td colspan="4"><h4>Printouts</h4></td></tr>

<tr>
<form action="reg_print.mas" method="post"> 
<input type="hidden" value="<% $school_id %>" name="school_id">
<td>Entry Master:</td>
<td><input class="blue" type="submit" name="print" value="Students">
</td><td align="center"><input class="blue" type="submit" name="print" value="Judges">
</td><td align="center"><input class="blue" type="submit" name="print" value="Both">
</td>
</form>
</tr>

<tr>
<form action="reg_print.mas" method="post"> 
<input type="hidden" value="<% $school_id %>" name="school_id">
<input type="hidden" value="secretive" name="no">
<td>Entry Master w/o assignments:</td>
<td><input class="blue" type="submit" name="print" value="Students">
</td><td align="center"><input class="blue" type="submit" name="print" value="Judges">
</td><td align="center"><input class="blue" type="submit" name="print" value="Both">
</td>
</form>
</tr>

<tr>
<td>Fees:</td>
<form action="school_invoice.mhtml" method="post">
<input type="hidden" value="<% $school_id %>" name="school_id">

<td align="center">
<input class="blue" type="submit" value="View" name="name">
</td>
</form>

<form action="invoice_print.mas" method="post">
<input type="hidden" value="<% $school_id %>" name="school_id">
<td align="center">
<input class="blue" type="submit" value="Receipt" name="name"></td>
<td align="center">
<input class="blue" type="submit" value="Invoice" name="name"></td>
</form>
</tr>

<tr>
<td colspan="4"><h4>Emails</h4></td>
</tr>

<tr>
<form action="email_registration.mhtml" method="post">
<input type="hidden" value="<% $school_id %>" name="school_id">
<td>Registration:</td>
<td colspan="3" align="right"><input class="blue" type="submit" value="Send"></td>
</form>

</table>

</td>

<td valign="top">

<table cellpadding="3" width="100%">
<tr><td colspan="3"><h3>Entry Fees:</h3></td></tr>

% my ($fee, $feline_ref) = $m->comp("/funclib/school_fees.mas", school_id => $school_id);

<td> Total fees: </td>
<td>$<% sprintf("%.2f", $fee) %></td>
</tr>

<form action="dues_save.mhtml" method="post">
<input type="hidden" name="school_id" value="<% $school->id %>">
<input type="hidden" name="from" value="school_view.mhtml"> 

<td> Amount paid: </td>
<td>$<input type="text" size="5" name="paid_amount" value="<% sprintf("%.2f", $school->paid_amount) %>"></td>
<td><input class="blue" type="submit" value="Save">
</tr>
</form>
<th> Due: </th>
<th>$<% sprintf("%.2f", $fee - $school->paid_amount) %></th>
</tr>


% if (@fines) { 

<tr><td colspan="4"><h4>Fines:</h4></td></tr>

</tr>

% foreach my $fine (@fines) { 

<tr>
<td> <% $fine->reason %></td>
<td>$<% $fine->amount %></td>
<form action="fine_forgive.mas" method="post">
<input type="hidden" value="<% $fine->id %>" name="fine_id">
<td><input class="blue" type="submit" value="Forgive"></td>
</tr>
</form>
% }

%} 

<tr><td><br></td></tr>
<tr><td colspan="5"><h4>Add fine: (use negative numbers for credits)</h4></td></tr>
<form action="fine_save.mas" method="post"> 
<input type="hidden" name="school_id" value="<% $school_id %>">
<td>Reason:
<input type="text" name="reason" size="15">
</td>
<td>
$<input type="text" name="amount" size="5">
</td>
<td align="right">
<input class="blue" type="submit" value="Add Fine">
</td>
</tr>
</form>
</table>

</td></tr>

<tr>
<td colspan="2"><h3>Contacts for <% $school->chapter->name %></h3></td></tr>

% if ($school->chapter) { 
% foreach my $coach ($school->chapter->coaches) {

<tr><td><% $coach->first." ".$coach->last %></td>
	<td><a href="mailto:<% $coach->email %>"><% $coach->email %></a></td>
</tr>


% } }

</table>

<%args>
	$circuit
	$tourn
	$session
	$school_id => undef
	$debug => undef
</%args>
<%init>

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);

    my $filename = "dance_cards-".$session->id;
    my $filepath = $Tab::file_root."/tmp/";
	system "/bin/rm -rf $filepath"."$filename.*";

	open (TEXOUT, ">>$filepath"."$filename.tex");

	print TEXOUT <<"EOF";

\\documentclass[10pt]{report}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{nopageno}
\\usepackage{fancyhdr,lastpage}
\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.75}

\\pagestyle{fancy}

\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}

\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

    
\\begin{document}

EOF

	close TEXOUT;

	my $now =  DateTime->now;
	$now->set_time_zone($circuit->timezone);

	my @students;
	my $over_school;

	if ($school_id) { 

		$over_school = Tab::School->retrieve($school_id);
		@students = $over_school->students if $over_school;
		@students = sort {$a->last cmp $b->last} @students;

	} else { 

		@students = $tourn->students;
		@students = sort {$a->last cmp $b->last} @students;
		@students = sort {$a->chapter->name cmp $b->chapter->name} @students;

	}

	foreach my $student (@students) { 

		my @comps = $student->entries($tourn);

		my $school = $student->chapter->school($tourn) unless $over_school;
		$school = $over_school if $over_school;

		open (TEXOUT, ">>$filepath"."$filename.tex");

		print TEXOUT "\\begin{flushright}\n";
		print TEXOUT "\\Huge\n";
		print TEXOUT "{\\bf ".Tab::texify($student->first." ".$student->last)."} \\\\ \n ";
		print TEXOUT "\\normalsize\n";
		print TEXOUT "\\end{flushright}\n \\begin{center}";

		print TEXOUT "\\begin{tabular}{p{.75in}p{2.25in}p{.75in}p{2.25in}} \n  ";
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\n";
		print TEXOUT "{\\bf School:} & ".  $school->name if $school;
		print TEXOUT " (".$school->code.") & " unless $circuit->diocese_based;
		print TEXOUT " (".$school->region->code.") & " if $circuit->diocese_based;
		print TEXOUT "{\\bf Tournament:} & ".Tab::texify($tourn->name)." \\\\ \n ";
		print TEXOUT "\\end{tabular} \n";
		print TEXOUT "\\bigskip\n";
		print TEXOUT "\\newline\n";

		my $congress;

		foreach my $comp (@comps) { 

			my @panels = $comp->panels;	
			@panels = sort {$a->round->timeslot->start->epoch <=> $b->round->timeslot->start->epoch} @panels;

		    print TEXOUT "\\begin{tabular}{p{.75in}p{1.0in}p{.75in}p{1.5in}p{1.75in}} \n";
			print TEXOUT "\\multicolumn{5}{l}{\\large Speaker ".$comp->code." in ".$comp->event->name." } \\\\ \\hline \n" if @panels;

			my $switch;

			foreach my $panel (@panels) {

				my $start = $panel->round->timeslot->start;
				$start->set_time_zone($circuit->timezone); 
		 
			 	$congress++ if $panel->event->type eq "congress"; 
			
				if ($panel->type eq "prelim") {

					print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\n" unless $switch++ % 2;
	
				} else { 
			
					print TEXOUT "\\rowcolor[rgb]{1,.94,.94}\n";
				}
		 
				print TEXOUT "{\\bf ".$panel->round->realname." }";
				print TEXOUT " & ";
				print TEXOUT $start->day_abbr." "  if scalar @days > 1;
				print TEXOUT $start->hour_12.":".$start->strftime("%M")." ";
				print TEXOUT $start->strftime("%p");
				print TEXOUT " & ";
				print TEXOUT "Sect: ".$panel->letter." & ";
				print TEXOUT "Room: ".Tab::texify($panel->room->name)." " if $panel->room;
				print TEXOUT " & ";
				print TEXOUT "Judges: ";

			 	foreach my $judge ($panel->judges) { 
					print TEXOUT Tab::texify($judge->code)." ";
				}
	
				 print TEXOUT "\\\\ \n";
			}	
      
			print TEXOUT "\\end{tabular}\n";
			print TEXOUT "\\bigskip\n";
			print TEXOUT "\\newline\n";

		}

		print TEXOUT "\\newpage\n";
	}

	print TEXOUT "\\end{center}\n";
	print TEXOUT "\\end{document}\n";
	close TEXOUT;

   	`cd $filepath; $Tab::latex_path $filename.tex;`;
   	`cd $filepath; $Tab::latex_path $filename.tex;`;
   	`cd $filepath; $Tab::dvipdfm_path $filename.dvi;`;
   	system "cd $filepath; /bin/rm -rf $filename.tex $filename.log $filename.dvi $filename.aux" unless $debug;
   	$m->redirect("$Tab::url_prefix/tmp/$filename.pdf");

</%init>

<div id="content">

<p><% $filename %></p>

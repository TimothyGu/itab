<%args>
	$tourn
	$session
	$account
	$method => undef
	$value => "AA"
</%args>


%	use Crypt::PasswdMD5;


%	unless ($method) { 


<h3>Scramble School Codes</h3>

<p>This script will permanently scramble school codes for your tournament only.
Use this to anonymize your school codes in some way for anonymity</p>

<center>
<table cellpadding="6" cellspacing="1" width="100%">


<tr class="evenrow">
<th>
	<form action="random_schoolcodes.mhtml">
	Input the starting value (A, AA, 100, etc):
</td>
<td>
	<input type="text" name="value" size="5">
</td>
</tr>

<td>
	Select a method to scramble codes:
</th>

<td>
	<select name="method">
		<option value="alpha">Alphabetically by School name</option>
		<option value="registration">In order of registration</option>
		<option value="random">Completely Randomly</option>
		<option value="semirandom">A SemiRandom Method That Will Always Come Out the Same Way</option>
		<option value="league">Restore league default school codes</option>
	</select>

</center>
<td>

<tr>

<tr class="bluerow">

	<td></td>

	<td><input class="blue" type="submit" value="Reset School Codes">
	</form>
	</td>


</tr>

</table>

%	} else { 


<%perl>

	my @schools;

	if ($method eq "alpha") { 

		@schools  = sort {$a->name cmp $b->name}  $tourn->schools;

	}

	if ($method eq "registration") { 

		@schools = sort {$a->id <=> $b->id} $tourn->schools;
	
	}

	if ($method eq "random") { 

		@schools = $tourn->schools;

		my $i = scalar(@schools);
		my $j;
       	foreach my $item (@schools) {    
			--$i;
           	$j = int rand ($i+1);
           	next if $i == $j;
           	@schools [$i,$j] = @schools[$j,$i];
    	}
	}

	if ($method eq "semirandom") { 

		my $salthash = $tourn->reg_start->epoch;
		@schools = sort {unix_md5_crypt($a->name, $salthash) cmp unix_md5_crypt($b->name, $salthash)} $tourn->schools;

	}

	if ($method eq "league") { 

		foreach my $school ($tourn->schools) {

			Tab::Comp->set_sql( recodeback => "
				update school,chapter_league,tournament
				set school.code = chapter_league.code
				where school.tournament = ".$tourn->id."
				and school.tournament = tournament.id
				and school.chapter = chapter_league.chapter
				and chapter_league.league = tournament.league");

			Tab::Comp->sql_recodeback->execute;

		}

	} else { 
		
		$value = "AA" unless $value;

	
		foreach my $school (@schools) {

			$value++ if $value eq 69;
			$value++ if $value eq 666;

			$school->code($value);
			$school->update;
			$value++;
		}

	}


	my $err = "Schools have been recoded.";

	$m->redirect("$Tab::url_prefix/register/list_schools.mhtml?err=$err");

}

</%perl>


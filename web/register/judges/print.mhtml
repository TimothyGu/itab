<%args>
	$circuit
	$tourn
	$account
	$session
	$group_id => 0
	$sort_by => "last"
</%args>
<%init>

	my @groups = $tourn->groups unless $group_id;
	push (@groups, Tab::JudgeGroup->retrieve($group_id)) if $group_id;

	my @judges;
	foreach (@groups) {  
		push(@judges, $_->judges); 
	} 

    @judges = sort {$a->last cmp $b->last} @judges;
    @judges = sort {$a->code cmp $b->code} @judges unless $sort_by eq "last";
    @judges = sort {$a->school->name cmp $b->school->name} @judges if $sort_by eq "schname";
    @judges = sort {$a->region->name cmp $b->region->name} @judges if $sort_by eq "regname";
    @judges = sort {$a->region->code cmp $b->region->code} @judges if $sort_by eq "regcode";
    @judges = sort {$a->prelim_pool->name cmp $b->prelim_pool->name} @judges if $sort_by eq "prelim_pool";
    @judges = sort {$a->judge_group->abbr cmp $b->judge_group->abbr} @judges;

	my $filename = $Tab::file_root."/tmp/judgemaster-".$tourn->id."-".$session->id;
	my $garbage = `rm -f $filename.*`;
	
	open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";
\\documentclass[10pt]{report}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage[hmargin=1in,vmargin=1in]{geometry}
\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.3}
\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}

\\begin{document}

EOF

	print TEXOUT "{\\LARGE ". &Tab::texify($tourn->name) ." Judge Master List } Sorted: ".&Tab::texify($sort_by)." \\\\ \n";

	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{.3in}p{.3in}p{1.25in}p{1.0in}p{3in}p{.3in}";
	print TEXOUT "p{1.0in}p{.5in}" if $circuit->diocese_based;
	print TEXOUT "}\n";
	print TEXOUT "\\multicolumn{5}{l}{\\large}\\\\\n";
	print TEXOUT "Div & Code & Last & First &";
	print TEXOUT " School & SCode \\\\ \n" unless $circuit->diocese_based;
	print TEXOUT "Diocese & DCode & Prelim & Elims \\\\ \n  " if $circuit->diocese_based;
	print TEXOUT "\\hline \n";
	print TEXOUT "\\end{tabular}\n\\\\ \n";

	my $switch; 

foreach my $judge (@judges) { 

	print TEXOUT "\\begin{tabular}{p{.3in}p{.3in}p{1.25in}p{1.0in}p{3in}p{.3in}";
	print TEXOUT "p{1.0in}p{.5in}" if $circuit->diocese_based;
	print TEXOUT "}\n";

	print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\n" if ($switch++ % 2);

	print TEXOUT &Tab::texify($judge->judge_group->abbr)." & ";
	print TEXOUT &Tab::texify($judge->code)." & ";
	print TEXOUT &Tab::texify($judge->last)." & ";
	print TEXOUT &Tab::texify($judge->first)." & ";

	if ($circuit->diocese_based) { 
		print TEXOUT &Tab::texify($judge->region->name)." & ". &Tab::texify($judge->region->code)." & " if $judge->region->id;
		print TEXOUT " Hired & --  " unless $judge->region->id;

		print TEXOUT &Tab::texify($judge->prelim_pool->name)." & " if $judge->prelim_pool;
		print TEXOUT &Tab::texify($judge->judge_group->abbr)." & " unless $judge->prelim_pool;

		foreach my $elim_group ($judge->elim_group) {
			 print TEXOUT &Tab::texify($elim_group->abbr)
		}
		
	} else { 
		print TEXOUT &Tab::texify($judge->school->name)." & ". &Tab::texify($judge->school->code) if $judge->school->id;
		print TEXOUT " Hired & -- " unless $judge->school->id;
	}

	print TEXOUT "\\\\ \n";
	print TEXOUT "\\end{tabular}\n \\newline \n";
}

	print TEXOUT "\\end{document}\n";
	close TEXOUT;


$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
`rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;
my $tourn_id = $tourn->id;
$m->redirect("$Tab::url_prefix/tmp/judgemaster-$tourn_id-".$session->id.".pdf");

</%init>

<div id="content">

<p><% $filename %></p>

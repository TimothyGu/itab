<%args>
	$league
	$tourn
	$account
	$session
	$event_id => 0
	$sort_by => "code"
	$school_id => undef
</%args>
<%init>

	my $chapter_id;
	my $school;

	if ($school_id) { 
		$school = Tab::School->retrieve($school_id);
		$chapter_id = $school->chapter->id;
	}

	my $filename = $Tab::file_root."/tmp/housing-".$tourn->id."-".$session->id;
	my $garbage = `rm -f $filename.*`;

	open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";	
		\\documentclass[10pt]{report}
		\\usepackage{fullpage}
		\\usepackage{helvet}
		\\usepackage{colortbl}
		\\usepackage[hmargin=1in,vmargin=1in]{geometry}
		\\renewcommand{\\familydefault}{\\sfdefault}
		\\renewcommand{\\arraystretch}{1.3}
		\\addtolength{\\textwidth}{1in}
		\\addtolength{\\hoffset}{-.3in}
		\\begin{document}
EOF

	my $switch;

	my @days = $tourn->days;
	my $day_before = $days[0]->clone;
	$day_before->subtract( days => 1);
	push (@days, $day_before);

	my $notfirst;

	foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

		my @reqs = Tab::Housing->search( night => $day->ymd, tournament => $tourn->id );
		next unless @reqs;

		print TEXOUT "\\newpage\n" if $notfirst;
		$notfirst++;

		print TEXOUT "\\begin{center}\n";
		print TEXOUT "\\Large Confirmed housing for ".$school->name.": ".Tab::nicedate($day)."\\\\ \n" if $school;
		print TEXOUT "\\Large Housing for ".$tourn->name.": ".Tab::nicedate($day)."\\\\ \n" unless $school;
		print TEXOUT "\\end{center}\n";
		print TEXOUT "\\normalsize\n";

		REQ:
		foreach my $request (sort {$a->requested->epoch <=> $b->requested->epoch} @reqs) {

			if ($request->student) { 

				my $student = $request->student;

				if ($chapter_id) { 
					next REQ if $student->chapter->id != $chapter_id;
					next REQ if $request->waitlist;
				}

				my @entries = $student->entries($tourn);

				my $yes;
				foreach my $entry (@entries) { 
					$yes++ unless $entry->waitlist || $entry->dropped;
				}

				next unless $yes;

				my $date = $request->requested;
				$date->set_time_zone($tourn->league->timezone);

				print TEXOUT "\\begin{tabular}{p{1.5in}p{.5in}p{.5in}p{1.5in}p{1.5in}p{.25in}p{.25in}}\n";
				print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

				print TEXOUT $student->first." ".$student->last." & ";
				print TEXOUT "Student & ";

				my $school;
	
				foreach my $entry (@entries) { 
					print TEXOUT $entry->event->abbr." ";
					$school = $entry->school;
				}

				print TEXOUT " & ".$school->name." & ";
				print TEXOUT $date->mdy." ".$date->hms." & ";
				print TEXOUT $student->gender." & ";
				print TEXOUT "WL" if $request->waitlist;
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";
				print TEXOUT "\\newline\n";

	
			} else {

				my $judge = $request->judge;

				if ($school_id) { 
					next REQ if $request->waitlist;
					next REQ if $judge->school->id != $school_id;
				}

				my $date = $request->requested;
				$date->set_time_zone($tourn->league->timezone);

				print TEXOUT "\\begin{tabular}{p{1.5in}p{.5in}p{.5in}p{1.5in}p{1.5in}p{.25in}p{.25in}}\n";
				print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

				print TEXOUT $judge->first." ".$judge->last." & ";
				print TEXOUT "Judge & ";

				print TEXOUT $judge->judge_group->abbr." & ";
				print TEXOUT $judge->school->name." & ";
				print TEXOUT $date->mdy." ".$date->hms." & ";
				print TEXOUT $judge->gender." & ";
				print TEXOUT "YES" if $request->waitlist;
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";
				print TEXOUT "\\newline\n";

			}

		}

	}

	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
	
#	`rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;

	$m->redirect("$Tab::url_prefix/tmp/housing-".$tourn->id."-".$session->id.".pdf");

</%init>

<%args>
	$circuit
	$tourn
	$chapter_id => undef
	$name => undef
	$school_id => undef;
	$region => undef;
	$code => 0; 
</%args>

<%init>
#/
	my $err;

	$name =~ s/&/and/g;
	my $school;

	if ($school_id) { 

		$school = Tab::School->retrieve($school_id);
		
		my $chapter = $school->chapter;

		$school->name($name) if $name;
		$school->code($code);

		$school->update;

		$chapter->name($name);
		$chapter->update;

		$err = "School $name has been updated";
		$m->redirect("$Tab::url_prefix/register/registration.mhtml?err=$err&school_id=$school_id");

	} else  { 
	
		my $chapter = Tab::Chapter->retrieve($chapter_id);
		my @already = Tab::School->search( chapter => $chapter_id, tournament => $tourn->id);

		my $chapter_region = $chapter->region($circuit);
		my $chapter_region_id = $chapter_region->id if $chapter_region;
		
		unless (@already) { 

	        my $school_code;

			if ($tourn->method->incremental_school_codes) {
            	my $highest_code = Tab::School->sql_highest_code->select_val($tourn->id);
            	$highest_code = $tourn->method->first_school_code unless $highest_code;
            	$highest_code++;
            	$school_code = $highest_code;
	        } else {
    	        $school_code = $chapter->code($tourn->circuit)
	        }

			$school_code = 0 unless $school_code;
	
			$school = Tab::School->create({
				chapter => $chapter->id,
				tournament => $tourn->id,
				name => $chapter->name,
				region => $chapter_region_id,
				code => $school_code,
			});
		 
		$school_id = $school->id;
		$err = "School $name has been added";

		}

	}

	$school->region($region) if $region;
	$school->update if $region;

	$m->redirect("$Tab::url_prefix/register/registration.mhtml?err=$err");


</%init>

<%args>
	$account
	$uber_id => undef
	$school_id 
	$group_id
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my $school = Tab::School->retrieve($school_id);

	unless ($uber_id) {

		my $err = "You did not select a judge from the list.  Please try again";
		$m->redirect("$Tab::url_prefix/user/tourn/entry/judges.mhtml?school_id=$school_id&group_id=".$group->id."&err=".$err);

	}

	my $uber = Tab::Uber->retrieve($uber_id);

	my $tourn = $school->tournament;

	$m->print($tourn->id);

	if ($uber->judge($tourn)) {
		my $err = "Judges may not judge in the same tournament twice.  Contact the tournament director if you need some accomodation.";
		$m->redirect("$Tab::url_prefix/user/tourn/entry/judges.mhtml?school_id=$school_id&group_id=".$group->id."&err=".$err);
	}

	my $now = DateTime->now;

	my $first_year = 0;

	$first_year++ if $uber->started && $uber->started == $now->year;

	my $judge = Tab::Judge->create({
		school => $school->id,
		judge_group => $group->id,
		notes => $uber->notes,
		first => $uber->first,
		last => $uber->last,
		cell => $uber->cell,
		tournament => $group->tournament->id,
		gender => $uber->gender,
		paradigm => $uber->paradigm,
		active => 1,
		uber => $uber->id,
		code => $group->next_code,
		first_year => $first_year
	});

	if ($tourn->method->track_reg_changes) {

		my $regline = $account->first." ".$account->last." entered ".$group->abbr." 
					judge $judge->code (".$judge->first." ".$judge->last.")";

		my $change = Tab::Change->create({
			tournament => $tourn->id,
			school => $school->id,
			type => "registration",
			regline => $regline
		});

	}

	if ( ($tourn->method->judge_cells &! $uber->cell) || $group->coach_ratings 
			|| $group->ask_alts || ($group->ask_paradigm &! $judge->paradigm) ) { 

		$m->redirect("judge_details.mhtml?judge_id=".$judge->id."&school_id=".$school->id);

	} else { 

		$m->redirect("school_judges.mhtml?school_id=$school_id&group_id=".$group->id);

	}

</%init>

<%args>
	$tourn
</%args>
<%init>

	Tab::Judge->set_sql( preffed_by_school => "
		select distinct judge.*
		from judge, rating, entry
		where judge.id = rating.judge
		and rating.entry =  entry.id
		and entry.school = ? 
	");

	my @pref_groups;
	my %group_schools = ();

	foreach my $group ($tourn->groups) { 

		if ($group->setting('prefs')) { 

			push (@pref_groups, $group);

			foreach my $school ($m->comp("/funclib/group_schools.mas", group => $group)) { 
				$group_schools{$school->id."-".$group->id}++;
				$group_schools{$school->id}++;
			}

		}

	}


</%init>

	<& "menu.mas", tourn => $tourn, whoami => "prefs" &>

	<div class="left huge">

		<& /funclib/tablesorter.mas, table => "sortme" &>

		<h2>Pref status</h2>

		<table cellpadding="4" cellspacing="1" id="sortme">

			<thead>

				<tr class="yellowrow">

					<th class="smaller">
						School
					</th>

%					foreach my $group (@pref_groups) { 
						<th class="smaller">
							<% $group->abbr %>
						</th>
%					} 

				</tr>

			</thead>

			<tbody>

%				foreach my $school (sort {$a->name cmp $b->name} $tourn->schools) { 

%					next unless $group_schools{$school->id};
%					my @judges = Tab::Judge->search_preffed_by_school($school->id);

%					my %jp_by_group = ();
%					foreach my $judge (@judges) { 
%						push (@{$jp_by_group{$judge->judge_group->id}}, $judge);
%					}

					<tr>

						<td class="smallish">
							<% $school->short_name %>
						</td>

%						foreach my $group (@pref_groups) { 
							<td class="smallish centeralign">

%								if ($group_schools{$school->id."-".$group->id}) { 
									<% $jp_by_group{$group->id} ? scalar @{$jp_by_group{$group->id}} : "0"%>
%								} else { 
									x
%								} 

							</td>
%						} 

					</tr>

%				}

			</tbody>

		</table>

	</div>


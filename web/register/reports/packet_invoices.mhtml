<%args>
	$tourn
	$session
	$fees => undef
	$concessions => undef
</%args>
<%init>

    my $name = $tourn->name;
    $name =~ s/[\W_]//g;

    my $filename = "AllInvoices-".$name."-".$session->id;
    $filename = "ConcessionsInvoices-".$name."-".$session->id if $concessions;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`;

    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1 );

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz);

	my @schools = sort { $a->name cmp $b->name } $tourn->schools;

	foreach my $school (@schools) { 

		unless ($fees || $concessions) { 
		    $m->comp("/register/school/print/combined.mas", school => $school,  filename => $filename);
		}

		if ($fees) { 
		    $m->comp("/register/school/print/fees.mas", school => $school,  filename => $filename);
		} 

		if ($concessions) { 
		    $m->comp("/register/school/print/concessions.mas", school => $school,  filename => $filename);
		}

		open (TEXOUT, ">>$filepath.tex");
		print TEXOUT "\\newpage\n"; 
		close TEXOUT;

	}

    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );

</%init>


<%args>
	$account    => undef
	$chapter    => undef
	$chapter_id
	$year       => undef
	$circuit_id => undef	
</%args>
<%init>

	use Time::HiRes qw( time );
	my $code_start = time(); 
	Tab::debuglog("CODE STARTS");
		
	$chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($year) { 
		my $this_year = Tab::school_year;
		$year = $this_year->year;
	}

	my $start_string = "07/01/$year";
	my $end_string = "06/30/".($year + 1);

	my $start_dt = Tab::dtme($start_string);	
	my $end_dt = Tab::dtme($end_string);	

	my $code_end = time(); Tab::debuglog("Time before first pull ".sprintf("%.2f", $code_end-$code_start) );

	#Load results

	Tab::ResultValue->columns(TEMP => qw/event_name/);	
	Tab::ResultValue->columns(TEMP => qw/tourn_name/);	
	Tab::ResultValue->columns(TEMP => qw/entry_name/);		
	Tab::ResultValue->columns(TEMP => qw/rank/);		
	Tab::ResultValue->set_sql(pull_results => "
		select result_value.*, event.name as event_name, entry.name as entry_name, tourn.name as tourn_name, result.rank as rank
		from entry, school, event, tourn, result_set, result_value, result
		where entry.school=school.id
		and school.chapter = $chapter_id
		and result.entry=entry.id
		and event.id=entry.event
		and tourn.id=entry.tourn
		and result_set.tourn=tourn.id
		and result.result_set=result_set.id
		and result_value.result=result.id
		and tourn.start >= '$start_dt'
		and tourn.end <=  '$end_dt'
		and result_set.label='Final Places'
		and result_value.tag='Place'
		order by rank asc
	");
	
	my @chpt_result = Tab::ResultValue->search_pull_results;
	
	$code_end = time(); Tab::debuglog("Time AFTER first pull ".sprintf("%.2f", $code_end-$code_start) );
	
</%init>

	<& menu.mas, circuit_id => $circuit_id, year => $year &>
	
	<div class="left huge">
	
		<h2>Seasonal Results for <% $chapter->name %></h2>

		Reults only appear if the tournament director has published final results.
		
		<& /funclib/tablesorter.mas, table => "sortme" &>

		<table cellpadding="4" id="sortme">

			<thead>
				<tr class="yellowrow">
					<th class="smallish">
						Tourney
					</th>
					<th class="smallish">
						Event
					</th>
					<th class="smallish">
						Entry
					</th>
					<th class="smallish">
						Finish
					</th>
					<th class="smallish">
						Rank
					</th>
				</tr>
				</tr>
			</thead>

			<tbody>

%				foreach my $result (@chpt_result) {				
				<tr>
					<td> <% $result->tourn_name  %> </td>
					<td> <% $result->event_name  %> </td>
					<td> <% $result->entry_name  %> </td>
					<td> <% $result->value  %> </td>						
					<td> <% $result->rank  %> </td>											
				</tr>
%				}					
			</tbody>

		</table>

	</div>

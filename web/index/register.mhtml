<%args>
	$tourn_id
	$session => undef
	$account => undef
</%args>
<%init>

	my $tourn = Tab::Tourn->retrieve($tourn_id);

	if ($account && $session) { 

	    my @chapters = $account->chapters;
	    my $chapter = shift @chapters if scalar @chapters == 1;	

		unless ($chapter) { 

			my $err = "You have several chapters; choose one please and register for ".$tourn->name;

			$m->redirect("/user/home.mhtml?err=$err");

		}

		my @membership = Tab::ChapterCircuit->search( 
					chapter => $chapter->id, 
					circuit => $tourn->circuit->id );

		unless (@membership) { 

			my $membership = Tab::ChapterCircuit->create({
				active => 1,
				full_member => 0,
				circuit => $tourn->circuit->id,
				chapter => $chapter->id
			});

		}

		$session->tournament($tourn_id);
		$session->circuit($tourn->circuit->id);
		$m->redirect("/user/tourn/enter.mhtml?tourn_id=".$tourn->id."&chapter_id=".$chapter->id);

	} else { 

		$m->redirect("/user/login/login.mhtml?tourn_id=$tourn_id");

	}

</%init>

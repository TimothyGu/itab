<%args>
	$account
	$country => undef
	$state => undef
	$month => undef
	$year => undef
</%args>
<%init>

	my $now = DateTime->now;
	my $end = $now->clone;
	my $start = $now->clone;

	my $limit;

	my %search_hash = ( hidden => {'!=', 1 });

	if ($month && $year) { 

		$start = $now->clone;
		$start->set(day => 1, year => $year, month => $month);
		$end->set(day => 1, year => $year, month => $month);

		$end->set_day(1)->add( months => 1 )->subtract( days => 1 ); #last day of month

		$search_hash{"start"} = { '>',  DateTime::Format::MySQL->format_datetime($start) };
		$search_hash{"end"} = { '<',  DateTime::Format::MySQL->format_datetime($end) };

	} elsif ($month) { 

		$year = $now->year;

		$start = $now->clone;
		$start->set(day => 1, month => $month);
		$end->set(day => 1, month => $month);
		$end->set_day(1)->add( months => 1 )->subtract( days => 1 ); #last day of month

		$search_hash{"start"} = { '>',  DateTime::Format::MySQL->format_datetime($start) };
		$search_hash{"end"} = { '<',  DateTime::Format::MySQL->format_datetime($end) };

	} elsif ($year) { 

		$limit++;
		$start = $now->clone;
		$month = 1; 

		$start->set(day => 1, year => $year);
		$end->set(month => 12, year => $year);
		$end->set_day(1)->add( months => 1 )->subtract( days => 1 ); #last day of month

		$search_hash{"start"} = { '>',  DateTime::Format::MySQL->format_datetime($start) };
		$search_hash{"end"} = { '<',  DateTime::Format::MySQL->format_datetime($end) };

	} else { 

		$limit++;
		$end->subtract(days => 1);
		$search_hash{"end"} = { '>',  DateTime::Format::MySQL->format_datetime($end) };

	}

	if ($state) { 
		$search_hash{"state"} = $state;
	}

	if ($country) { 
		$search_hash{"country"} = $country;
	}

	my %search_attrs = (  order_by => "name" );
	$search_attrs{"limit"} = "40" if $limit;

	my @tourns  = Tab::Tourn->search_where(\%search_hash);

</%init>

	<div class="huge left">

		<h2> 

%		if ($year) { 
			<% scalar @tourns %> Tournaments in <% $month %>/<% $year %>
%		} else {
			Upcoming Tournaments
%		}

%		if ($state || $country) { 
			in <% $state %><% $country %>
%		}

		</h2>

		<table cellpadding="5" width="100%" style="font-size: 90%">  

			<tr class="dkgreen">
			
				<th class="smaller">
					Dates
				</th>

				<th class="smaller">
					Circuits
				</th>

				<th class="smaller">
					Tournament
				</th>

				<th class="smaller">
					Locale
				</th>

				<th class="smaller">
					Register
				</th>

			</tr>

%			foreach my $tourn (sort {$a->start->epoch <=> $b->start->epoch} @tourns) { 

%       	    my $open++ if ($tourn->reg_start && $tourn->reg_end && $tourn->reg_start->epoch < $now->epoch && 
%								$tourn->reg_end->epoch > $now->epoch);
	
				<tr class="<% ($open) ? "yellowrow" : "evenrow" %>">

					<td class="centeralign" style="width: 5.5em;">
						<% Tab::niceshortdate($tourn->start) %><% ($tourn->start->day != $tourn->end->day) ? "-".Tab::niceshortdate($tourn->end) : "" %>
					</td>

					<td class="centeralign">
%						foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 
							<% $circuit->abbr %>
%						}
					</td>

					<td width="375">
						<a class="nowrap white block" style="width: 350px;" href="tourn/index.mhtml?tourn_id=<% $tourn->id %>">
							<% $tourn->name %>
						</a>
					</td>

					<td class="centeralign">
						<% $tourn->location %> 
					</td>

					<td class="centeralign">
						<% ($open) ? "by ".Tab::niceshortdate($tourn->reg_end) : "" %>
						<% $tourn->reg_start > $now ? "Open ".Tab::niceshortdate($tourn->reg_start) : ""%>
						<% $tourn->reg_end < $now ? "Closed ".Tab::niceshortdate($tourn->reg_end) : ""%>
					</td>
			
				</tr>

%			}

			</table>

	</div>

	<div class="small right">

		<div class="sidenote">

			<h4>Search by Dates</h4>

			<form action="index.mhtml#default" method="post">
			<input type="hidden" name="state" value="<% $state%>">
			<input type="hidden" name="country" value="<% $country%>">

			<span class="halfblock plain">
				M: <select name="month" onchange='this.form.submit()'>
				<option value=""></option>
%				foreach my $amonth (1 .. 12) { 
					<option value="<%$amonth %>" <% $month == $amonth ? 'selected' : "" %>>
						<% $amonth %>
					</option>
%				}
				</select>
			</span>

			<span class="halfblock plain">
				Y: <select name="year" onchange='this.form.submit()'>
				<option value=""></option>
%				my $ayear;
%				for ($ayear = $now->year + 1, $ayear >= 1995, $ayear--) { 
					<option value="<% $ayear %>" <% $month == $ayear ? 'selected' : "" %>>
						<% $ayear %>
					</option>
%					$ayear--;
%				}
				</select>
			</span>

		</div>

<%perl>

	my $dbh = Tab::DBI->db_Main();
	my $sth = $dbh->prepare("select distinct state from tourn order by state");
	$sth->execute();
	my $state_one = $sth->fetchrow_array();  #this line looks totally unnecessary but evidently is.  I can't explain it.

	my $cth = $dbh->prepare("select distinct country from tourn order by country");
	$cth->execute();
	my @countries = @{$cth->fetchrow_arrayref()};  #this line looks totally unnecessary but evidently is.  I can't explain it.

</%perl>


		<div class="sidenote">

			<h4>Locations</h4>

			<a class="yellow block" href="index.mhtml?year=<% $year %>&month=<% $month %>#default">
				All Locations
			</a>

			<h4>Countries</h4>

%			while( my $acountry = $cth->fetchrow_array() ) { 
				<a class="<% $country eq $acountry ? "dk" : "" %>blue block" href="index.mhtml?country=<% $acountry %>&year=<% $year %>&month=<% $month %>#default">
					<% $acountry %>
				</a>
%			}

			<h4>States/Provinces</h4>

%			while( my ($astate) = $sth->fetchrow_array() ) { 
%				next unless $astate;
				<a class="<% $state eq $astate ? "dk" : "" %>blue halfblock" href="index.mhtml?state=<% $astate %>&year=<% $year %>&month=<% $month %>#default">
					<% $astate %>
				</a>
%			}

%			$sth->finish;
%			$cth->finish;

		</div>

	</div>

	<br style="clear: both;">


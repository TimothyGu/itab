<%args>
	$tourn_id
	$account => undef
	$round_id => undef
	$event_id => undef
</%args>
<%init>

	my $tourn =  Tab::Tourn->retrieve($tourn_id);

	my $tz =  $account->tz if $account;
	$tz = $tourn->tz unless $tz;

    my @rounds = $m->comp('/funclib/tourn_round_results.mas', tourn => $tourn);
    my @results = $m->comp('/funclib/tourn_result_sets.mas', tourn => $tourn);
    my @files = $m->comp("/funclib/tourn_result_files.mas", tourn => $tourn); 
    my @events = sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_events.mas", tourn => $tourn);

    #uniq 
    my %seen = (); 
    @rounds = grep { ! $seen{$_->id} ++ } @rounds;

    my %event_rounds;
    my %event_results;
    my %event_files;

    foreach my $round (@rounds) { 
        push @{$event_rounds{$round->event->id}}, $round;
    }   

    foreach my $result (@results) { 
        push @{$event_results{$result->event->id}}, $result;
    }   

    foreach my $file (@files) { 
        push @{$event_files{$file->event->id}}, $file;
    }   

	foreach my $all_event (@events) { 
		next unless $event_files{$all_event->id} || $event_rounds{$all_event->id} || $event_results{$all_event->id} || $all_event->setting("live_updates");
		$event_id = $all_event->id unless $event_id;
	}

	my $current;

	foreach my $round (@{$event_rounds{$event_id}}) { 
		if ($current < $round->name) { 
			$round_id = $round->id;
			$current = $round->name;
		}
	}

	my $event =  Tab::Event->retrieve($event_id) if $event_id;

	my $result_set = Tab::ResultSet->search(label => "Final Places", event => $event_id)->first if $event && $event->setting("results_published");

    my $webpage = Tab::Webpage->search( tourn => $tourn_id, special => "postings")->first;

	my $switch;

</%init>

	<div class="left huge">

		<span class="hugespan">
			<h2>
				<% $tourn->name %> 
			</h2>
		</span>

		<span class="medspan" style="vertical-align: top;">
			<h4 style="text-align: right;">
				<% $tourn->location %>  
			</h4>
		</span>

		<br style="clear: both;">

        <& ../tourn_header.mas, tourn => $tourn, account => $account &>

%		my $round = Tab::Round->retrieve($round_id) if $round_id;

%		if ($result_set) { 

%			$m->redirect("/index/tourn/results/event_results.mhtml?tourn_id=".$tourn->id."&result_id=".$result_set->id);

%		} elsif ($round) { 

%			$m->redirect("/index/tourn/results/round_results.mhtml?tourn_id=".$tourn->id."&round_id=".$round->id);

%		} elsif ($webpage) { 

			<p>
				<% $webpage->content %>
			</p>

%		} 

	</div>

	<& sidebar.mas, tourn_id => $tourn_id, event_id => $event_id, round_id => $round_id &>


<%args>
	$tourn_id => undef
	$search_date => undef
	$search_location => undef
	$search_name => undef
</%args>
<%init>

	my $now = DateTime->now;

	if ($search_date) { 

		$date_dt = Tab::dateme($search_date);

		$start_search = $date_dt->subtract( weeks => 2 );
		$end_search = $date_dt->add( weeks => 2 );
		
		my $start_string = DateTime::Format::MySQL->format_date($start_search);
		my $end_string = DateTime::Format::MySQL->format_date($end_search);

		Tab::Tourn->set_sql(by_results_published => "
			select distinct tourn.*
			from tourn,tourn_setting
			where tourn.id = tourn_setting.tourn
			and tourn_setting.tag = \"results\"
			and tourn_setting.value = 1
			and tourn.hidden != 1
			and tourn.approved = 1
			and tourn.start > ?
			and tourn.end < ?
			order by tourn.start DESC
			limit 40 
		");

		@published = Tab::Tourn->search_by_results_published($start_string, $end_string);

	} elsif ($search_location) { 

		$search_location = "%$search_location%";

		Tab::Tourn->set_sql(by_results_published => "
			select distinct tourn.*
			from tourn,tourn_setting
			where tourn.id = tourn_setting.tourn
			and tourn_setting.tag = \"results\"
			and tourn_setting.value = 1
			and tourn.hidden != 1
			and tourn.approved = 1
			and tourn.location like ?
			order by tourn.start DESC
			limit 40 
		");

		@published = Tab::Tourn->search_by_results_published($search_location);

	} elsif ($search_name) { 

		$search_name = $search_name."%";

		Tab::Tourn->set_sql(by_results_published => "
			select distinct tourn.*
			from tourn,tourn_setting
			where tourn.id = tourn_setting.tourn
			and tourn_setting.tag = \"results\"
			and tourn_setting.value = 1
			and tourn.hidden != 1
			and tourn.approved = 1
			and tourn.name like ?
			order by tourn.start DESC
			limit 40 
		");

		@published = Tab::Tourn->search_by_results_published($search_name);

	} else { 

		Tab::Tourn->set_sql(by_results_published => "
			select distinct tourn.*
			from tourn,tourn_setting
			where tourn.id = tourn_setting.tourn
			and tourn_setting.tag = \"results\"
			and tourn_setting.value = 1
			and tourn.hidden != 1
			and tourn.approved = 1
			order by tourn.start DESC
			limit 40 
		");
	
		@published = Tab::Tourn->search_by_results_published;

	}


</%init>

	<div class="left huge">

		<h2>Recent Results</h2>

        <a class="dkgreen block">
            <span class="medspan">
                Dates
            </span>

            <span class="medspan">
                Circuit
            </span>

            <span class="bigspan">
                Tournament
            </span>

            <span class="smallspan">
                Location
            </span>
		</a>

%		foreach my $tourn (sort {$b->start->epoch <=> $a->start->epoch} @published) { 

			<a class="<% ($open) ? "blue" : "grey" %> block" href="tourn/index.mhtml?tourn_id=<% $tourn->id %>"> 
			
				<span class="medspan">
                    <% Tab::niceshortdate($tourn->start) %>
                    <% ($tourn->start->day != $tourn->end->day) ? " - ".Tab::niceshortdate($tourn->end) : "" %>
                </span>

                <span class="medspan">
%                   foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 
						<% $circuit->abbr %>
%                   }
				</span>

				<span class="bigspan">
					<% $tourn->name %>
				</span>

				<span class="smallspan">
					<% $tourn->location %>
				</span>

			</a>

%		}

	</div>

	<div class="right small">

		<div id="sidenote">

			<h3>Search Results:</h3>



		</div>

	</div>


<%args>
	$tourn_id
</%args>
<%init>

	my $tourn =  Tab::Tourn->retrieve($tourn_id);

	my @rounds = $tourn->published_rounds;
	push (@rounds, $tourn->listed_rounds);

	@rounds = sort {$a->name <=> $b->name} @rounds;

    #uniq 
	my %seen = ();
    @rounds = grep { ! $seen{$_->id} ++ } @rounds;

	my %events_with_rounds = ();

	foreach my $round (@rounds) { 
		push (@{$events_with_rounds{$round->event->id}}, $round);
	}

	my $switch;

</%init>

	<h2>
		Postings for <% $tourn->name %>
	</h2>

	<h4>Judge Rosters & Pools</h4>

	<table cellpadding="4" cellspacing="1" width="100%">

%		foreach my $group (sort {$a->name cmp $b->name} $tourn->groups(pub_assigns => 1) ) {

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th> 
					<% $group->name %>
				</th>

				<td>

				</td>

				<td class="center">
					(<a href="judge_master.mhtml?tourn_id=<% $tourn->id %>&group_id=<% $group->id %>">Judge Assignments</a>)
				</td>

			</tr>

%		}

%		foreach my $pool (sort {$a->name cmp $b->name} $tourn->pools(publish => 1) ) {

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th> 
					<% $pool->name %>
				</th>

				<td class="center">
					(<a href="pool.mhtml?tourn_id=<% $tourn->id %>&pool_id=<% $pool->id %>">Judges Called</a>)
				</td>

				<td>
				</td>

			</tr>

%		}

	</table>

	<h4>Student Schematics</h4>

	<table cellpadding="4" cellspacing="1" width="100%">

%		foreach my $event (sort {$a->name cmp $b->name} $tourn->events) { 

%			next unless $events_with_rounds{$event->id};

			<tr class="liblrow">

				<th colspan="4">
					<% $event->name %>
				</th>

			</tr>

%			undef $switch;

%			foreach my $round (@{$events_with_rounds{$event->id}}) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						<% ($round->label) ? $round->label : "Round ".$round->name %>
					</td>

					<td>
						<% &Tab::nicetime($round->timeslot->start->set_time_zone($event->tournament->circuit->timezone)) %>

					<td align="center">
%						if ($round->published) { 
							(<a href="<% $Tab::url_prefix %>/index/round.mhtml?tourn_id=<% $tourn_id %>&round_id=<% $round->id %>">Schematic</a>)
%						}
					</td>

					<td align="center">
%						if ($round->listed) { 
							(<a href="<% $Tab::url_prefix %>/index/cleared.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>">Advancing Students</a>)
%						}
					</td>

%		}

		</tr>
%	}

</table>

<%args>
	$tourn
	$view => undef
	$session
</%args>
<%init>

	if ($view eq "print" || $view eq "print_novii") { 

    my $filename = $Tab::file_root."/tmp/sweeps-".$tourn->id."-".$session->id;
    my $garbage = `rm -f $filename.*`;
	open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";
\\documentclass[12pt]{report}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}
\\begin{document}

\\begin{center}
\\normalsize

EOF

	close TEXOUT;

$m->comp("print_sweeps.mas",
                filename => $filename,
                tourn => $tourn,
                view => $view);

	open (TEXOUT, ">>$filename.tex");
	print TEXOUT "\\end{center}\n";
	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
	$garbage = `rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;
	$m->redirect("$Tab::url_prefix/tmp/sweeps-".$tourn->id."-".$session->id.".pdf");

}

 	$m->comp("sweep_comps.mas", tourn => $tourn);

	my @schools = $tourn->schools;
	my %school_points = ();

	foreach my $school (@schools) { 

		my %comps_counted = $m->comp("school_count.mas", school => $school, tourn => $tourn)
				if $view eq "view" || $view eq "print";

		%comps_counted = $m->comp("school_novices.mas", school=> $school, tourn => $tourn) 
				if $view eq "view_novii" || $view eq "print_novii";
		
		foreach my $comp ($school->comps) { 

			$school_points{$school->id} = $school_points{$school->id} + $comp->sweeps_points 
				if $comps_counted{$comp->id};
		}

	}


</%init>

	<table width="100%">

		<tr>

			<td width="100%">
				<form action="overall_report.mhtml" method="post">
				<input type="hidden" name="view" value="<% ($view eq "view") ? "print" : "print_novii" %>">
				<h3>Tournament sweepstakes for <% $tourn->name %></h3>
			</td>
	
			<td align="right">
				<input  type="submit" value="Print">
				</form>
			</td>	
		</tr>

	</table>

	<center>

	<table cellpadding="7" width="75%" cellspacing="1">

%	my $switch  = 1;
% 	my $rank;

% 	foreach my $school (sort { $school_points{$b->id} <=> $school_points{$a->id} } @schools ) { 

%		next unless $school_points{$school->id};
% 		$rank++;

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th>
				<% $rank %>. 
			</th>
			
			<td>
				<% $school_points{$school->id} %> points
			</td>
			
			<td>
				<% $school->chapter->name %> (<% $school->chapter->state %>)
			</td> 
			
			<td> 
				<% scalar $school->comps %> entries 
			</td>
		
		</tr>

% 	}

	</table>




<%args> 
	$account
	$tourn
	$league
	$event_id => undef 
	$basis => undef
	$debug => undef
</%args> 
<%init> 

	my @events = sort {$a->name cmp $b->name} $tourn->events; 

	my $event = Tab::Event->retrieve($event_id);

	unless ($event) { 
		my $err = "You have tried to view a nonexistent event.  Please try again";
		$m->redirect("/results/printouts.mhtml?err=$err");
	}

	my @students = $event->students_only;

	my %students_by_code = ();

	my %round_label = ();
	my %round_type = ();

	foreach my $round ($event->rounds) { 

		$round_label{$round->id} = "Prelim" if $round->type eq "prelim"; 	
		$round_label{$round->id} = $round->label if $round->type ne "prelim"; 	

		$round_type{$round->id} = $round->type;
	}

	foreach my $student (@students) {

		$students_by_code{$student->compcode} = $student;

	}

	my %partners_by_code = ();

	if ($event->team == 2) { 

		my @partners = $event->partners;

		foreach my $partner (@partners) {
			$partners_by_code{$partner->compcode} = $partner;
		}

	}

	my @comps_in_order; 

	if ($event && $basis && $basis) { 

		@comps_in_order = $m->comp("order_comps.mas", 
						tourn => $tourn, 
						event => $event, 
						breaks_only => 1,
						basis => $basis);

	}

	if (@comps_in_order && $event->bids) {

		@comps_in_order = $m->comp("award_bids.mas",
							tourn => $tourn,
							basis => $basis,
							event => $event,
							ordered_comps => \@comps_in_order);
	}

	my %ties_by_comp = ();

	foreach my $comp (@comps_in_order) { 

		my @ties = Tab::Comp->search_ties($comp->id);

		@{$ties_by_comp{$comp->id}} = @ties;

	}

	my @non_advancing;

	if ($basis ne "prelim") { 

		@non_advancing = $m->comp("order_comps.mas", 
							tourn => $tourn, 
							event => $event, 
							nonadv => "1",
							basis => "prelim");
	}

	if (@non_advancing && $event->bids) {

		@non_advancing = $m->comp("award_bids.mas",
							tourn => $tourn,
							basis => $basis,
							event => $event,
							ordered_comps => \@non_advancing);
	}

	my @bidded = Tab::Comp->search( event => $event->id, bid => 1);

	my %bids = ();

	foreach my $bid (@bidded) {
		$bids{$bid->id}++;
	}

</%init> 

	<h3>
		Event results: <% $event->name . ($account->id == 1) ? $event->id : "" %>
	</h3>


	<table cellpadding="5" width="75%" cellspacing="1"> 

		<tr>
			<td>
				Event:
			</td>
			
			<td>
				<form action="event_results.mhtml" method="post"> 

				<select name="event_id">

%					foreach my $ev (@events) { 
						<option value="<% $ev->id %>" <% ($ev->id == $event_id) ? "selected" : "" %>>
							<% $ev->name %>
						</option>
% 					} 
				
				</select>

			</td>
			
			<td>
				Basis:
			</td>
			
			<td>

				<select name="basis">
					<option value="prelim" <% ($basis eq "prelim") ? "selected" : "" %> >
						Prelims
					</option>
					
					<option value="elim" <% ($basis eq "elim") ? "selected" : "" %> >
						Elims
					</option>
					
					<option value="final" <% ($basis eq "final") ? "selected" : "" %> >
						Finals
					</option>
				</select>

			</td> 
			
			<td align="right">
				<input class="blue" type="submit" value="   View Results  ">
				</form>
			</td> 
			
		</tr>

	</table>

	<hr>

% 	my $switch; 

	<table cellpadding="5" width="100%" cellspacing="1"> 
	
		<tr class="bluerow"> 
			
			<th class="smaller">
			</th>

%			if ($league->diocese_based) { 

		   		<th>
					Dio
				</th>

%			} 

			<th class="smaller">
				Code
			</th>
			
			<th class="smaller">
				Name
			</th>
			
			<th class="smaller" style="border-right: 1px solid brown;">
				School
			</th>

%			if ($event->bids) { 

				<th class="smaller">
					Bid
				</th>

%			}

%			if ($tourn->method->noshows_never_break) { 

				<th class="smaller">
					N/S	
				</th>

%			}

<%perl>

			my @tiebreaks = $tourn->method->tiebreaks(covers => $basis);

			my $last_priority;

			my %tiebreaks_by_priority = ();

			foreach my $tb (@tiebreaks) { 

				push (@{$tiebreaks_by_priority{$tb->priority}}, $tb);

			}

			foreach my $tier (sort {$a <=> $b} keys %tiebreaks_by_priority) { 

				my @tbs = @{$tiebreaks_by_priority{$tier}};

				$m->print("<th class=\"smaller\">");

				my $first;

				foreach my $tiebreaker (@tbs) { 

					my $name = $tiebreaker->tiebreaker;

					$name = "Cume" if $name eq "cumulative";
					$name = "Judge Pref" if $name eq "judgepref";
					$name = "Recips" if $name eq "reciprocals";
					$name = "Round" if $name eq "roundrank";
					$name = "Ranks" if $name eq "rankinround";

</%perl>

					<% ($first) ? "+" : "" %>

					<% ucfirst($name) ." <br /> ". ucfirst($tiebreaker->count) %>

%					$first++;

%				}

				</th>

%			}

			<th class="smaller">
				Scores
			</th>

			<th class="smaller">
				Ties
			</th>

		</tr>

<%perl>

		my $rank;

		my @ballots = $event->ballots;

		my %ballots_by_code = ();
	
		foreach my $ballot (@ballots) { 
			push (@{$ballots_by_code{$ballot->code}}, $ballot);
		}

		my %advanced = ();

		foreach my $comp (@comps_in_order) { 

	 		my $last_round_label = $round_label{$comp->last_round} if $comp->last_round;
	 		my $last_round_type = $round_type{$comp->last_round} if $comp->last_round;

			next if $last_round_label eq "Prelim" && $basis ne "prelim";

			$advanced{$comp->id}++;
	
			my $student = $students_by_code{$comp->code};
			my $partner = $partners_by_code{$comp->code};

			$rank++;

			my @ballots = @{$ballots_by_code{$comp->code}} if $ballots_by_code{$comp->code};

			next unless @ballots;
		
			my @ties = @{$ties_by_comp{$comp->id}} if $ties_by_comp{$comp->id};

</%perl>

%			if (@ties && $last_round_type eq $basis) {

       			<tr <% ($switch++ % 2) ? "class=\"redrow\"" : "class=\"lirdrow\"" %>>

%   		} else {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%			}

				<th class="smaller">

					<% $last_round_label %> 

%					if ($last_round_type eq $basis) { 
						<% $rank %> 
%					}

				</th>

%				if ($league->diocese_based) { 
	
					<td class="smaller">
						<% $comp->region->code %>
					</td>

%				}

				<td class="smaller">
					(<a href="/register/comp_edit.mhtml?comp_id=<% $comp->id %>"><% $comp->code %></a>)
				</td>

				<td class="smaller">

					<% ($comp->event->team == 3) ? $comp->name.": " : "" %>

%					my $notfirst;

%					foreach my $student ($comp->members) { 

						<a href="/register/student_edit.mhtml?student_id=<% $student->id %>">
							<% ($notfirst) ? "<br /> " : "" %>
							<% $student->first." ".$student->last %>
						</a>
							
						<% ($tourn->method->novices ne "none" && $student->novice) ? "*" : "" %>


%						$notfirst++;

%					}

				</td> 
				
				<td class="smaller" style="border-right: 1px solid brown;">
					<% ($student) ? substr($student->chname,0,25) :  substr($comp->school->name,0,25) %>
				</td>

%				if ($event->bids) { 
					<th class="smaller">
						<% ($bids{$comp->id} == 1) ? "Bid" : "" %>
					</th>
%				}

%				my $tbcount; 

%				if ($basis ne "prelim") {  #This is to edge past the "last round" tiebreaker, which is not
%					my $tb_key = "tb".$tbcount++;			#  displayed..
%				}

%				if ($tourn->method->noshows_never_break) { 

%					my $tb_key = "tb".$tbcount++;

					<th>
						<% ($comp->$tb_key) ? $comp->$tb_key : "" %>
					</th>

%				}

%				foreach my $tiebreaker (@tiebreaks) {

%					my $tb_key = "tb".$tbcount++;

%					system "/usr/bin/logger -t tabroom ".$comp->code." $tb_key is ".$comp->$tb_key if $debug;

%					my $result = sprintf("%.2f", $comp->$tb_key);
%					$result =~ s/\.00//g;
					<th>
						<% ($result != 0) ? $result : "" %>
					</th>

%					$last_priority = $tiebreaker->priority;

%				}

				<td class="smaller">

%					foreach my $ballot (@ballots) { 
						<% $ballot->rank %>
% 					}

				</td>

				<td class="smaller">

%					if ($last_round_type eq $basis) {
%						foreach my $tie (@ties) {
							<% $tie->code %>
%						}
%					}

				</td>

			</tr>

% 		}

	</table>

	<table cellpadding="5" width="100%" cellspacing="1">

%		my @prelim_breaks;

%		if (@non_advancing) { 

%			@prelim_breaks = $tourn->method->tiebreaks(covers => "prelim");

			<tr class="oddrow">
				<td colspan="15">
					<h4>Non-advancing students</h4>
				</td>
			</tr>

			<tr class="bluerow">

%				if ($league->diocese_based) { 
					<th class="smaller">
						Dio
					</th>
%				}

				<th class="smaller">
					Code
				</th>

				<th class="smaller">
					Name
				</th>

				<th class="smaller" style="border-right: 1px solid brown;">
					School
				</th>

%				if ($event->bids) { 
					<th class="smaller">
						Bid
					</th>
%				}

%				if ($tourn->method->noshows_never_break) { 
					<th class="smaller">
						Noshow
					</th>
%				}

%				foreach my $tiebreaker (sort {$a->priority <=> $b->priority} @prelim_breaks) {

%					my $name = $tiebreaker->tiebreaker;
%					$name = "Cume" if $name eq "cumulative";
%					$name = "JP" if $name eq "judgepref";
%					$name = "Recips" if $name eq "reciprocals";
					<th class="smaller">
						<% ucfirst($name) ." <br /> ". ucfirst($tiebreaker->count) %>
					</th>
%				}
	
				<th class="smaller">
					Scores
				</th>

			</tr>
%		}

%		foreach my $comp (@non_advancing) { 

%			next if $advanced{$comp->id};

%			my $student = $students_by_code{$comp->code};
%			my $partner = $partners_by_code{$comp->code};
%			my @ballots = @{$ballots_by_code{$comp->code}} if $ballots_by_code{$comp->code};

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%				if ($league->diocese_based) { 

					<td>
						<% $comp->region->code %>
					</td>

%				}

				<td class="smaller">
					(<a href="/register/comp_edit.mhtml?comp_id=<% $comp->id %>"><% $comp->code %></a>)
				</td> 
			
				<td class="smaller">
					<% ($comp->event->team == 3) ? $comp->name.": " : "" %>

%					foreach my $student ($comp->members) { 
						<a href="/register/student_edit.mhtml?student_id=<% $student->id %>">
							<% $student->first." ".$student->last %></a>
						<% ($tourn->method->novices ne "none" && $student->novice) ? "*" : "" %>
%					}
				</td>

				<td class="smaller" style="border-right: 1px solid brown;">
					<% ($student) ? substr($student->chname,0,45) :  substr($comp->school->name,0,45) %>
				</td>

%				if ($event->bids) { 
					<th>
						<% ($bids{$comp->id} == 1) ? "Bid" : "" %>
					</th>
%				}

%				my $tbcount;

%				if ($tourn->method->noshows_never_break) { 

%					my $tb_key = "tb".$tbcount++;

					<th>
						<% ($comp->$tb_key) ? $comp->$tb_key : "" %>
					</th>

%				}

%				foreach my $tiebreaker (@prelim_breaks) {

%					my $tb_key = "tb".$tbcount++;

%					if ($tiebreaker->tiebreaker eq "reciprocals") {

						<th>
							<% ($comp->$tb_key) ? sprintf("%.2f", $comp->$tb_key) : "" %>
						</th>

%					} else { 

						<th>
							<% ($comp->$tb_key) ? $comp->$tb_key : "" %>
						</th>

%					}
	
%				}

				<td class="smaller">
%					foreach my $ballot (@ballots) { 
						<% $ballot->rank %>
% 					}
				</td>

			</tr>

% 		} 

	</table>

	<p style="font-weight: bold;">
		<% ($tourn->method->novices) ? "* -- Novice" : "" %>
	</p>


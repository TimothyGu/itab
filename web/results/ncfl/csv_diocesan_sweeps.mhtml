<%args>
	$tourn
	$session
</%args>
<%init>

	my @dioceses;
	my %sweeps_by_diocese = ();
	my $sweeps_points_ref;

	($sweeps_points_ref, @dioceses) 
		= $m->comp("/results/ncfl/diocese_sweeps.mas", tourn => $tourn);

	%sweeps_by_diocese = %$sweeps_points_ref;

    my $filename = "DioceseSweeps-".$tourn->id."-".$session->id;
    my $filepath = $Tab::file_root."/tmp/".$filename;
	my $garbage = `rm -f $filepath.*`;

	open (CSV, ">$filepath.csv");

	print CSV "\"Order\",\"School\",\"Diocese\",\"Diocese Code\",\"Points\",\"Previous Cooke\",\"Current Cooke\",\n";

	my $rank = 1;

	foreach my $diocese (@dioceses) { 
		print CSV "\"".$rank++."\",\"";
		print CSV $diocese->name."\",\"";
		print CSV $diocese->name."\",\"";
		print CSV $diocese->code."\",\"";
		print CSV $sweeps_by_diocese{$diocese->id}."\",\"";
		print CSV $diocese->cooke_pts."\",\"";
		print CSV ($diocese->cooke_pts + $sweeps_by_diocese{$diocese->id})."\"\n";
	}

	close CSV;

    $m->redirect("$Tab::url_prefix/tmp/$filename.csv");

</%init> 


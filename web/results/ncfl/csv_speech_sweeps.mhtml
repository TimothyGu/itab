<%args>
	$tourn
	$session
</%args>
<%init>

	my @schools;
	my %sweeps_by_school = ();
	my $sweeps_points_ref;

	($sweeps_points_ref, @schools) 
		= $m->comp("/results/ncfl/speech_sweeps.mas", tourn => $tourn);

	%sweeps_by_school = %$sweeps_points_ref;

    my $filename = "SpeechSweeps-".$tourn->id."-".$session->id;
    my $filepath = $Tab::file_root."/tmp/".$filename;
	my $garbage = `rm -f $filepath.*`;

	open (CSV, ">$filepath.csv");

	print CSV "\"Order\",\"School\",\"Diocese\",\"Diocese Code\",\"Points\"\n";

	my $rank = 1;

	foreach my $school (@schools) { 
			print CSV "\"".$rank++."\",\"";
			print CSV $school->name."\",\"";
			print CSV $school->region->name."\",\"";
			print CSV $school->region->code."\",\"";
			print CSV $sweeps_by_school{$school->id}."\"\n";
	}

	close CSV;

    $m->redirect("$Tab::url_prefix/tmp/$filename.csv");

</%init> 


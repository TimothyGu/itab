<%args>
	$tourn
	$account
	$pool_id => undef
</%args>
<%init>

	my $pool = Tab::RoomGroup->retrieve($pool_id);

	my @pools = $tourn->room_groups;

	my @rooms = $m->comp("/funclib/tourn_rooms.mas", tourn => $tourn, inactive => 0);
	@rooms = map  { $_->[0] } sort { $a->[1] <=> $b->[1] } map  { [$_, $_->name=~/(\d+)/] } @rooms;
	@rooms = map  { $_->[0] } sort { $a->[1] cmp $b->[1] } map  { [$_, $_->name=~/(\D+)/] } @rooms;

	my @rounds = $m->comp("/funclib/tourn_rounds.mas", tourn => $tourn);

	my @sites = $tourn->sites;
	my $multi_sites++ if scalar @sites > 0;

</%init>

	<div class="right small">

		<div class="sidenote">

			<h4>Room Pools</h4>

			<form action="pool.mhtml" method="post">

			<div class="evenrow block">
				<select name="pool_id" class="fixedmed" onchange='this.form.submit()' data-placeholder="Choose group..">
					<option value=""></option>
%					foreach my $pool (sort {$a->name cmp $b->name} @pools) { 
						<option <% $pool->id == $pool_id ? "selected" : "" %> value="<% $pool->id %>"><% $pool->name %></option>
%					}
				</select>
			</div>

			</form>

			<a href="pool_create.mhtml" class="martop yellow block">Create New Room Pool</a>

		</div>

%		if ($pool) { 

			<div class="sidenote">

%				my @pool_rounds = $m->comp("/funclib/pool_rounds.mas", pool => $pool);
%				my %used_round;

%				if (@pool_rounds) { 
					
					<h4>Rounds Using Pool</h4>

%					foreach my $round ($m->comp("/funclib/pool_rounds.mas", pool => $pool)) { 
%						$used_round{$round->id}++;
						<a class="yellow block" href="pool_round_rm.mhtml?round_id=<% $round->id %>&pool_id=<% $pool->id %>">
							<% $round->event->abbr %> <% $round->realname %>
						</a>
%					}

%				}

				<h4>Use for round</h4>

				<form action="pool_round_add.mhtml" method="post">
				<input type="hidden" name="pool_id" value="<% $pool->id %>">

				<div class="evenrow block">

					<select name="round_id" class="fixedmed" onchange='this.form.submit()'>
						<option value=""></option>
%						foreach my $round (@rounds) { 
%							next if $used_round{$round->id};
							<option value="<% $round->id %>"><% $round->event->name %> <% $round->realname %></option> 
%						}
					</select>

				</div>

				</form>

			</div>
%		}

	</div>

	<div class="left huge">

%		unless ($pool) { 

			<h2>Choose a pool at right</h2>

%		} else {

%			my @pool_rooms = $m->comp("/funclib/pool_rooms.mas", pool => $pool);
%			@pool_rooms = map  { $_->[0] } sort { $a->[1] <=> $b->[1] } map  { [$_, $_->name=~/(\d+)/] } @pool_rooms;
%			@pool_rooms = map  { $_->[0] } sort { $a->[1] cmp $b->[1] } map  { [$_, $_->name=~/(\D+)/] } @pool_rooms;

			<h2>Rooms for <% $pool->name %></h2>

			<p>Note: this will override any event specific pools you have created under Settings -> Sites</p>

			<script type="text/javascript">
				$(document).ready(function(){
					$("input:checkbox.room").change(function() { 

						var spanstring = '#span_' + $(this).attr("id");

						if($(this).is(":checked")) { 
							$.ajax({
								url: 'pool_room_switch.mhtml',
								type: 'POST',
								data: { room_id:$(this).attr("id"), value:"1", pool_id:"<% $pool_id %>" },
								success: function(data) { 
									$(spanstring).removeClass('greynohover').addClass('bluenohover');
								}

							});
						} else {
							$.ajax({
								url: 'pool_room_switch.mhtml',
								type: 'POST',
								data: { room_id:$(this).attr("id"), value:"0", pool_id:"<% $pool_id %>" },
								success: function(data){ 
									$(spanstring).removeClass('bluenohover').addClass('greynohover');
								}
							});
						}
					}); 
				});
			</script>

%			my %used = ();

			<div class="halfpage">

				<h4><% scalar @pool_rooms %> in pool:</h4>

%				foreach my $room (sort {$a->site->name cmp $b->site->name} @pool_rooms) { 
%					next if $room->inactive;
%					$used{$room->id}++;

					<label for="<% $room->id %>">
					<span class="biggishblock bluenohover" id="span_<% $room->id %>" style="height: 36px;">

						<span class="medspan nowrap padno">
							<% $room->name %>
							<% $multi_sites ? "<br />".$room->site->name : ""%>
						</span>

						<span class="huntwofive nowrap padno">
							<% $room->quality %>, <% $room->capacity %> 
						</span>

						<span class="check" style="padding: 2px; vertical-align: middle;">
							<input type="checkbox" class="room" style="margin: 0; margin-top: 2px;" id="<% $room->id %>" name="<% $room->id %>" value="1" checked="checked">
						</span>
					</span>
					</label>

%				}

			</div>

%			if ($pool) { 

				<div class="halfpage rightfloat">

					<h4><% scalar @rooms %> rooms:</h4>

%					foreach my $room (sort {$a->site->name cmp $b->site->name} @rooms) { 

%						next if $room->inactive;
%						next if $used{$room->id};

						<label for="<% $room->id %>">
						<span class="biggishblock greynohover" id="span_<% $room->id %>" style="height: 37px;">

							<span class="medspan  nowrap padno ">
								<% $room->name %>
								<% $multi_sites ? "<br />".$room->site->name : ""%>
							</span>

							<span class="huntwofive nowrap padless ">
								<% $room->quality %>, <% $room->capacity %>
							</span>

							<span class="check" style="padding: 2px; vertical-align: middle;">
								<input type="checkbox" class="room" style="margin: 0; margin-top: 2px;" id="<% $room->id %>" name="<% $room->id %>" value="1">
							</span>

						</span>
						</label>
%					}

				</div>
%			}
%		}

	</div>


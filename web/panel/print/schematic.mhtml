<%args>
	$tourn
	$session
	$event_id
	$schools => undef 
	$min_paper => undef
	$round_id => undef
	$timeslot_id => undef
</%args>
<%init>

	my @events;

	if ($event_id eq "all") { 
		@events = $tourn->events;
	} else {
		push (@events, Tab::Event->retrieve($event_id));
	}
	@events = sort {$a->name cmp $b->name} @events;

	my @timeslots;

	if ($timeslot_id eq "all") { 
		@timeslots = $tourn->timeslots;
	} else { 
		push (@timeslots, Tab::Timeslot->retrieve($timeslot_id)) if $timeslot_id;
		my $round = Tab::Round->retrieve($round_id) if $round_id;
		push (@timeslots, $round->timeslot) if $round;
	}

	@timeslots = sort {$a->start->epoch <=> $b->start->epoch} 


	my $name = $events[0]->name if $event_id ne "all";
	$name = "ALL" unless $name;
    $name =~ s/[\W_]//g;

    my $filename = "Schematic-".$name."-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`;

    $m->comp("/funclib/printout.mas", filename => $filename, head => 1 );

	EVENT:
	foreach my $event (@events) { 

		TIMESLOT:
		foreach my $timeslot (@timeslots) { 

			my @rounds = Tab::Round->search(event => $event->id, timeslot => $timeslot->id);
	
			#	next TIMESLOT unless (@rounds);
			#	print TEXOUT "\\huge ". $timeslot->name ." \\\\ \n" if $timeslot;
	
			unless ($timeslot) { 
				print TEXOUT "\\huge TAB ROOM COPY: ". $event->name ." \\\\ \n" if $schools;
				print TEXOUT "\\huge ". $event->name ." \\\\ \n" unless $schools;
			}

			close TEXOUT;

			foreach my $round (@rounds) { 

				next unless $round->panels;
			
				if ($event->type eq "speech") { 
					$m->comp("schemat/round_print_speech.mas", round_id => $round->id, filename => $filename, schools => $schools);
				} elsif ($event->type eq "congress") { 
					$m->comp("schemat/round_print_congress.mas", round_id => $round->id, filename => $filename, schools => $schools);
				} elsif ($event->type eq "BP") { 
					$m->comp("schemat/round_print_bp.mas", round_id => $round->id, filename => $filename, schools => $schools);
				} else { 
					$m->comp("schemat/round_print_debate.mas", round_id => $round->id, filename => $filename, schools => $schools);
				}

				if ($tourn->setting("ncfl")) { 
					open (TEXOUT, ">>$filepath.tex");
					print TEXOUT "\\newpage \n";
					close TEXOUT;
				}
	
			}

		} 	

		unless ($schools || $min_paper) { 
			open (TEXOUT, ">>$filepath.tex");
			print TEXOUT "\\newpage \n";
			close TEXOUT;
		}
	} 

    $m->comp("/funclib/printout.mas", filename => $filename, tail => 1 );

</%init>

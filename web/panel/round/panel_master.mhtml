<%args>
	$tourn
	$event_id => undef
	$all => undef
</%args>
<%init>

	my @events;
	my @rounds;

	my %num_panels_by_event = ();
	my %num_panels_by_round = ();

	if ($all) { 

		Tab::debuglog("All was selected");

		foreach my $event ($tourn->events) { 
			next unless $ARGS{"do_".$event->id};
			push (@events, $event);
			$num_panels_by_event{$event->id} = $ARGS{"num_panels_".$event->id};
		}

	} else { 

		Tab::debuglog("Event ".$event_id." was selected");

		my $event = Tab::Event->retrieve($event_id);

		push (@events, $event);

		foreach my $round ($event->rounds) { 
			next unless $ARGS{"do_".$round->id};
			push (@rounds, $round);
			$num_panels_by_round{$round->id} = $ARGS{"num_panels_".$round->id};
		}

	}

	foreach my $event (@events) { 
			
		Tab::debuglog("Doing event ".$event->name.". Type is ".$event->type);

		my $num_panels = $num_panels_by_event{$event->id};

		if ($event->type eq "speech") { 
		
			Tab::debuglog("Event ".$event->name." type is speech");

			my @event_rounds = @rounds if @rounds;
			@event_rounds = $event->rounds(type => "prelim") unless @event_rounds;

			foreach my $round (@event_rounds) { 
				$num_panels = $num_panels_by_round{$round->id} if $num_panels_by_round{$round->id};
				$m->comp("pair_speech.mas", round => $round, num_panels => $num_panels);
			}

		} elsif ($event->type eq "congress") { 

			my @event_rounds = @rounds if @rounds;
			@event_rounds = $event->rounds(type => "prelim") unless @event_rounds;

			foreach my $round (@event_rounds) { 
				$num_panels = $num_panels_by_round{$round->id} if $num_panels_by_round{$round->id};
				$m->comp("pair_congress.mas", round => $round, num_panels => $num_panels);
			}

		} else { 

			my @event_rounds = @rounds if @rounds;
			@event_rounds = $event->rounds(type => "preset") unless @event_rounds;

			foreach my $round (@event_rounds) { 
				$num_panels = $num_panels_by_round{$round->id} if $num_panels_by_round{$round->id};
				$m->comp("pair_debate.mas", round => $round, flighting => $num_panels);
			}

		}

	}

	$m->redirect("/panel/report/disasters.mhtml?event_id=".$event_id);

</%init>

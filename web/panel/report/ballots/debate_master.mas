<%args>
	$panel_id => undef
	$judge_id => undef
	$event_id => undef
	$chair => undef
	$filename
</%args>
<%perl>

	my $filepath = $Tab::file_root."/tmp/".$filename;

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	my $round = $panel->round if $panel;
	my $event = $round->event if $round;

	$event = Tab::Event->retrieve($event_id) unless $event;
	my $tourn = $event->tourn;
	
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel) if $panel;

	my $start;
	
	if ($round) { 
		$start = $round->start_time;
		$start = $round->timeslot->start unless $start;
		$start->set_time_zone($tz);
	}

	my $flight_offset = $event->setting("flight_offset");

	if ($flight_offset && $panel && $panel->flight > 1) { 
		my $flight = $panel->flight - 1;
		$start->add( minutes => $flight_offset * $flight);
	}

	my $points;
	my $ranks;

	if ($panel && $panel->round->tb_set) { 
		foreach my $tb ($panel->round->tb_set->tiebreaks) {
			$points++ if $tb->name eq "points";
			$ranks++ if $tb->name eq "ranks";
		}
	} else { 
		my @round = sort {$a->name <=> $b->name} $event->rounds;
		my $sample = shift @round;
		if ($sample->tb_set) { 
			foreach my $tb ($sample->tb_set->tiebreaks) {
				$points++ if $tb->name eq "points";
				$ranks++ if $tb->name eq "ranks";
			}
		} else { 
			$points++;
			$ranks++;
		}
	}

	my $lpw++ unless $event->setting("no_lpw");
	my $max_points = $event->setting("max_points");
	my $min_points = $event->setting("min_points");

	my $max_entry = $event->setting("max_entry");
	my $min_entry = $event->setting("min_entry");

	$min_points = 0 unless $min_points;
	$max_points = 30 unless $max_points;

	open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "\\renewcommand{\\arraystretch}{1.8}\n";

	print TEXOUT "\\noindent";

	if ($panel) { 
		print TEXOUT "\\parbox[l][][t]{2in}{";
		print TEXOUT "\\normalsize \n";
		print TEXOUT "{\\bf Room: ".&Tab::texify($panel->room->name)." } \n\n " if $panel->room;
		print TEXOUT "{\\bf Room: ASK TAB } \n\n " unless $panel->room;
		print TEXOUT "{\\bf Flight ".$panel->flight." Start: ".Tab::nicetime($start)." } \n\n " if $round->flighted > 1;
		print TEXOUT "{\\bf Start: ".Tab::nicetime($start)." } \n\n " if $round->flighted < 2;
		print TEXOUT "{\\bf ".&Tab::texify($event->name)." } \n\n ";
		print TEXOUT "}  \\hfill ";
		print TEXOUT "{\\huge \\bf ".$round->name."} \\hfill";
		print TEXOUT "{\\huge \\bf *}" if $judge->chair;
		print TEXOUT "{\\huge \\bf ".&Tab::texify($judge->first." ".$judge->last)."} \\\\ \n";
	} else { 
		print TEXOUT "{\\bf Room: \\makebox[1.5in]{\\hrulefill} \\hfill Round: \\makebox[.5in]{\\hrulefill} \\hfill Judge: \\makebox[1.5in]{\\hrulefill}}\n\\medskip\\newline\n";
	}

	print TEXOUT "\\begin{center}\n";
	print TEXOUT "{\\huge \\bf ".&Tab::texify(uc($tourn->name))." } \\\\ \n";

	my $t_start = $tourn->start->set_time_zone($tz);
	my $t_end = $tourn->end->set_time_zone($tz);
	
	my $date_string = $t_start->month_abbr." ".$t_start->day." - ".$t_end->day.", ".$t_end->year  if $t_start->month == $t_end->month;
	$date_string = $t_start->month_abbr." ".$t_start->day." - ".$t_end->month_abbr." ".$t_end->day.", ".$t_end->year  unless $t_start->month == $t_end->month;

	print TEXOUT "\\smallskip \n ";
	print TEXOUT "{\\large \\bf ".&Tab::texify($date_string)." } \\\\ \n";
	print TEXOUT "\\end{center} \n";

	if ($chair && scalar @judges > 1) { 
		print TEXOUT "\\small {\\bf *Please chair this round.}\n";
		print TEXOUT "\\medskip \n ";
		print TEXOUT "\\newline\n ";
	}

	my $message = $event->setting("ballot_rules");

	if ($message) { 
		my $strip = HTML::Strip->new();
		$message = $strip->parse( $message );
		print TEXOUT "\\small \n ";
		print TEXOUT &Tab::texify($message);
		print TEXOUT "\\bigskip \\newline \n ";
	}

	my $aff;
	my $neg;

	if ($panel) { 
		foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) {
			$aff = $entry if $entry->side == 1;
			$neg = $entry if $entry->side == 2;
		}
	}

	my @affs = $aff->students if $aff;
	my @negs = $neg->students if $neg;

	print TEXOUT "{\\begin{minipage}[c]{3in}";
	print TEXOUT "\n \\normalsize\n";

	if ($event->type eq "pf") { 
		print TEXOUT "{\\small {\\bf  PRO \\hspace{.1in} CON } \\hspace{.1in} {\\footnotesize (Circle One) } }\n\\medskip\n\\newline\n";
		print TEXOUT "\\begin{tabular}{"
	} else { 
		print TEXOUT "{\\small \\bf AFFIRMATIVE}\n\\newline\n";
		print TEXOUT "\\begin{tabular}{"
	} 

	my $first_row;
	my $size = "1.75in" if $ranks;
	$size = "2.25in" unless $ranks;

	if ($max_entry > 1 && $event->type ne "pf") { 
		print TEXOUT "|p{.25in}|p{$size}";
		$first_row = " {\\bf \\scriptsize Pos} & {\\bf \\truncate{$size}{".Tab::texify($aff->code)."} }" if $aff;
		$first_row = " {\\bf \\scriptsize Pos} & {\\bf Team: } " unless $aff;
	} else { 
		print TEXOUT "|p{$size}";
		$first_row = " {\\bf \\truncate{$size}{".Tab::texify($aff->code)."} }" if $aff;
		$first_row = " {\\bf \\truncate{$size}{ Debater: } }" unless $aff;
	}

	if ($points) { 
		print TEXOUT "|p{.4in}";
		$first_row .= " & \\begin{minipage}[c]{.4in}\n";
		$first_row .= "\\vspace{.05in}\n";
		$first_row .= "{\\bf \\scriptsize POINTS}\n\n";
		$first_row .= "{\\scriptsize ( $min_points - $max_points )}\n";
		$first_row .= "\\vspace{.02in}\n";
		$first_row .= "\\end{minipage}\n";
	}

	if ($ranks) { 
		print TEXOUT "|p{.4in}";
		$first_row .= " & {\\bf \\scriptsize RANK} "
	}

	print TEXOUT "|}\n \\hline\n";
	print TEXOUT $first_row."\\\\ \n";
	print TEXOUT "\\hline\n";

	my $order = 1;

	if (@affs) { 
		foreach my $speaker (@affs) { 
			if ($event->type eq "pf") { 
				print TEXOUT "Speaker $order:";
				$order += 2;
			} else { 
				print TEXOUT " & " if scalar @affs > 1;
				print TEXOUT Tab::texify($speaker->first." ".$speaker->last." ");
			}
			print TEXOUT " & " if $points;
			print TEXOUT " & " if $ranks;
			print TEXOUT "\\\\ \n";
			print TEXOUT "\\hline\n";
		}
	} else { 

		my $order = 1;
		foreach (1 .. $max_entry) { 

			if ($event->type eq "pf") { 
				print TEXOUT "Speaker $order:";
				$order += 2;
			} else { 
				print TEXOUT " & " if $max_entry > 1;
				print TEXOUT "{\\footnotesize Name: }";
			}
			print TEXOUT " & " if $points;
			print TEXOUT " & " if $ranks;
			print TEXOUT "\\\\ \n";
			print TEXOUT "\\hline\n";
		}
	}

	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\end{minipage}\n";

	if ($ranks) { 
		print TEXOUT "\\hspace{.65in}\n"
	} else { 
		print TEXOUT "\\hspace{.75in}\n"
	}

	print TEXOUT "{\\begin{minipage}[c]{3in}";
	print TEXOUT "\n \\normalsize\n";

	if ($event->type eq "pf") { 
		print TEXOUT "{\\small {\\bf  PRO \\hspace{.1in} CON } \\hspace{.1in} {\\footnotesize (Circle One) } }\n\\medskip\n\\newline\n";
		print TEXOUT "\\begin{tabular}{"
	} else { 
		print TEXOUT "{\\small \\bf NEGATIVE}\n\\newline\n";
		print TEXOUT "\\begin{tabular}{"
	} 

	undef $first_row;
	$size = "1.75in" if $ranks;
	$size = "2.25in" unless $ranks;

	if ($max_entry > 1 && $event->type ne "pf") { 
		print TEXOUT "|p{.25in}|p{$size}";
		$first_row = " {\\bf \\scriptsize Pos} & {\\bf \\truncate{$size}{".Tab::texify($neg->code)."} }" if $neg;
		$first_row = " {\\bf \\scriptsize Pos} & {\\bf Team: } " unless $neg;
	} else { 
		print TEXOUT "|p{$size}";
		$first_row = " {\\bf \\truncate{$size}{".Tab::texify($neg->code)."} }" if $neg;
		$first_row = " {\\bf \\truncate{$size}{ Debater: } }" unless $neg;
	}

	if ($points) { 
		print TEXOUT "|p{.4in}";
		$first_row .= " & \\begin{minipage}[c]{.4in}\n";
		$first_row .= "\\vspace{.05in}\n";
		$first_row .= "{\\bf \\scriptsize POINTS}\n\n";
		$first_row .= "{\\scriptsize ( $min_points - $max_points )}\n";
		$first_row .= "\\vspace{.02in}\n";
		$first_row .= "\\end{minipage}\n";
	}

	if ($ranks) { 
		print TEXOUT "|p{.4in}";
		$first_row .= " & {\\bf \\scriptsize RANK} "
	}

	print TEXOUT "|}\n \\hline\n";
	print TEXOUT $first_row."\\\\ \n";
	print TEXOUT "\\hline\n";

	$order = 1;

	if (@negs) { 
		foreach my $speaker (@negs) { 
			if ($event->type eq "pf") { 
				print TEXOUT "Speaker $order:";
				$order += 2;
			} else { 
				print TEXOUT " & " if $max_entry > 1;
				print TEXOUT Tab::texify($speaker->first." ".$speaker->last." ");
			}
			print TEXOUT " & " if $points;
			print TEXOUT " & " if $ranks;
			print TEXOUT "\\\\ \n";
			print TEXOUT "\\hline\n";
		}
	} else { 

		foreach (1 .. $max_entry) { 

			if ($event->type eq "pf") { 
				print TEXOUT "Speaker $order:";
				$order += 2;
			} else { 
				print TEXOUT " & " if $max_entry > 1;
				print TEXOUT "{\\footnotesize Name: }";
			}
			print TEXOUT " & " if $points;
			print TEXOUT " & " if $ranks;
			print TEXOUT "\\\\ \n";
			print TEXOUT "\\hline\n";
		}
	}

	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\end{minipage}\n";

	print TEXOUT "\\vspace{.25in}\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "Winner: \\makebox[2.5in]{\\hrulefill} debating on the \\makebox[1in]{\\hrulefill}\n";
	print TEXOUT "\\hspace{.3in} \\footnotesize Low point win? \\makebox[.5in]{\\hrulefill} \n" if $lpw;
	print TEXOUT "\\newline\n";

	print TEXOUT "\\scriptsize\n";
	print TEXOUT "\\makebox[1.25in]{}School/Team\\makebox[2.3in]{} Side (Aff or Neg)" unless $event->type eq "pf";
	print TEXOUT "\\makebox[1.25in]{}School/Team\\makebox[2.3in]{} Side (Pro or Con)" if $event->type eq "pf"; 
	print TEXOUT "\\bigskip \\newline \n";
	print TEXOUT "\\makebox[1.5in]{} " unless $event->type eq "pf";
	print TEXOUT "\\makebox[.5in]{} " if $event->type eq "pf";
	print TEXOUT "Signature:  \\makebox[3.25in]{\\hrulefill} ";
	print TEXOUT "School: \\makebox[2in]{\\hrulefill}\n" if $event->type eq "pf";
	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\makebox[7in]{\\hrulefill}\n";
	print TEXOUT "\\smallskip\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "Comments \\\& Reason for Decision:\n";
	print TEXOUT "\\newline\n";

	close (TEXOUT);

	return;

</%perl>

<%args>
	$account
	$tourn
	$show => undef
	$seeds => undef
	$event_id => undef
	$round_id => undef
	$done => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;

	my $ncfl++ if $tourn->setting("ncfl");

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	unless ($event || $round) { 
		my $msg = "Please pick an event or a round plz";
		$m->redirect("/register/index.mhtml?msg=$msg");
	}

	$event = $round->event unless $event;

	my @rounds = sort {$a->name <=> $b->name} $event->rounds;

	unless ($round) { 

		unless (@rounds) { 
			my $msg = "There are no rounds scheduled of ".$event->name.".  Try scheduling some?";
			$m->redirect("/setup/schedule/event.mhtml?event_id=$event_id&msg=$msg");
		}

		$round = $m->comp("/funclib/event_current_round.mas", event => $event);

		$round = $m->comp("/funclib/event_current_round.mas", event => $event, done => "done") unless $round;

		$round = $rounds[0] unless $round;

	}

	my $preset = 1 unless $m->comp('/funclib/round_entries.mas', round => $round);

	my $start = $round->start_time;
	$start = $round->timeslot->start unless $start;
	$start->set_time_zone($tz);

	my $tourn_access = Tab::TournAdmin->search( account => $account->id, tourn => $tourn->id )->first;
	my $entry_only++ if $tourn_access && $tourn_access->entry_only;
	undef $entry_only if $account->site_admin;
	$show = "schools" if $entry_only;

</%init>

	<div class="right small">

%		if ($entry_only) { 

			<div class="sidenote">

				<h4>Return</h4>
				
				<a class="blue block" href="/tabbing/entry/index.mhtml">
					Return to Ballot Entry
				</a>

			</div>
%		} else { 

		<div class="sidenote">

			<h4>Share & Enjoy</h4>

			<div class="block evenrow">
				<form action="start_time.mhtml" method="post">
				Start time
				<input type="hidden" name="round_id" value="<% $round->id %>">
					<& /funclib/timepicker.mas, name => "starttime", time => $start, size => 9 &>
				<input type="submit" class="notfirst thinner" value="Save">
				</form>
			</div>

			<a class="<% $show || $seeds ?  "" : "dk" %>blue halfblock" href="show.mhtml?round_id=<% $round->id %>">
				Pairing
			</a><a class="<% $show eq "yeppers" ?  "dk" : "" %>blue halfblock" href="show.mhtml?round_id=<% $round->id %>&show=yeppers">
				w/<% $ncfl ? "Dioceses" : "Schools" %>
			</a>

%			if ($event->type eq "congress" || $event->type eq "speech") { 
				<a class="blue halfblock" href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>">	
					Print Pairing
				</a><a class="blue halfblock" href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>&schools=yep">	
					w/<% $ncfl ? "Dioceses" : "Schools" %>
				</a>
%			} else { 
				<a class="blue halfblock" href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>">	
					Print Pairing
				</a><a class="blue halfblock" href="/panel/report/schematic.mhtml?record=sanchez&round_id=<% $round->id %>&event_id=<% $round->event->id %>">	
					w/Records
				</a>
%			} 

%			if ($event->setting("pair_seeds")) { 
				<a class="<% $seeds ?  "dk" : "" %>blue block " href="show.mhtml?round_id=<% $round->id %>&seeds=yesmaam">
					Show Pairing w/seeds
				</a>
%			}


%			if ($event->type eq "speech" || $event->type eq "congress") { 
				<a class="blue block" href="/panel/report/master_ballots.mhtml?timeslot_id=<% $round->timeslot->id %>&event_id=<% $event->id %>&sort_by=name">	
					Print Ballots
				</a>
%			} 

%			if ($event->type eq "congress") { 
				<a class="blue block" href="/panel/report/chamber_roster.mhtml?round_id=<% $round->id %>">	
					Print Roster with Chambers
				</a>
%			} 


%			if ($round->type eq "elim" || $round->type eq "final") { 
				<a class="<% $round->listed ? "dkgreen" : "blue"  %> block" href="clearing.mhtml?round_id=<% $round->id %>">	
					Clearing list: <% $round->listed ? "PUBLISHED" : "NOT PUBLISHED" %>
				</a>
%			}


			<form action="publish.mhtml" method="post">
			<input type="hidden" name="round_id" value="<% $round->id %>">

			<div class="evenrow block martop">

				<span class="smallerspan padno">
					Round:
				</span>

				<span class="hundo">
					<select name="published" id="notfirst" class="notfirst fixedtiny">
						<option value="0" <% $round->published ? "" : "selected" %> >Not Public</option>
						<option value="1" <% $round->published == 1 ? "selected" : "" %>>On Web</option>
						<option value="2" <% $round->published == 2 ? "selected" : "" %>>On Web w/o Judges</option>
%						if ($event->type eq "wudc") { 
							<option value="3" <% $round->published == 3 ? "selected" : "" %>>On Web w/Motion</option>
%						}
					</select>
				</span>

				<span>
					<input type="submit" value="Go" class="thinner notfirst">
					</form>
				</span>

			</div>

			<form action="post_results.mhtml" method="post">
			<input type="hidden" name="round_id" value="<% $round->id %>">

			<div class="oddrow block">

				<span class="smallerspan padno">
					Results:
				</span>

				<span class="hundo">
					<select name="post" id="notfirst" class="notfirst fixedtiny">
						<option value="0" <% $round->post_results ? "" : "selected" %> >Not Public</option>
						<option value="1" <% $round->post_results == 1 ? "selected" : "" %>>Only <% $event->type eq "speech" || $event->type eq "congress" ? "Ranks" : "Win/Loss"%></option>
						<option value="2" <% $round->post_results == 2 ? "selected" : "" %>>Full Results</option>
					</select>
				</span>

				<span>
					<input type="submit" value="Go" class="thinner notfirst">
					</form>
				</span>

			</div>

			<a class="martop blue block" href="blast.mhtml?round_id=<% $round->id %>">
				Send Email/text blast
			</a>

		</div>

		<div class="sidenote">
			
			<h4>Change & Destroy</h4>

				<div class="block evenrow rightalign">

					<span class="tiny">
						Time:
					</span>
					<span class="huntwofive rightalign">
					<form action="round_timeslot.mhtml" method="post">
						<input type="hidden" name="round_id" value="<% $round->id %>">

						<select name="timeslot_id" onchange='this.form.submit()' class="fixedsmaller notfirst">
%						foreach my $timeslot (sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots) { 
							<option value="<% $timeslot->id %>" <% $timeslot->id == $round->timeslot->id ? 'selected' : "" %>>
								<% $timeslot->name %>
							</option>
%						}
						</select>
					</form>
					</span>
				</div>

				<a class="yellow block" href="/setup/schedule/event.mhtml?event_id=<% $event->id %>">
					Edit <% $event->abbr %> Schedule
				</a>


%				unless ($round->panels) { 

%					my $warn;

%					if ($event->type eq "wudc") { 
%						my @entries = $event->entries( dropped => 0, waitlist => 0, unconfirmed => 0);
%						$warn = "The field size is not divisible by 4.  This pairing will have byes." if (scalar @entries % 4);	
%					}

					<a class="dkgreen block" <& "/funclib/confirm.mas", warn => $warn &> href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>">
						Auto-pair round
					</a>

%					if ($event->type eq "speech" || $event->type eq "congress") { 
						<a class="yellow block" href="/panel/round/manual.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>">
							Manually pair round
						</a>
%					}

					<br />

%					$warn = "You will destroy this round and not get it back.  Are you sure?";

					<a class="dkred block" href="/panel/schemat/round_rm.mhtml?round_id=<% $round->id %>" <& "/funclib/confirm.mas", warn => $warn &> >
						Delete Round
					</a>

					<p class="explain">
						Create sections using the Create Additional Sections
						box on the left if you want to pair this round.  
					</p>

					<p class="explain">
						Otherwise you can also pair the event/round using the
						functions under Paneling -> Pair Round.
					</p>


%				} else { 

%					my $warn = "Danger, Will Robinson! You are about to repanel this round entirely.  Are you sure?";

					<a class="yellow block" <& "/funclib/confirm.mas", warn => $warn &> href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>">
						Auto-pair round
					</a>

%					$warn = "Danger, Will Robinson! You are about to dump all the judges and re-assign them.  Are you sure?";
					<a class="yellow block"  <& "/funclib/confirm.mas", warn => $warn &>  href="/panel/round/judges.mhtml?round_id=<% $round->id %>">
						Auto-pair judges
					</a>

%					$warn = "Danger, Will Robinson! You are about to dump all the rooms and re-assign them.  Are you sure?";
					<a class="yellow block" <& "/funclib/confirm.mas", warn => $warn &> href="/panel/round/rooms.mhtml?round_id=<% $round->id %>">
						Auto-pair rooms
					</a>

%					if ($m->comp('/funclib/round_unbalanced.mas', round => $round) && $event->type eq "speech" ) {
						<a class="martop dkgreen block" href="/panel/pair/rebalance.mhtml?round_id=<% $round->id %>">
							Auto-Rebalance this round
						</a>
						<a class="dkgreen block" href="/panel/manipulate/manual_rebalance.mhtml?round_id=<% $round->id %>">
							Manually Rebalance
						</a>
%					}

%					$warn = "You are about to delete all entries from this round.  You cannot get it back.  Please, for the love all that is good and holy, be certain you mean it";
%					my $warn2 = "You are about to delete all judges from this round.  You cannot get them back.  Please, for the love all that is good and holy, be certain you mean this";
					<a class="dkred halfblock " style="margin-top: 8px;" <& "/funclib/confirm.mas", warn => $warn &> href="round_dump_entries.mhtml?round_id=<% $round->id %>">
						Dump entries
					</a><a class="dkred halfblock " style="margin-top: 8px;" <& "/funclib/confirm.mas", warn => $warn2 &> href="round_dump_judges.mhtml?round_id=<% $round->id %>">
						Dump judges
					</a>

%					$warn = "You are about to delete all judges from this round.  You cannot get them back.  Please, for the love all that is good and holy, be certain you mean this";
%					$warn2 = "You are about to delete this ENTIRE ROUND.  You cannot get it back.  Please, for the love all that is good and holy, be certain you mean this";
					<a class="dkred halfblock " style="margin-top: 1px;" <& "/funclib/confirm.mas", warn => $warn &> href="round_dump_rooms.mhtml?round_id=<% $round->id %>">
						Dump rooms
					</a><a class="dkred halfblock " style="margin-top: 1px;" <& "/funclib/confirm.mas", warn => $warn2 &> href="round_dump.mhtml?round_id=<% $round->id %>">
						Dump round
					</a>

%				if ($account->site_admin || $tourn->hidden) { 

%					$warn2 = "You are about to fake the ranks for an entire round.  Existing ranks will be wiped out.  Please be sure.  There is no undo here.";
					<br />
					<br />
					<a class="dkred halfblock " style="margin-top: 1px;" <& "/funclib/confirm.mas", warn => $warn2 &> href="/tabbing/entry/<% $event->type %>_fake.mhtml?round_id=<% $round->id %>">
						Fake Ranks
					</a><a class="dkred halfblock " style="margin-top: 1px;" <& "/funclib/confirm.mas", warn => $warn2 &> href="/tabbing/entry/<% $event->type %>_fake.mhtml?event_id=<% $event->id %>">
						Whole Event
					</a>
%				}

%			}
	
		</div>

		<div class="sidenote">

			<h4>Stats & Data</h4>

			<a class="blue block" href="round_entries.mhtml?round_id=<% $round->id %>&done=1">
				List Entries
			</a>

			<a class="<% $done ? "dk" : "" %>blue block" href="show.mhtml?round_id=<% $round->id %>&done=1">
				Show Results
			</a>

%			if ($event->type eq "wudc") {
				<span class="thirdblock">
					Motion
				</span>
				<span class="twothirdblock">
					<% $round->motion ? "Entered" : "Not Entered" %>
				</span>
%			}

			<span class="thirdblock">
				Paired
			</span>
			<span class="twothirdblock">
				<% $round->created ? &Tab::nicedt($round->created->set_time_zone($tourn->tz)) : "Not recorded" %>
			</span>

			<span class="thirdblock">
				Finished
			</span>
			<span class="twothirdblock">
				<% $round->completed ? &Tab::nicedt($round->completed->set_time_zone($tourn->tz)) : "Not recorded" %>
			</span>

			<span class="thirdblock">
				Blasted
			</span>
			<span class="twothirdblock">
				<% $round->blasted ? &Tab::niceshortdayte($round->blasted->set_time_zone($tourn->tz)) : "Not yet blasted" %> @
				<% $round->blasted ? &Tab::pickertime($round->blasted->set_time_zone($tourn->tz)) : "Not yet blasted" %>
			</span>

		</div>

%	}
	</div>

	<div class="left huge">

		<h2>
			<% $event->name %>
			<% ($round->label) ? $round->label : "R".$round->name %>: 
			<% &Tab::nicetime($start) %>
		</h2>

		<ul id="tabnav">

%			foreach my $allround (@rounds) {

%				my $realname = $allround->realname;
%				my $eventname = quotemeta $allround->event->name;
%				my $eventabbr = quotemeta $allround->event->abbr;
%				$realname =~ s/$eventname//g;
%				$realname =~ s/$eventabbr//g;
%				$realname =~ s/Round\ /Rd/g;
%				$realname =~ s/Doubles/Dubs/g;
%				$realname =~ s/\s//g;

%				my $test = $realname;
%				eval { $test = $test + 0; };
%				$realname = "R".$realname if $test;

%				if ($m->comp("/funclib/round_unbalanced.mas", round => $allround)) { 
					<li class="<% ($allround->id == $round->id) ? "selected" : "" %>warning">
%				} else { 
					<li class="<% ($allround->id == $round->id) ? "selected" : "" %>">
%				}

					<a href="show.mhtml?round_id=<% $allround->id %>"> 
						<% $realname %>
					</a>

				</li>
%			}

		</ul>

%		if ($round && not defined $preset) { 

%			if ($done) { 

% 				if ( $event->type eq "debate" || $event->type eq "policy" || $event->type eq "ld" || $event->type eq "pf") { 
					<& debate_results.mas, round => $round &>
%				}

% 				if ( $event->type eq "speech" ) { 
					<& speech_results.mas, round => $round &>
%				}

% 				if ( $event->type eq "congress" ) { 
					<& congress_results.mas, round => $round &>
%				}

% 				if ( $event->type eq "wudc" ) { 
					<& wudc_results.mas, round => $round &>
%				}

%			} else { 

%				my $admin++ if $account->id == 1;

%	 			if ( $event->type eq "speech" ) { 
					<& show_speech.mas, entry_only => $entry_only, round => $round, show => $show, admin => $admin &>
%				}

%	 			if ( $event->type eq "congress" ) { 
					<& show_congress.mas, entry_only => $entry_only, round => $round, show => $show, seeds => $seeds &>
%				}

%	 			if ( $event->type eq "wudc" ) { 
					<& show_wudc.mas, entry_only => $entry_only, round => $round, show => $show, seeds => $seeds &>
%				}

% 				if ( $event->type eq "debate" || $event->type eq "policy" || $event->type eq "ld" || $event->type eq "pf") { 
					<& show_debate.mas, entry_only => $entry_only, round => $round &>
%				}

%			}

%		}

%		if ($preset) { 
			<& preset_edit.mas, round => $round &>
%		} 	

	</div>


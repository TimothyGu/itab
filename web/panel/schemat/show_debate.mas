<%args>
	$round
	$debug => undef
	$sort_by => "letter"
</%args>
<%init>

	my $event = $round->event;
	my $anonymize if $event->setting("anonymize");

	my $tourn = $event->tourn;

	my @panels = sort {$a->flight cmp $b->flight} $round->panels;

	my @entries = $m->comp("/funclib/round_entries.mas", round => $round);
	my @ballots = $m->comp("/funclib/round_ballots.mas", round => $round);

	my %entries_by_panel = ();

	foreach my $entry (@entries) { 
		next if $entry->dropped;
		next if $entry->dq;
		push (@{$entries_by_panel{$entry->panelid}}, $entry);
		Tab::debuglog("Pushing ballot for entry ".$entry->id." into panel ".$entry->panelid);
		Tab::debuglog("Columns are ".$entry->columns);
	}

	my %ballots_by_entry = ();
	my %panel_undone = ();

	foreach my $ballot (@ballots) { 
		push (@{$ballots_by_entry{$ballot->entry->id}}, $ballot);
		$panel_undone{$ballot->panel->id}++ unless $ballot->audit;
	}

	my %judges_by_panel = ();

	Tab::log("No of judges: ".$round->judges);

	my @judges = $m->comp("/funclib/round_judges.mas", round => $round);

	foreach my $judge (@judges) { 
		push (@{$judges_by_panel{$judge->panelid}}, $judge);
		Tab::debuglog("Pushing ballot for judge ".$judge->id." into panel ".$judge->panelid);
	}

    my @rooms = $m->comp('/funclib/round_rooms.mas', round => $round);
	my %room_by_panel = (); 
	
	foreach my $room (@rooms) { 
		$room_by_panel{$room->panelid} = $room->name;
		Tab::debuglog("Pushing room ".$room->name." into panel ".$room->panelid);
	}   

	@panels = sort {$room_by_panel{$a->id} cmp $room_by_panel{$b->id}} @panels;

</%init>

	<table cellpadding="3" cellspacing="1" width="100%"> 
		
		<tr class="yellowrow">

			<td class="small centeralign smallcell">
			</td>

%			if ($round->flighted) { 
				<th>
					Flight
				</th>
%			}
			
			<th class="centeralign">
				<span class="block">
				Room
			</th>

			<th class="centeralign">
				<span class="block">
				Aff
			</th>

			<th class="centeralign">
				<span class="block">
				Neg
			</th>

			<th class="centeralign">
				<span class="block">
				Judge<% $round->judges > 1 ? "s" : "" %>
			</th>

			<th>
			</th>

		</tr>
		
%		my $switch;

% 		foreach my $panel (@panels) { 

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td class="small centeralign smallcell">
					<% $switch %>
				</td>
			
%				if ($round->flighted) { 
					<td class="centeralign">
						<% $panel->flight %>
					</td>	
%				}

				<td>
					<a class="white block" href="room_edit.mhtml?panel_id=<% $panel->id %>">
						<% ($room_by_panel{$panel->id}) ? $room_by_panel{$panel->id} : "Pick" %>
					</a>
				</td>

<%perl>
				my $aff;
				my $neg;

				foreach my $pc (@{$entries_by_panel{$panel->id}}) { 
					if ($ballots_by_entry{$pc->id}) { 
						$aff = $pc if ${$ballots_by_entry{$pc->id}}[0]->side eq "A";
						$neg = $pc if ${$ballots_by_entry{$pc->id}}[0]->side eq "N";
					}
				}
</%perl>

				<td class="centeralign">
%					if ($panel->bye) { 
						BYE:
%					} elsif ($aff) { 
						<a class="white block" href="/panel/aff_edit.mhtml?round_id=<% $round->id %>&aff_id=<% $aff->id %>">
							<% ($anonymize) ? $aff->id : $aff->code %>
						</a>
%					} 
				</td>

				<td class="centeralign">
%					if ($neg) { 
						<a class="white block" href="/panel/neg_edit.mhtml?round_id=<% $round->id %>&neg_id=<% $neg->id %>">
							<% ($anonymize) ? $neg->id : $neg->code %>
						</a>
%					}
				</td>

				<td class="centeralign">
					<a class="white block" href="panel_view.mhtml?panel_id=<% $panel->id %>">
%						foreach my $judge (@{$judges_by_panel{$panel->id}}) {
							<% $judge->last.", ".$judge->first %><% ($judge->chair) ? "*" : "" %>
% 						} 
					</a>
				</td>

				<th class="centeralign">
%					unless ($panel_undone{$panel->id}) { 
						IN
%					}
				</th>
			
			</tr>

%		}

	</table>



<%args>
	$tourn
	$account
	$panel_id
	$from => undef
	$judge_id => undef
</%args>
<%init>

	my $panel = Tab::Panel->retrieve($panel_id);
	my $switch;

	my $ncfl++ if $tourn->setting("ncfl");

	my $tourn_access = Tab::TournAdmin->search( account => $account->id, tourn => $tourn->id)->first;
	my $entry_only++ if $tourn_access && $tourn_access->entry_only;
	undef $entry_only if $account->site_admin;

	unless ($panel) { 
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $round = $panel->round;
	my @values = $m->comp("/funclib/panel_ballot_values.mas", panel => $panel);

	my $timeslot = $panel->round->timeslot;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $start = $timeslot->start->set_time_zone($tz);
	my $end = $timeslot->end->set_time_zone($tz);

	my $event = $panel->round->event;
	my $group = $event->judge_group;

	#judges currently assigned
	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel); 

	my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

	my @good_judges = $m->comp("/funclib/clean_judges.mas", panel => $panel);

	@good_judges = sort {$a->code cmp $b->code} @good_judges;	
	@good_judges = sort {$b->score <=> $a->score} @good_judges;	

	my @busy_judges = $m->comp("/funclib/clean_judges.mas", panel => $panel, stealable => "daveroberts");

	@busy_judges = sort {$a->code cmp $b->code} @busy_judges;	
	@busy_judges = sort {$b->score <=> $a->score} @busy_judges;	
	
	my $judge_hash = $m->comp("/funclib/judge_use.mas", round_id => $round->id);			
	my %used_by_judgeid = %{$judge_hash};

	my $affref;
	my $negref;
	my $diffref;
	($affref, $negref, $diffref) = $m->comp("/funclib/panel_ratings.mas", panel => $panel, type => $group->setting("prefs"));
		
</%init>

	<div class="left huge">

		<h2>Judge switch for round: <% $round->realname %> Panel: <% $panel->letter %> Event: <% $event->abbr %></h2>

		<h4>Judge(s) currently on panel</h4>
		
		<table cellspacing="1" cellpadding="5" width="100%">

			<tr class="yellowrow">

				<th class="smaller">
%					if ($event->type eq "congress") { 
						Parli
%					} else { 
						Chair
%					} 
				</th>

				<th class="smaller">
					Judge
				</th>

				<th class="smaller">
					School
				</th>

				<th class="smaller" colspan="2">
					Remove
				</th>

			</tr>

% 			foreach my $judge (@judges) { 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smaller centeralign" width="15px;">
						<% $judge->chair
							? "<a class=\"dkgreen fullblock\" href=\"chair_switch.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">Y</a>"
							: "<a class=\"dkred fullblock\" href=\"chair_switch.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">N</a>" %>
					</td>

					<td class="smallish" align="left">
						<% $judge->first %> <% $judge->last %>
					</td>

					<td class="smallish">
						<% ($judge->school) ? $judge->school->short_name : "HIRE" %>
					</td>

%					if (@values) { 

%						my $warn = "These ballots have scores entered.  If you remove the judge you will also delete those scores.  Continue?";

						<td class="centeralign smaller">
							<a class="dkred fullblock" <& "/funclib/confirm.mas", warn => $warn &>
							href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>">Remove</a>
						</td>
					
						<td class="centeralign smaller">
							<a class="dkred fullblock" <& "/funclib/confirm.mas", warn => $warn &>
							href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes">RM & Fine</a>
						</td>

%					} else { 

						<td class="centeralign smaller">
							<a class="dkred fullblock" href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>">Remove</a>
						</td>
					
						<td class="centeralign smaller">
							<a class="dkred fullblock" href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes">RM & Fine</a>
						</td>

%					} 


				</tr>

% 		}

		</table>
		
		<h4>Unused and available Judges</h4>
		
		<table cellspacing="1" cellpadding="5" width="100%">
			<tr class="yellowrow">
				<th class="smaller">Name</th>
				<th class="smaller">Owed</th>
				<th class="smaller">Oblig / Used / Scheduled</th>
				<th class="smaller">School</th>
				<th class="smaller">Aff</th>
				<th class="smaller">Neg</th>												
				<th class="smaller">Pref</th>												
				<th class="smaller">Mut</th>																
				<th class="smaller">Avg</th>				
				<th class="smaller">Add</th>				
				<th class="smaller">Replace</th>								
			</tr>
			
%			foreach my $judge (@good_judges) { 
			<tr>
				<td>
					<% $judge->first." ".$judge->last %>
				</td>
				<td>
%					unless($used_by_judgeid{$judge->id}{'judged_already'}) { $used_by_judgeid{$judge->id}{'judged_already'} = 0; }
%					unless($used_by_judgeid{$judge->id}{'will_judge'}) { $used_by_judgeid{$judge->id}{'will_judge'} = 0; }
					<% ($judge->obligation)-$used_by_judgeid{$judge->id}{'judged_already'}-$used_by_judgeid{$judge->id}{'will_judge'} %>
				</td>
				<td>
					<% $judge->obligation %>/<% $used_by_judgeid{$judge->id}{'judged_already'} %>/<% $used_by_judgeid{$judge->id}{'will_judge'} %>
				</td>
				<td>
					<% substr(&Tab::short_name($judge->schoolname),0,20) %>
				</td>
				<td>
					<% sprintf( "%.1f", ${$affref}{$judge->id} ) %>
				</td>
				<td>
					<% sprintf( "%.1f", ${$negref}{$judge->id} ) %>
				</td>
				<td>
%				if ( ${$affref}{$judge->id} > ${$negref}{$judge->id} ){
					<% sprintf( "%.1f", ${$affref}{$judge->id} ) %>
%				} else {
					<% sprintf( "%.1f", ${$negref}{$judge->id} ) %>
%				}
				</td>
				<td>
					<% sprintf( "%.1f", abs(${$negref}{$judge->id} - ${$affref}{$judge->id}) ) %>
				</td>
				<td>
					45.3
				</td>
				<td>
					<a class=\"dkgreen fullblock\" href=\"chair_switch.mhtml">Add</a>
				</td>
				<td>
					<a class=\"dkgreen fullblock\" href=\"chair_switch.mhtml">Replace</a>
				</td>

			</tr>
%			}			
		</table>
		
		<h4>Judges Current Assigned to other Debates</h4>

		<table cellspacing="1" cellpadding="5" width="100%">
		
		</table>

		<h4>Unavailable Judges</h4>

		<table cellspacing="1" cellpadding="5" width="100%">
		
		</table>

%		if ($account->site_admin) { 

			<br />

			<p style="text-align: center;" >
				<% $round->realname %> Section <% $panel->id %> Event <% $event->id %>
			</p>
%		}

	</div>

	<div class="right small">

		<h4>Adjustments</h4>
		<a href="speaker_order.mhtml?panel_id=<% $panel->id %>" class="yellow block">
			Back to Pairings
		</a>
		<form action="judge_add.mhtml" method="post">
		<input type="hidden" name="panel_id" value="<% $panel->id %>">
		<span class="greynohover block">
			Max Mut:
			<input type="text" size="5" class="thin" name="MaxMut" ><br>
			Max Pref:
			<input type="text" size="5" class="thin" name="MaxPref" ><br>
			<input type="submit" value="Go" class="thin padno">
		</span>
		</form>

	</div>

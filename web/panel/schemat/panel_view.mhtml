<%args>
	$session
	$tourn
	$account
	$panel_id
	$from => undef
	$judge_id => undef
</%args>
<%init>

	my $panel = Tab::Panel->retrieve($panel_id);

	my $ncfl++ if $tourn->setting("ncfl");

	unless ($panel) { 
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $round = $panel->round;

	my @values = $m->comp("/funclib/panel_ballot_values.mas", panel => $panel);

	my $timeslot = $panel->round->timeslot;
	my $start = $timeslot->start;
	my $end = $timeslot->end;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	$start->set_time_zone($tz);
	$end->set_time_zone($tz);

	my $event = $panel->round->event;
	my $group = $event->judge_group;

	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);
	my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

	my $coach_ratings++ if $group->setting("coach_ratings");
	my $tab_ratings++ if $group->setting("tab_ratings");
	my $no_judge_codes++ if $group->setting("no_codes");
	my $no_school_codes++ if $tourn->setting("school_codes") eq "none";

	my %rating_by_judge = ();

	if ($coach_ratings) { 

		my @ratings = $m->comp("/funclib/group_ratings.mas", event => $event);

		my @tiers = $group->rating_tiers;
		my %tier_names = ();

		foreach my $tier (@tiers) { 
			$tier_names{$tier->id} = $tier->name;
		}

		foreach my $rating (@ratings) { 
			$rating_by_judge{$rating->judge->id} = $tier_names{$rating->rating_tier->id} if $rating && $rating->rating_tier;
		}

	}

	my $room = $panel->room;
	my @good_judges = $m->comp("/funclib/clean_judges.mas", panel => $panel);

	my $judge_indicator;

	@good_judges = sort {$a->code cmp $b->code} @good_judges;	
	@good_judges = sort {$b->score <=> $a->score} @good_judges;	
	@good_judges = sort {$rating_by_judge{$a->id} cmp $rating_by_judge{$b->id}} @good_judges if $coach_ratings;	
	@good_judges = sort {length($rating_by_judge{$b->id}) <=> length($rating_by_judge{$a->id})} @good_judges if $coach_ratings;	
	@good_judges = sort {$b->tab_rating <=> $a->tab_rating} @good_judges if $tab_ratings;
	@good_judges = sort {$b->standby cmp $a->standby} @good_judges;

</%init>

	<div class="left huge">

		<h2>Round <% $round->name %> Section <% $panel->letter %> of <% $event->abbr %></h2>

		<h4>Judges</h4>
		
		<table cellspacing="1" cellpadding="5" width="100%">

			<tr class="yellowrow">

				<th class="smaller">
%					if ($event->type eq "congress") { 
						Parli
%					} else { 
						Chair
%					} 
				</th>

				<th class="smaller">
					Judge
				</th>

% 				if ($coach_ratings || $tab_ratings) { 
					<th class="smaller">
						Rate
					</th>
%				}

%				if ($ncfl) { 
					<th class="smaller">
						Dio
					</th>
%				}

				<th class="smaller">
					School
				</th>

				<th class="smaller" colspan="2">
					Remove
				</th>

			</tr>

% 			my $switch;

% 			foreach my $judge (@judges) { 

%				my $rating_name = $rating_by_judge{$judge->id};

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smaller centeralign" width="15px;">
						<% $judge->chair
							? "<a class=\"dkgreen block\" href=\"chair_switch.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">Y</a>"
							: "<a class=\"dkred block\" href=\"chair_switch.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">N</a>" %>
					</td>

					<td class="smallish" align="left">
						<a class="white block" href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>"> 
							<% ($no_judge_codes) ? "" : $judge->code  %>
							<% $judge->first." ".$judge->last %>
							(<% scalar $m->comp("/funclib/judge_follower.mas", judge => $judge) %> followers)
						</a>
					</td>

% 					if ($coach_ratings) { 
						<td class="smallish" align="center">
							<% $rating_name %>
						</td>
% 					}

% 					if ($tab_ratings) { 
						<td class="smallish" align="center">
							<% $judge->tab_rating %>
						</td>
% 					}

%					if ($ncfl) { 
						<td class="smallish" align="center">
							<% $judge->school->region->code %>
						</td>
%					}

					<td class="smallish">
						<% ($judge->school) ? $judge->school->short_name : "HIRE" %>
					</td>

%					if (@values) { 

%						my $warn = "These ballots have scores entered.  If you remove the judge you will also delete those scores.  Continue?";

						<td class="centeralign smaller">
							<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &>
							href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>">Remove</a>
						</td>
					
						<td class="centeralign smaller">
							<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &>
							href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes">RM & Fine</a>
						</td>

%					} else { 

						<td class="centeralign smaller">
							<a class="dkred block" href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>">Remove</a>
						</td>
					
						<td class="centeralign smaller">
							<a class="dkred block" href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes">RM & Fine</a>
						</td>

%					} 


				</tr>

% 		}

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<th class="smallish rightalign" style="padding-top: 13px;" colspan="7">

					<span class="eighty ">
						Add judge:
					</span>
					
					<span class="inline ">

					<form action="judge_add.mhtml" method="post">
					<input type="hidden" name="panel_id" value="<% $panel_id %>">
					<input type="hidden" name="from" value="<% $from %>">
					<select name="judge_id" onchange='this.form.submit()'>

						<option value="">------------------------------------<% $no_school_codes ? "------------------" : "" %></option>
<%perl>

						my $is_not_standby;
						my $not_yet = 1;

	 					foreach my $judge (@good_judges) { 

							my $rating = "-";

							if ($coach_ratings) { 
								$rating = $rating_by_judge{$judge->id} if $rating_by_judge{$judge->id};
								foreach ( length($rating) .. 3) {
									$rating .= "&nbsp;";
								}
							}

							if ($tab_ratings) { 
								$rating = $judge->tab_rating;
								foreach ( length($rating) .. 3) {
									$rating .= "&nbsp;";
								}
							}

							my $school;

							if ($no_school_codes) { 
								$school = substr(&Tab::short_name($judge->schoolname),0,20);
								foreach ( length($school) .. 20) {
									$school .= "&nbsp;";
								}

							} else { 

								$school = substr($judge->schoolcode,0,8);
								foreach ( length($school) .. 9) {
									$school .= "&nbsp;";
								}

							}

							my $code;
							unless ($no_judge_codes) { 
								$code = $judge->code;
								foreach ( length($code) .. 5) {
									$code .= "&nbsp;";
								}
							}

							my $regcode;
							if ($ncfl) {
								$regcode = $judge->regcode;
								foreach ( length($regcode) .. 4) {
									$regcode .= "&nbsp;";
								}
							}

</%perl>

%							if ($judge->standby && $not_yet) { 
								<optgroup label="Judges in standby pool:">
%									undef $not_yet;
								</optgroup>

								<optgroup class="key" label="&nbsp;&nbsp;Rds  Own  <% ($coach_ratings) ? "Rtng" : "" %> <% ($ncfl) ? "Dio" : "" %> &nbsp;&nbsp;Judge">
								</optgroup>
%							}

%							unless ($is_not_standby || $judge->standby || $not_yet) { 
								<optgroup label="Judges not in standby pool:">
								</optgroup>

								<optgroup class="key" label="&nbsp;&nbsp;Rds  Own  <% ($coach_ratings) ? "Rtng" : "" %> <% ($ncfl) ? "Dio" : "" %> &nbsp;&nbsp;Judge">
								</optgroup>
%								$is_not_standby++ unless $judge->standby;
%							} 

%							if ($not_yet &! $is_not_standby) { 
								<optgroup class="key" label="&nbsp;&nbsp;&nbsp;Rds&nbsp;&nbsp;Own  <% ($coach_ratings) ? "Rtng" : "" %> <% ($ncfl) ? "&nbsp;Dio" : "" %> &nbsp;&nbsp;Judge">
								</option>
%								undef $not_yet;
%								$is_not_standby++;
%							}

							<option value="<%$judge->id %>">
 
								<% $judge->tmp ? $judge->tmp : 0 %>
								&nbsp;

								<% $judge->score ? $judge->score : 0 %>
								&nbsp;

								<% $rating %>
								<% $regcode %>
%								my $school_name = substr(Tab::short_name($judge->schoolname), 0, 10);
%								$school_name =~ s/\s+$//;

								<% $school_name %>

%								unless ($ncfl) { 
%									foreach (length($school_name) .. 11 ) { 
%										$m->print("&nbsp;");
%									}
%								}

								<% $code %>
								<% $judge->first." ".$judge->last %>

							</option>
	
% 						} 

					</select> 
					</span>

					<noscript>
					<input  type="submit" value="Add">
					</noscript>
					</form>


				</td>

			</tr>

		</table>

		<h4><% scalar @entries %> Entries</h4>

		<table cellspacing="1" cellpadding="4" width="100%">

			<tr class="yellowrow">

%				if ($event->type eq "speech") { 
					<th class="smaller">
						Spks
					</th>
%				} elsif ($event->type eq "wudc") { 
					<th class="smaller">
						Pos
					</th>
%				} elsif ($event->type eq "congress") { 

%				} else { 
					<th class="smaller">
						Side
					</th>
%				} 

				<th class="smaller">
					Entry
				</th>

				<th class="smaller">
					School
				</th>

%				if ($tourn->setting("ncfl")) {
					<th class="smaller">
						Dio
					</th>
%				}

				<th colspan="2">
				</th>


			</tr>

% 		$switch = 1;

% 		foreach my $entry (@entries) { 

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

%				if ($event->type eq "speech") { 
					<td class="smallish">
						<% $entry->speaks ? Lingua::EN::Numbers::Ordinate::ordinate($entry->speaks) : "" %>
					</td>
%				} elsif ($event->type eq "wudc") { 
					<td class="smallish">
						<% $entry->speaks == 1 ? "OG" : "" %>
						<% $entry->speaks == 2 ? "OO" : "" %>
						<% $entry->speaks == 3 ? "CG" : "" %>
						<% $entry->speaks == 4 ? "CO" : "" %>
					</td>
%				} elsif ($event->type eq "congress" ) { 

%				} else { 

					<td class="smallish">
						<% $entry->side == 1 ? "Aff" : ""%>
						<% $entry->side == 2 ? "Neg" : ""%>
					</td>
%				} 

				<td class="smallish">
					<a class="white block" href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
%						unless ($event->setting("code_style") eq "names") {
							<% ($entry->dq) ? "DQ" : $entry->code %>
%						}
%						unless ($event->setting("code_style") eq "names_lastfirst") {
							<% $entry->name %>
%						}
						(<% scalar $m->comp("/funclib/entry_follower.mas", entry => $entry) %> followers)
					</a>
				</td>
					
				<td class="smallish">
					<% $entry->school->short_name %> 
				</td>

				<% ($entry->school->code) ? "<td class=\"smallish\">".$entry->school->code."</td>" : "" %>

%				if ($tourn->setting("regions") || $ncfl) {

					<td class="smallish centeralign">
						<% ($entry->school->region) ? $entry->school->region->code : "" %>
					</td>

%				}

				<td class="smallish centeralign">
					<a class="dkgreen block" href="/panel/manipulate/entry_edit.mhtml?entry_id=<%$entry->id%>&round_id=<% $round->id %>">Move</a>
				</td>

			</tr>

% 		}

		</table>


%		if ($account->site_admin) { 

			<br />

			<p style="text-align: center;" >
				Round <% $round->id %> Section <% $panel->id %> Event <% $event->id %>
			</p>
%		}

	</div>

	<div class="right small">

		<div class="sidenote">

			<h4>Pairings/Printouts</h4>

			<a class="blue block" href="show.mhtml?round_id=<% $round->id %>">
				<% $event->abbr %> Round <% $round->name %> Pairing
			</a>

			<a class="blue block" href="/panel/report/master_single.mhtml?panel_id=<% $panel->id %>">
				Print Master Ballots
			</a>

			<a class="blue block" href="/panel/report/posting.mhtml?panel_id=<% $panel->id %>">
				Print Round Posting
			</a>

			<a class="blue block" href="/panel/schemat/panel_blast.mhtml?panel_id=<% $panel->id %>">
				Text/email blast this section
			</a>

		</div>

		<div class="sidenote">

%			if ($round->flighted > 1) { 
				<h4>Flight</h4>

				<span class="evenrow block centeralign">
					<form action="panel_flight_save.mhtml" method="post">
					<input type="hidden" name="panel_id" value="<% $panel_id %>">
					<select name="flight" onchange='this.form.submit()' class="fixedsmall">  
						<option value="">None</option>
%					foreach my $flight ( 1 .. $round->flighted ) { 	
						<option value="<% $flight %>" <% $flight == $panel->flight ? "selected" : "" %>>
							<% $flight %>
						</option>
%					}
				</select>
				</form>
			</span>

%			}

			<h4>Room</h4>

			<span class="evenrow block centeralign">
				<form action="panel_room_save.mhtml" method="post">
				<input type="hidden" name="panel_id" value="<% $panel_id %>">
				<select name="room_id" onchange='this.form.submit()' class="fixedsmall">  

%					if ($panel->room) { 
						<option value="<% $panel->room->id %>" "selected"><% $room->name %></option>
%					}

%					foreach my $room ($m->comp("/funclib/clean_rooms.mas", panel => $panel)) { 
						<option value="<% $room->id %>"><% $room->name %></option>
%					}

				</select>
				</form>
			</span>

			<h4>Time</h4>

			<table cellpadding="4" cellspacing="1" width="100%">
		
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						Starts: 
					</td>

					<td class="centeralign smallish">
						<% &Tab::niceshortdt($start) %> 
					</td>
				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
	
					<td class="smallish">
						Ends
					</td>	

					<td class="centeralign smallish">
						<% &Tab::niceshortdt($end) %> 
					</td>

				</tr>

			</table>

%			if ($round->pool) {
				<h4>Judge Pool</h4>
				<a class="blue block" href="/panel/judge/pool.mhtml?pool_id=<% $round->pool->id %>">
					<% $round->pool->name %>
				</a>
%			}

		</div>

		<div class="sidenote">

			<h4>Make Changes</h4>
%			if ($event->type eq "speech" || $event->type eq "congress") { 
				<a href="speaker_order.mhtml?panel_id=<% $panel->id %>" class="yellow block">
					Change Speaker Order
				</a>
%			} else { 
				<a href="debate_sides.mhtml?panel_id=<% $panel->id %>" class="yellow block">
					Change Sides
				</a>
%			} 

			<a href="/tabbing/entry/panel.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				View/Edit Ranks
			</a>

% 			unless (@judges || @entries) { 
				<a href="panel_rm.mas?panel_id=<% $panel_id %>" class="dkred block">Delete Section</a>
% 			}

			<form action="judge_add.mhtml" method="post">
			<input type="hidden" name="panel_id" value="<% $panel->id %>">
			<span class="greynohover block">
				Force add judge
				<input type="text" size="5" class="thin" name="code" placeholder="Code">
				<input type="submit" value="Go" class="thin padno">
			</span>
			</form>
	
		</div>

	</div>


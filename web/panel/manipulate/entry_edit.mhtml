<%args>
	$tourn
	$entry_id => undef
	$round_id => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id);
	my $entry = Tab::Entry->retrieve($entry_id);

	my $school_id = $entry->school->id if $entry && $entry->school;

	my @panels = $round->panels;

	my %panel_same_hits;
	my %panel_school_hits;
	my %panel_judge_hits;
	my %panel_score;
	
	Tab::Panel->set_sql( same_hits => "
		select count(distinct p2e2.entry)
			from ballot p2e1, ballot p2e2
			where p2e1.entry = ? 
			and p2e2.entry != p2e1.entry
			and p2e2.panel = p2e1.panel
			and p2e2.entry in 
			 	(select ballot.entry 
					from ballot where ballot.panel = ?)
	");

	Tab::Panel->set_sql( same_school_hits => "
		select count(distinct entry.id) 
			from entry, ballot
			where ballot.entry = entry.id
			and entry.school = ? 
			and ballot.panel = ?
		");  #my head hurts.

	foreach my $panel (@panels) { 

		$panel_same_hits{$panel->id} = Tab::Panel->sql_same_hits->select_val($entry_id, $panel->id);
		$panel_school_hits{$panel->id} = Tab::Panel->sql_same_school_hits->select_val($school_id, $panel->id);

		foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

			if ($panel->round->type ne "elim" && $panel->round->type ne "final") {
				$panel_judge_hits{$panel->id}++ unless $m->comp("/funclib/clean_to_judge.mas", judge => $judge, entry => $entry);
			} else { 
				my $type = $m->comp("/funclib/clean_to_judge.mas", judge => $judge, entry => $entry);
				$panel_judge_hits{$panel->id}++ unless $type eq "prelim" || $type eq "1";
			}
		}

		$panel_score{$panel->id} = (10000 * $panel_judge_hits{$panel->id}) + (100 * $panel_school_hits{$panel->id}) + ($panel_same_hits{$panel->id});

	}
	
	@panels = sort {$panel_score{$a->id} <=> $panel_score{$b->id}} @panels;


</%init>

	<div class="small right">

		<div class="sidenote">

			<h4>Navigation</h4>

				<a class="blue block nowrap" href="/panel/schemat/show.mhtml?round_id=<% $round->id %>&show=yes">
					<% $round->realname %> <% $round->event->abbr %> Schemat
				</a>

				<a class="blue block nowrap" href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
					<% $entry->code %> <% $entry->name %> info
				</a>


			<h4>Entry Details</h4>


		</div>

	</div>

	<div class="left huge">

		<& /funclib/tablesorter.mas, table => "sortme" &>

		<h2>Move competitor <% $entry->school->code %> <% $entry->code %> </h2>

			<table cellpadding="4" cellspacing="1" id="sortme">

				<thead>

					<tr class="yellowrow">

						<th class="smallish">
							Room
						</th>

						<th class="smallish">
							Judges
						</th>

						<th class="smallish">
							Entries
						</th>

						<th class="smallish">
							Hits
						</th>

						<th class="smallish">
							School
						</th>

						<th class="smallish">
							Choose
						</th>

					</tr>

				</thead>

				<tbody>


%					foreach my $panel (@panels) { 

%						my $mine;

						<tr>

							<td class="smallish">
								<% $panel->room ? $panel->room->name : "" %>
							</td>

							<td class="smallish">
%								foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
									<span class="padno hundo nowrap block <% $panel_judge_hits{$panel->id} ? "strike" : "plain" %>">
										<a class="plain padno" href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>">
											<% $judge->school ? $judge->school->code : "HIRE" %>
											<% $judge->first." ".$judge->last %>
										</a>
									</span>
%								}

							</td>

							<td class="smallish">

%								foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) { 

									<a class="plain" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">

%										my $mine++ if $entry->id == $entry_id;

										<span class="padno smallspan nowrap 
											<% $entry->id == $entry_id ? "dkgreen" : "" %>" <% $entry->school->id == $school_id ? "dkred" : "" %>" 
											style="padding-left: 3px; width: 47px;">
											<% $entry->school->code %><% $entry->code %>
										</span>
									</a>
%								}

							</td>

							<td class="smallish centeralign">
								<% $panel_same_hits{$panel->id} %>
							</td>

							<td class="smallish centeralign">
								<% $panel_school_hits{$panel->id} %>
							</td>

							<td class="smallish">
%								unless ($panel_judge_hits{$panel->id} || $mine) { 
									<a class="dkgreen nowrap block" href="entry_move.mhtml?entry_id=<% $entry->id %>&panel_id=<% $panel->id %>">
										Move Into
									</a>
%								}
							</td>

						</tr>

%					}

				</tbody>

			</table>

	</div>



	

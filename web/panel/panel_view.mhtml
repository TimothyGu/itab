<%args>
	$session
	$circuit
	$tourn
	$account
	$panel_id
	$from => undef
	$judge_id => undef
</%args>
<%init>

	my $panel = Tab::Panel->retrieve($panel_id);

	unless ($panel) { 
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $round = $panel->round;

	my $timeslot = $panel->round->timeslot;
	my $start = $timeslot->start;
	my $end = $timeslot->end;
	$start->set_time_zone($tourn->tz);
	$end->set_time_zone($tourn->tz);
	my $event = $panel->event;
	my @judges = $panel->judges;
	my @entries = $panel->entries;

	my $room = $panel->room;
	my @good_judges = $m->comp("/funclib/clean_judges.mas", 
		panel_id => $panel_id, 
		session => $session );

	my $judge_indicator;

	@good_judges = sort {$a->code cmp $b->code} @good_judges;	
	@good_judges = sort {$b->score cmp $a->score} @good_judges;	
	@good_judges = sort {$a->qual cmp $b->qual} @good_judges;	

	my %is_standby = ();

	foreach my $pool ($timeslot->standby_pools) { 

		foreach my $judge ($pool->judges) { 
			$is_standby{$judge->id} = 1;
			$judge->score("S");
		}

	}

	@good_judges = sort {$is_standby{$b->id} <=> $is_standby{$a->id}} @good_judges;	

</%init>

	<h2>Round <% $round->name %> Panel <% $panel->letter %> of <% $event->abbr %></h2>

	<div class="left huge">


%			if ($from eq "entry") { 

				<td>
					<form action="<% $Tab::url_prefix %>/tabbing/rank.mhtml" method="post">
					<input type="hidden" value="<% $panel->round->timeslot->id %>" name="timeslot_id">

%					if (@judges && scalar @judges == 1) { 
						<input type="hidden" value="<% $judges[0]->id %>" name="judge_id">
%					}

 					<input  type="submit" value="Return to Rank Entry" align="right">
					</form>
				</td>

%			}

		<h3>Judges:</h3>
		
		<table cellspacing="1" cellpadding="5" width="100%">

			<tr class="liblrow">

				<th class="smaller">
					Judge
				</th>

% 				if ($event->judge_group->coach_ratings) { 
					<th class="smaller">
						Qual
					</th>
%				}

%				if ($tourn->setting("ncfl")) { 
					<th class="smaller">
						Dio
					</th>
%				}

				<th class="smaller">
					School
				</th>

				<th class="smaller" colspan="2">
					Remove
				</th>

%				if (scalar @judges > 1) { 
					<th class="smaller">
						Chair?
					</th>
%				}

			</tr>

% 			my $switch;

% 			foreach my $judge (@judges) { 

%				my $block = "white block" if $switch % 2;
%				$block = "white block" unless $switch % 2;

%	 			my $j_school = $judge->school;
%				my $rating = $judge->rating($event);
%				$rating = $judge->rating unless $rating;
%   			my $qual = $rating->qual if $rating;

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td class="smaller" align="left">
						<a class="<% $block %>" href="/register/judge_edit.mhtml?judge_id=<% $judge->id %>"> 
							<% $judge->code %>
							<% $judge->first." ".$judge->last %>
						</a>
					</td>

% 					if ($event->judge_group->coach_ratings) { 
						<td class="smaller" align="center">
							<% ($qual) ? $qual->name : "" %>
						</td>
% 					}

%					if ($tourn->setting("ncfl")) { 

						<td class="smaller" align="center">
							<% $judge->school->region->code %>
						</td>

%					}

					<td class="smaller">
						<% ($judge->school) ? $judge->school->short_name : "HIRE" %>
					</td>

					<td class="smaller" align="center">
						<a class="<% $block %>" href="/panel/judge_rm.mas?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>">w/o Fine</a>
					</td>
					
					<td class="smaller" align="center">
						<a class="<% $block %>" href="/panel/judge_rm.mas?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes">w/Fine</a>
					</td>


%					if (scalar @judges > 1) { 

						<td class="smaller" align="center">
							<% $judge->is_chair($panel) 
								? "<b>Yup</b>" 
								: "<a class=\"".$block."\" href=\"make_chair.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">No</a>" %>
						</th>

%					}

				</tr>

% 		}

		</table>


		<h3> Add Judge: </h3>

		<table cellspacing="1" cellpadding="5" width="100%">

			<tr class="liblrow">

				<td class="smaller">
					Clean judges:
				</td>

				<td>
					<form action="panel_judgeadd.mas" method="post">
					<input type="hidden" name="panel_id" value="<% $panel_id %>">
					<input type="hidden" name="from" value="<% $from %>">
					<select name="judge_id"> 

						<option value="">Rds  Kids  <% ($event->judge_group->coach_ratings) ? "Qual" : "" %> <% ($tourn->setting("ncfl")) ? "Dio" : "" %> &nbsp;&nbsp;Judge</option>
						<option value="">------------------------------------</option>

%	 					foreach my $judge (@good_judges) { 

%							my $qual = $judge->qual;
%							$qual .= "&nbsp;";

%							my $schcode = $judge->schcode;
%							my $score = $judge->score;
%           				my $tmp = $judge->tmp;
%			   				my $code = $judge->code;

%							foreach ( length($schcode) .. 4) {
%								$schcode .= "&nbsp;";
%							}


							<option value="<%$judge->id %>">
 
								&nbsp;<% $tmp %>
								&nbsp;

								<% $score %>
								&nbsp;&nbsp;

								<% ($judge->qual) ? $qual : "" %>&nbsp;

								<% $schcode %> 
								<% $code %>&nbsp;
	
								<% $judge->first." ".$judge->last %>

								<% ($is_standby{$judge->id}) ? "STANDBY" : "" %>

							</option>
	
% 						} 

					</select> 

				</td>

				<td class="right">
					<input  type="submit" value="Add">
					</form>
				</td>

			</tr>

			<tr class="lirdrow">

				<td class="smaller">
					Force add judge:
				</td>

				<td align="left">
					<form action="panel_judgeadd.mas" method="post">
					<input type="hidden" name="panel_id" value="<% $panel_id %>">
					Enter numeric code:
					<input type="text" name="judge_code" value="" size="5">
				</td>

				<td align="right">
					<input  type="submit" value="Add">
					</form>
				</td>

			</tr>

		</table>

		<h3> Students </h3>

		<table cellspacing="1" cellpadding="4" width="100%">

			<tr class="liblrow">

				<th class="smaller">
					Spks
				</th>

				<th class="smaller">
					Entry
				</th>

				<th class="smaller">
					School
				</th>

%				if ($tourn->setting("ncfl")) {
					<th class="smaller">
						Dio
					</th>
%				}

				<th colspan="2">
				</th>


			</tr>

% 		$switch = 1;

% 		foreach my $entry (@entries) { 

%			my $block = "white block" if $switch % 2;
%			$block = "white block" unless $switch % 2;

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td class="smaller">
					<% Lingua::EN::Numbers::Ordinate::ordinate($entry->speaks) %>
				</td>

				<td class="smaller" align="left">
					<a class="<% $block %>" href="/register/entry_edit.mhtml?entry_id=<% $entry->id %>">
						<% ($entry->dq) ? "DQ" : $entry->code %>
						<% $entry->team_name %>
					</a>
				</td>
					
				<td class="smaller">
					<% $entry->school->short_name %> 
				</td>

				<% ($entry->school->code) ? "<td>".$entry->school->code."</td>" : "" %>

%				if ($tourn->setting("regions") || $tourn->setting("ncfl")) {

					<td class="smaller" align="center">
						<% ($entry->school->region) ? $entry->school->region->code : "" %>
					</td>

%				}

				<td align="center">
					<a class="<% $block %>" href="/panel/entry_edit.mhtml?entry_id=<%$entry->id%>&round_id=<% $round->id %>">Move</a>
				</td>

			</tr>

% 		}

		</table>


%		if ($account->site_admin) { 

			<br />

			<p style="text-align: center;" >
				Round <% $round->id %> Panel <% $panel->id %> Event <% $event->id %>
			</p>
%		}

	</div>

	<div class="right small">

		<a href="schemat_show.mhtml?round_id=<% $round->id %>" class="blue block">Round <% $round->name %> Schematic</a>
		<a href="schemat_show.mhtml?event_id=<% $event->id %>" class="blue block"><% $event->name %> Full Schematic</a>

		<h3> Panel Info  </h3>

		<table cellpadding="4" cellspacing="1" width="100%">
		
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Starts: 
				</td>

				<td class="center">
					<% &Tab::niceshortdt($start) %> 
				</td>
			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Ends
				</td>

				<td class="center">
					<% &Tab::niceshortdt($end) %> 
				</td>
			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				<td>
					Room
				</td>

				<td class="center">
					<% ($panel->room) ? $panel->room->name : "" %>
				</td>
			</tr>

		</table>

		<hr>
			<a class="blue block" href="<% $Tab::url_prefix %>/panel/print_one_master.mhtml?panel_id=<% $panel->id %>">Print Master Ballots</a>
			<a class="blue block" href="<% $Tab::url_prefix %>/panel/print_posting.mhtml?panel_id=<% $panel->id %>">Print Round Posting</a>
		<hr>

			<a href="manual_assign.mhtml?panel_id=<% $panel->id %>" class="red block">Alter Speakers in Section</a>
			<a href="speaker_order.mhtml?panel_id=<% $panel->id %>" class="red block">Change Speaker Order</a>

		<hr>
			<a href="/tabbing/panel_card.mhtml?panel_id=<% $panel->id %>" class="red block">
				View/Edit Ranks
			</a>

% 			unless (@judges || @entries) { 
				<a href="panel_rm.mas?panel_id=<% $panel_id %>" class="red block">Delete Panel</a>
% 			}

	</div>

	<div style="clear: both;">

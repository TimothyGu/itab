<%args>
	$username => undef
	$password => undef
	$round => undef
</%args>
<%init>
	use Crypt::PasswdMD5;
	use XML::Simple;
	use Data::Dumper;

	my ($account) = Tab::Account->search( email => lc($username) );

	unless ($account) { 
		$m->print("<error>No account with the email ".$username." was found.</error>");
		$m->abort;
	} 

	$password =~ s/\s+$//g;
	my $db_password = $account->passhash;
   	my $verify_password = unix_md5_crypt($password,$db_password);
   
   	unless ($verify_password eq $db_password) { 
		$m->print("<error>Password incorrect for ".$username.".</error>");
		$m->abort;
	}
	
	my $round = Tab::Round->retrieve($round_id);
	my $event = $round->event;
	my $tourn = $event->tourn;

	unless ($round) { 
		$m->print("NO_SUCH_ROUND");
		$m->abort;
	}

	unless ($tourn) { 
		$m->print("NO_SUCH_TOURNAMENT");
		$m->abort;
	}

	unless ($account->site_admin || Tab::TournAdmin->search( tourn => $tourn->id, account => $account->id )) { 
		$m->print("TOURN_ACCESS_DENIED");
		$m->abort;
	}

	my $panels = [];
	my $ballots = [];
	my $scores = [];

	foreach my $panel ($round->panels) { 

		my $room = $panel->room->id if $panel->room;
		
		my $xml_panel = {
			ID => $panel->id,
			ROUND => $round->id,
			ROOM => $room,
			FLIGHT => $panel->flight
		};

		push (@{$panels}, $xml_panel);

		foreach my $ballot ($panel->ballots) { 

			my $judge = $ballot->judge->id if $ballot->judge;
			my $entry = $ballot->entry->id if $ballot->entry;

			my $xml_ballot = {
				ID => $ballot->id,
				JUDGE => $judge,
				PANEL => $panel->id,
				ENTRY => $entry,
				SIDE => $ballot->side
			};

			push (@{$ballots}, $xml_ballot);

			foreach my $score ($ballot->values) { 

				if ($score->tag eq "Ballot") { 

					my $xml_score = {
						ID => $score->id,
						BALLOT => $ballot->id,
						RECIPIENT => $entry,
						SCORE_ID => 1,
						SCORE => $score->value
					};

					push (@{$scores}, $xml_score);
			
				} elsif ($score->tag eq "Ranks") { 
					
					my $student = $score->student->id if $score->student;

					my $xml_score = {
						ID => $score->id,
						BALLOT => $ballot->id,
						RECIPIENT => $student,
						SCORE_ID => 3,
						SCORE => $score->value
					};
			
					push (@{$scores}, $xml_score);

				} elsif ($score->tag eq "Points") { 
					
					my $student = $score->student->id if $score->student;

					my $xml_score = {
						ID => $score->id,
						BALLOT => $ballot->id,
						RECIPIENT => $student,
						SCORE_ID => 2,
						SCORE => $score->value
					};
					
					push (@{$scores}, $xml_score);
			
				}

			}

		}

	}

	my $xml_round = {
		ID => $round->id,
		EVENT => $round->event->id,
		TIMESLOT => $round->timeslot->id,
		TB_SET => $round->tb_set->id,
		RD_NAME => $round->name,
		LABEL => $round->realname,
		FLIGHTING => $round->flighted,
		JUDGESPERPANEL => $round->judges
	};


	my $xml_hash = {
		ROUND => $xml_round,
		PANEL => $panels,
		BALLOT => $ballots,
		BALLOT_SCORE => $scores
	};

	my $filename = "RoundData-$round_id";
	my $filepath = $Tab::file_root."tmp/".$filename;
	`rm -f $filepath.*`; 

	my $xs = new XML::Simple();
	my $xml = $xs->XMLout($xml_hash, RootName => 'ROUNDRESULTS', NoAttr => 1, XMLDecl => 1, OutputFile => "$filepath.xml");

	$m->redirect("$Tab::url_prefix/tmp/$filename.xml");
	
</%init>

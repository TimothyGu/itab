<%args>
	#Pass in an account and password
	$username => undef
	$password => undef
	
</%args>
<%init>

	use Crypt::PasswdMD5;

	my $now = DateTime->now;

	#Check Account
	my ($account) = Tab::Account->search( email => lc($username) );
	unless ($account) {
		$m->print("NO_SUCH_ACCOUNT");
		$m->abort;
	}	

	#Check Password
	#$password =~ s/\s+$//g;
	#my $db_password = $account->passhash;
	#my $verify_password = unix_md5_crypt($password,$db_password);

	#unless($verify_password eq $db_password) {
	#	$m->print("PASSWORD_WRONG");
	#	$m->abort;
	#}

	#Initiate new XML
	use XML::Simple;
	my $xs = new XML::Simple();

	#Print the start of the XML
	$r->content_type("application/xml");
	$m->print("<?xml version='1.0' standalone='yes'?>\r\n");
	$m->print("<ROUNDS>\r\n");

	#Set SQL for searching entries by student first/last
	Tab::Entry->set_sql ( by_student => "
		select distinct entry.*
		from entry, entry_student, student, event, tourn
		where student.last = ?
		and student.first = ?
		and student.id = entry_student.student
		and entry_student.entry = entry.id
		and entry.event = event.id
		and event.tourn = tourn.id
		order by tourn.start desc
	");

	#Get the entries for the debater with first/last from account
	my @entries = Tab::Entry->search_by_student($account->last, $account->first);

	my @panels;

	#Get panels (rounds) for each entry and store in array
	foreach my $entry (@entries) {
		my $entryid = $entry->id;
		Tab::Panel->set_sql( by_entry => "
			select distinct panel.*
			from panel, ballot, round
			where ballot.entry = $entryid
			and ballot.panel = panel.id
			and panel.round = round.id
			and round.published = 1
			order by round.name desc
		");
		
		push( @panels, Tab::Panel->search_by_entry() );
	}

	foreach my $panel (@panels) {

		next unless $panel->round;
		#Get date of round, split out the time
		my $startdate = $panel->round->event->tourn->start if $panel->round->event;
		next unless $startdate;
		my @datearray = split(/"T"/, $startdate);
		$startdate = $datearray[0];

		#Get tournament name (use UC webname for ease of reading) and round number
		my $tourn = ucfirst($panel->round->event->tourn->webname);
		my $roundname = $panel->round->name;
		my $roundside;
		my $oppschool;
		my $oppname;		
		my $accountschool;

		#Get opposing school, opponent name, and side
		foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) {
			my $moi;
		
			#Find school for passed in account
			foreach my $student ($entry->students) {
				if ($student->last eq $account->last && $student->first eq $account->first) {
					$accountschool = $entry->school->short_name;
					$moi++;
				}
			}

			#Loop through students for each entry - set the side, and if opponent, save their name 
			foreach my $student ($entry->students) {
				if ($moi) {
					$roundside = "Aff" if $entry->side == 1;
					$roundside = "Neg" if $entry->side == 2;
				} else {
					$oppschool = $entry->school->short_name;
					if ($oppname eq "") {
						$oppname = $oppname . $student->last;
					} else {
						$oppname = $oppname . "-" . $student->last;
					}
					$roundside = "Neg" if $entry->side == 1;
					$roundside = "Aff" if $entry->side == 2;
				}
			}
		}

		#Get judge
		my $judgenames;

		foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {
			$judgenames .= ", " if $judgenames;
			$judgenames .= $judge->last;
		}

		#Only include rounds from this season
		my $cutoff = "2013-09-01";

		if ($startdate gt $cutoff) {

			#Set variables for the XML
			my $xml_round = {
				TOURNAMENT => $tourn,
				ROUND_NUM => $roundname,
				OPPONENT => $oppschool . " " . $oppname,
				JUDGE => $judgenames,
				SIDE => $roundside
			};

			#Print XML
			$m->print("<ROUND>\n");
			$m->print($xs->XMLout($xml_round, RootName => "", NoAttr => 1, XMLDecl => 0));
			$m->print("</ROUND>\n");		
		}
	}

	#Close XML
	$m->print("</ROUNDS>");
</%init>

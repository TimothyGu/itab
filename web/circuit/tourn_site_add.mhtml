<%args>
	$circuit
	$tourn_id
	$site_id
</%args>
<%init>

#	Make sure this site isn't already part of that tournament 

	my $tourn = Tab::Tourn->retrieve($tourn_id);

	my @sites = $m->comp("/funclib/tourn_sites.mas", tourn => $tourn);

	my @already = Tab::TournSite->search( tournament => $tourn->id, 
											  	site => $site_id );

	if (@already) { 

		my $err = "That site is already part of your tournament";
		$m->redirect("$Tab::url_prefix/setup/tourn_edit.mhtml?err=$err");
	
 	} else { 

		my $join = Tab::TournSite->create ({
			tournament => $tourn->id,
			site => $site_id 
		});

		foreach my $round ($tourn->rounds) { 

			if ($round->site->id) { 

				$round->site($site_id) unless grep $_->id == $round->site->id, @sites;

			} else { 

				$round->site($site_id);

			}

			$round->update;
		}
	
		my $err = "Site added to your tournament.  Unassigned rounds added to site.";

		$m->redirect("$Tab::url_prefix/circuit/tourn_edit.mhtml?err=$err&tourn_id=$tourn_id");

	}

</%init> 


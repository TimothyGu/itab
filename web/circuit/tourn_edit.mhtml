<%args>
	$err => undef
	$tourn_id => undef
	$circuit
	$account
	$tz
</%args>
<%init>

	my $tourn = Tab::Tourn->retrieve($tourn_id) if $tourn_id;

	my $switch;

</%init>


	<h2><% ($tourn) ? "Edit tournament" : "Create tournament" %></h2>

	<table width="100%" cellpadding="6" cellspacing="1">

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>Name:</th>

			<td class="rightalign">
				<form action="tourn_save.mhtml" method="post">
				<input type="hidden" name="tourn_id" value="<% $tourn_id %>">
				<input type="text" name="name" size="30" value="<% ($tourn) ? $tourn->name : "" %>">
			</td>

		</tr>
		
		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				Start:
			</th>

			<& /funclib/datepicker.mas, id => "start" &>

			<td align="right">
				<input type="text" name="start" id="start" size="10" value="<% ($tourn) ? &Tab::pickerdate($tourn->start->set_time_zone($tz)) : "" %>">
			</td>

		</tr>
		
		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				End:
			</th>

			<& /funclib/datepicker.mas, id => "end" &>

			<td align="right">
				<input type="text" name="end" id="end" size="10" value="<% ($tourn) ? &Tab::pickerdate($tourn->end->set_time_zone($tz)) : "" %>">
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				Registration Opens
			</th>

			<& /funclib/datepicker.mas, id => "reg_start" &>

			<td align="right">
				<input type="text" name="reg_start" id="reg_start" size="10" 
					value="<% ($tourn && $tourn->reg_start) ? $tourn->reg_start->set_time_zone($tz)->mdy('/') : "" %>">
				at
%					if ($tourn && $tourn->reg_start) { 
            			<& /funclib/timepicker.mas, time =>"reg_starttime", time => $tourn->reg_start->set_time_zone($tz) &>
%					} else { 
						<& /funclib/timepicker.mas, name => "reg_starttime" &>
%					} 

			</td>

		</tr>
		
		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				New Entry Deadline
			</th>

			<& /funclib/datepicker.mas, id => "reg_end" &>

			<td align="right">
				<input type="text" name="reg_end" id="reg_end" size="10" value="<% ($tourn && $tourn->reg_end) ? $tourn->reg_end->set_time_zone($tz)->mdy('/'): "" %>">
				at
%				if ($tourn && $tourn->reg_end) { 
            		<& /funclib/timepicker.mas, time =>"reg_endtime", time => $tourn->reg_end->set_time_zone($tz) &>
%				} else { 
					<& /funclib/timepicker.mas, name => "reg_endtime" &>
%				} 
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				Judge Change Deadline
			</th>

			<& /funclib/datepicker.mas, id => "judge_deadline" &>

			<td align="right">
				<input type="text" name="judge_deadline" id="judge_deadline" size="10" value="<% ($tourn && $tourn->judge_deadline) ? $tourn->judge_deadline->set_time_zone($tz)->mdy('/') : "" %>">
				at
%				if ($tourn && $tourn->judge_deadline) { 
					<& /funclib/timepicker.mas, name => "judge_deadlinetime", time => $tourn->judge_deadline->set_time_zone($tz) &>
%				} else { 
					<& /funclib/timepicker.mas, name => "judge_deadlinetime" &>
%				} 
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				Fines Frozen Deadline
			</th>

			<& /funclib/datepicker.mas, id => "freeze" &>

			<td align="right">
				<input type="text" name="freeze" id="freeze" size="10" value="<% ($tourn && $tourn->freeze_deadline) ? $tourn->freeze_deadline->set_time_zone($tz)->mdy('/') : "" %>">
				at
%				if ($tourn && $tourn->freeze_deadline) { 
					<& /funclib/timepicker.mas, name => "freezetime", time => $tourn->freeze_deadline->set_time_zone($tz) &>
%				} else { 
					<& /funclib/timepicker.mas, name => "freezetime" &>
%				} 
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				Drops & Changes Until		
			</th>

			<& /funclib/datepicker.mas, id => "drop_deadline" &>

			<td align="right">
				<input type="text" name="drop_deadline" id="drop_deadline" size="10" value="<% ($tourn && $tourn->drop_deadline) ? $tourn->drop_deadline->set_time_zone($tz)->mdy('/') : "" %>">
				at
%				if ($tourn && $tourn->drop_deadline) { 
					<& /funclib/timepicker.mas, name => "drop_deadlinetime", time => $tourn->drop_deadline->set_time_zone($tz) &>
%				} else { 
					<& /funclib/timepicker.mas, name => "drop_deadlinetime" &>
%				} 
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				Penalty Fines apply after
			</th>

			<& /funclib/datepicker.mas, id => "fine_deadline" &>

			<td align="right">
				<input type="text" name="fine_deadline" id="fine_deadline" size="10" value="<% ($tourn && $tourn->fine_deadline) ? $tourn->fine_deadline->set_time_zone($tz)->mdy('/') : "" %>">
				at
%				if ($tourn && $tourn->fine_deadline) { 
					<& /funclib/timepicker.mas, name => "fine_deadlinetime", time => $tourn->fine_deadline->set_time_zone($tz) &>
%				} else { 
					<& /funclib/timepicker.mas, name => "fine_deadlinetime" &>
%				} 
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th colspan="2">
			</th>

		</tr>

%		if ($account->site_admin && $tourn) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th>
					Circuit:
				</th>

				<td class="rightalign">

					<select name="circuit_id">

%					foreach my $circuit (sort {$a->name cmp $b->name} Tab::Circuit->search(active => 1)) { 

						<option value="<% $circuit->id %>" <% ($tourn && $circuit->id == $tourn->circuit->id) ? "selected" : "" %>>
							<% substr($circuit->name,0,35) %>
						</option>


%					}

			</tr>

%		}
		
% 		# Tournament Director/Main Contact. 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>	
				Tournament is approved?
			</td>

			<td class="rightalign">
				Yes <input type="radio" name="approved" value="1" <% ($tourn && $tourn->approved) ? "checked" : "" %>>
				No <input type="radio" name="approved" value="0" <% ($tourn && $tourn->approved) ? "" : "checked" %>>
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>	
				Hide tournament on website?
			</td>

			<td class="rightalign">
				Yes <input type="radio" name="hidden" value="1" <% ($tourn && $tourn->hidden) ? "checked" : "" %>>
				No <input type="radio" name="hidden" value="0" <% ($tourn && $tourn->hidden) ? "" : "checked" %>>
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>	
				Director/Contact:
			</td>

			<td class="rightalign">
				<input type="text" name="director_email" size="30" value="<% ($tourn) ? ($tourn->director) ? $tourn->director->email : "" : "" %>">
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<th>
				Copy Tournament Rules:
			</th>

			<td class="rightalign">

				<select name="copy_tourn_id">

					<option value="">---No Default---</option>

%						foreach my $tourn (sort {$b->start->epoch <=> $a->start->epoch} $circuit->tournaments) { 
							<option value="<% $tourn->id %>">
								<% substr($tourn->name,0,27) %> <% $tourn->start->year %>
							</option> 
% 						}

				</select>

			</td>

		</tr>

%  		# Save things.

		<tr class="liblrow">
			<td colspan="2" class="rightalign">
				<input class="grey" type="submit" value="Save Tournament">
				</form>
			</td>
		</tr>
		
	</table>

% 	if ($tourn) { 

		<table cellpadding="5" width="100%" cellspacing="1">

			<tr>
				<td colspan="5">
					<h4>Sites:</h4>
				</td>
			</tr>

%			undef $switch;

% 			foreach my $site (sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_sites.mas", tourn => $tourn)) {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >
					<td colspan="2">
						<% $site->name %>:
					</td>

					<td class="centeralign">
						<% scalar $site->rooms %> Rooms
					</td>

					<td class="rightalign" colspan="2">
						<form action="tourn_site_rm.mhtml" method="post">
						<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
						<input type="hidden" name="site_id" value="<% $site->id %>">
						<input type="submit" class="grey" value="Remove Site">
						</form>
					</td>

				</tr>
% 			}

			<tr class="liblrow">

				<td>
					<form action="tourn_site_add.mhtml" method="post">
					<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
					Add Site:
				</td>

				<td class="centeralign" colspan="2">

					<select name="site_id">
%						foreach my $site (sort {$a->name cmp $b->name} $circuit->sites ) { 
							<option value="<% $site->id %>"> <% substr($site->name,0,20) %> </option>
% 						}
					</select>

				</td>

				<td class="rightalign" colspan="2">
					<input class="grey" type="submit" value="   Add Site    ">
					</form>
				</td>

			</tr>

			<tr>
				<td colspan="5" style="padding-top: 10px;">
					<h4>Tournament Staff:</h4>
				</td>
			</tr>

%			undef $switch;

% 			foreach my $staff (sort {$a->account->last cmp $b->account->last} $tourn->accounts) {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

					<td>
						<% $staff->account->first." ".$staff->account->last %>
					</td>

					<td class="smaller">
						<form action="tourn_staff_save.mhtml" method="post">
						<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
						<input type="hidden" name="staff_id" value="<% $staff->id %>">
						<input type="checkbox" name="entry" value="1" <% ($staff->entry) ? "checked" : "" %>>Entry Only
					</td>

					<td class="smaller">
						<input type="checkbox" name="contact" value="1" <% ($staff->contact) ? "checked" : "" %>>Tournament Contact
					</td>

					<td class="centeralign">
						<input type="submit" class="grey" value="Save">
						</form>
					</td>

					<td class="centeralign">
						<form action="tourn_staff_rm.mhtml" method="post">
						<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
						<input type="hidden" name="staff_id" value="<% $staff->id %>">
						<input type="submit" class="grey" value="Remove">
						</form>
					</td>

				</tr>

% 			}

			<tr class="liblrow">

				<td>Add Staff:</td>

				<td colspan="2" class="centeralign">
					<form action="tourn_staff_add.mhtml" method="post">
					<input type="hidden" name="tourn_id" value="<% $tourn_id %>">
					<input type="text" size="30" name="email" value="Enter email addresss" onfocus="value=''">
				</td>

				<td class="centeralign" colspan="2">
					<input  type="submit" value="       Add Staff      ">
					</form>
				</td>
			</tr>

			<tr>
				<td style="padding-top: 20px;">
				</td>
			</tr>

			<tr class="lirdrow">

				<td colspan="5" class="centeralign">
					<form action="tourn_rm.mhtml" method="post">
					<input type="hidden" name="tourn_id" value="<% $tourn_id %>">
					<input class="red" type="submit" value="     Delete Tournament      ">
					</form>
				</td>

			</tr>

		</table>

% 	}

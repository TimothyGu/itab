<%args>
	$circuit
	$account	
	$search_field
	$search_value => undef
	$err => undef
	$show_coaches => 1
</%args>
<%init>

	$search_field = lcfirst($search_field);

	my @chapters;

	if ($search_field eq "all") { 
		@chapters = $circuit->chapters;
	}

	if ($search_field eq "name") { 
		$search_value = $search_value."%";
		@chapters = Tab::Chapter->search_circuit_and_name($circuit->id, $search_value);
	}

	if ($search_field eq "code") {
		$search_value = $search_value."%";
		@chapters = Tab::Chapter->search_circuit_and_code($circuit->id, $search_value);
	}

	if ($search_field eq "region") {
		my $region = Tab::Region->retrieve($search_value);
		@chapters = $region->chapters;
	}

	if ($search_field eq "membership") { 

		@chapters = Tab::Chapter->search_circuit_and_membership($circuit->id, $search_value);
	}

    #uniq
    my %seen = ();
    @chapters = grep { ! $seen{$_->id} ++ } @chapters;

	@chapters = sort {$a->name cmp $b->name} @chapters;
	@chapters = sort {$a->state cmp $b->state} @chapters;

</%init>

	<h2>Search chapters in the <% $circuit->short_name %></h2>

	<table cellpadding="5" cellspacing="1" width="100%">

%		my $switch;

		<tr class="lirdrow">

			<th class="smaller">
				Delete
			</th>

			<th>
				Name
			</th>

			<th>
				ST
			</th>

			<th>
				Membership
			</th>

		</tr>

% 		foreach my $chapter (@chapters) { 

%			my $mem = $chapter->circuit_membership($circuit);

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td class="center">
					[<a href="circuit_leave.mhtml?chapter_id=<% $chapter->id %>&circuit_id=<% $circuit->id %>">X</a>]
				</td>

				<td>
					<a href="chapter_edit.mhtml?chapter_id=<% $chapter->id %>" class="white block">
						<% $chapter->name %>
					</a>

				</td>

				<td>
					<% $chapter->state %>
				</td>

				<td class="smaller" width="20%">
					<% ($mem->membership && $mem->membership->id) ? $mem->membership->name : ($mem->full_member) ? "Full Member" : "Tourns Only" %>
				</td>


			</tr>
%		}


		<tr class="liblrow">
			<td colspan="7" class="right">
				<input  type="submit" value="Save All Changes">
				</form>
			</td>
		</tr>

	</table>

<%args> 
	$account
	$chapter_id => undef
	$err => undef
	$circuit
</%args>
<%init> 

	my $switch;

	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;
	my @students = $chapter->students if $chapter;

    my @regions = $circuit->regions;
    @regions = sort{$a->name cmp $b->name} @regions if @regions;

	my $is_admin;

	foreach my $admin ($circuit->admins) {

		# This feels like an ugly way to do this that I'd probably not use if
		# I'd actually read a Perl book before programming in it.

		$is_admin++ if $admin->id == $account->id;
	}

	my $cl;

	if ($chapter) { 

		my @cls = Tab::ChapterCircuit->search( chapter => $chapter->id, circuit => $circuit->id );

		$cl = shift @cls;

		unless ($account->site_admin || ( $cl && $cl->circuit->id == $circuit->id) ) { 

			$m->print("<h4>Error</h4><p><b>That chapter does not belong to your circuit.  Try again</b></p>");
			$m->abort;

		}
	}

</%init> 

	<h2><% ($chapter) ? "Edit ".$chapter->name : "Create New Chapter:" %></h2>

	<table cellpadding="5" width="100%" cellspacing="1">

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<td>
				Name:
			</td>

			<td colspan="2">
				<form action="chapter_save.mhtml" method="post"> 
				<input type="hidden" name="chapter_id" value="<% $chapter_id %>">
				<input type="text" name="name" size="30" value="<% ($chapter) ? $chapter->name : "" %>">
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<td>
				Short Code:
			</td>

			<td colspan="2">
				<input size="10" type="text" name="code" value="<% ($cl) ? $cl->code : "" %>">
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<td>
				State:
			</td>

			<td colspan="2">
				<input size="10" maxlength="2" type="text" name="state" value="<% $chapter->state %>">
			</td>

		</tr>

		<tr class="liblrow">

			<td colspan="3" align="right">
				<input  type="submit" value="    Save Chapter Info   ">
				</form>
			</td>

		</tr>

% 		if ($chapter) { 

			<tr>
				<td colspan="4">
					<h3>Students:</h3>
				</td>
			</tr>

			<tr class="evenrow">

				<td>
					<% scalar $chapter->students( retired => 0 ) %> Active Students
				</td>

				<td colspan="2" align="right">
					<a class="white block" href="students_view.mhtml?chapter_id=<% $chapter->id %>">
						Student Roster
					</a>
				</td>

			</tr>

			<tr class="oddrow">

				<td>
					<% scalar $chapter->ubers( retired => 0 ) %> Active Judges
				</td>

				<td colspan="2" align="right">
					<a class="white block" href="uber_roster.mhtml?chapter_id=<% $chapter->id %>">
						Judge Roster
					</a>
				</td>

			</tr>

			<tr>
				<td colspan="4">
					<h3>Coach Names (for crediting):</h3>
				</td>
			</tr>

%			 my @credits = $chapter->credits;
%			 @credits = sort {$a->id <=> $b->id} @credits;

%			 foreach my $cred (@credits) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 

					<td>
						Name:
					</td>

					<td>
						<% $cred->name %>
					</td>

					<td align="center">
						<a class="white block" href="credit_rm.mhtml?credit_id=<% $cred->id %>">
							Delete
						</a>
					</td>

				</tr>

% 			}


			<tr class="liblrow">
				<td>
					Add Credit:
				</td>

				<td>
					<form action="credit_save.mhtml" method="post"> 
					<input type="hidden" value="<% $chapter->id %>" name="chapter_id">
					<input type="text" size="30" name="name" value="Enter Name" onfocus='value=""'>
				</td>

				<td class="right">
					<input  type="submit" value="  Save  ">
					</form>
				</td>

			</tr>

			<tr>
				<td colspan="4">
					<h3>Accounts that have access to this chapter:</h3>
				</td>
			</tr>

% 			my @coaches = $chapter->coaches;
%			undef $switch;

% 			foreach my $coach (@coaches) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 

					<td class="smaller">	
						<% $coach->first." ".$coach->last %>
					</td>

					<td class="smaller">	
						<a href="<% $Tab::url_prefix %>/circuit/account_edit.mhtml?account_id=<% $coach->id %>">
						<% $coach->email %> </a>
					</td>

					<td align="center" class="smaller">	
						<a class="white block" href="access_rm.mhtml?coach_id=<% $coach->id %>&chapter_id=<% $chapter_id %>">
							Delete
						</a>
					</td>
				</tr>
% 			}


			<tr class="liblrow">

				<td class="smaller">	
					<form action="access_grant.mhtml" method="post">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					Grant Access:
				</td>

				<td>
					<input type="text" name="email" size="30" value="Email address" class="faded" onfocus='value=""' onfocus=''>
				</td>

				<td class="right">
					<input  type="submit" value="  Grant ">
					</form>
				</td>
	
			</tr>

		</table>

		<h3>Circuit memberships:</h3>

		<table cellpadding="5" cellspacing="1" width="100%">

%		my @ljs = sort {$a->circuit->name cmp $b->circuit->name} $chapter->circuit_joins;

%			foreach my $chap_circuit ($chapter->circuits) { 

%				next unless ($account->site_admin || ($circuit->id == $chap_circuit->id));

%				my $lj;

%				foreach my $clj (@ljs) { 
%					$lj = $clj if $clj->circuit->id == $chap_circuit->id;
%				}

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td class="smaller">
						<% $chap_circuit->name %>
					</td> 
					
					<td class="smaller"> 

%						unless ($lj->full_member) { 

							Tourns

%						} else { 

%                      		if ($lj->membership) {

                       			<% $lj->membership->name %>
								<% ($lj->membership->dues > 0) ? "(\$".$lj->membership->dues.")" : "" %>

%							} else { 

								Full

%							}

%						}

					</td>

					<td class="smaller">

%						if ($tourn->setting("regions")) { 

							<% ($lj->region) ? $lj->region->name : "" %>

%						}
	
					</td>

					<td class="smaller">
						<a class="white block" href="membership_change.mhtml?circuit_mem_id=<% $lj->id %>">
							Change
						</a>
					</td>
					
					<td class="smaller">
						<a class="white block" href="circuit_leave.mhtml?chapter_id=<% $chapter->id %>&circuit_id=<% $chap_circuit->id %>">
							Remove
						</a>
					</td> 
					
				</tr>
%			}

			<tr class="lirdrow">
				<td colspan="5" class="right">
					<form action="chapter_merge.mhtml" method="post">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<input class="red" type="submit" value="Search for Duplicates">
					</form>
				</td>
			</tr>

%			if ($account->site_admin) { 

				<tr class="lirdrow">
					<td colspan="5" class="right">
						<form action="chapter_rm.mhtml" method="post">
						<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
						<input class="red" type="submit" value="Delete Chapter">
						</form>
					</td>
				</tr>

%			}
%		}

	</table>



<%args>
	$tourn
	$account
	$err => undef
	$type => "Team"
	$tb_set_id => undef
</%args>
<%init>

	my $switch;

	my @tiebreakers = 	("ranks","winloss","reciprocals","points","ballots","judgepref","opp_ranks", "opp_wins", "opp_points","chair_ranks","rankinround","judgevar", "coinflip");

	my @counts = 		("all","prelim","elim","last elim","final");

	my $set = Tab::TiebreakSet->retrieve($tb_set_id) if $tb_set_id;
	$type = $set->type unless $type;

</%init> 

	<& sidebar.mas, tourn => $tourn, set_id => $tb_set_id, chosen => $type &>

	<div class="left huge">
			
		<h2>Tiebreaker sets <% ($type eq "Speaker") ? "for Debate Speaker Awards" : "" %></h2>

			<h4><% $set  ? $set->name." Settings " : "Create Tiebreak Set:" %></h4>

			<form action="tb_set_save.mhtml" method="post">
			<input type="hidden" name="tb_set_id" value="<% $tb_set_id %>">
			<input type="hidden" name="type" value="<% $type %>">

			<div class="block greynohover">

				<span class="smallspan inline smallish padless">
					Name: 
				</span>

				<span class="twofifty inline padless">
					<input type="text" size="25" name="name" value="<% $set ? $set->name : "" %>" placeholder="Tiebreak set name">
				</span>

				<span class="twofifty inline padless">
					<label for="elim" class="smallish">
						Advance equal numbers from each section
					</label>
				</span>

				<span class="smallspan inline smallish padless">
					<input type="checkbox" id="elim" name="elim" value="1" <% $set && $set->elim ? 'checked="checked"' : "" %> >
				</span>
			</div>

			<div class="block">
				<span class="twofifty inline padless">
					<label for="truncate_to_smallest" class="smallish">
						Truncate ranks to size of smallest section
					</label>
				</span>
				<span class="smallspan inline smallish padless">
					<input type="checkbox" id="truncate_to_smallest" name="truncate_to_smallest" value="1" <% $set && $set->setting("truncate_to_smallest") ? 'checked="checked"' : "" %> >
				</span>

				<span class="twofifty inline padless">
					<label for="truncate_ranks_to" class="smallish">
						Truncate ranks to 
					</label>
				</span>
				<span class="smallishspan inline smallish padless">
					<input type="number" id="truncate_ranks_to" name="truncate_ranks_to" size="3" min="0" max="99" value=<% $set ? $set->setting("truncate_ranks_to") : "" %>>
				</span>
			</div>

			<div class="block greynohover">
				<span class="twofifty inline padless">
					<label for="noshows_never_break" class="smallish">
						No shows cannot break/advance
					</label>
				</span>
				<span class="smallspan inline smallish padless">
					<input type="checkbox" id="noshows_never_break" name="noshows_never_break" value="1" <% $set && $set->setting("noshows_never_break") ? 'checked="checked"' : "" %> >
				</span>

				<span class="twofifty inline padless">
					<label for="mfl_time_violation" class="smallish">
						MFL Time Violation penalty (+1 rank)
					</label>
				</span>
				<span class="smallspan inline smallish padless">
					<input type="checkbox" id="mfl_time_violation" name="mfl_time_violation" value="1" <% $set && $set->setting("mfl_time_violation") ? 'checked="checked"' : "" %> >
				</span>

			</div>

			<div class="rightalign bluenohover block">

%				my $warn = "You are about to delete this tiebreaker set.  That may cause terrible, terrible damage.  Are you sure?";

				<span class="left medbigspan smaller centeralign">
%					if ($set) { 
						<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &>  href="tiebreak_set_rm.mhtml?set_id=<% $set->id %>">
							Remove Tiebreak Set
						</a>
%					}
				</span>

				<span class="floatright">
					<input type="submit" value="<% $set ? "Save Settings" : "Create Tiebreak Set" %>">
					</form>
				</span>
			</div>

			<br style="clear: both;" />


%		if ($set) { 
			
			<h4>Tiebreaks order for set <% $set->name %></h4>

%			my $prime = 1;

			<table width="100%" cellpadding="5" cellspacing="1">

%   			foreach my $tiebreak (sort {$a->priority <=> $b->priority} Tab::Tiebreak->search(tb_set => $set->id)) {

%					$prime++;
%					my $highlow;
%					my $highlow_count = $tiebreak->highlow_count;
%					$highlow_count = 1 unless $highlow_count;
%					$highlow = ", except the ".$highlow_count." best & worst" if $tiebreak->highlow == 1 || $tiebreak->highlow == 2;
%					$highlow = ", except the ".$highlow_count." best" if $tiebreak->highlow == 3;
%					$highlow = ", except the ".$highlow_count." worst" if $tiebreak->highlow == 4;

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			            <td colspan="7" style="padding-top: 10px; padding-left: 10px;">

							 <% $tiebreak->priority %>. <% ucfirst($tiebreak->name) %> score
							 from <% $tiebreak->count %> 
							 rounds<% $highlow %><% ($tiebreak->multiplier > 1) ? ", multiplied by ".$tiebreak->multiplier : "" %>

							<span style="float: right; width: 100px; text-align: center; margin: 0; padding: 0;">
            			    	<a class="dkred fullblock" href="tiebreak_rm.mhtml?tiebreak_id=<% $tiebreak->id %>">Delete</a>
							</span>

						</td>
					</tr>
%				}

				<tr>
					<td>
					</td>
				</tr>

				<tr class="liblrow"> 
				
					<td>
						Add
						<form action="tiebreak_save.mhtml" method="post">
						<input type="hidden" name="tb_set_id" value="<% $set->id %>">
						<input type="hidden" name="type" value="<% $type %>">
					</td> 
					
					<td class="centeralign">
						<select name="name">
%               			foreach my $tb (@tiebreakers) {
                    			<option value="<% $tb %>"><% ucfirst($tb) %></option>
%               			}
           	 			</select>
        			</td> 
					
					<td class="centeralign">
						<input type="number" min="1" max="99" size="2" name="priority" value="<% $prime %>" placeholder="Priority"> 
					</td> 
					
					<td>
						<select name="count">
%           				foreach my $ct (@counts) {
                				<option value="<% $ct %>"><% ucfirst($ct) %></option>
%           				}
            			</select>
        			</td>

					<td class="centeralign">
						<input type="number" min="1" max="99" size="10" name="multiplier" placeholder="Multiplier">
					</td> 

					<td class="smaller centeralign">
						Drop
						<input type="number" name="highlow_count" min="1" max="9" size="3" class="thin">

						<select name="highlow"> 
                   			<option value="0">None</option>
                   			<option value="1">H/L</option>
                   			<option value="3">Best</option>
                   			<option value="4">Worst</option>
						</select>
					</td> 
					
					
					<td class="centeralign">
						<input class="skinny" type="submit" value="Save">
						</form>
					</td>

				</tr>

			</table>

%		}

		<br />

	</div>


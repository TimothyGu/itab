<%args>
	$tourn
	$event_id => undef
	$add => undef
	$err => undef
	$tz => undef
</%args>
<%init>

	$tz = $tourn->tz unless $tz;
 	my @groups = sort{$a->name cmp $b->name} $tourn->judge_groups;

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	if (scalar $tourn->events == 1 && not defined $add) {
		$event = $tourn->events->first;
	}

	my $switch;

</%init>
	
	<& "/funclib/editor.mas" &>


	<div class="left huge">

%		if ($event) { 

			<h4><% $event->name %></h4>

%		} else { 

			<h4>Add and edit events</h4>
%		}

%		unless (@groups) {
		
			<p>
				Events, or divisions, are organized into judge groups.  Events
				in the same group will share judges, same judge obligations,
				and judge rating systems.
			</p>

			<p>
				You must create judge group(s) under 
				<a href="/setup/judges/edit.mhtml">Setup -> Judge Groups</a>
				before creating events here.
			</p>

%		}

%		if ($event || $add ) { 

			<table cellpadding="3" cellspacing="1" border="0" width="100%" style="margin-bottom: 5px;"> 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						<form enctype="multipart/form-data" onsubmit="return uploadThis()" name="ballot" action="event_save.mhtml" method="post">
						<input type="hidden" value="<% ($event) ? $event->id : "" %>" name="event_id">
						Event Name
					</td>
				
					<td class="rightalign">
						<input type="text" name="name" value="<% ($event) ? $event->name : "" %>" size="40" tabindex="1">
					</td>
					
					<td>
						Abbreviation
					</td> 
					
					<td class="rightalign">
						<input type="text" name="abbr" value="<% ($event) ? $event->abbr : "" %>" size="5">
					</td> 

				</tr>

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 

					<td>
						Entry Deadline
					</td>

%					my $deadline = $event->setting("deadline") unless $add;
%					$deadline->set_time_zone($tz) if $deadline;

					<& /funclib/datepicker.mas, id =>"deadline" , max => $tourn->end &>

					<td class=" smaller rightalign">
						(if before <% Tab::pickerdate($tourn->reg_end->set_time_zone($tz)) %>)
						<input type="text" name="deadline" id="deadline" size="10" value="<% ($deadline) ?  $deadline->mdy('/') : "" %>">
							@
						<& /funclib/timepicker.mas, name => "deadlinetime", time => $deadline &>
						<br />
					</td>

					<td >
						Entry Fee
					</td>

					<td class="rightalign">
						<input type="text" name="fee" value="<% ($event) ? $event->fee : "" %>" size="5">
					</td>

				</tr>


				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>


				</tr>


			</table>

			<hr />

%			undef ($switch);

			<div class="half" style="width: 49%; float: left;">
				
				<table cellpadding="3" cellspacing="1" border="0" width="100%"> 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							Judge Group
						</td>
					
						<td class="smaller rightalign">
							<select name="judge_group_id" class="fixedmed">
								<option></option>
	
%								foreach my $group (sort {$a->name cmp $b->name} $tourn->judge_groups) { 
									<option value="<% $group->id %>" <% ($event && $event->judge_group && $group->id == $event->judge_group->id) ? "selected" : "" %>>
										<% $group->name %>
									</option>
%								}

							</select>
						</td>
						
					</tr>
				
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%						my $code_style = $event->setting("code_style") if $event;

						<td>
							Code style
						</td>

						<td class="smaller rightalign">

							<select name="code_style" class="fixedmed" onchange='this.form.submit()'>

								<option value="numbers" <% ($event && $code_style eq "numbers") ? "selected" : "" %>>
									Numeric codes
								</option>

								<option value="school_number" <% ($event && $code_style eq "school_number") ? "selected" : "" %>>
									School code + numeric code
								</option>

								<option value="initials" <% ($event && $code_style eq "initials") ? "selected" : "" %>>
									School name & entry initials	
								</option>

								<option value="register" <% ($event && $code_style eq "register") ? "selected" : "" %>>
									Ask registrants to supply code
								</option>

								<option value="names" <% ($event && $code_style eq "names") ? "selected" : "" %>>
									Full names
								</option>

							</select>
		
						</td>
		
					</tr>

%					unless ($event && ($event->type eq "speech" || $event->type eq 'congress')) { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td colspan="2" class="padmore rightalign" style="padding: 13px;">
								Tiebreak set for speaker awards:
							</td>
						</tr>
%					}

				</table>

			</div>

%			undef ($switch);

			<div class="half" style="width: 49%; float: right;">

				<table cellpadding="3" cellspacing="1" border="0" width="100%"> 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td >
							Event Type
						</td> 

						<td class="smaller">
							<select name="type" class="fixedmed" onchange='this.form.submit()'>

								<option value="speech" <% ($event && $event->type eq "speech") ? "selected" : "" %>>
									Speech
								</option>
								<option value="congress" <% ($event && $event->type eq "congress") ? "selected" : "" %>>
									Congress
								</option>
								<option value="debate" <% ($event && $event->type eq "debate") ? "selected" : "" %>>
									Debate
								</option>
								<option value="roundrobin" <% ($event && $event->type eq "roundrobin") ? "selected" : "" %>>
									Round Robin
								</option>
								<option value="policy" <% ($event && $event->type eq "policy") ? "selected" : "" %>>
									Policy
								</option>
								<option value="parli" <% ($event && $event->type eq "parli") ? "selected" : "" %>>
									Parli
								</option>
								<option value="ld" <% ($event && $event->type eq "ld") ? "selected" : "" %>>
									LD
								</option>
								<option value="pf" <% ($event && $event->type eq "pf") ? "selected" : "" %>>
									PF
								</option>
								<option value="wudc" <% ($event && $event->type eq "wudc") ? "selected" : "" %>>
									WUDC (BP)
								</option>
							</select>
						</td> 

					</tr> 

%					if ($event && $event->type eq "speech") { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
							
							<td >
								Master Ballot
							</td> 
							
							<td>
								<select name="ballot_type" class="fixedmed">
									<option value="normal" <% ($event && $event->setting("ballot_type") eq "normal") ? "selected" : "" %>>
										Plain
									</option>

									<option value="cfl" <% ($event && $event->setting("ballot_type") eq "cfl") ? "selected" : "" %>>
										List Rules (Enter Below)
									</option>
								</select>
							</td>

						</tr> 

%					}

%					unless ($event && ($event->type eq "speech" || $event->type eq 'congress')) { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td >
								Event Level
							</td> 

							<td class="smaller">
								<select name="level" class="fixedmed">
									<option value="">
									</option>
									<option value="open" <% ($event && $event->setting("level") eq "open") ? "selected" : "" %>>
										Open/Varsity
									</option>
									<option value="jv" <% ($event && $event->setting("level") eq "jv") ? "selected" : "" %>>
										JV
									</option>
									<option value="novice" <% ($event && $event->setting("level") eq "novice") ? "selected" : "" %>>
										Novice
									</option>
								</select>
							</td>

						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%							my $set = $event->setting("speaker_tbset") if $event;
							<td colspan="2" class="leftalign">
								<select name="speaker_tbset" class="fixedmed nowrap">
									<option value="">None</option>
%									foreach my $tb_set (Tab::TiebreakSet->search( tourn => $tourn->id, type => "Speaker")) { 
										<option value="<% $tb_set->id %>" <% $tb_set->id == $set ? "selected" : "" %>>
											<% $tb_set->name %>
										</option>
%									}
								</select>
							</td>
%					}

					</tr>

				</table>

			</div>

			<br style="clear: both;">

			<hr />

%			undef($switch);

			<div class="half" style="width: 49%; float: left;">

				<table cellpadding="3" cellspacing="1" border="0" width="100%"> 

%					unless ($event && ($event->type eq "speech" || $event->type eq 'congress')) { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td >
								Min students per entry
							</td> 

							<td class="padcheck">
								<input type="text" class="thin" name="min_entry" value="<% ($event) ? $event->setting("min_entry") : "" %>" size="5">
							</td> 

						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td >
								Max students per entry
							</td> 

							<td class="padcheck">
								<input type="text" class="thin" name="max_entry" value="<% ($event) ? $event->setting("max_entry") : "" %>" size="5">
							</td> 

						</tr> 
%					}

				
	
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td >
							Field Cap 
						</td>

						<td class="padcheck">
							<input type="text" class="thin" name="cap" value="<% ($event) ? $event->setting("cap") : ""%>" size="5">
						</td>

					</tr>

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	
						<td >
							School Cap 
						</td>

						<td class="padcheck">
							<input type="text" class="thin" name="school_cap" value="<% ($event) ? $event->setting("school_cap") : "" %>" size="5">
						</td> 
						
					</tr> 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>		
					
						<td>
							<label for="waitlist">
								Waitlist entries over cap
							</label>
						</td> 
						
						<td align="left">
							<input type="checkbox" id="waitlist" name="waitlist" value="1" <% ($event) ? ($event->setting("waitlist")) ? 'checked' : '' : '' %>>
						</td> 

					</tr> 


					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>		
					
						<td>
							<label for="waitlist_all">
								Waitlist all entries
							</label>
						</td> 
						
						<td align="left">
							<input type="checkbox" id="waitlist" name="waitlist_all" value="1" <% ($event) ? ($event->setting("waitlist_all")) ? 'checked' : '' : '' %>>
						</td> 

					</tr>

%					if ($code_style eq "numbers" || $code_style eq "school_number") { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td >
								1st Numeric Speaker Code
							</td>

							<td>
								<input type="text" class="thin" name="code_start" value="<% ($event) ? $event->setting("code_start") : ""%>" size="5">
							</td>

						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td>
								<label for="code_hide">
									Hide codes at registration
								</label>
							</td>

							<td>
								<input type="checkbox" id="code_hide" name="code_hide" value="1" <% ($event) ? ($event->setting("code_hide")) ? 'checked' : '' : '' %>>
							</td>

						</tr> 

%					}

%					if ($event && $event->type eq "speech") {

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td>
								<label for="ask_for_titles">
								Ask for piece titles
								</label>
							</td>

							<td>
								<input type="checkbox" id="ask_for_titles" name="ask_for_titles" value="1" <% ($event) ? ($event->setting("ask_for_titles")) ? 'checked' : '' : '' %>>
							</td>
					
						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td>
								<label for="enter_me_twice">
									Allow double entry within event
								</label>
							</td>

							<td>
								<input type="checkbox" id="enter_me_twice" name="enter_me_twice" value="1" <% ($event) ? ($event->setting("enter_me_twice")) ? 'checked' : '' : '' %>>
							</td>
					
						</tr>

%					}

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							<label for="hybrids">
								Allow hybrid entries (2+ schools)
							</label>
						</td>

						<td>
							<input type="checkbox" id="hybrids" name="hybrids" value="1" 
								<% ($event) ? ($event->setting("hybrids")) ? 'checked' : '' : '' %>>
						</td>

					</tr>

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							<label for="no_judge_burden">
								No judge obligations
							</label>
						</td>

						<td>
							<input type="checkbox" id="no_judge_burden" name="no_judge_burden" value="1" <% ($event) ? ($event->setting("no_judge_burden")) ? 'checked' : '' : '' %>>
						</td>
			
					</tr>

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							<label for="self_strike">
								Judges can strike self from event
							</label>
						</td>

						<td>
							<input type="checkbox" id="self_strike" name="self_strike" value="1" <% ($event) ? ($event->setting("self_strike")) ? 'checked' : '' : '' %>>
						</td>
			
					</tr>

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
						<td>
							<label for="supp">
								Supplemental Event
							</label>
						</td>

						<td>
							<input type="checkbox" name="supp" id="supp" value="1" <% ($event) ? ($event->setting("supp")) ? 'checked' : '' : '' %>>
						</td>

					</tr>

%					if ($event && $event->type ne "speech" && $event->type ne 'congress') { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td>
								<label for="apda">
									APDA Seeds
								</label>
							</td>

							<td>
								<input type="checkbox" name="apda" id="apda" value="1" <% ($event) ? ($event->setting("apda")) ? 'checked' : '' : '' %>>
							</td>

						</tr>

%					}

				</table>

			</div>

%			undef($switch);

			<div class="half" style="width: 49%; float: right;">

				<table cellpadding="3" cellspacing="1" border="0" width="100%"> 

%					if ($event && ($event->type eq "speech" || $event->type eq 'congress')) { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td >
								Min students per entry
							</td> 

							<td class="padcheck">
								<input type="text" class="thin" name="min_entry" value="<% ($event) ? $event->setting("min_entry") : "" %>" size="5">
							</td> 

						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td >
								Max students per entry
							</td> 

							<td class="padcheck">
								<input type="text" class="thin" name="max_entry" value="<% ($event) ? $event->setting("max_entry") : "" %>" size="5">
							</td> 

						</tr> 
%					}

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
						<td>
							<label for="field_report">
								Publish web field report
							</label>
						</td>

						<td>
							<input type="checkbox" id="field_report" name="field_report" value="1" <% ($event) ? ($event->setting("field_report")) ? 'checked' : '' : '' %>>
						</td>

					</tr>

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
						<td>
							<label for="field_waitlist">
								Include waitlist on field report
							</label>
						</td>

						<td>
							<input type="checkbox" id="field_waitlist" name="field_waitlist" value="1" <% ($event) ? ($event->setting("field_waitlist")) ? 'checked' : '' : '' %>>
						</td>

					</tr>

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
						<td>
							<label for="live_updates">
								Live Updates (Text/Emails)
							</label>
						</td>

						<td>
							<input type="checkbox" id="live_updates" name="live_updates" value="1" <% ($event) ? ($event->setting("live_updates")) ? 'checked' : '' : '' %>>
						</td>
					</tr>


%					unless ($event && ($event->type eq "speech" || $event->type eq 'congress')) { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
							<td>
								<label for="online_ballots">
									Online Ballot Entry
								</label>
							</td>

							<td>
								<input type="checkbox" id="online_ballots" name="online_ballots" value="1" 
									<% ($event) ? ($event->setting("online_ballots")) ? 'checked' : '' : '' %>>
							</td>
						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td >
								Min speaker points
							</td>

							<td class="padcheck">
								<input type="text" class="thin" name="min_points" value="<% ($event) ? $event->setting("min_points") : "0" %>" size="5">
							</td>

						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
							<td >
								Max speaker points
							</td>

							<td class="padcheck">
								<input type="text" class="thin" name="max_points" value="<% ($event) ? $event->setting("max_points") : "100" %>" size="5">
							</td> 
							
						</tr> 


						<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

%							my $increments = $event->setting("point_increments") if $event;
		
							<td >
								Point increments
							</td>

							<td class="padmore" style="padding-top: 7px; padding-bottom: 8px;">

								<select name="point_increments" class="fixedtiny">

									<option value="whole" <% ($event && $increments eq "whole") ? "selected" : "" %>>
										Whole
									</option>

									<option value="half" <% ($event && $increments eq "half") ? "selected" : "" %>>
										Half
									</option>

									<option value="fourths" <% ($event && $increments eq "fourths") ? "selected" : "" %>>
										Fourths
									</option>

									<option value="tenths" <% ($event && $increments eq "tenths") ? "selected" : "" %>>
										Tenths
									</option>

								</select>
							</td> 
							
						</tr> 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
							<td>
								No low-point wins
							</td>

							<td>
								<input type="checkbox" name="no_lpw" value="1" <% ($event && $event->setting("no_lpw")) ? "checked" : "" %>>
							</td> 
							
						</tr> 
%					}
					
					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					
						<td>
							<label for="point_ties">
								Point ties allowed
							</label>
						</td> 
						
						<td>
							<input type="checkbox" id="point_ties" name="point_ties" value="1" <% ($event) ? ($event->setting("point_ties")) ? 'checked' : '' : '' %>> 
						</td> 
						
					</tr> 
					
					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					
						<td>
							<label for="omit_sweeps">
								No sweepstakes credit
							</label>
						</td> 
						
						<td>
							<input type="checkbox" id="omit_sweeps" name="omit_sweeps" value="1" <% ($event) ? ($event->setting("omit_sweeps")) ? 'checked' : '' : '' %>> 
						</td> 
						
					</tr> 
					
		
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							<label for="bids">
								Award Bids/Quals
							</label>
						</td>

						<td>
							<input type="checkbox" id="bids" name="bids" value="1" <% ($event) ? ($event->setting("bids")) ? 'checked' : '' : '' %>>
						</td>
				
					</tr>

% 					unless ($tourn->setting("allow_judge_own")) { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td>
								<label for="allow_judge_own">
									Allow same-school judges
								</label>
							</td>

							<td>
								<input type="checkbox" id="allow_judge_own" name="allow_judge_own" value="1" <% ($event) ? ($event->setting("allow_judge_own")) ? 'checked' : '' : '' %>>
							</td>

						</tr>

%					}


				</table>
		

			</div>

		<br style="clear: both;">

		<div class="liblrow block rightalign">
			<input type="submit" value="Save Event" class="thin">
		</div>
		
		<hr />
		
%		if ($event && ($event->type eq "speech")) { 
			<h4>Event Rules (for master ballots)</h4>

			<span class="block leftalign">
				<textarea name="text" rows=5 cols="58" wrap="virtual"><% ($event) ? $event->setting("text") : "" %></textarea>
			</span>
%		}

		<h4>Event Description (for website)</h4>

		<span class="block leftalign">
			<textarea name="description" rows=5 cols="58" wrap="virtual"><% ($event) ? $event->setting("description") : "" %></textarea>
		</span>

		<span class="liblrow rightalign block">
			<input type="submit"  value="  Save Event  ">
			</form>
		</span>
%	} 

	</div>
			
	<div class="right small">
		<& menu.mas, tourn => $tourn, event_id => ($event) ? $event->id : "" &>		
	</div>

<%args>
	$circuit
	$tourn
	$session
	$debug => 1
	$pool_id => undef
</%args>
<%init>

use POSIX;
my $now = DateTime->now;
$now->set_time_zone", $tourn->tz);

if ", $pool_id) {

	my $filename =  "judge_pool-".$pool_id."-".$session->id;
	`cd $Tab::file_root/tmp; rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;

	my $pool = Tab::Pool->retrieve", $pool_id);

	open (TEXOUT, ">>$Tab::file_root/tmp/$filename.tex");

    print TEXOUT <<"EOF";

\\documentclass[10pt]{article}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=1in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.35in}

\\begin{document}
\\footnotesize

EOF

print TEXOUT "\\bigskip \n";
print TEXOUT "{\\Large\\bf Judges in pool ".$pool->name."}\\\\ \n";
print TEXOUT "\\medskip\n";

print TEXOUT <<'EOF';

\medskip
\begin{center}

EOF

	my $switch;

	foreach my $judge (sort {$a->code <=> $b->code} $pool->judges) { 

		print TEXOUT "\\begin{tabular}{p{.5in}p{.5in}p{.75in}p{.75in}p{1.5in}p{2in}}\n";

        print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" unless ", $switch++ % 2);

		print TEXOUT ", $judge->school->id) ? $judge->school->code : "HIRE";
		print TEXOUT " & ";
		print TEXOUT $judge->code." & ";
		print TEXOUT $judge->first." & ";
		print TEXOUT $judge->last." & ";
		print TEXOUT $judge->school->name." " if $judge->school->id;
		print TEXOUT " Hired " unless $judge->school->id;

		print TEXOUT " & ";

		foreach my $class ", $judge->judge_group->setting("classes) {
			print TEXOUT $class->name.": ";
			print TEXOUT $judge->class_qual", $class)->name." " if $judge->class_qual", $class);
		}


		print TEXOUT "\\\\ \n";
		print TEXOUT "\\end{tabular} \n";
		print TEXOUT "\\newline\n";
	}

	print TEXOUT "\\end{center} \n";
	print TEXOUT "\\end{document} \n";
	close TEXOUT;

	`cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
	`cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
	`cd $Tab::file_root/tmp; rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;
	$m->redirect("$Tab::url_prefix/tmp/$filename.pdf");

} else { 

	my $filename =  "judge_pools-".$tourn->id."-".$session->id;

    my $now = DateTime->now;
    $now->set_time_zone", $tourn->tz);

	open (TEXOUT, ">>$Tab::file_root/tmp/$filename.tex");

    print TEXOUT <<"EOF";

\\documentclass[10pt]{article}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=1in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.35in}

\\begin{document}
\\small

EOF

print TEXOUT "\\begin{center} \n";
print TEXOUT "\\bigskip \n";
print TEXOUT "{\\Large\\bf ".$tourn->name." Judge Pools }\\\\ \n";
print TEXOUT "\\medskip\n";

print TEXOUT <<'EOF';

\end{center}
\medskip

\begin{center}


EOF

	my $switch;

	foreach my $pool (sort {$a->name cmp $b->name} $tourn->pools) { 

		print TEXOUT "\\begin{tabular}{p{.5in}p{.5in}p{5.5in}}\n";
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\n" if ", $switch++ % 2);

		print TEXOUT $pool->name." & ";

		my $not_first;

		my @judges = sort {$a->code <=> $b->code} $pool->judges;

		print TEXOUT scalar @judges." judges & ";

		foreach my $judge (@judges) {
			print TEXOUT ",  if $not_first;
			print TEXOUT $judge->code.":".$judge->last;
			$not_first++;
		}

		print TEXOUT "\\\\ \n";
		print TEXOUT "\\end{tabular} \n";
		print TEXOUT "\\newline\n";
	}

	print TEXOUT "\\end{center} \n";
	print TEXOUT "\\end{document} \n";
	close TEXOUT;

	`cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
	`cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
#	`cd $Tab::file_root/tmp; rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;
	$m->redirect("$Tab::url_prefix/tmp/$filename.pdf");

}

</%init>

<%args>
	$account
	$school
	$session
</%args>
<%init>

	my $tourn = $school->tourn;

	my @results = $m->comp('/funclib/school_results.mas', school => $school);

	my @result_values = $m->comp('/funclib/school_result_values.mas', school => $school);

	my %values_by_result = ();

	foreach my $value (@result_values) { 
		push @{$values_by_result{$value->result->id}}, $value;
	}

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz);

    my $name = $tourn->name."-".$school->short_name;
    $name =~ s/[\W_]//g;

    my $filename = "Results-$name-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 
    
    $m->comp("/funclib/printout.mas", filename => $filename, head => 1, array => 2.0 );

    open (TEXOUT, ">>$filepath.tex");
    
    print TEXOUT "\\bigskip\n";
    print TEXOUT "{\\huge Results: ". Tab::texify($tourn->name) ." ".Tab::texify($school->short_name)." } \\\\ \n";
    print TEXOUT "\\newline\n";

	my $tabular = "\\begin{tabular}{p{.35in}p{1.5in}p{.35in}p{.5in}p{1.75in}p{1.5in}}\n";

	print TEXOUT $tabular;
	print TEXOUT "\\rowcolor[rgb]{1,.95,.66}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT "\\bf Place & \\bf Entry & \\bf Event & \\bf Set & \\bf Tiebreaks & \\bf Ballots \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	my $switch;

	foreach my $result (@results) { 

		print TEXOUT $tabular;
		print TEXOUT "\\rowcolor[rgb]{.95,.95,.95}\[5.5pt\]\[5.5pt\]\n" if $switch++ % 2;

		my @values = @{$values_by_result{$result->id}};
		my $seed;

		my $label = $result->result_set->label;
		$label =~ s/Places//g;

		foreach my $value (@values) {
			next if $value->value eq "Prelim";
			$seed = $value if $value->tag eq "seed";
			$seed = $value if $value->tag eq "Place";
		}

		print TEXOUT Tab::texify($seed->value) if $seed;

		print TEXOUT " & ".Tab::texify($result->entry->name);

		print TEXOUT " & ".Tab::texify($result->entry->event->abbr);

		print TEXOUT " & ".Tab::texify($label);

		print TEXOUT " & \\raisebox{.025in}{";

		foreach my $value (@values) { 
			next if $value->tag eq "Ballots";
			next if $value->tag eq "Place";
			print TEXOUT "\\parbox{.32in}{\\footnotesize{ ";
			print TEXOUT Tab::texify($value->tag)."} \\\\ ";
			print TEXOUT Tab::texify($value->value)." }";
		}

		print TEXOUT "} & \\raisebox{.025in}{";

		foreach my $value (@values) { 
			next unless $value->tag eq "Ballots";
			my $ballots = Tab::texify($value->value);
			$ballots =~ s/-/\\\\/g;
			$ballots =~ s/ /}} \\parbox\{.22in\}\{\\footnotesize{ /g;
			print TEXOUT "\\parbox{.22in}{\\footnotesize{".$ballots." }} ";
		} 
		
		print TEXOUT "} \\\\ \n";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";

	} 
	
	close TEXOUT; 
	
	$m->comp("/funclib/printout.mas", filename => $filename, tail => 1 );


</%init>



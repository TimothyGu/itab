<%args>
	$diocese_id	
	$tourn_id
	$debug => 1
</%args>
<%init>

	my $diocese = Tab::Region->retrieve($diocese_id);
	my $tourn = Tab::Tourn->retrieve($tourn_id) if $tourn_id;

    my $filename = "Diocese-Registration-".$tourn->id."-".$diocese->id;
    my $filepath = $Tab::file_root."/tmp/";
    my $garbage = `rm -f $filepath"."$filename.*`;
    open (TEXOUT, ">$filepath"."$filename.tex");

	print TEXOUT <<"EOF";
\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{multirow}
\\usepackage{courier}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=1in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\arraystretch}{1.4}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}

\\begin{document}
\\small

EOF
	my $now = DateTime->now;

	print TEXOUT "\\begin{tabular}{p{3.5in}p{3.5in}}\n";
	print TEXOUT "\\Huge ". $tourn->name;
    print TEXOUT "& \\Large The Archdiocese of " if $diocese->arch;
    print TEXOUT "& \\Large The Diocese of " unless $diocese->arch;
	print TEXOUT $diocese->name ." \\\\ \n";
    print TEXOUT "& \\normalsize Director: ". $diocese->director->first." ".$diocese->director->last ."\\\\ \n";
    print TEXOUT "& Quota: ". $diocese->quota ."\\\\ \n";
    print TEXOUT "& Printed: ". $now->mdy('/') ."\\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\small\n";

	close TEXOUT;

	$m->comp("/funclib/ncfl/registration_print.mas", 
				diocese_id => $diocese_id, 
				filename => $filename, 
				filepath => $filepath, 
				tourn_id => $tourn_id, 
				);

    open (TEXOUT, ">>$filepath"."$filename.tex");
	print TEXOUT "\n\n \\medskip\n";
	close TEXOUT;

	$m->comp("/funclib/ncfl/judge_registration_print.mas", 
				diocese_id => $diocese_id, 
				filename => $filename, 
				filepath => $filepath, 
				tourn_id => $tourn_id );

    open (TEXOUT, ">>$filepath"."$filename.tex");
	print TEXOUT "\\medskip\n";
	close TEXOUT;

	$m->comp("/funclib/ncfl/schools_print.mas", 
				diocese_id => $diocese_id, 
				filename => $filename, 
				filepath => $filepath, 
				tourn_id => $tourn_id);

    open (TEXOUT, ">>$filepath"."$filename.tex");
	print TEXOUT "\\end{document}\n";
	close TEXOUT;

    $garbage = `cd $filepath; $Tab::latex_path $filename.tex;`;
    $garbage = `cd $filepath; $Tab::latex_path $filename.tex;`;
    $garbage = `cd $filepath; $Tab::dvipdfm_path $filename.dvi;`;
    $garbage = `cd $filepath; rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;
    $m->redirect("$Tab::url_prefix/tmp/$filename.pdf");

</%init>

<div id="content">

<p><% $filename %></p>

<%args> 
	$group_id
	$region_id
	$account
</%args>
<%init>

	my $region = Tab::Region->retrieve($region_id);

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my @classes = sort {$a->name cmp $b->name} $group->classes;

	my $tourn = $group->tournament;

	my @judges = $m->comp("/funclib/ncfl/covering_judges.mas", region => $region, group => $group);

	my @prelim_pools = $group->prelim_pools;

	my %judges_by_pool = ();

	my @poolless_judges;

	if (@prelim_pools) { 

		foreach my $judge (@judges) { 

			push (@poolless_judges, $judge) unless $judge->prelim_pool;
			next unless $judge->prelim_pool;

			push (@{$judges_by_pool{$judge->prelim_pool->id}}, $judge);

		}

	}

	my $pool_obligation;

	my @chapters = sort {$a->name cmp $b->name} $region->chapters;

	my @quals = $tourn->quals;

	my @elim_pools = $group->elim_pools;

	my $judge_burden = $m->comp("/funclib/ncfl/judge_obligation.mas", region => $region, group => $group);

	unless ($region->director->id eq $account->id || $account->site_admin) { 
		$m->redirect("/account/access_denied.mhtml");
	}

	my @events = sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_events.mas", tourn => $tourn);

	my $switch;

</%init>

	<div class="left huge">
		
		<table cellpadding="0" width="100%">

			<tr>
				<td width="100%"> 
					<h2>
						Judges for <% $group->abbr %> prelims
					</h2>
				</td>

			</tr>

		<table cellpadding="4" cellspacing="1" width="98%" border="0" style="margin-left: 10px;">

			<tr class="liblrow">

				<td style="background-color: #f9f9f9;">
				</td>

				<td class="smaller">
					First
				</td>

				<td class="smaller">
					Last
				</td>

				<td class="smaller">
					School
				</td>

				<td class="smaller">
					Exp
				</td>

				<td class="smaller" colspan="2">
					Functions
				</td>

			</tr>


%			if (@prelim_pools) { 

%				foreach my $pool (@prelim_pools) { 

%					my @pool_judges = @{$judges_by_pool{$pool->id}} if $judges_by_pool{$pool->id};

%					my $pool_burden = $m->comp("/funclib/ncfl/prelim_pool_obligation.mas", region => $region, pool => $pool);

%					my $needed = $pool_burden - scalar @pool_judges;
%					$needed = 0 if $needed < 0;

%					$pool_obligation = "Short in ".$pool->name if $needed > 0; 
				
					<tr class="<% ($needed) ? "lirdrow" : "ligrnrow" %>">

						<td class="smaller" colspan="5" style="padding-top: 2px;">
							Judges in <% $pool->name %>  (<% $pool_burden %> owed)
						</td>

						<td class="smaller" colspan="2" style="padding-top: 2px;" align="center">
							<% ($needed) ? $needed." more needed " : "Obligation met!" %>
						</td>
					</tr>

<%perl>
					foreach my $judge (@{$judges_by_pool{$pool->id}}) {

						$switch = print_judge($judge, $group,$switch);

					}

				}

				if (@poolless_judges) { 

</%perl>

					<tr class="lirdrow"> 

						<td class="smaller" colspan="5" style="padding-top: 2px;">
							Judges without prelim pools:
						</td>

						<td class="smaller" colspan="2" style="padding-top: 2px;" align="center">
						</td>
					</tr>

<%perl>


					foreach my $judge (@poolless_judges) { 

						$switch = print_judge($judge, $group,$switch);

					}

				}

			} else { 

				foreach my $judge (@judges) {

					$switch = print_judge($judge, $group,$switch);

				}

			}

</%perl>

			<tr class="<% ($judge_burden > scalar (@judges)) ? "lirdrow" : ($pool_obligation) ? "lirdrow" : "ligrnrow"%>">

				<td colspan="5" style="text-align: right;" class="smaller">
					<% $judge_burden %> total prelim judges owed:
				</td>

				<td colspan="2" style="text-align: center;" class="smaller">

					<% ($judge_burden - scalar (@judges) > 0) ? ($judge_burden - scalar (@judges))." more needed" 
						: ($pool_obligation) ? $pool_obligation : "Obligation met!" %>

				</td>

			</tr>

			<tr class="liblrow">

				<td class="smaller" align="right" colspan="7">
					<form action="<% ($group->tab_room) ? "tab_edit.mhtml" : "judge_edit.mhtml" %>" method="post">
					<input type="hidden" name="group_id" value="<% $group->id %>">
					<input type="hidden" name="region_id" value="<% $region->id %>">
					<input type="submit" value=" Add another <% ($group->tab_room) ? "Tabber" : "Judge" %>" >
					</form>
				</td>

			</tr>


		</table>

%		if (@elim_pools) { 

			<h3>Judges for <% $group->abbr %> Elims:</h3>

			<p class="smaller">Note: "D" judges may not judge elim rounds and
			will not appear below.  Judges can only judge in one division
			during elims, but may judge a different division than they judged
			in prelims.</p>

			<table cellpadding="4" cellspacing="1" width="98%" border="0" style="margin-left: 5px;">

				<tr class="liblrow">

					<td style="background-color: #fafafa;">
						<form action="judge_elims_save.mhtml" method="post">
						<input type="hidden" name="group_id" value="<% $group->id %>">
						<input type="hidden" name="region_id" value="<% $region->id %>">
					</td>

%					foreach my $pool (@elim_pools) { 

						<td align="center" class="smaller">
							<% $pool->name %>
						</td>

%					}
					

				</tr>

%			foreach my $judge ($region->judges($tourn)) { 

%				next if $judge->elim_group && $judge->elim_group != $group->id;
%				next if $judge->judge_group->tab_room;
%				my @quals = $judge->quals;
%				next unless @quals;
%				next if $quals[0]->name eq "D";

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td class="smaller">
						<% $judge->first." ".$judge->last %>
						(<% $judge->judge_group->abbr %>)
					</td>

%					foreach my $pool (@elim_pools) { 
						<td align="center">
							<input type="checkbox" name="<% $judge->id %>_<% $pool->id %>" value="1"
								<% ($judge->in_pool($pool)) ? "checked" : "" %>
							>
						</td>
%					}

				</tr>
%			}

<%perl>

# Calculate the total owed if the region is small enough to qualify for the
# Alternative Maximum Tax.

	my ($total_owed, $style) = $m->comp("/funclib/ncfl/pool_obligation.mas", region => $region, group => $group);

</%perl>

			<tr class="<% ($total_owed) ? "lirdrow" : "ligrnrow" %>">
				
				<td class="smaller">
					Elims Owed:
				</td>

%				if ($style eq "overall") { 
					<td colspan="6" align="right" class="smaller">
						<% ($total_owed) ? $total_owed." more elim round(s)" : "All set for elims!" %>
					</td>
%				} else { 

%					foreach my $pool (@elim_pools) { 

%						my ($owed, $ditch) = $m->comp("/funclib/ncfl/pool_obligation.mas", region => $region, pool => $pool);

						<td align="center" class="smaller">
							<% ($owed) ? $owed." more " : "OK" %>
						</td>
%					}

%				}

			</tr>

			<tr class="liblrow">
				
				<td colspan="6" align="right">
					<input type="submit" value="  Save Elim Assignments ">
					</form>
				</td>

			</tr>

			</table>


%		}

%	unless ($group->tab_room) { 

		<p class="smaller">
			For elim rounds, you owe EITHER a percentage of your judges for
			each elim round, OR a total of elim rounds equal to <% $group->max_pool_burden %>x the number
			of judges you owe in that judge group, whichever is smaller.  This
			rule affects smaller dioceses, keeping them from having to place
			their judges in every elim round to fill quotas. 
		</p>
		
		<p class="smaller">

			A diocese owing 2 judges in a category thus only owes <%
			$group->max_pool_burden * 2 %> elim rounds total.  You may, of
			course, always register to judge MORE elims than your obligation,
			if desired.

		</p>
%	}

	</div>

	<& menu.mas, group => $group, tourn => $tourn, region => $region &>

%	sub print_judge { 

%		my ($judge, $group, $switch) = @_;

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td class="smaller">
						<% $switch %>.
					</td>

					<td class="smaller">
						<% $judge->first %>
					</td>

					<td class="smaller">
						<% $judge->last %>
					</td>

					<td class="smaller">
						<% $judge->school->name %>
					</td>

					<td class="smaller" align="center">
%						foreach my $qual ($judge->quals) { 
							<% $qual->name %>
%						}
					</td>

%					if ($judge && $judge->alt_group && $judge->alt_group->id == $group->id ) { 

						<td colspan="2" class="smaller" align="center">
							<a href="tourn_judges_enter.mhtml?region_id=<% $judge->school->region->id %>&group_id=<% $judge->judge_group->id %>">
							From <% $judge->judge_group->name %>
							</a>
						</td>

%					} else { 

						<td class="smaller" align="center">
							<form action="<% ($group->tab_room) ? "tab_edit.mhtml" : "judge_edit.mhtml" %>" method="post">
							<input type="hidden" name="judge_id" value="<% $judge->id %>">
							<input type="submit" value=" Edit " >
							</form>
						</td>

						<td class="smaller" align="center">
							<form action="judge_drop.mhtml" method="post">
							<input type="hidden" name="judge_id" value="<% $judge->id %>">
							<input type="submit" value=" Drop " class="red">
							</form>
						</td>

%					}

				</tr>

%		return $switch;

%	}

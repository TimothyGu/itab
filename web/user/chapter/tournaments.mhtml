<%args>
	$account
	$chapter_id
	$tourn
	$all => undef
	$tz => "America/New_York"
</%args>
<%init>

	$tz = "America/New_York" unless $tz;

	my $chapter = Tab::Chapter->retrieve($chapter_id);
	my $switch; 

	my $now = DateTime->now;
	my $now_string = DateTime::Format::MySQL->format_datetime($now);

	Tab::Tourn->set_sql("by_entered_tourn", "
		select distinct tourn.* 
			from school,tourn
			where school.chapter = ? 
			and school.tourn = tourn.id
			and tourn.end < ?");
	
	my @existing_tourns = Tab::Tourn->search_by_entered_tourn($chapter->id, $now_string);

	Tab::Tourn->set_sql("by_open_tourn", "
		select distinct tourn.* 
			from tourn,tourn_circuit,chapter_circuit
			where chapter_circuit.chapter = ?
			and chapter_circuit.circuit = tourn_circuit.circuit
			and tourn_circuit.tourn = tourn.id
			and tourn.reg_start > ?
			and tourn.reg_end < ?
			and not exists ( 
				select school.id from school
				where school.chapter = chapter_circuit.chapter
				and school.tourn = tourn.id)");
	
	my @open_tourns = Tab::Tourn->search_by_open_tourn($chapter->id, $now_string, $now_string);


</%init>

	<div class="huge left">

%			if (@existing_tourns) { 

				<h2>Existing tournament registrations</h2>

				<table cellpadding="5">

					<tr class="dkgreenrow"> 

						<th class="smaller">
							Dates
						</th>

						<th class="smaller">
							Name
						</th>

						<th class="smaller">
							Circuits
						</th>

						<th class="smaller">
							Deadline
						</th>

						<th></th>

					</tr>

%					foreach my $et (@existing_tourns) { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td width="15%" class="center smaller">
								<% Tab::niceshortdate($et->start->set_time_zone($tz)) %>
								<% ($et->start->day != $et->end->day) ? " - ".Tab::niceshortdate($et->end->set_time_zone($tz)) : "" %>
							</td>

							<td class="smaller">
								<a class="white block" href="/user/tourn/enter.mhtml?chapter_id=<% $chapter->id %>&tourn_id=<% $et->id %>">
								<% $et->name %> 
								</a>
							</td>

							<td width="10%" class="centeralign smaller">
% 								foreach ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 
									<% $_->abbr %>
% 								}
							</td>

							<td width="8%" class="centeralign smaller">
								<% Tab::niceshortdate($et->reg_end->set_time_zone($tz)) %>
							</td>

						
							<td class="centeralign">
								<a class="dkgreen block" href="/user/tourn/enter.mhtml?chapter_id=<% $chapter->id %>&tourn_id=<% $et->id %>">
									Entry
								</a>
							</td>

						</tr>

%					}

				</table>

%			}

%			if (@open_tourns) { 

				<h2>Tournaments open for registration</h2>

				<table cellpadding="3" cellspacing="1" width="100%">

%					my $hidden;

%					foreach my $ot (@open_tourns) { 

%						$hidden++ if $account->no_interest($ot) && not defined $all;
%						next if $account->no_interest($ot) && not defined $all;

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td class="center">
								[<a href="no_interest.mhtml?tourn_id=<% $ot->id %>&chapter_id=<% $chapter_id %>">X</a>]
							</td>

							<td>
								<a class="whiteblock" href="/index/tourn/index.mhtml?tourn_id=<% $ot->id %>">
								<% $ot->name %> 
								</a>
							</td>

							<td width="10%" class="center">
								<% Tab::niceshortdate($ot->start) %>
							</td>

							<td width="10%" class="center">
								<% $ot->league->short_name %>
							</td>

							<td width="20%" class="center">
								<a class="whiteblock" href="/user/tourn/enter.mhtml?chapter_id=<% $chapter->id %>&tourn_id=<% $ot->id %>">
									Register
								</a>
							</td>

						</tr>
%					}

%					if ($hidden) { 
					
						<tr class="oddrow">
							<td colspan="4" class="smaller">
								[<a href="tournaments.mhtml?chapter_id=<% $chapter_id %>&all=yessireebob">Show all</a>]
							</td>
						</tr>


%					}

				</table>

%			} 

%			unless (@open_tourns || @existing_tourns) {

				<h2>You must join a league or two</h2>

				<p>There are currently no tournaments open for registration in
				your league(s).</p>

				<p>Double-check your <a href="leagues.mhtml?chapter_id=<%
				$chapter->id%>">League Memberships</a> by clicking the tab
				above if there are tournaments you believe you should be able
				to register for.</p>

				<p>If you are looking for open high school invitationals, you
				have to join the "league" Invitationals: High School before you
				can register for the tournaments.  No dues/fees apply for
				joining this league</p>
		
				<p>Remember to add your students and judges to your roster
				(tabs above) before registering them for tournaments!</p>

%			}

	</div>


	<div class="small right">

		<& /user/menu.mas, chapter => $chapter, account => $account, tourn => $tourn &>

	</div>
	

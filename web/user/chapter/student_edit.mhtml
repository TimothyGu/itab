<%args>
	$account
	$newbie => undef
	$student_id => undef
	$chapter_id => undef;
	$from => undef;
</%args>
<%init>

	my $student = Tab::Student->retrieve($student_id) if $student_id;
	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($student || $chapter) { 
		my $err = "You haven't chosen a chapter.  Please choose at right";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	$chapter = $student->chapter unless $chapter;

	unless ($chapter) { 
		my $err = "You haven't chosen a chapter.  Please choose at right";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $now = DateTime->now(time_zone => $account->tz);
	$now->subtract( days => 1 );

	my @students = Tab::Student->search_where({
		chapter => $chapter->id, 
		timestamp => {">=", DateTime::Format::MySQL->format_date($now)}},
		{order_by => "timestamp"}
		);

	my $switch;

</%init>

	<div class="left huge">

		<h2><% $chapter->name %> Student Roster</h2>

        <& tabbar.mas, chapter => $chapter, whoami => "students" &>

%		if ($student) {
			<h4>Edit <% $student->first." ".$student->last %></h4>
% 		} else { 
			<h4>Add a student:</h4>
% 		}

%		if ($newbie) { 

			<p>
				You now should add the student names for your team into your
				roster by adding their information below.  Consider adding in
				your entire team to save work later.
			</p>
			
			<p>
				You only have to add each student once for their entire career;
				you can then look up an entire student record for all the
				tournaments on Tabroom that a given student attends.
			</p>

			<p>
				Begin by adding the first student below.
			</p>

			<hr />

%		}

		<table cellpadding="5" cellspacing="1" width="100%" >
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					<form action="student_search.mhtml" method="post">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<% ($student) ? "Link this student to "  : "Find student w/" %>an idebate.org account:
				</td>

				<td>
					<input type="email" name="email" placeholder="Search by email address" size="25">
				</td>

				<td>
					<input type="submit" class="thin" value="Search">
					</form>
				</td>
			</tr>

		</table>

		<br />

		<h4>Or, Create a new student (without idebate.org account)</h4>

		<table cellpadding="5" cellspacing="1" width="100%" >

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
				<td class="rightalign">
					<form action="student_save.mhtml" method="post">
					<input type="hidden" name="student_id" value="<% ($student) ? $student->id : "" %>">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<input type="hidden" name="from" value="<% $from %>">
					First Name:
				</td>
				
				<td>
					<input type="text" name="first" size="20" value="<% ($student) ? $student->first : "" %>">
				</td>

			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
				<td class="rightalign">
					Last Name:
				</td>
				
				<td>
					<input type="text" name="last" size="20" value="<% ($student) ? $student->last : ""%>">
				</td>

			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
				<td class="rightalign">
					Phonetic Pronunciation:
				</td>
				
				<td>
					<input type="text" name="phonetic" size="20" value="<% ($student) ? $student->phonetic : ""%>">
				</td> 

			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
				<td class="rightalign">
					Grad Year:
				</td>
				
				<td>
					<input type="text" name="grad_year" size="6" value="<% ($student) ?   $student->grad_year : ""%>">
				</td>

			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
				<td class="rightalign">
					Novice:
				</td>
				
				<td>
					<input type="checkbox" name="novice" value="1" <% ($student) ?  ($student->novice) ? 'checked' : '': "" %> >
				</td> 

			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
				<td class="rightalign">
					Gender:
				</td>
				
				<td>
					<input type="radio" name="gender" value="M" <% ($student) ? ($student->gender eq "M") ? "checked" : "" : "" %>> M
					<input type="radio" name="gender" value="F" <% ($student) ? ($student->gender eq "F" ) ? "checked" : "" : "" %>> F
				</td>
			</tr> 
			
			<tr class="liblrow">

				<td colspan="2" class="rightalign">
					<input  type="submit" name="twitch" value="  Save Student & Add Another  ">
					</form>
				</td>
				
			</tr>

		</table>

	</div>

	<div class="right small">
	
		<div class="sidenote">
			
			<h4>Your Students:</h4>

			<a class="yellow block" href="students.mhtml?chapter_id=<% $chapter->id %>">
				Return to student roster
			</a>

			<br />

%			foreach my $student (@students) { 
			
				<a class="blue block" href="student_edit.mhtml?student_id=<% $student->id %>">
					<span class="namespan">
						<% $student->first." ".$student->last %>
					</span>
					<span class="tinyspan" style="text-align: right; float: right;">
						<% $student->grad_year %>
					</span>
				<a>

%			}

		</div>

	</div>


<%args>
	$chapter_id
	$account
	$session
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	$m->comp("/user/chapter/auth.mas", chapter => $chapter, account => $account, session => $session);

	my %league_member = ();

	my @ljs = sort {$a->league->name cmp $b->league->name} $chapter->league_joins;

	my $switch;

</%init>

	<div id="leftbignb"> 
	
		<& /user/tabbar.mas, chapter => $chapter, whoami => "league" &>

%		if (@ljs) { 
			
			<h2>Leagues: <% $chapter->name %></h2>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">

					<th>
						League
					</th>

					<th>
						Membership
					</th>

					<th class="smaller">
					</th>

				</tr>

%				foreach my $lj (@ljs) { 

%					next unless $lj->active;
%					my $league = $lj->league;

%					$league_member{$league->id}++;

%					next if ($league->diocese_based || $league->active < 1 );

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>			

						<td class="smaller">
							<% $league->name %>
						</td>

						<td class="smaller">

							<% ($lj->full_member) ? "" : "Tournaments Only" %>

%							if ($lj->membership) { 
								<% $lj->membership->name %>		
								<% ($lj->membership->dues > 0) ? "(\$".$lj->membership->dues.")" : "" %>		
%							}

%							if ($league->region_based && $league->regions && $lj->region) { 
								<% $lj->region->name %> region
%							}

						</td>

						<td class="smaller">

							<a href="league_leave.mhtml?lj_id=<% $lj->id %>" class="whiteblock">
								Leave League
							</a>

						</td>

					</tr>

%				}

			</table>

%		} else { 

			<h2>Joining Leagues</h2>

			<p class="smallish">
				All tournaments on tabroom.com are part of a league.  The
				leagues on tabroom.com are listed below.
			</p>
			
			<p class="smallish">
				Click "Join League" to fully join.  You will be able to
				register for tournaments, and will recieve emails about the
				league.  You may also be billed for membership dues.  This is
				best for joining a state or local league.
			</p>

			<p class="smallish">
				Click "Tournaments Only" if you want to register for
				tournaments, but don't want League emails or to be a dues
				paying member.  Some leagues are run entirely on a 
				tournament-only basis.
			</p>

			<p class="smallish">
				Register for tournaments without organized leagues on tabroom
				by joining "Invitationals: High School" for tournaments with
				high school competitors, or "Invitationals: College" for
				tournaments for college student competitors (not high school
				tournaments hosted by colleges; those are under High School).
			</p>

			<p class="smallish">
				If you don't know what league your tournament is in, check 
				front page of Tabroom.com.  Click on the tournament and
				the league will be listed at right.
			</p>

%		}

		<h3>Leagues You Can Join</h3>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr class="liblrow">

				<th>
					League
				</th>

				<th class="smaller">
					State
				</th>

				<th class="smaller" colspan="2">
					Click to join:
				</td>

			</tr>

%		foreach my $league (sort {$a->name cmp $b->name} Tab::League->search( active => 1 )) {  

%			next if $league->diocese_based;
%			next if $league_member{$league->id};

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>			

				<td class="smaller">
					<% $league->name %>
				</td>

				<td class="smallctr">
					<% $league->state %>
				</td>

				<td class="smaller">
%					if ($league->tourn_only) { 
						<a class="whiteblock" href="league_join.mhtml?type=to&league_id=<% $league->id %>&chapter_id=<% $chapter->id %>">
							Tournaments Only
						</a>
%					}
				</td>

				<td class="smaller">
%					if ($league->full_members) { 
						<a class="whiteblock" href="league_join.mhtml?type=full&league_id=<% $league->id %>&chapter_id=<% $chapter->id %>">
							Join League
						</a>
%					} 
				</td>

			</tr>

%		}

		</table>

	</div>

	<div id="rightsmall"> 

		<& /user/menu.mas, chapter => $chapter, account => $account &> 

	</div>

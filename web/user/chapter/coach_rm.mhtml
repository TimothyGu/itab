<%args>
	$coach_id
	$chapter_id
	$account
</%args>
<%init>

	my $err;
	my $chapter = Tab::Chapter->retrieve($chapter_id);
	my $coach = Tab::Account->retrieve($coach_id); 

    my @acc = Tab::ChapterAccess->search( account => $account->id, chapter => $chapter_id);

    unless (@acc || $account->site_admin) {
        my $err = "You are not authorized to edit ". $chapter->name ;
        $m->redirect("$Tab::url_prefix/user/chapter/settings.mhtml?err=$err");
    }

	# Can't be the only one left 

	my @all_coaches = Tab::ChapterAccess->search( chapter => $chapter_id );

	unless ((scalar @all_coaches) > 1) { 
		my $err = "You may not delete the last coach to have access to that chapter";
		$m->redirect("$Tab::url_prefix/user/chapter/settings.mhtml?err=$err&chapter_id=$chapter_id");

	}

	my @ca = Tab::ChapterAccess->search( account => $coach_id, chapter => $chapter->id);

	foreach (@ca) {  $_->delete; } 

	$err = "Coach ".$coach->first." ".$coach->last." has been removed from ". $chapter->name;	

	$m->redirect("$Tab::url_prefix/user/chapter/settings.mhtml?err=$err&chapter_id=$chapter_id");

</%init>

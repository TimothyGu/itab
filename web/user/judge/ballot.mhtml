<%args>
	$account
	$panel_id => undef 
	$judge_id => undef
</%args>
<%init>

	unless ($panel_id && $judge_id) { 
		my $err = "I didn't get both a judge and a ballot record";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	unless ($panel && $judge) { 
		my $err = "No ballots found for that judge and that panel."
		$m->redirect("/user/home.mhtml?err=$err");
	}

	unless ($judge->account->id == $account->id) { 
		my $err = "You are not authorized to enter ballots for that judge."
		$m->redirect("/user/home.mhtml?err=$err")
	}

	my @ballots = Tab::Ballot->search(  judge => $judge->id, panel => $panel->id );

	unless (@ballots) { 
		my $err = "That judge does not judge in that room."
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $type = $panel->round->event->type;
	my $tiebreaks = $panel->round->tb_set;

	my $wins;
	my $points;
	my $ranks;

	foreach my $tb ($tb_set->tiebreaks) { 
		$ranks++ if ($tb->name eq "ranks" || $tb->name eq "reciprocals");
		$wins++ if ($tb->name eq "opp_wins" || $tb->name eq "winloss");
		$points++ if ($tb->name eq "points" || $tb->name eq "competition" || $tb->name eq "opp_points");
	}

	my $tourn = $judge->judge_group->tourn;

	my @panel_students = $m->comp('/funclib/panel_students.mas', panel => $panel);
	my $tv++ if $type eq "speech" && $tourn->setting("mfl_time_violation"));
	my $noshow++ if $type eq "speech" && $tourn->setting("noshows_never_break");
	my $max_points = $panel->round->event->setting("max_points");

</%init>

	<div id="left huge">
		
		<span class="hugespan">
			<h2>Enter your Ballot</h2>
		</span>

%		if ($type eq "pf" || $round->type eq "elim") { 
			<span class="smallspan">
				<form action="ballot_side_swap.mhtml">
				<input type="hidden" name="panel_id" value="<% $panel->id %>">
				<input type="submit" value="Swap Sides">
				</form>
			</span>
%		}
	
		<br style="clear: both;">

			<tr class="yellowrow">

%				unless ($type eq "speech" || $type eq "congress") { 
					<th>
						Side
					</th>
%				}

				<th>
					Entry
				</th>

%				unless ($type eq "speech" || $type eq "congress") 

					<th>
						Side
					</th>
%				}

%				if  ($wins) { 
					<th>
						W/L
					</th>
%				}

%				if  ($ranks) { 
					<th>
						Rank
					</th>
%				}

%				if  ($points) { 
					<th>
						Points
					</th>
%				}

%				if ($tv) { 
			
					<th>
						Overtime
					</th>
%				}

%				if ($noshow) { 
			
					<th>
						No show
					</th>
%				}

			</tr>

%			my $index = 1;

%			foreach my $ballot (@ballots) { 

%				my @students = $ballot->entry->students;

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

%					unless ($type eq "speech" || $type eq "congress") { 

						<td>
%							if ($type eq "pf") { 
								<% ($ballot->side == 1) ? "Pro" : "Con" %>
%							} else { 
								<% ($ballot->side == 1) ? "Aff" : "Neg" %>
%							}
						</td>

%					}

					<td>
						<% $ballot->entry->name %>
					</td>

%					if  ($wins) { 
						<td>
							Winner: <input type="radio" name="win" value="<% $ballot->id %>">
						</td>
%					}

%					if  ($ranks) { 
						<td>
%							foreach my $student (@students) { 
								<div class="white block"> 
									<% (scalar @students > 1) ? substr($student->first." ".$student->last.":", 0, 30) : "" %>
									<input tabindex=<% $index++ %> type="number" name="<% $student->id %>_points" min="1" max="<% scalar @panel_students %>">
								</div>
%							}
						</td>
%					}

%					if  ($points) { 
						<td>
%							foreach my $student (@students) { 
								<div class="white block"> 
									<% (scalar @students > 1) ? substr($student->first." ".$student->last.":", 0, 30) : "" %>
									<input tabindex=<% $index++ %> type="number" name="<% $student->id %>_points" min="1" max="<% scalar @panel_students %>">
								</div>
%							}
						</td>
%					}

%					if ($tv) { 

						<td>
							<input type="checkbox" name="<% $ballot->id %>_tv" value="1"> 
						</td>
%					}

%					if ($noshow) { 

						<td>
							<input type="checkbox" name="<% $ballot->id %>_noshow" value="1"> 
						</td>
	
%					}

				</tr>
%			}

			<tr class="liblrow">

				<td colspan="4" class="rightalign">
					<input type="submit" value=" Submit Ballot ">
					</form>
				</td>

			</tr>

		</table>

	</div>

	<div id="right small">

		<div id="sidenote">

			<h4>This round:</h4>

			<span class="tinyspan">
				Round
			</span>

			<span class="medspan">
				<% $panel->round->realname %>
			</span>

			<br style="clear: both;">

			<span class="tinyspan">
				Room
			</span>

			<span class="medspan nowrap">
				<% $panel->room ? $panel->room->name : "" %>
			</span>

			<br style="clear: both;">

%			if ($round->judges > 1) { 

%				foreach my $other_judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

%					next if $other_judge->id == $judge->id;
	
					<span class="tinyspan">
						<% $other_judge->chair ? "Chair:" : "Other:" %>
					</span>

					<span class="medspan nowrap">
						<% $other_judge->code." ".$other_judge->first." ".$other_judge->last %>
					</span>
%				}

%			}


			<a href="round.mhtml?round_id=<% $panel->round->id %>" class="blue block">
				Full Pairing/Schematic
			</a>

		</div>

		<div id="sidenote">

			<h4>Your ballots</h4>


		</div>


	</div>

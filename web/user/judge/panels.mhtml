<%args>
	$account
	$session
</%args>

%	my @panels = $m->comp("/funclib/account_panels.mas", account => $account);
%	my @done_panels = $m->comp("/funclib/account_panels.mas", account => $account, done => 1);
%	my @pubs = $m->comp("/funclib/account_published.mas", account => $account);
%	my %panels_done = ();
%	my $switch;

	<& /user/menu.mas, account => $account &>

	<div class="huge left">

		<h2>
			Current Tournament Assignments & Ballots
		</h2>

%		if (@panels) { 
			
			<h4>Pending Rounds:</h4>

			<table cellpadding="5" cellspacing="1">

				<tr class="yellowrow">

					<th class="smaller">
						Round
					</th>

					<th class="smaller">
						Room
					</th>

					<th class="smaller">
						Starts
					</th>

					<th class="smaller">
						Entries
					</th>

					<th class="smaller">
					</th>

				</tr>
%		}

%		foreach my $panel (@panels) { 

%			$panels_done{$panel->id}++;
%			next unless $panel->round->published;

%			my $judge = Tab::Judge->retrieve($panel->judge);
%			my $tourn = $judge->judge_group->tourn;
%			my @entries = $m->comp('/funclib/panel_entries.mas', panel => $panel);
%			my @scores = $m->comp('/funclib/panel_scores.mas', panel => $panel, judge => $judge);

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td class="smallish">
					<% $panel->round->event->abbr %> <% $panel->round->realname %>
				</td>

				<td class="smallish">
					<% $panel->room ? $panel->room->name : "No Room Listed" %> 
				</td>

				<td class="smallish">
					<% Tab::nicetime($panel->round->timeslot->start->set_time_zone($tourn->tz)) %>
				</td>

				<td class="smallish">
%					foreach my $entry (@entries) { 
						<span class="medbigspan nowrap" style="padding-bottom: 5px">
							<% $entry->name %> 
						</span>
						<span class="tinyspan rightalign">
							<% $entry->side ? $entry->side == 1 ? "Aff" : "Neg" : "" %>
						</span>
						<br />
%					}
				</td>

				<td class="centeralign">

%					if ($panel->started) { 
						<a class="dkgreen block" href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">
							<% (@scores ) ? "RE" : "" %>ENTER
						</a>
%					} else { 
						<a class="dkgreen block" href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">
							START ROUND
						</a>
%					}

%					if (@scores) { 
						<a class="dkred block" href="re_confirm.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">
							CONFIRM
						</a>
%					}
				</td>

			</tr>

%		}

%		if (@panels) { 
			</table>
%		}


%		if (@done_panels) { 

%			undef $switch;
			<h4>Previously Entered Results:</h4>

			<table cellpadding="5" cellspacing="1">

				<tr class="yellowrow">

					<th class="smaller">
						Rnd
					</th>

					<th class="smaller">
						Entry
					</th>

					<th class="smaller">
						W/L
					</th>

					<th colspan="8" class="smaller">
						Speaks & Ranks
					</th>

				</tr>


%		}

%		foreach my $done (@done_panels) { 

%			$panels_done{$done->id}++;

%			my $judge = Tab::Judge->retrieve($done->judge) if $done->judge;
%			my @entries = $m->comp('/funclib/panel_entries.mas', panel => $done);
%			my @scores = $m->comp('/funclib/panel_scores.mas', panel => $done, judge => $judge);
%			my %scores_by_recipient =();
%			foreach my $score (@scores) {  
%				push @{$scores_by_recipient{$score->student->id}}, $score if $score->student && $score->student->id; 
%			}

%			$switch++;
%			my $rounded;

%			foreach my $entry (@entries) { 

				<tr class="<% ($switch % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						<% $rounded ? "" : $done->round->label ? substr($done->round->label,0,4) : $done->round->name  %>
						<% $done->round->flighted > 1 && not defined $rounded ? $done->flight : "" %>
%						$rounded++;
					</td>

					<td class="smallish nowrap">
						<span class="tinyspan">
						<% $entry->side ? $entry->side == 1 ? "Aff" : "Neg" : "" %>
						</span>
						<% $entry->name %>  
					</td>

					<td class="smallish nowrap">

%						foreach my $score (@scores) { 
%							next if $score->student > 0;
%							next unless $score->ballot->entry->id == $entry->id;
							<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
							<% $score->tag eq "rank" ? $score->value : "" %>
							<% $score->tag eq "points" ? $score->value : "" %>
%						}
					</td>

%					foreach my $student ($entry->students) { 
%						my @scores = @{$scores_by_recipient{$student->id}} if $student->id && $scores_by_recipient{$student->id};
%						next unless @scores;
								
						<td class="smallish nowrap">

							<% $student->last %>:

%							my $notfirst;
%							foreach my $score (@scores) { 
								<% $notfirst++ ? "-" : "" %>
								<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
								<% $score->tag eq "rank" ? $score->value : "" %>
								<% $score->tag eq "points" ? $score->value : "" %>
%							}
								
						</td>

%					}

				</tr>

%			}

%		}

%		if (@done_panels) { 
			</table>
		
			<p class="explain" style="margin-top: 25px;">
				Note: You cannot edit past ballots; you can only view them.  Once
				you have confirmed a ballot, you must contact the tournament
				officials to make changes.
			</p>
%		}

%		if (@pubs) { 

			<h4>Assignments</h4>

			<table cellpadding="4" cellspacing="1">

				<tr class="yellowrow">

					<th class="smaller">
						Div/Round
					</th>

					<th class="smaller">
						Start
					</th>

					<th class="smaller">
						Room
					</th>

					<th class="smaller">
						Entries
					</th>

				</tr>

%			foreach my $panel (@pubs) { 

%				my $tz = $panel->round->event->tourn->tz;
%				$tz = "UTC" unless $tz;

%				next if $panels_done{$panel->id};
%				my @entries = $m->comp('/funclib/panel_entries.mas', panel => $panel);

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						<% $panel->round->event->abbr." ".$panel->round->realname %>
					</td>

					<td class="smallish">
						<% Tab::niceshortdt($panel->round->timeslot->start->set_time_zone($tz)) %>
					</td>

					<td class="smallish">
						<% $panel->room ? $panel->room->name : "" %>
					</td>
					
					<td class="smallish">
%						foreach my $entry (@entries) { 
							<span class="medbigspan nowrap" style="padding-bottom: 5px">
								<% $entry->name %> 
							</span>
							<span class="tinyspan rightalign">
								<% $entry->side ? $entry->side == 1 ? "Aff" : "Neg" : "" %>
							</span>
							<br />
%						}
					</td>

				</tr>
%			}

			</table>

%		}

	</div>


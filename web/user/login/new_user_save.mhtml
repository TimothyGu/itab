<%args>
	$err => undef
	$first
	$last
	$email
	$pass1
	$pass2
	$phone
</%args>

<%init>

	use Crypt::PasswdMD5;
	use Email::Valid;

    my $md5_salt = $m->comp("/funclib/generate_randomstring.mas");

	$email =~tr/[A-Z]/[a-z]/;

	my @existing_account = Tab::Account->search( email => $email );

	if (@existing_account) { 
	
		$err = "An account with that email address already exists on this system.  Please have the system email you your password if you've forgotten it.";
		$m->redirect("$Tab::url_prefix/user/login/new_user.mhtml?err=$err&first=$first&last=$last&email=$email&phone=$phone");
		
	} else { 

		unless ($pass1 eq $pass2) { 

			$err = "The two passwords supplied did not match.";
			$m->redirect("$Tab::url_prefix/user/login/new_user.mhtml?err=$err&first=$first&last=$last&email=$email&phone=$phone");

		}

		my $emailok = Email::Valid->address( -address => $email, -mxcheck => 0 ) ? 'yes' : 'no';

		if ($emailok ne 'yes') {

    	    $err = "That email address is not valid.  Please enter a valid address. $emailok";
			$m->redirect("$Tab::url_prefix/user/login/new_user.mhtml?err=$err&first=$first&last=$last&email=$email&phone=$phone");

		}

        my $passhash = unix_md5_crypt($pass1,$md5_salt);

		my $account = Tab::Account->create({ 
			first => $first,
			last  => $last,
			email => $email,
			passhash => $passhash,
			phone => $phone
		});

		$m->redirect("$Tab::url_prefix/user/login/login_save.mhtml?email=$email&password=$pass1&first=yippee");

	}

</%init>

<%args>
	$comp_id
	$judge_id
	$account
</%args>
<%perl>

	my $comp = Tab::Comp->retrieve($comp_id);
	my $judge = Tab::Judge->retrieve($judge_id);
	my $group = $comp->event->judge_group;

	unless ($group->id == $judge->judge_group->id) { 
		my $err = "You cannot strike judges outside your judge group.  Quit messing around.";
		$m->redirect("/user/tourn/entry/ratings/comp_strikes.mhtml?school_id=".$comp->school->id."&comp_id=$comp_id&group_id=".$group->id."&err=$err");
	}

    # Get the list of existing strikes.
    my @strikes = $comp->strikes;

    my %strikes_by_id = ();

	my $bank = $group->comp_strikes;

    foreach (@strikes) { 
		$strikes_by_id{$_->judge->id} = $_; 
		$bank--;
	}
	
	if ($strikes_by_id{$judge_id}) {

		$strikes_by_id{$judge_id}->delete;
		my $msg = "You have un-struck ".$judge->first." ".$judge->last;
		$m->redirect("/user/tourn/entry/ratings/comp_strikes.mhtml?school_id=".$comp->school->id."&comp_id=$comp_id&group_id=".$group->id."&msg=$msg");
		$bank++;

	} elsif ($bank > 0) { 

		$bank--;

		my $strike = Tab::Strike->create({
			tournament => $group->tournament->id,
			comp => $comp_id,
			type => "comp",
			strike => 1,
			judge => $judge_id
		});

		my $msg = "You have struck ".$judge->first." ".$judge->last;
		$m->redirect("/user/tourn/entry/ratings/comp_strikes.mhtml?school_id=".$comp->school->id."&comp_id=$comp_id&group_id=".$group->id."&msg=$msg");
	
	} else { 

		my $msg = "You already have reached your strike limit.  Unstrike a judge if you hate that judge sufficiently to strike them";
		$m->redirect("/user/tourn/entry/ratings/comp_strikes.mhtml?school_id=".$comp->school->id."&comp_id=$comp_id&group_id=".$group->id."&msg=$msg");

	}
	
</%perl>


<%args>
	$group_id
	$school_id
	$account
	$hired_number
	$certain => undef
	$debug => undef
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id);
	my $school = Tab::School->retrieve($school_id);

	my $now = DateTime->now();
	my $err;

	my $request = $school->requests_by_group($group);

	system "$Tab::logger -t tabroom I am called to hire judges" if $debug;

	if ($hired_number) { 

		my $covers = $hired_number * $group->setting("judge_per") if $group->hired_fee;
		$covers = $hired_number unless $covers;
		
		system "$Tab::logger -t tabroom Covers request is $covers " if $debug;

		if ($request) { 

			system "$Tab::logger -t tabroom Request exists with id ".$request->id if $debug;

			$request->covers($covers);
			$request->update;

			if ($covers < $request->accepted) { 
		
				system "$Tab::logger -t tabroom Covers fewer than accepted " if $debug;

				if ($certain) { 

					$request->accepted($covers);
					$request->update;

					# In case the number here was reduced, go through and accept
					# requests for anyone waiting in line
					$m->comp("/funclib/accept_pending_hires.mas", group => $group, account => $account);

				} else {

					$m->comp("/funclib/check_reducing_hires.mas", 
									group => $group, 
									account => $account,
									school => $school, 
									hired_number => $hired_number);
					$m->abort;

				}

			}

		} else { 

			system "$Tab::logger -t tabroom Creating a judge request:" if $debug;

			$request = Tab::JudgeHire->create({
				tournament => $school->tournament,
				school => 	$school->id,
				judge_group => $group->id,
				request_made => $now,
				covers => $covers
			});

			system "$Tab::logger -t tabroom Created judge request: ".$request->id if $debug;

		}

		my $available_slots = $group->hired_pool * $group->setting("judge_per");
		system "$Tab::logger -t tabroom There are $available_slots slots available" if $debug;

		if ($available_slots) { 
	
			foreach my $acc (Tab::JudgeHire->search( judge_group => $group->id )) { 
				$available_slots -= $acc->accepted;
			}
			
			system "$Tab::logger -t tabroom There are $available_slots slots available after checking" if $debug;

			if ($available_slots < $request->covers && $request->accepted < $request->covers) { 

				$request->accepted($available_slots) if $available_slots > 0;

				$err = "There were not sufficient hired judges in the
				tournament pool to meet your request.  <br /><br /> You will be
				notified by email if the tournament adds hired judges and
				accepts your hire request. <br /><br />";

				$err = "This tournament is manually manging hiring requests.
				Your request for hired judging has been submitted.  You will be
				notified by automatic email if and when the tournament accepts
				your request." if $available_slots == 0;

			} else { 

				$request->accepted( $request->covers ) if $available_slots >= $request->covers;
			}

			$request->update;
		}


	} else { 

		$request->delete() if $request;
	}

	$m->redirect("$Tab::url_prefix/user/tourn/entry/judges.mhtml?group_id=".$group->id."&school_id=".$school->id."&err=$err");

</%init>


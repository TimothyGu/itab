<%args>
	$account
	$event_id	
	$school_id => undef
	$student_id => undef
	$partner_id => undef
	$waitlist => undef
	$name => undef
</%args>
<%init>

	unless ($school_id) { 
		my $err = "You have no school.  Please choose your tournament entry at right";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $msg;
	my $entry;

	unless ($student_id || $name) { 
		my $err = "You have not entered a student or a team name.  Please try again.\n";
		$m->redirect("$Tab::url_prefix/user/tourn/entry/students.mhtml?event_id=$event_id&school_id=$school_id&err=$err");
	}

	my $now = DateTime->now;

	$name =~ s/&/and/g;

	my $event = Tab::Event->retrieve($event_id);
	my $tourn = $event->tournament;


	my $student = Tab::Student->retrieve($student_id) if $student_id;
	my $partner = Tab::Student->retrieve($partner_id) if $partner_id;

	if ($student) { 

		my @entries = $student->entries($tourn);

		if (grep $event_id == $_->event->id, @entries) {

			my $err = $student->first." ".$student->last." is already entered";
			$m->redirect("$Tab::url_prefix/user/tourn/entry/students.mhtml?school_id=$school_id&event_id=$event_id&err=$err")
	
		}

	}

	if ($partner) { 

		my @entries = $partner->entries($tourn);

		if (grep $event_id == $_->event->id, @entries) {

			my $err = $partner->first." ".$partner->last." is already entered";
			$m->redirect("$Tab::url_prefix/user/tourn/entry/students.mhtml?school_id=$school_id&event_id=$event_id&err=$err")
	
		}

	}

	if ($event->team == 2 && $student_id == $partner_id) { 
		my $err = "You have tried to enter the same person twice in a team event.  Try again.";
       	$m->redirect("$Tab::url_prefix/user/tourn/entry/students.mhtml?err=$err&event_id=$event_id&school_id=$school_id");
	}

	if ($event->team == 2 && not defined $partner_id) { 
		my $err = "You need to register two students for this event.  Try again.";
       	$m->redirect("$Tab::url_prefix/user/tourn/entry/students.mhtml?err=$err&event_id=$event_id&school_id=$school_id");
	}

	my $code = $event->next_code;

	if ($event->team == 1) { 

		my @already = Tab::Entry->search( student => $student->id );
	
		$entry = Tab::Entry->create({ 
			tournament => $tourn->id,
			school => $school_id,
			student => $student_id,
			waitlist => $waitlist,
			event => $event_id,
			code => $code,
			registered_at => $now,
			dropped => 0
		});

		if ($tourn->method->track_reg_changes) { 

			my $regline = $account->first." ".$account->last." 
				entered ".$event->abbr." competitor $code (".$student->first." ".$student->last.")";
			
			my $change = Tab::Change->create({
				tournament => $tourn->id,
				school => $school_id,
				type => "registration",
				regline => $regline
			});

		}
			
		$msg = $student->first." ".$student->last." has been entered in ". $event->name;
			
	} 
	
	if ($event->team == 2) { 

		$entry = Tab::Entry->create({ 
			tournament => $tourn->id,
			school => $school_id,
			event => $event_id,
			code => $code,
			student => $student_id,
			partner => $partner_id,
			waitlist => $waitlist,
			registered_at => $now,
			dropped => 0
		});

		if ($tourn->method->track_reg_changes) { 

			my $regline = $account->first." ".$account->last." entered ".$event->abbr." 
							competitor $code (".$student->last." and ".$partner->last.")";
			my $change = Tab::Change->create({
				tournament => $tourn->id,
				school => $school_id,
				type => "registration",
				regline => $regline
			});

		}
	
		$msg = $student->first." ".$student->last." and ". $partner->first." ".$partner->last." have been entered in ". $event->name;
	
	}
	
	if ($event->team == 3) { 
	
		$entry = Tab::Entry->create({ 
			tournament => $tourn->id,
			school => $school_id,
			waitlist => $waitlist,
			event => $event_id,
			code => $code,
			registered_at => $now,
			name => $name
		});

	 	if ($tourn->method->track_reg_changes) { 

			my $regline = $account->first." ".$account->last." entered ".$event->abbr." competitor $code (".$name.")";

			my $change = Tab::Change->create({
				tournament => $tourn->id,
				school => $school_id,
				type => "registration",
				regline => $regline
				});

		}

		$m->redirect("$Tab::url_prefix/user/tourn/entry/team_members.mhtml?entry_id=".$entry->id."&school_id=".$school_id);
	}

	if ($event->ask_for_titles || $tourn->method->ask_qualifying_tournament || $tourn->method->ask_two_quals) { 

		$m->redirect("$Tab::url_prefix/user/tourn/entry/details.mhtml?entry_id=".$entry->id."&school_id=$school_id");

	}

	$msg = "Entry entered";

	$m->redirect("$Tab::url_prefix/user/tourn/entry/students.mhtml?event_id=$event_id&school_id=$school_id&msg=$msg");

</%init>


<%args> 
	$school_id
	$group_id => undef
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);
	my $group = Tab::JudgeGroup->retrieve($group_id);
	
	my $tourn = $school->tournament;
	my $league = $tourn->league;

	my @events = $group->events if $group;

	my $err;

	#Make sure that the tournament is open for registration
	my $now = DateTime->now;

	my $switch;

</%init>

    <h2><% $school->name %> at the <% $tourn->name %></h2>

    <& menubar.mas, school => $school, whoami => "judges" &>

	<div id="leftbignb">

%		if ($group) { 

%			if ($tourn->judge_deadline < $now || $group->deadline < $now) { 							

				<p class="warning">The deadline to enter judge information
				online has passed.  You must contact the tournament directly to
				make changes.</p>

%			}

%           my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group);
			<p>You have <% $uncovered %> entr<% ($uncovered == 1) ? "y" : "ies" %> uncovered.  Each judge covers <% $group->judge_per %> entries.</p>

			<h3><% $group->name %> Judges</h3>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">

					<% ($tourn->method->hide_codes || $group->hide_codes) ? "" : "<th>Code</th>" %>

					<th>
						Name
					</th>

%					if ($group->bins) { 
						<th class="smaller">
							Availability (Click to change)
						</th>
%					}

%					if ($group->coach_ratings) { 
						<th class="smaller">
							Ratings
						</th>
%					}

					<th>
					</th>

				</tr>

%				foreach my $judge ($m->comp("/funclib/judgemath/judges_useful_by_group.mas", school => $school, group => $group)) {

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<% ($tourn->method->hide_codes || $group->hide_codes) ? "" : "<td>".$judge->code."</td>" %>

						<td>
%							unless ($tourn->judge_deadline < $now || $group->deadline < $now) { 							
								<a class="whiteblock" href="judge_details.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
%							}
							<% $judge->first." ".$judge->last%>
							</a>
						</td>


%						if ($group->bins) { 

%							my $binned;

							<td class="smaller">
%								unless ($tourn->judge_deadline < $now || $group->deadline < $now) { 							
									<a class="whiteblock" href="judge_timebins.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
%								}

%									foreach my $bin ($group->bins) { 
%										if ($bin->strike($judge)) { 
%											$binned++;
											Not available <% $bin->name %> ($<% $bin->fine %>)
%										}
%									}

%									unless ($binned) { 
										All rounds
%									}
								
								</a>

							</td>
%						}

%						if ($group->coach_ratings) { 

							<td class="center">

%							foreach my $rating ($judge->all_ratings) { 
%								next unless $rating->qual;
								<% $rating->qual->name %>
%							}

							</td>

%						}

						<td class="center">
%							unless ($tourn->judge_deadline < $now || $group->deadline < $now) {
								<a class="whiteblock" href="judge_drop.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
									[Drop]
								</a>
%							}
						</td>

					</tr>

% 				} 

			</table>

%			if ($group->track_judge_hires) { 

				<br />
				<br />

%				if ($group->uncovered_entry_fee > 0) { 

%				undef($switch);
%   			my $request = $school->requests_by_group($group);
%   			my $hires_requested += $request->covers if $request;
%   			my $hires_accepted += $request->accepted if $request;

				<h3>Hired Judging</h3>

				<p class="explain" style="padding-left: 10px;">
					This tournament hires judging by the student, not the whole
					judge.  Enter hire requests for the number of students who
					you do not have judging for.  Please note that a hire
					request does not mean the tournament has judges available
					for hire; the software will notify you when/if your request
					is accepted.
				</p>

					<table cellpadding="9" cellspacing="1" width="100%"> 

%						unless ($tourn->judge_deadline < $now || $group->deadline < $now) {
						
							<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
							
								<td>
									<form action="hire_save.mhtml" method="post">
									<input type="hidden" name="school_id" value="<% $school->id %>">
									<input type="hidden" name="group_id" value="<% $group->id %>">
									Request how many entries of hired judging:
								</td> 

								<td class="center">
									<input type="text" name="hired_number" size="2" value=<% $hires_requested %>>
								</td>
							
								<td class="center">
									<input class="skinny" type="submit" value="   Request Hires   ">
									</form>
								</td>
							
							</tr> 
%						}
						
%						if ($hires_requested) { 

							<tr class="liblrow">

								<td>
									Entries of hired judging the tournament accepted:
								</td>
							
								<td class="center">
										<% $hires_accepted %>
								</td>
								
								<td class="center">
									(of <% $hires_requested %>)
								</td>
							
							</tr>

%							if ($uncovered) { 

								<tr class="lirdrow">

									<td>
										Entries still uncovered by judging:
									</td>
							
									<td class="center">
										<% $uncovered %>
									</td>
								
									<td class="center">
									</td>
							
								</tr>
%							}
%						}

					</table>
%				}

%				if ($group->hired_fee > 0) { 

%					undef $switch;

%					my $request = $school->requests_by_group($group);
%       			my $hires_requested += $request->covers if $request;
%       			my $hires_accepted += $request->accepted if $request;

%       			$hires_requested = ceil($hires_requested / $group->judge_per) if $group->judge_per;
%       			$hires_accepted = ceil($hires_accepted / $group->judge_per) if $group->judge_per;
	
					<h3>Hired judging</h3>

					<table cellpadding="4" cellspacing="1"  width="100%">

%					unless ($tourn->judge_deadline < $now || $group->deadline < $now) {

		            	<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input type="hidden" name="school_id" value="<% $school->id %>">
        		        	    <input type="hidden" name="group_id" value="<% $group->id %>">
    		            	    Request 
                			    <input type="text" name="hired_number" size="2" value=<% $hires_requested %>>
								hired judges
            			    </td>

                			<td class="center">
                    			<input class="blue" type="submit" value="   Save   ">
                			    </form>
            			    </td>

    		        	</tr>

%					}

%					if ($hires_requested) { 

		            <tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>		

            		    <td>
        		            Hiring requests accepted*
    		            </td>
	
            		    <td class="center">
							<% $hires_accepted %> (of <% $hires_requested %>)
        		        </td>

		            </tr>

%					}

					</table>

%				}

%			}

			<br />
			<br />

%		} else { 

			<p>
				Choose a judge category at right to enter judges or hire out
				judging committments (where tournaments permit).
			<p>

			<p>
				Divisions marked in red are divisions where you still owe
				judging.
			</p>

%		}

%		if ($tourn->judge_policy > 0) { 
			<h4 style="margin-left: 5px;">Tournament Judging notes:</h4>
			<p style="padding: 5px;"><% $tourn->judge_policy %></p>
%		}

	</div>

	<div id="rightsmall">

%		if ($group && ($tourn->judge_deadline > $now)) { 

%			unless ($group->deadline && $group->deadline < $now) {
        
			<h3>Add Judges:</h3>

%			my @ubers = $school->free_ubers;
%		    my $now = DateTime->now;

%			if (@ubers) { 

				<table cellpadding="3" cellspacing="1" width="100%">

					<tr>
						<td class="center">
	
							<form action="/user/tourn/entry/judge_save.mhtml" method="post">
							<input type="hidden" name="group_id" value="<% $group->id %>">
							<input type="hidden" name="school_id" value="<% $school->id %>">
		
							<select name="uber_id" size="7">
%								foreach my $uber (sort {$a->last cmp $b->last} @ubers) { 
									<option value="<% $uber->id %>"><% $uber->last.", ".$uber->first %></option>
%								}
							</select>
						</td>
					</tr>

					<tr class="liblrow">
	
						<td class="right">
							<input type="submit" value=" Enter Judge into <% $group->abbr %> ">
							</form>
						</td>
	
					</tr>

				</table>

%			} else { 

				<p>
					You have no judges on your roster to add.  Please add them
					before registering them into the tournament.  You only need
					to type in each judge's name to your roster once; they'll
					be available for all future tournaments.
				</p>



%			}

			<a class="redblock" href="/user/chapter/uber_roster.mhtml?from=<% $group->id %>&chapter_id=<% $school->chapter->id %>">
				Add Judges to Roster
			</a>


			<hr />

%		}
%		}

		<a class="whiteblock">Categories in red are below obligation:</a>

%		foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {

%			my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group); 
%			my (@useful_judges, @dontcount) = $m->comp("/funclib/judgemath/judges_useful_by_group.mas", school => $school, group => $group);
%			my $obligation = $m->comp("/funclib/judgemath/judges_needed_by_group.mas", school => $school, group => $group);

				<a href="judges.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" 
					class="<% ($uncovered < 1) ? "blueblock" : "redblock" %>">
						<span style="float: left;  width: 160px;"><% substr($group->name,0,22) %></span>
					<% scalar @useful_judges %>/<% $obligation %>
					<% ($uncovered < 1) ? " " : " Not Met" %> 
					<% ($uncovered < 1 && (scalar @useful_judges < $obligation) ) ? "+ Hires " : "" %> 
				</a>


%			if ($group->deadline) {
				<a href="/user/tourn/entry/judges.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" class="whiteblockind">
					**<% $group->abbr %> Judges due: <% &Tab::niceshortdt($group->deadline->set_time_zone($tourn->league->timezone)) %>
				</a>

%			}

%		}

	</div>


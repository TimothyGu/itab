<%args>
	$judge_id
	$school_id
	$cellphone => undef
	$alt_id => undef
	$paradigm => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);
	my $group = $judge->judge_group;
	my $tourn = $group->tournament;

	my $school = Tab::School->retrieve($school_id);

	my $missing_rating;

	if ($group->coach_ratings) { 

		unless ($group->qual_subsets) { 

			my $qual_id = $ARGS{"qual_id"};

			my $rating = $judge->rating;

			$missing_rating .= "<br/> Missing ".$group->name." rating " unless $qual_id;

			if ($rating) { 

				$rating->qual($qual_id);
				$rating->update;

			} else { 
		
				Tab::Rating->create({
					type => "coach",
					tournament => $tourn->id,
					judge => $judge->id,
					qual => $qual_id,
				});
			}

		} else { 

			foreach my $subset ($group->qual_subsets) { 

				my $qual_id = $ARGS{$subset->id};

				$missing_rating .= "<br/> Missing ".$subset->name." rating." unless $qual_id;

				my $rating = $judge->rating($subset);

				if ($rating) {	 

					$rating->qual($qual_id);
					$rating->update;

				} else { 

					Tab::Rating->create({
						type => "coach",
						tournament => $tourn->id,
						judge => $judge->id,
						qual => $qual_id,
						subset => $subset->id
					});

				}
			}
		}

		if ($missing_rating) { 

			my $err = "You must rate the judge in every category. ".$missing_rating;
			$m->redirect("judge_details.mhtml?school_id=$school_id&judge_id=$judge_id&err=$err");

		}

	}

	$judge->paradigm($paradigm);
	$judge->cell($cellphone);
	$judge->alt_group($alt_id) if $alt_id;

	$judge->update;

	my $uber = $judge->uber;
	$uber->paradigm($paradigm);
	$uber->cell($cellphone);
	$uber->update;

	my $msg = "Judge ".$judge->first." ".$judge->last." entered";

	$m->redirect("judges.mhtml?school_id=$school_id&group_id=".$group->id."&msg=$msg");

</%init>

<%args> 
	$school_id
	$account
	$event_id => undef
</%args>
<%init>

	unless ($school_id) {
		my $err = "You have to choose a chapter first";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $school = Tab::School->retrieve($school_id);

	my $event = Tab::Event->retrieve($event_id) if $event_id;	

	my $tourn = $school->tournament;
	my $league = $tourn->league;

	my $tz = $league->timezone;

    my $now = DateTime->now;

	if ($event) { 

		my @already_entered = Tab::Comp->search( 
			school => $school->id, 
			event => $event_id, 
			waitlist => 0
		);

		my @waitlist = Tab::Comp->search( 
			school => $school->id, 
			event => $event_id, 
			waitlist => 1
		);

</%init>

	<h2><% $school->name %> at the <% $tourn->name %></h2>

	<& menubar.mas, school => $school, whoami => "students" &>

	<div id="leftbignb">

%		if ($now > $tourn->drop_deadline) { 

			<h2>Change deadline has passed</h2>
							
			<p>
				If you have additional changes, you can no longer enter them
				online.  Please contact the tournament directly.
			</p>

%		}

		<h3><% $event->name %> Entries:</h3>

%			if ($tourn->method->ask_two_quals) { 

				<p>
					Please enter the qualifying tournaments in the slots
					providing, along with the student's placement at that
					tournament and the size of the entry in that event.  
				</p>

%			}

% 			my $count;

% 			my $waitlist_done;

			<table cellpadding="5" cellspacing="1"  width="100%">

				<tr class="liblrow">

					<th>
					  	<% ($event->no_codes || $tourn->method->hide_codes) ? "" : "Code" %>
					</th>

%					if ($event->team == 3) { 

						<th>
							Team Name
						</th>

						<th>
							Members
						</th>

%					} else { 

						<th>
							Name <% ($event->team != 3) ? " (Click to swap) " : "" %>
						</th>
%					}

					<th>
						Access*
					</th>


					<th>
					</th>

				</tr>

% 				foreach my $already (@already_entered, @waitlist) { 

%					if ($already->waitlist &! $waitlist_done) { 

						<tr>

							<td colspan="8">
								<h4>Waitlisted Entries:</h4>
							</td>

						</tr>

%						$waitlist_done++;
	
%					}

%					if ($already->dropped) {
						<tr <% ($count % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%					} else { 
						<tr <% ($count % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%					}
			
						<td>
							<% ($already->dropped) ? "DROP" : ($tourn->method->hide_codes || $event->no_codes) ? "" : $already->code %>
						</td>


%							if ($event->team == 3) { 

								<td> 
									<% $already->team_name %>
								</td>


								<td class="smaller" style="padding-left: 7px;" width="35%">

% 									foreach my $student ($already->members) { 
%										if ($now < $tourn->drop_deadline) { 
											<a class="whiteblock"  style="padding: 1px; margin: 1px;"
											href="team_members.mhtml?student_id=<% $student->id %>&comp_id=<% $already->id%>&school_id=<% $school->id %>">
%										} else { 
											<a class="noblock" >
%										}
											<% $student->first %> <% $student->last %>
										</a>
%									}

%									unless ($already->members) { 
%										if ($now < $tourn->drop_deadline) { 
											<a class="whiteblock"  style="padding: 1px; margin: 1px;" href="team_members.mhtml?comp_id=<% $already->id%>&school_id=<% $school->id %>">
												Add Team Members
											</a>
%										}
%									}

									</td>

%							} else { 
								
								<td style="padding-left: 7px;" width="35%">

% 								foreach my $student ($already->members) { 
%									if ($now < $tourn->drop_deadline) { 
										<a class="whiteblock"  style="padding: 1px; margin: 1px;"
										href="nameswitch.mhtml?student_id=<% $student->id %>&comp_id=<% $already->id%>&school_id=<% $school->id %>">
%									} else { 
										<a class="noblock" >
%									}
										<% $student->first %> <% $student->last %>
									</a>
%								}
							
								</td>

%							}
	
						<td>

%							if ($already->ada) { 

%								if ($now < $tourn->drop_deadline) { 
									<a class="redblock" href="ada_switch.mhtml?comp_id=<% $already->id %>&school_id=<% $school->id %>">
										Cancel
									</a>
%								} else { 
									Requested
%								}

%							} else { 
%								if ($now < $tourn->drop_deadline) { 

								<a class="whiteblock" href="ada_switch.mhtml?comp_id=<% $already->id %>&school_id=<% $school->id %>">
									Request 
								</a>
%								} else { 
									<a class="noblock">
									None requested
									</a>
%								}

%							}

						</td>

						<td align="center">

%							unless ($now > $tourn->drop_deadline) { 
									
%								unless ($already->dropped) {

									<a class="whiteblock" href="comp_drop.mhtml?school_id=<% $school_id %>&comp_id=<% $already->id %>">
										Drop 
									</a>

%								} elsif ($now < $tourn->reg_end && $now < $event->deadline) { 

									<a class="redblock" href="comp_drop.mhtml?school_id=<% $school_id %>&comp_id=<% $already->id %>">
										DROPPED.  Click to un-drop
									</a>
%								}

%							}

						</td>

					</tr>

% 					if ($event->ask_for_titles) {

						<tr <% ($count % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<th class="smallrt">
								Title/ISBN:
							</th>

							<td colspan="4" class="smaller">
								<a class="whiteblock" href="details.mhtml?comp_id=<% $already->id %>&school_id=<% $school->id %>">
									<% ($already->title) ? $already->title : "Click to Enter Title" %>
								</a>
							</td>

						</tr>

%					}

%					if ($tourn->method->ask_qualifying_tournament || $tourn->method->ask_two_quals) { 

						<tr <% ($count % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<th class="smallrt">
								Qualifiers:
							</th>

							<td colspan="3" class="smaller">
								<a class="whiteblock"  style="padding: 1px; margin: 1px;" href="details.mhtml?comp_id=<% $already->id %>&school_id=<% $school->id %>">
									<% ($already->qualifier) ? $already->qualifier." ". $already->qualexp : "Enter Qualifier" %>
									<% ($tourn->method->ask_two_quals && $already->qualifier) ? "<br />".$already->qual2." ".$already->qual2exp : "" %>
								</a>
							</td>

						</tr>

%					}

%					$count++;

					</tr>

% 				} #end of foreach my already


%				if ($waitlist_done) {

					<tr>
						<td>
						</td>
					</tr>

					<tr>
						<td colspan="4" style="border: 1px solid black; padding: 8px;" class="explain">

							You have waitlisted students.  You will be notified
							by email when (or if) the tournament accepts your
							students off the waitlist.  Until then, it's
							difficult to predict when and by how much a
							waitlist is going to move.  

						</td>
						
					</tr>

%				}

%				if (@already_entered) {

					<tr>
						<td colspan="5" class="explain" style="border-top: 1px solid black;">
							<br />

							<b>*Access:</b>

							Use this box to indicate that the entry needs wheelchair or
							other access considerations.  Email the tournament
							staff if more details are needed.

						</td>
					</tr>

%				}

% 				if ($event->blurb > 0) { 

					<tr>
						<td colspan="8">
							<br />
							<br />
							<br />
							<br />
							<h4>Description and rules for <% $event->name %> </h4>
						</td>
					</tr>

					<tr>

						<td colspan="8">
% 							my $blurb = $event->blurb;
% 							$blurb =~ s/\n/\n<BR>/g;
							<% $blurb %>
						</td>
				
					</tr>
% 				}
	
			</table>

%		} else { 

			<h2>Enter students into <% $tourn->name %></h2>
	
			<& menubar.mas, school => $school, whoami => "students" &>

			<div id="leftbignb">

				<p>Choose an event at right to register students</p>
%		}

	</div>

	<div id="rightsmall">

%		if ($event) {

%			if ( ($now > $tourn->reg_end) || ($event->deadline && $now > $event->deadline) ) { 

%				if ($event->deadline && $now > $event->deadline) { 

					<a class="redblock">
						Event add deadline was <% Tab::niceshortdt($event->deadline->set_time_zone($tz)) %>
					</a>

%				} else { 
				
					<a class="redblock">
						Add Deadline was <% Tab::niceshortdt($tourn->reg_end->set_time_zone($tz)) %>
					</a>

%				}


%			} else { 

				<a class="redblock" href="/user/chapter/student_roster.mhtml?chapter_id=<% $school->chapter->id %>">Edit Student Roster</a>


<%perl>

			my $caphit; 

			$caphit = "Your school's limit of ".$event->school_cap." Reached" if (
				 ((scalar Tab::Comp->search( school => $school->id, event => $event->id, waitlist => 0)) >= ($event->school_cap)) && ($event->school_cap > 0) 
			);

		    $caphit = "This event is full." if (
				((scalar Tab::Comp->search(event => $event->id, dropped => 0, waitlist => 0)) >= ($event->cap)) && ($event->cap > 0)
			) ;

			$caphit.= " Add students to the waitlist:" if $caphit && $event->waitlist;

			$caphit .= "All students will be waitlisted and admitted to the tournament manually by tournament policy" if $event->waitlist_all;

		    my @clean_students = $m->comp("/funclib/students_evententer.mas",
        	    event => $event,
        	    league => $league,
       		    tourn => $tourn,
				chapter => $school->chapter);
				
			@clean_students = sort {ucfirst($a->last) cmp ucfirst($b->last)} @clean_students;

</%perl>
			
			<hr />

			<table cellpadding="2" cellspacing="1" width="100%">
				
				<tr>
					<td class="smaller">
						<form action="student_save.mhtml" method="post">
						<input type="hidden" name="school_id" value="<% $school->id %>">
						<input type="hidden" name="waitlist" value="<% ($caphit) ? 1 : 0 %>"> 
						<input type="hidden" name="event_id" value="<% $event->id %>">
						<% $caphit %>
					</td>
				</tr>

%				if ($event->team == 3) {

					<tr>
						<th>
							Add team:
						</th>

						<td align="right">
							<input type="text" name="name" size="25">
						</td>
					</tr>

%				} else { 

					<tr>
						<td class="center">
							<select name="student_id" size="10">

%								foreach my $student (@clean_students) { 
									<option value="<% $student->id %>">
										<% $student->last.", ".$student->first %>
									</option>
%								}

							</select>
						</td>
					</tr>

%					if ($event->team == 2) { 

						<tr>
							<td style="border-top: 1px solid black;" class="center">
								<select name="partner_id" size="10">

%									foreach my $student (@clean_students) { 
										<option value="<% $student->id %>">
											<% $student->last.", ".$student->first %>
										</option>
%									}

								</select>
							</td>
						</tr>

%					}

%				} 

				<tr class="liblrow">
					
					<td align="right" colspan="2">
						<input type="submit" class="blue" value="  Enter  ">
						</form>
					</td>

				</tr>

			</table>


%			if ($event->school_cap) {
				<a class="redblock"> 
					<% $event->abbr %> has a per-school limit of <% $event->school_cap %>
				</a>
%			}

%			if ($event->cap) {
				<a class="redblock">
					<% $event->abbr %> has a overall cap of <% $event->cap %>
				</a>
%			}

%		}

%			}

		<br />

		<h3>Events:</h3>

%		foreach my $event (sort {$a->name cmp $b->name} $tourn->events) { 

			<a class="<% ($event->id == $event_id) ? "chosenblock" : "blueblock"  %>"
				href="students.mhtml?school_id=<% $school->id %>&event_id=<% $event->id %>">
				<% scalar($school->comps(event => $event->id)) %> - <% $event->name %>
			</a>

%		}

	</div>


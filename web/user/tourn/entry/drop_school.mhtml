<%args>
	$school_id
	$account
	$confirmed => undef
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);

	unless ($school && $school->id) { 
		my $err = "School is not defined.  Perhaps you already deleted it?";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $chapter_id = $school->chapter->id;

	my $tourn = $school->tournament;

	$account->can_alter($school);

</%init>

%	unless ($confirmed eq "Yep") { 

		<div class="left huge">
		
			<h3>You are about to drop your entire entry.</h3>

			<div style="padding: 10px;">

			<p>This will remove all your students & judges from this tournament.
			You will lose any slots on your waitlist, and you will lose the ability
			to register altogether if the tournament is past its add deadline.
			</p>

			<p>At the very least you'd have to enter everyone all over again
			if you do intend to go to this tournament.</p>

			<p>Tread carefully</p>

			<p>If you do truly want to drop for good, click confirm below.</p>

			</div>

			<table cellpadding="5" width="100%">
				<tr class="lirdrow">
					<td align="right">
						<form action="drop_school.mhtml" method="post">
						<input type="hidden" name="school_id" value="<% $school_id %>">
						<input type="hidden" name="confirmed" value="Yep">
						<input type="submit" class="red" value="    Confirm Drop   ">
						</form>
					</td>
				</tr>
			</table>
		</div>

		<div class="right small" style="background-color: brown;">

			<span style="color: white; font-size: 38pt; display: block; writing-mode:tb-rl; -webkit-transform:rotate(90deg); -moz-transform:rotate(90deg); -o-transform: rotate(90deg); margin-top: 210px; margin-bottom: 0px; vertical-align: bottom; margin-left: -200px;">
				ARE
			</span>

			<span style="color: white; font-size: 38pt; display: block; writing-mode:tb-rl; -webkit-transform:rotate(90deg); -moz-transform:rotate(90deg); -o-transform: rotate(90deg); margin-top: 70px; margin-bottom: 15px; height=100px; margin-left: -200px;">
				YOU
			</span>

			<span style="color: white; font-size: 38pt; display: block; writing-mode:tb-rl; -webkit-transform:rotate(90deg); -moz-transform:rotate(90deg); -o-transform: rotate(90deg); margin-top: 70px; margin-bottom: -50px; margin-left: -200px;">
				SERIOUS?
			</span>
		</div>

<%perl>

	} else { 

		foreach my $comp ($school->entries) { 

			foreach my $strike (Tab::Strike->search(comp => $comp->id)) { $strike->delete;}

			foreach my $student ($comp->members) { 
				foreach my $housing ($student->housing($tourn)) {
					$housing->delete if $housing; 
				} 
			}
			
			$comp->delete;
		}

		foreach my $judge ($school->judges) { 

			foreach my $strike ($judge->strikes) { 
				$strike->delete;
			}

			foreach my $housing ($judge->housing) {
				$housing->delete if $housing;
			}

			$judge->delete;

		}

	    if ($tourn->method->track_reg_changes) {

	        my $regline = $account->first." ".$account->last." dropped the entire entry for ".$school->name.".  Bummer.";

	        my $change = Tab::Change->create({
	            tournament => $tourn->id,
	            type => "registration",
	            regline => $regline
	        });

    	}

		Tab::log($account->first." ".$account->last." deleted school ".$school->name." from ".$tourn->name);

        my $regline = $account->first." ".$account->last." dropped school ".$school->name;

        my $change = Tab::Change->create({
            tournament => $tourn->id,
            school => $school->id,
            type => "registration",
            regline => $regline
        }) if $tourn->method->track_reg_changes;

		$school->delete;

		my $msg = "You have been dropped completely from ".$tourn->name.".  Don't say I didn't warn you.";
		$m->redirect("/user/chapter/tournaments.mhtml?chapter_id=$chapter_id&msg=$msg");

	}

</%perl>


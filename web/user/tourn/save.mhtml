<%args>
	$account
	$name
	$webname
	$start
	$end
	$reg_start
	$reg_end
	$frozen
	$judge
	$drops
	$fines
	$circuit_string
	$site_id => undef
	$site_name => undef
	$state => undef
	$country => undef
	$tz => undef
</%args>
<%init>

	$tz = "UTC" unless $tz;

	unless ($site_name || $site_id) { 
		my $return = "You must select an existing site, or give your site a name";
		$m->redirect("location.mhtml?name=$name&start=$start&end=$end&reg_start=$reg_start&reg_end=$reg_end&drops=$drops&judge=$judge&frozen=$frozen&fines=$fines&circuit_string=$circuit_string&state=$state&tz=$tz&country=$country&error=$return");
	}

	my @circuits;

	foreach my $circuit_id (split(/-/, $circuit_string)) { 
		 push(@circuits, Tab::Circuit->retrieve($circuit_id));
	}

	my $default_circuit = $circuits[0];

	my $startdt = DateTime::Format::MySQL->parse_datetime($start);
	my $enddt = DateTime::Format::MySQL->parse_datetime($end) if $end;
	my $reg_startdt = DateTime::Format::MySQL->parse_datetime($reg_start);
	my $reg_enddt = DateTime::Format::MySQL->parse_datetime($reg_end);
	my $frozendt = DateTime::Format::MySQL->parse_datetime($frozen);
	my $finesdt = DateTime::Format::MySQL->parse_datetime($fines);
	my $judgedt = DateTime::Format::MySQL->parse_datetime($judge);
	my $dropsdt = DateTime::Format::MySQL->parse_datetime($drops);

	$startdt->set_time_zone($tz);
	$enddt->set_time_zone($tz);
	$reg_startdt->set_time_zone($tz);
	$reg_enddt->set_time_zone($tz);
	$frozendt->set_time_zone($tz);
	$finesdt->set_time_zone($tz);
	$judgedt->set_time_zone($tz);
	$dropsdt->set_time_zone($tz);

	my $site = Tab::Site->retrieve($site_id) if $site_id;

	unless ($site) { 

		$site = Tab::Site->create({
			circuit => $default_circuit->id,
			host => $account->id,
			name => $site_name
		});

		$site_id = $site->id;

	}

	my $tourn = Tab::Tourn->create( { 
		name => $name,
		webname => $webname,
		start => $startdt,
		end => $enddt,
		reg_start => $reg_startdt,
		reg_end => $reg_enddt,
		hidden => 0,
		state => $state,
		country => $country,
		tz => $tz
	});

	$tourn->setting("freeze_deadline", "date", $frozendt);
	$tourn->setting("fine_deadline", "date", $finesdt);
	$tourn->setting("judge_deadline", "date", $judgedt);
	$tourn->setting("drops_deadline", "date", $dropsdt);

	my $join = Tab::TournSite->create ({
		tourn => $tourn->id,
		site => $site_id
	});

	$join = Tab::TournAdmin->create ({
		tourn => $tourn->id,
		account => $account->id,
		contact => '1'
	});

	foreach my $circuit (@circuits) { 
		my $join = Tab::TournCircuit->create ({
			tourn => $tourn->id,
			circuit => $circuit->id
		});
	}

	$tourn->setting("school_codes", "shortname");

	$m->redirect("$Tab::url_prefix/user/tourn/confirm.mhtml?tourn_id=".$tourn->id);

</%init>


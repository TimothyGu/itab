<%args>
	$circuit
	$account
	$year => undef
</%args>
<%init>

	my $tz = $account->tz;
	$tz = "UTC" unless $tz;

	my @is_admin = Tab::CircuitAdmin->search( circuit => $circuit->id, account => $account->id );

	$year = $now->year unless $year;
	$year-- unless $now->month > 7;

	my $start_range = DateTime->create({
		year => $year,
		month => 7,
		day => 1,
		hour => 00,
		minute => 00,
		second => 00
	});

	my $end_range = DateTime->create({
		year => ($year + 1),
		month => 6,
		day => 30,
		hour => 11,
		minute => 59,
		second => 59
	});

	my @emails = Tab::Email->search_where({
		circuit => $circuit,
		sent_on => { '<', $end_range },
		sent_on => { '>', $start_range },
		
	});

	my $switch;

</%init>

	<& menu.mas, circuit => $circuit, whoami => "edit" &>

	<div class="left huge">

		<h2><% $circuit->abbr %> Emails</h2>

%	 	if ($year) { 

			<h4>Emails sent in <% $year."-".($year + 1) %> school year</h4>

			<table cellpadding="4" cellspacing="1" width="100%">

% 				foreach my $email (@emails) { 

%					my $sent_on = $email->sent_on->set_time_zone($tz);

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >
			
						<td class="nowrap smaller" width="30%">
							<% $email->subject %>
						</td>

						<td class="smaller">
							<% substr($email->sender->first,0,1)." ".$email->sender->last %>
						</td>

						<td class="smaller">
							<% Tab::niceshortdate($sent_on)%>
						</td>

						<td class="smaller" width="30%">
							<% $email->sent_to %>
						</td>

						<td>
							<a class="dkgreen block" href="email_view.mhtml?email_id=<% $email->id %>">
							View Email
							</a>
						</td>

					</tr>

% 				} 
			
			</table>

%		} 

	</div>


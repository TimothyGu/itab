<%args>
	$session
	$school
	$err => undef
	$histu => undef
</%args>
<%init>

	my $tourn = $school->tourn;

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $now = DateTime->now;
	my $reg_end = $tourn->reg_end;

</%init> 

	<div class="left huge">
		
		<h2><% $school->name %> at the <% $tourn->name %></h2> 

		<& menubar.mas, school => $school, whoami => "housing" &>

		<h3>Entry Housing</h3>

		<table cellpadding="3" cellspacing="1" width="100%">

			<tr class="yellowrow">

				<th colspan="2">
					Name/Gender
				</th>

				<th>
					Night
				</th>

				<th>
					Status
				</th>

				<th colspan="2">
				
				</th>

			</tr>

<%perl> 

			my $switch;

			my @students = $m->comp("/funclib/school_students.mas", school => $school);

			my @judges = $school->judges;
			my %students_sans_housing = ();
			my %judges_sans_housing = ();

			foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

				foreach my $stu (@students) { 

					my $housing = $m->comp("/funclib/student_housing.mas", tourn => $tourn, student => $stu, day => $day);
	
					if ($housing) { 
						next unless $housing->waitlist;
					}

					push (@{$students_sans_housing{$day->ymd}}, $stu);
				}

				foreach my $jud (@judges) { 

					my $housing = $m->comp("/funclib/judge_housing.mas", judge => $jud, day => $day);

					if ($housing) { 
						next unless $housing->waitlist;
					}
				
					push (@{$judges_sans_housing{$day->ymd}}, $jud);
				}
	
			}

</%perl>

%			foreach my $student (sort {$a->last cmp $b->last} $school->students) {

%				my $event_names;

%				foreach my $event ($m->comp("/funclib/student_entries.mas", tourn => $tourn, student => $student, event => 1)) {
%					$event_names .= $event->name;
%				}

%				if ($histu == $student->id) { 

					<tr class="redrow">
	
%				} else { 

					<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%				}

				<td>
					<a class="white block" href="/user/chapter/student_edit.mhtml?student_id=<% $student->id %>">
						<% $student->first." ".$student->last %>
						( <% $event_names %> )
					</a>
				</td>

				<td class="centeralign">
					<% ($student->gender) ? $student->gender : "" %>
				</td>

%				unless ($student->gender) { 

					<td class="smaller">
						Set student gender:
					</td>

					<td colspan="2">
						<form action="sex_change.mhtml" method="post">
						<input type="hidden" name="student_id" value="<% $student->id %>">
						<input type="hidden" name="school_id" value="<% $school->id %>">
						M
						<input type="radio" name="gender" value="M" <% ($student->gender eq "M") ? "checked" : "" %> >

						F
						<input type="radio" name="gender" value="F" <% ($student->gender eq "F") ? "checked" : "" %> >
					</td>

					<td class="centeralign">
						<input type="submit" class="smaller" value="Set Gender">
						</form>
					</td>

					</tr>

%				} else { 

%					my $notfirst;

%					foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%						next unless Tab::HousingSlots->search( night => $day->ymd, tourn => $tourn->id );

%						if ($notfirst) { 
							<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
							<td colspan="2">
							</td>
%						}

%						$notfirst++;
			
						<td class="centeralign">
							<% $day->day_abbr %>
						</td>
	
%						my $housing = $student->housing($tourn, $day); 

%						if ($housing) { 

							<th class="centeralign">
								<% ($housing->waitlist) ? "Waitlist" : "Yes" %>
							</th>

							<td class="centeralign">

%								if ($now->epoch < $reg_end->epoch) {
									<a class="dkred block" href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
										CANCEL
									</a>
%								}

							</td>

%							if ($judges_sans_housing{$day->ymd} || $students_sans_housing{$day->ymd}) { 

								<td class="centeralign">
	
%									if ($now->epoch < $reg_end->epoch) {
										<a class="dkgreen block" href="housing_transfer.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
											TRANSFER
										</a>
%									}

								</td>

%							} else { 

								<td></td>
		
%							}

%						} else { 

							<td class="centeralign">
								No
							</td>

							<td class="centeralign">

%								if ($now->epoch < $reg_end->epoch) {
									<a class="dkgreen block" href="housing_plz.mhtml?student_id=<% $student->id %>&tourn_id=<% $tourn->id %>&school_id=<% $school->id %>&day=<% $day->ymd %>">
										REQUEST
									</a>
%								}
	
							</td>

							<td>
	
							</td>
	
%						}


%					}  

					</tr>

%				}	

%				$switch++;

%			}

		</table>

%		undef $switch;

	<h3>Judges</h3>

	<table cellpadding="3" cellspacing="1" width="100%">

		<tr class="lirdrow">

			<td colspan="100" style="line-height: 20px; border: 1px solid red;">
				NOTE: Most tournaments only offer housing to judges still in
				high school; i.e. students who are judging novice divisions.
				Please check the tournament invite before requesting housing
				for adult judges.
			</td>

		</tr>

		<tr>
			<td></td>
		</tr>

%		foreach my $judge ($school->judges) {

			<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
%					if ($judge->chapter_judge) { 
						<a class="white block" href="/user/chapter/chapter_judge_edit.mhtml?chapter_judge_id=<% $judge->chapter_judge->id %>">
%					}
						<% $judge->first." ".$judge->last %>
						(<% $judge->judge_group->abbr %>)
					</a>
				</td>

			</td>

%			unless ($judge->gender) { 

				<td class="explain">
					Set judge gender:
				</td>

				<td colspan="2">
					<form action="judge_sex_change.mhtml" method="post">
					<input type="hidden" name="judge_id" value="<% $judge->id %>">
					<input type="hidden" name="school_id" value="<% $school->id %>">
					M
					<input type="radio" name="gender" value="M" <% ($judge->gender eq "M") ? "checked" : "" %> >
					F
					<input type="radio" name="gender" value="F" <% ($judge->gender eq "F") ? "checked" : "" %> >
				</td>
	
				<td class="centeralign" class="smaller">
					<input type="submit" class="smaller" value="Set Gender">
					</form>
				</td>

%			} else {
				
				<td class="centeralign">
					<% $judge->gender %>
				</td>

%				my $notfirst;

%				foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%					next unless Tab::HousingSlots->search( night => $day->ymd, tourn => $tourn->id );

%					if ($notfirst) { 
						<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
						<td colspan="2">
						</td>
%					}

%					$notfirst++;

					<td class="centeralign">
						<% $day->day_abbr %>
					</td>

%					my $housing = $m->comp("/funclib/judge_housing.mas", tourn => $tourn, judge => $judge, day => $day);

%					if ($housing) { 

						<th class="centeralign">
							<% ($housing->waitlist) ? "Waitlist" : "Yes" %>
						</th>

						<td class="centeralign">
%							if ($now->epoch < $reg_end->epoch) {
								<a class="dkred block" href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
									CANCEL
								</a>
%							}
						</td>

%						if ($judges_sans_housing{$day->ymd} || $students_sans_housing{$day->ymd}) { 

							<td class="centeralign">

%								if ($now->epoch < $reg_end->epoch) {
									<a class="dkgreen block" href="housing_transfer.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
										TRANSFER
									</a>
									<form action="housing_transfer.mhtml" method="post">
%								}
							</td>

%						} else { 
	
							<td>
							</td>
%						}

%					} else { 

						<td class="centeralign">
							None
						</td>

						<td class="centeralign">

%							if ($now->epoch < $reg_end->epoch) {

								<a class="dkgreen block" href="judge_housing_plz.mhtml?judge_id=<% $judge->id %>&tourn_id=<% $tourn->id %>&school_id=<% $school->id %>&day=<% $day->ymd %>">
									REQUEST
								</a>
%							}

						</td>

						<td>
						</td>

%					}

%				}  

%			}

%			$switch++;

%		}

	</table>


	</div>

	<div class="right small">
	
		<div class="sidenote">

%		if ($tourn->setting("housing_message")) { 

			<h4>Housing Messages:</h4>

				<p>
					<% $tourn->setting("housing_message") %>
				</p>

%		}
	
		</div>

%		my @tbas = Tab::Housing->search( tba => 1, school => $school->id );

%		if (@tbas) { 

			<div class="sidenote">

				<h4>TBA Housing Slots</h4>

%				foreach my $day (@days) { 
%					my @tbas = Tab::Housing->search( tba => 1, school => $school->id, night => $day );
%					next unless @tbas;

					<p>You have <% scalar @tbas %> slots <% $day->day_name %></p>
					
					<a class="dkgreen block" href="housing_transfer.mhtml?housing_id=<% $tbas[0]->id %>&school_id=<% $school->id %>">
						TRANSFER TO STUDENT
					</a>
%				}

			</div>

%		}

	</div>

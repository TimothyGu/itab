<%args> 
	$account
	$school_id
	$group_id => undef
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);
	my $group = Tab::JudgeGroup->retrieve($group_id);
	
	my $tourn = $school->tourn;

	my @events = $group->events if $group;

	my $err;

	my $tz = $account->tz;
	$tz = $tourn->tz unless $tz;
	$tz = "UTC" unless $tz;

	#Make sure that the tournament is open for registration
	my $now = DateTime->now( time_zone => $tz);

	my $switch;

	my $judge_deadline = $tourn->setting("judge_deadline");
	$judge_deadline->set_time_zone($tz);

</%init>

	<div class="left huge">
    
		<h2>Judges: <% $tourn->name %></h2>
    	
		<& menubar.mas, school => $school, whoami => "judges" &>

%		if ($group) { 

%			my $group_deadline = $group->setting("deadline");
%			$group_deadline->set_time_zone($tz) if $group_deadline;
%			$group_deadline = $judge_deadline->clone unless $group_deadline;

%			if ($judge_deadline < $now || $group_deadline &&  $group_deadline < $now) { 							

				<p class="warning">
					The deadline to enter judge information online has passed.
					You must contact the tournament directly to make
					changes.
				</p>

%			}

%           my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group);
			<p>You have <% $uncovered %> entr<% ($uncovered == 1) ? "y" : "ies" %> uncovered.  Each judge covers <% $group->setting("judge_per") %> entries.</p>

			<h4><% $group->name %> Judges</h4>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">

					<% ($tourn->setting("hide_codes")|| $group->setting("no_codes")) ? "" : "<th>Code</th>" %>

					<th>
						Name
					</th>

%					if ($group->strike_times) { 
						<th class="smaller">
							Availability 
						</th>
%					}

%					if ($group->setting("coach_ratings")) { 
						<th class="smaller">
							Ratings
						</th>
%					}

					<th>
					</th>

				</tr>

%				foreach my $judge ($m->comp("/funclib/judgemath/judges_by_group.mas", school => $school, group => $group)) {

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<% ($tourn->setting("hide_codes")|| $group->setting("no_codes")) ? "" : "<td>".$judge->code."</td>" %>

						<td>
%							unless ($judge_deadline < $now || $group_deadline < $now) { 							
								<a class="white block" href="judge_details.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
%							}
							<% $judge->first." ".$judge->last%>
							</a>
						</td>


%						if ($group->strike_times) { 

%							my $strike_timened;

							<td class="smaller">
%								unless ($judge_deadline < $now || $group_deadline < $now) { 							
									<a class="white block" href="judge_timestrike_times.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
%								}

%									foreach my $strike_time ($group->strike_times) { 
%										if ($strike_time->strike($judge)) { 
%											$strike_timened++;
											Not available <% $strike_time->name %> ($<% $strike_time->fine %>)
%										}
%									}

%									unless ($strike_timened) { 
										All rounds
%									}
								
								</a>

							</td>
%						}

%						if ($group->setting("coach_ratings")) { 

							<td class="centeralign">
								<% $m->comp("/funclib/judge_rating.mas", print => 1, judge => $judge )%>
							</td>

%						}

						<td class="centeralign">
%							unless ($judge_deadline < $now || $group_deadline < $now) {
								<a class="dkred block" href="judge_drop.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
									DROP
								</a>
%							}
						</td>

					</tr>

% 				} 

			</table>

%			if ($group->setting("track_judge_hires") ) { 

				<br />
				<br />

%				if ($group->setting("uncovered_entry_fee") > 0) { 

					<h4>Hired Judging</h4>

%					undef($switch);

					<p class="explain" style="padding-left: 10px;">
						This tournament hires judging by the entry, not the whole
						judge.  Enter hire requests for the number of entries who
						you do not have judging for.  Please note that a hire
						request does not mean the tournament has judges available
						for hire; Tabroom will email you when/if your request
						is accepted.
					</p>

					<table cellpadding="9" cellspacing="1" width="100%"> 

%						unless ($judge_deadline < $now || $group_deadline < $now) {
						
							<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
							
								<td>
									<form action="hire_save.mhtml" method="post">
									<input type="hidden" name="school_id" value="<% $school->id %>">
									<input type="hidden" name="group_id" value="<% $group->id %>">
									Request more hired judging:
								</td> 

								<td class="centeralign">
									Cover
									<input type="text" name="hired_number" size="2" value="">
									entries
								</td>
							
								<td class="centeralign">
									<input class="thin" type="submit" value="   Request Hires   ">
									</form>
								</td>
							
							</tr> 
%						}
						
%   					my @requests = Tab::JudgeHire->search( school => $school->id, judge_group => $group->id );

%						foreach my $request (@requests) { 
		            	
							<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

								<td>
									Request made <% Tab::niceshortdt($request->request_made->set_time_zone($tz)) %>
								</td>
							
								<td class="centeralign">
										<% $request->accepted %>
								</td>
								
								<td class="centeralign">
									(of <% $request->covers %>)
								</td>
							
							</tr>

%							if ($uncovered) { 

								<tr class="lirdrow">

									<td>
										Entries still uncovered by judging:
									</td>
							
									<td class="centeralign">
										<% $uncovered %>
									</td>
								
									<td class="centeralign">
									</td>
							
								</tr>
%							}
%						}

					</table>
%				}

%				if ($group->setting("hired_fee") > 0) { 

%					undef $switch;

%					my $request = $school->requests_by_group($group);
%       			my $hires_requested += $request->covers if $request;
%       			my $hires_accepted += $request->accepted if $request;

%       			$hires_requested = ceil($hires_requested / $group->setting("judge_per")) if $group->setting("judge_per");
%       			$hires_accepted = ceil($hires_accepted / $group->setting("judge_per")) if $group->setting("judge_per");
	
					<h4>Hired judging</h4>

					<table cellpadding="4" cellspacing="1"  width="100%">

%					unless ($judge_deadline < $now || $group_deadline < $now) {

		            	<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input type="hidden" name="school_id" value="<% $school->id %>">
        		        	    <input type="hidden" name="group_id" value="<% $group->id %>">
    		            	    Request 
                			    <input type="text" name="hired_number" size="2" value=<% $hires_requested %>>
								hired judges
            			    </td>

                			<td class="centeralign">
                    			<input  type="submit" value="   Save   ">
                			    </form>
            			    </td>

    		        	</tr>

%					}

%					if ($hires_requested) { 

		            <tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>		

            		    <td>
        		            Hiring requests accepted*
    		            </td>
	
            		    <td class="centeralign">
							<% $hires_accepted %> (of <% $hires_requested %>)
        		        </td>

		            </tr>

%					}

					</table>

%				}

%			}

			<br />
			<br />

%		} else { 

			<p>
				Choose a judge category at right to enter judges or hire out
				judging committments (where tournaments permit).
			<p>

			<p>
				Divisions marked in red are divisions where you still owe
				judging.
			</p>

%		}

%		if ($tourn->setting('judge_policy') > 0) { 
			<h4 style="margin-left: 5px;">Tournament Judging notes:</h4>
			<p style="padding: 5px;"><% $tourn->setting("judge_policy") %></p>
%		}

	</div>

	<div class="right small">
	
		<div class="sidenote">

%		if ($group && ($judge_deadline > $now)) { 

%			my $group_deadline = $group->setting("deadline");
%			$group_deadline->set_time_zone($tz) if $group_deadline;
%			$group_deadline = $judge_deadline->clone unless $group_deadline;

%			unless ($group_deadline && $group_deadline < $now) {
        
				<h4>Add Judges:</h4>

%				my @chapter_judges = $m->comp("/funclib/chapter_judges_free.mas", school => $school);
%			    my $now = DateTime->now;

%				if (@chapter_judges) { 

					<table cellpadding="3" cellspacing="1" width="100%">

						<tr>
							<td class="centeralign">
	
								<form action="judge_save.mhtml" method="post">
								<input type="hidden" name="group_id" value="<% $group->id %>">
								<input type="hidden" name="school_id" value="<% $school->id %>">
	
								<select name="chapter_judge_id" size="7" class="fixedmedsmall">
%									foreach my $chapter_judge (sort {$a->last cmp $b->last} @chapter_judges) { 
										<option value="<% $chapter_judge->id %>"><% $chapter_judge->last.", ".$chapter_judge->first %></option>
%									}
								</select>
							</td>
						</tr>

						<tr class="liblrow">

							<td class="rightalign">
								<input type="submit" class="thin" value=" Enter Judge">
								</form>
							</td>
		
						</tr>

					</table>

%				} else { 

					<p>
						You have no judges on your roster to add.  Please add
						them before registering them into the tournament.  You
						only need to type in each judge's name to your roster
						once; they'll be available for all future tournaments.
					</p>

%				}

				<a class="yellow block" href="/user/chapter/judge_edit.mhtml?from=<% $group->id %>&chapter_id=<% $school->chapter->id %>">
					Add Judge to Roster
				</a>

				<hr />

%			}
%		}

		<h4>Judge groups</h4>

%		foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {

%			my $group_deadline = $group->setting("deadline");
%			$group_deadline->set_time_zone($tz) if $group_deadline;


%			my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group); 
%			my (@useful_judges, @dontcount) = $m->comp("/funclib/judgemath/judges_by_group.mas", school => $school, group => $group);
%			my $obligation = $m->comp("/funclib/judgemath/judges_needed_by_group.mas", school => $school, group => $group);

				<a href="judges.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" 
					class="<% ($uncovered < 1) ? "blue block" : "dkred block" %>">
						<span style="float: left;  width: 160px;"><% substr($group->name,0,22) %></span>
					<% scalar @useful_judges %>/<% $obligation %>
					<% ($uncovered < 1) ? " " : " Not Met" %> 
					<% ($uncovered < 1 && (scalar @useful_judges < $obligation) ) ? "+ Hires " : "" %> 
				</a>


%			if ($group_deadline) {
				<a href="/user/tourn/entry/judges.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" class="white block">
					**<% $group->abbr %> Judges due: <% &Tab::niceshortdt($group_deadline->set_time_zone($tz)) %>
				</a>

%			}

%		}

	
		</div>

	</div>


<%args>
	$judge_id
	$school_id
	$alt_id => undef
	$ada => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);
	my $group = $judge->judge_group;
	my $tourn = $group->tourn;

	my $now = DateTime->now;

	my $school = Tab::School->retrieve($school_id);

	my $missing_rating;

	if ($group->setting("coach_ratings")) { 

		unless ($group->rating_subsets) { 

			my $rating_id = $ARGS{"rating_id"};
			my $rating = $judge->ratings->first;

			$missing_rating .= "<br/> Missing ".$group->name." rating " unless $rating_id;

			if ($rating) { 

				$rating->rating_tier($rating_id);
				$rating->update;

			} else { 
		
				Tab::Rating->create({
					type => "coach",
					entered => $now,
					tourn => $tourn->id,
					judge => $judge->id,
					rating_tier => $rating_id,
				});
			}

		} else { 

			foreach my $subset ($group->rating_subsets) { 

				my $tier_id = $ARGS{$subset->id};

				$missing_rating .= "<br/> Missing ".$subset->name." rating." unless $tier_id;

				my $rating = $judge->ratings(rating_subset => $subset)->first;

				if ($rating) {	 

					$rating->rating_tier($tier_id);
					$rating->update;

				} else { 

					Tab::Rating->create({
						type => "coach",
						tourn => $tourn->id,
						judge => $judge->id,
						rating_tier => $tier_id,
						rating_subset => $subset->id
					});

				}
			}
		}

		if ($missing_rating) { 

			my $err = "You must rate the judge in every category. ".$missing_rating;
			$m->redirect("judge_details.mhtml?school_id=$school_id&judge_id=$judge_id&err=$err");

		}

	}

	$judge->alt_group($alt_id) if $alt_id;
	$judge->ada($ada);

	$judge->update;

	my $msg = "Judge ".$judge->first." ".$judge->last." entered";

	$m->redirect("judges.mhtml?school_id=$school_id&group_id=".$group->id."&msg=$msg");

</%init>

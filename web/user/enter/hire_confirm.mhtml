<%args>
	$tourn
	$school
	$judge_id
	$rounds => undef
	$account
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	$m->redirect("judges.mhtml?school_id=".$school->id."&err=That judge doesn't belong to your tournament") if $judge->judge_group->tourn->id != $school->tourn->id;
	$m->redirect("judges.mhtml?school_id=".$school->id."&err=That judge group is not using the hiring exchange") unless $judge->judge_group->setting("exchange");
	$m->redirect("judges.mhtml?school_id=".$school->id."&err=That judge has no hired rounds left".$judge->hire_offer." ".$judge->hired) unless $judge->hire_offer > $judge->hired || not defined $judge->hired;

	my $max = $judge->hire_offer - $judge->hired;

	my $err;

	if ($rounds > $max) { 
		$err = "The judge only has $max rounds available; Your request was reduced";
		$rounds = $max;
	}

	my $hired = $judge->hired + $rounds;
	$judge->hired($hired);
	$judge->update;

	my $now = DateTime->now;

	Tab::JudgeHire->create({
		tourn => $school->tourn,
		judge => $judge->id,
		judge_group => $judge->judge_group->id,
		school => $school->id,
		rounds => $rounds,
		rounds_accepted => $rounds,
		request_made => $now
	});


	my $recipient = $judge->account;
	my $subject = "Your judge hire offer was accepted";

	my $school_name = $school->name;
	my $tourn_name = $school->tourn->name;

	my $body = "

	This is an automated email to inform you that 

	$school_name

	Has claimed $rounds hired rounds of judging at 

	$tourn_name

	If this is OK, you don't need to do anything.  If this is not OK
	(the other school has not arranged payment) you may reply to this
	email to rant at the person who did it, or log into your Tabroom
	account and cancel this hire at

	https://www.tabroom.com/user/judge/hire.mhtml

	Cheers,
	iDebate Tabroom
	http://tabroom.idebate.org

";

	$m->comp( "/funclib/send_email.mas", from => $account, to => $recipient, subject => $subject, body => $body );

	$m->redirect("hire_exchange.mhtml?group_id=".$judge->judge_group->id."&school_id=".$school->id."&err=$err&msg=Judge hire confirmed.  Judge was notified by email.");

</%init>


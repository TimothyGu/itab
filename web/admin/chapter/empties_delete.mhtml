<%args>
	$account
	$certain => undef
</%args>
<%init>

	if ($certain eq "I am certain") {

		my @school_chapters = Tab::Chapter->search_by_no_schools;
		my @student_chapters = Tab::Chapter->search_by_no_students;
	
		my %original = ();
	
		map { $original{$_} = 1 } @school_chapters;
		my @chapters = grep { $original{$_} } @student_chapters;
	
	    #uniq
	    my %seen = ();
	    @chapters = grep { ! $seen{$_->id} ++ } @chapters;
	
		my $counter;
	
		foreach my $chapter (@chapters) { 
	
			next unless $ARGS{$chapter->id};
			Tab::log($account->email." deleted chapter ".$chapter->id." ".$chapter->name);
	
			foreach my $credit ($chapter->credits) {
				$credit->delete;
			}
	
			foreach my $cl (Tab::ChapterLeague->search( chapter => $chapter->id)) {
				$cl->delete;
			}
	
			foreach my $ca (Tab::ChapterAccess->search( chapter => $chapter->id)) {
				$ca->delete;
			}
	
			$chapter->delete;
	
			$counter++;
	
		}
	
		my $err = "$counter chapters deleted";
		$m->redirect("/admin/chapter/index.mhtml?err=$err");

	} else {

		my $err = "You did not type \"I am certain\"";

		$m->redirect("/admin/chapter/empties.mhtml?err=$err");

	}

</%init>



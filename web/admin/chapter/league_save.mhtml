<%args>
	$chapter_id
	$account
	$session
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);
	
	my $err;

	LEAGUE:
	foreach my $circuit (Tab::Circuit->retrieve_all) { 

		my $cl = $chapter->circuit_membership($circuit);

		unless ($cl) { 

			next LEAGUE unless $circuit->create_own_account;
			next LEAGUE unless $ARGS{$circuit->id."_active"};
			
			$cl = Tab::ChapterCircuit->create({
				circuit => $circuit->id,
				chapter => $chapter->id
			});

			$err .= " <br />You joined the ".$circuit->name;

		}

		$cl->region($ARGS{$circuit->id."_region"});
		$cl->active($ARGS{$circuit->id."_active"});
		$cl->full_member($ARGS{$circuit->id."_full_member"});
		$cl->membership($ARGS{$circuit->id."_membership"});
		$cl->update;

		if ($tourn->setting("regions")) { 
			$err .= " <br />WARNING:  You must choose a region to join the ".$circuit->short_name unless $ARGS{$circuit->id."_region"};
		}

		if ($circuit->memberships) { 
			$err .= " <br />WARNING:  You must choose a membership type to join the ".$circuit->short_name unless $ARGS{$circuit->id."_membership"};
		}

	}

	$err .= " <br />Circuit memberships updated.";

	$m->redirect("/admin/chapter/circuits.mhtml?chapter_id=".$chapter->id."&err=$err");

</%init>

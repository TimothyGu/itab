<%args>
	$account
</%args>
<%init>

	$m->abort unless $account->site_admin;  #When I write this you know I'm really up to no good.

	Tab::Student->set_sql( twins => "
		select distinct one.id as id 
		from student as one, student as two
		where one.first = two.first
		and one.last = two.last
		and one.id != two.id
		and one.chapter = two.chapter
		and one.grad_year = two.grad_year

	");

	Tab::Entry->set_sql( steal_entries => "	update entry_student set student = ? where student = ?" );

	my @twins = Tab::Student->search_twins;

	my %twins_by_name = ();

	foreach my $twin (@twins) { 
		push (@{$twins_by_name{$twin->first."-".$twin->last}}, $twin)
	}

	foreach my $name (keys %twins_by_name) { 

		my @students = @{$twins_by_name{$name}};

		next unless scalar @students > 1;

		my $first = shift @students;

		foreach my $other (@students) { 

			Tab::Entry->sql_steal_entries->execute( $first->id, $other->id);
			$other->delete;

		}

	}

</%init>

	<h2>Fin.</h2>

	<p>	
		<% scalar @twins %> twins found & deleted
	</p>


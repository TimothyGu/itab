<%args>
	$league
	$account
	$err => undef
</%args>
<%init>

	my $now = DateTime->now(time_zone => $league->timezone);

	my $school_year = &Tab::school_year;

	my $switch;

	my @memberships = $league->memberships;

</%init>

	<h2>Record Dues Payments</h2>

%	foreach my $membership ($league->memberships) { 

%		next unless $membership->dues;

		<h4><% $membership->name %></h4>

		<table width="100%" cellpadding="5" cellspacing="1">

			<tr class="liblrow">

				<th>
					<form action="dues_save.mhtml" method="post">
					School
				</th>

				<th>
					Paid to Date
				</th>

				<th class="center">
					Fully Paid
				</th>

				<th>
					Last
				</th>

			</tr>

<%perl>

			my @cms = $membership->chapter_memberships(full_member => 1);
			@cms = sort {$a->chapter->name cmp $b->chapter->name} @cms;

			my $switch;

			my $first_paid;

			foreach my $cm (@cms) { 

				my $school_year = &Tab::school_year;

				my @dues = Tab::Dues->search_where(
					chapter => $cm->chapter->id,
					league => $league->id,
					paid_on => {">=", $school_year}
				);

				my $last;

				if (@dues) {
					@dues = sort {$b->paid_on->epoch <=> $a->paid_on->epoch} @dues;
					$last = shift @dues;
				}

				if ($cm->paid &! $first_paid) {

</%perl>

					<tr>
						<td colspan="4">
							<h4>Paid Members:</h4>
						</td>
					</tr>

%					$first_paid++;

%				}


				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

					<td>
						<a href="chapter_edit.mhtml?chapter_id=<% $cm->chapter->id %>">
						<% $cm->chapter->name %>
						</a>
					</td>
		
					<td class="center">
						$<input type="text" name="<% $cm->id %>_dues" size="4" value="<% $cm->chapter->paid_dues($league) %>">
					</td>

					<td class="center">
						<input type="checkbox" name="<% $cm->id %>_paid" value="1" <% ($cm->paid) ? "checked" : "" %>>
					</td>

					<td class="smaller">
						<% ($last) ? &Tab::niceshortdate($last->paid_on) : "" %>
					</td>

				</tr>

%			}

		<tr class="liblrow">

			<td colspan="4" class="right">

				<input type="submit" value="   Save Due Payments   ">
				</form>

			</td>

		</tr>

		</table>

%	}

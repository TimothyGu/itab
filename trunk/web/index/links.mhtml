<%args> 
	$link_id => undef
	$all_years => undef
</%args>
<%init>

	my $link = Tab::Link->retrieve($link_id) if $link_id;

	my $circuit = $link->circuit;

	my @newses;

	my $now = DateTime->now;

	unless ($all_years) { 

		my $year = $now->year;
		$year-- if $now->month < 7;

		my $search_date = DateTime->new(	
			year => $year,
			month => 6,
			day => 30	
		);

		@newses = Tab::News->search_where( 
			link => $link_id, 
			active => 1,
			posted => {">=", DateTime::Format::MySQL->format_date($search_date) } );

	} else { 

		@newses = $link->news(active => 1);
	}

</%init>


<h2><% $link->name %></h2>

<p><% $link->text %></p>


		<table width="100%">

			<tr>

				<td width="85%">
					<h4>Items:</h4>
				</td>

				<td>
					<form action="links.mhtml" method="post">
					<input type="hidden" name="link_id" value="<% $link->id %>">
					<input type="hidden" name="circuit_id" value="<% $circuit->id %>">
					<input type="hidden" name="all_years" value="<% ($all_years) ? "" : "1" %>">
					<input class="blue" type="submit" value="<% ($all_years) ? "This Year Only" : "All Years" %>">
				</td>

			</tr>

		</table>

% 	if (@newses) {  

		<table cellpadding="3" width="100%">

		<tr>

			<th>
				Story
			</th>

			<th>
				Posted On
			</td>

			<th>
				Author:
			</td>

			<th>
				Last edited by:
			</td>

		</tr>

%		my $switch;

% 		foreach my $news (sort {$b->posted->epoch <=> $a->posted->epoch} @newses) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					<a href="view_story.mhtml?news_id=<% $news->id %>&circuit_id=<% $circuit->id %>"><% $news->title %></a>
				</td>

				<td>
					<% $news->posted->mdy('/') %>
				</td>

				<td>
					<% ($news->author) ? substr($news->author->first,0,1).". ".$news->author->last : "" %>
				</td>

				<td>
					<% ($news->edited_by->id) ? substr($news->edited_by->first,0,1).". ".$news->edited_by->last : 
												substr($news->author->first,0,1).". ".$news->author->last %>
				</td>

			</tr>

%		} 

% 	}

</table>


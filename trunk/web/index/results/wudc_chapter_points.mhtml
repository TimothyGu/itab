<%args>
	$account => undef
	$chapter_id => undef
</%args>
<%init>
	
	use Time::HiRes qw( time );
	use Data::Dumper;
	use POSIX qw(strftime);
	my $tz = $account->tz if $account;
	$tz = "UTC" unless $tz;
	my $start=time();
	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;
				
	Tab::Entry->columns(TEMP => qw/school_name/);
	Tab::Entry->columns(TEMP => qw/tourn_name/);
	Tab::Entry->columns(TEMP => qw/points/);
	Tab::Entry->columns(TEMP => qw/tourn_id/);
	Tab::Entry->columns(TEMP => qw/tourn_weight/);
	Tab::Entry->columns(TEMP => qw/weighted_points/);
	Tab::Entry->set_sql(pull_points => "
			select entry.*, school.name as school_name, tourn.name as tourn_name, result_value.value as points, tourn.id as tourn_id, tourn.start, tourn.end, tourn_setting.value as tourn_weight, (tourn_setting.value * result_value.value) as weighted_points
			from school, entry, tourn, result, result_value, tourn_setting
			where school.chapter = $chapter_id
			and entry.school=school.id
			and tourn.id=entry.tourn
			and result.entry=entry.id
			and result_value.result=result.id
			and result_value.tag='WUDC points'
			and tourn_setting.tourn=entry.tourn
			and tourn_setting.tag='weight'
			ORDER BY ABS(result_value.value) desc
			");

	my @entries = Tab::Entry->search_pull_points;
	#print "Row 1=".Dumper($entries[0]);
	
</%init>
	<h4>WUDC points breakdown for <% $chapter->name %></h4>
	<div class="left huge">
	<& /funclib/tablesorter.mas, table => "WUDC" &>

		<table cellpadding="3" width="100%" id="WUDC" class="tablesorter">
		<thead>
			<tr class="dkgreen">
				<th class="smaller">tournament</th>
				<th class="smaller">Entry</th>
				<th class="smaller">Points</th>
				<th class="smaller">Weight</th>
				<th class="smaller">Weighted Points</th>
			</tr>
		</thead>
%			foreach my $entry (@entries) {
				<tr>
					<td> <% $entry->tourn_name %> </td>
					<td> <% $entry->name %> </td>
					<td> <% $entry->points %> </td>
					<td> <% $entry->tourn_weight %> </td>
					<td> <% $entry->weighted_points %> </td>
				</tr>
%			}

		</table>
		
% my $end = time();
% #printf("%.2f\n", $end - $start);

	</div>



	<div class="right small">

		<div class="sidenote">

			<h4>Places to go</h4>

			<a class="yellow block" href="wudc_standings.mhtml">WUDC Overall Standings</a>

		</div>

	</div>

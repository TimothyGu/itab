<%args>
	$account => undef
	$circuit => undef
	$circuit_id => undef
	$year=> undef
</%args>
<%init>
	
	use Time::HiRes qw( time );
	use Data::Dumper;

	if ($circuit_id) { $circuit = Tab::Circuit->retrieve( $circuit_id ); }
	unless ($circuit) { $circuit = Tab::Circuit->retrieve( 43 ); $circuit_id=43; }
	
	unless ($year) { 
		my $this_year = Tab::school_year;
		$year = $this_year->year;
	}

	my $start_string = "07/01/$year";
	my $end_string = "06/30/".($year + 1);

	my $start_dt = Tab::dtme($start_string);	
	my $end_dt = Tab::dtme($end_string);	

#Load tournaments

	Tab::Tourn->columns(TEMP => qw/event_name/);	
	Tab::Tourn->columns(TEMP => qw/event_id/);	
	Tab::Tourn->columns(TEMP => qw/tourney_id/);	
	Tab::Tourn->set_sql(pull_tourneys => "
		select tourn.*, event.id, event.name as event_name, event.id as event_id, tourn.id as tourney_id
		from tourn, event, tourn_circuit
		where event.tourn=tourn.id
		and tourn.id=tourn_circuit.tourn 
		and tourn_circuit.circuit = $circuit_id
		and tourn.start >= ? 
		and tourn.end <=  ?
		order by tourn.start, tourn.id
	");
	
	my @tourn = Tab::Tourn->search_pull_tourneys( DateTime::Format::MySQL->format_date($start_dt), DateTime::Format::MySQL->format_date($end_dt));

</%init>

	<& menu.mas, circuit_id => $circuit_id, year => $year &>
	
	<div class="left huge">
	
	<h2>Tourney results for <% $circuit->name %> in the <% $year %> season</h2>

		<& /funclib/tablesorter.mas, table => "Stats" &>

		<table cellpadding="3" width="100%" id="Stats" class="tablesorter">

		<thead>
			<tr class="dkgreen">
				<th class="smaller">Tourn</th>
				<th class="smaller">Date</th>
				<th class="smaller">Event</th>
				<th class="smaller">Team records</th>
				<th class="smaller">Cume Sheet</th>
				<th class="smaller">Elim Bracket</th>				
				<th class="smaller">Speaker Awards</th>				
			</tr>
		</thead>

%		foreach my $tourney (@tourn) {
		<tr>
			<td> <% $tourney->name %> </td>
			<td> <% Tab::pickerdate($tourney->start) %> </td>
			<td> <% $tourney->event_name %></td>
			<td>
				<a class="plain fullblock padless" href="/index/tourn/results/ranked_list.mhtml?event_id=<% $tourney->event_id %>&tourn_id=<% $tourney->tourney_id %>">Team Records</a>
			</td>
			<td>
				<a class="plain fullblock padless" href="debate_cumesheet?event_id=<% $tourney->event_id %>&sorttype=alpha">Cume Sheet</a>
			</td>

%			my @bracket_result = Tab::ResultSet->search( tourn=> $tourney->tourney_id, event=> $tourney->event_id, bracket=>1, published => 1 );
%			my $dummy;
%			if ( scalar(@bracket_result) > 0 ) {
%				$dummy = $bracket_result[0];
%			}

			<td>
%				if ( scalar(@bracket_result)>0 ) {
				<a class="plain fullblock padless" href="/index/tourn/results/bracket.mhtml?tourn_id=<% $tourney->tourney_id %>&result_id=<% $dummy %>">Elim Bracket</a>
%				} else {
				Not Enabled
%				}				
			</td>

%			@bracket_result = Tab::ResultSet->search( tourn=> $tourney->tourney_id, event=> $tourney->event_id, label=>"Speaker Awards", published => 1 );
%			$dummy=0;
%			if ( scalar(@bracket_result) > 0 ) {
%				$dummy = $bracket_result[0];
%			}

			<td>
%				if ( scalar(@bracket_result)>0 ) {
				<a class="plain fullblock padless" href="/index/tourn/results/event_results.mhtml?tourn_id=<% $tourney->tourney_id %>&result_id=<% $dummy %>">Speaker Awards</a>
%				} else {
				Not Enabled
%				}				
			</td>
			
		</tr>
%		}		

		</table>
		
%# my $end = time(); print "<br>Load time ";
%# printf("%.2f\n", $end - $start);

	</div>

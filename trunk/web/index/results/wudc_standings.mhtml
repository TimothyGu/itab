<%args>
	$account => undef
	$circuit => undef
</%args>
<%init>
	
	use Time::HiRes qw( time );
	use Data::Dumper;
		
	my $start = time(); 
	
	Tab::Chapter->columns(TEMP => qw/points/);
	Tab::Chapter->columns(TEMP => qw/weighted_points/);
	
	Tab::Chapter->set_sql(pull_points => "
			select chapter.name, chapter.id, sum(result_value.value) as points
			from school, entry, result, result_value, chapter
			where school.chapter = chapter.id
			and entry.school=school.id
			and result.entry=entry.id
			and result_value.result=result.id
			and result_value.tag='WUDC points'
			GROUP BY chapter.id
			ORDER BY 3 desc
			");

	my @chapters = Tab::Chapter->search_pull_points;
	#print "N schools=".scalar(@schools)."<br>";
	
	sub commify {
		local($_)=shift;
		1 while s/^(-?\d+)(\d{3})/$1,$2/;
		return $_;
	}
	
</%init>

	<h2>WUDC point standings</h2>
	<div class="left huge">
	<& /funclib/tablesorter.mas, table => "WUDC" &>

		<table cellpadding="3" width="100%" id="WUDC" class="tablesorter">
		<thead>
			<tr class="dkgreen">
				<th class="smaller">chapter</th>
				<th class="smaller">points</th>
			</tr>
		</thead>
%			foreach my $chapter (@chapters) {
				<tr>
					<td> <a href="wudc_chapter_points.mhtml?chapter_id=<% $chapter->id %>"> <% $chapter->name %> </a></td>
					<td> <% commify($chapter->points) %> </td>
				</tr>
%			}

		</table>
		
% my $end = time();
% printf("%.2f\n", $end - $start);

	</div>



	<div class="right small">

		<div class="sidenote">

			<h4>Places to go</h4>

			<a class="yellow block" href="https://www.tabroom.com/jbruschke/TeamResults.php">NDT/CEDA Results Sheets</a>
			<a class="yellow block" href="index.mhtml">Main Results Page</a>

		</div>

	</div>

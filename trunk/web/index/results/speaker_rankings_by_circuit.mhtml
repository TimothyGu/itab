<%args>
	$account    => undef
	$year       => undef
	$circuit_id => undef	
</%args>
<%init>

	use Time::HiRes qw( time );
	use POSIX qw(strftime);
	my $code_start = time(); 
	Tab::debuglog("CODE STARTS");

	#to debug
	$circuit_id = 43;
	my $circuit = Tab::Circuit->retrieve($circuit_id);
					
	unless ($year) { 
		my $this_year = Tab::school_year;
		$year = $this_year->year;
	}

	my $start_string = "07/01/$year";
	my $end_string = "06/30/".($year + 1);

	my $start_dt = Tab::dtme($start_string);	
	my $end_dt = Tab::dtme($end_string);	

	my $code_end = time(); Tab::debuglog("Time before first pull ".sprintf("%.2f", $code_end-$code_start) );

	Tab::Student->columns(TEMP => qw/event_name/);			
	Tab::Student->columns(TEMP => qw/pts_avg/);				
	Tab::Student->columns(TEMP => qw/n_rds/);					
	Tab::Student->set_sql(pull_entry => "
		SELECT student.id, event.name as event_name, avg(ballot_value.value) as pts_avg, count(distinct ballot_value.id) as n_rds
		FROM tourn, event, tourn_circuit, round, panel, ballot, ballot_value, student
		WHERE tourn_circuit.circuit=$circuit_id
		and tourn.id=tourn_circuit.tourn
		and tourn.start >= '$start_dt'
		and tourn.end <=  '$end_dt'
		and event.tourn=tourn.id
		and (event.type != 'speech' and event.type != 'congress' )
		and round.event=event.id
		and panel.round=round.id
		and ballot.panel=panel.id
		and ballot_value.ballot=ballot.id
		and ballot_value.tag='points'
		and student.id=ballot_value.student
		group by student.id
		order by pts_avg desc
	");
	
	my @speakers = Tab::Student->search_pull_entry;
	$code_end = time(); Tab::debuglog("Time AFTER IE pull ".sprintf("%.2f", $code_end-$code_start) );	

</%init>

	<& menu.mas, circuit_id => $circuit_id, year => $year &>
	
	<div class="left huge">
	
		<h2>Speakers ranked by average points</h2>
		<h4> <% $circuit->name %> <% $year %> </h4>

		<& /funclib/tablesorter.mas, table => "sortme" &>

		<table cellpadding="4" id="sortme">
		
			<thead>
				<tr class="yellowrow">
					<th class="smallish">
						Speaker
					</th>
					<th class="smallish">
						Chapter (Institution)
					</th>
					<th class="smallish">
						Ballots
					</th>
					<th class="smallish">
						Avg Points
					</th>
				</tr>
				</tr>
			</thead>

			<tbody>
%			foreach my $spkr(@speakers) {
			<tr>
				<td><% $spkr->first %> <% $spkr->last %></td>
				<td><% $spkr->chapter->name %></td>				
				<td><% $spkr->n_rds %></td>												
				<td><% sprintf("%.3f", $spkr->pts_avg) %></td>								
			</tr>
%			}			
			</tbody>

		</table>

	</div>

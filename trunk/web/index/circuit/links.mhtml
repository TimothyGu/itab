<%args> 
	$link_id => undef
	$all_years => undef
	$circuit
</%args>
<%init>

	my $link = Tab::Link->retrieve($link_id) if $link_id;

	my @newses;
	my @any_newses;

	my $now = DateTime->now;

	unless ($all_years) { 

		my $year = $now->year;
		$year-- if $now->month < 7;

		my $search_date = DateTime->new(	
			year => $year,
			month => 6,
			day => 30	
		);

		@newses = Tab::News->search_where( 
			link => $link_id, 
			active => 1,
		);

	} else { 

		@newses = $link->news(active => 1);
	}

</%init>

	<div class="story">

		<p>
			<% $link->text %>
		</p>

% 		if (@newses) {  

			<h4>More:</h4>

			<table cellpadding="3" cellspacing="1" width="100%">

				<tr class="liblrow">

					<th>
						Page
					</th>

					<th>
						Posted On
					</td>

					<th>
						Author:
					</td>

					<th>
						Last edited by:
					</td>

				</tr>

%				my $switch;

% 				foreach my $news (sort {$b->posted->epoch <=> $a->posted->epoch} @newses) { 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							<a href="view_story.mhtml?news_id=<% $news->id %>&circuit_id=<% ($circuit) ? $circuit->id : "" %>"><% $news->title %></a>
						</td>

						<td>
							<% $news->posted->mdy('/') %>
						</td>

						<td>
							<% ($news->author) ? substr($news->author->first,0,1).". ".$news->author->last : "" %>
						</td>

						<td>
							<% ($news->edited_by->id) ? substr($news->edited_by->first,0,1).". ".$news->edited_by->last : 
							substr($news->author->first,0,1).". ".$news->author->last %>
						</td>

					</tr>

%				} 

% 			}

		</table>

	</div>


<%args>
	$event_id => undef
	$account
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;  
	my $tourn = $event->tourn if $event;

	$m->abort() unless $event && $event->setting("live_updates");

	my $switch;

	use POSIX;

	my @entries = sort {$a->school->name cmp $b->school->name} $event->entries ( waitlist => 0, unconfirmed => 0);
	my @ballot_values = $m->comp("/funclib/event_values.mas", event => $event, public => 1, prelim => 1);

	my %ballots_by_entry = ();
	my %ballots_by_panel = ();
	my %ballots_by_entry_panel = ();

	my %panels_by_entry = ();

	foreach my $value (@ballot_values) {
		$ballots_by_entry{$value->entryid}++ if $value->value == 1 and $value->tag eq "ballot";
		$ballots_by_panel{$value->panelid}++ if $value->value == 1 and $value->tag eq "ballot";
		$ballots_by_entry_panel{$value->entryid."-".$value->panelid}++ if $value->value == 1 and $value->tag eq "ballot";
		push @{$panels_by_entry{$value->entryid}}, $value->panelid;
	}

	my %wins_by_entry = ();

	my $different;

	foreach my $entry (@entries) { 

		my %done = ();

		foreach my $panel (@{$panels_by_entry{$entry->id}}) { 
			
			next if $done{$panel};
			$wins_by_entry{$entry->id}++ if $ballots_by_entry_panel{$entry->id."-".$panel} > ( $ballots_by_panel{$panel} / 2);
			$done{$panel}++;
		}

		$different++ if $wins_by_entry{$entry->id} != $ballots_by_entry{$entry->id};

	}

	@entries = sort { $ballots_by_entry{$b->id} <=> $ballots_by_entry{$a->id} } @entries;
	@entries = sort { $wins_by_entry{$b->id} <=> $wins_by_entry{$a->id} } @entries;

</%init>

	<& sidebar.mas, tourn_id => $tourn->id, event_id => $event_id, whoami => "records" &>

	<& /funclib/tablesorter.mas, table => "sortme" &>

	<div class="left huge">

		<span class="hugespan">
			<h2>
				<% $tourn->name %> 
			</h2>
		</span>

		<span class="medspan" style="vertical-align: top;">
			<h4 style="text-align: right;">
				<% $tourn->location %>  
			</h4>
		</span>

		<br style="clear: both;">

        <& ../tourn_header.mas, tourn => $tourn, account => $account &>

		<h4><% $event->abbr %> Entries by Prelim Record</h4>

			<table cellpadding="4" cellspacing="1" id="sortme">

				<thead>

				<tr class="yellowrow">
					
					<th class="smaller">
						Wins
					</th>

%					if ($different) {
						<th class="smaller">
							Ballots
						</th>
%					}

					<th class="smaller">
						Name
					</th>

					<th class="smaller">
						Code
					</th>

					<th class="smaller">
						School
					</th>
				</tr>

				</thead>

				<tbody>

%				foreach my $entry (@entries) {

					<tr>

						<td class="smaller centeralign">
							<% $wins_by_entry{$entry->id} ? $wins_by_entry{$entry->id} : "" %>
						</td>

%						if ($different) {
							<td class="smaller centeralign">
								<% $ballots_by_entry{$entry->id} ? $ballots_by_entry{$entry->id} : "" %>
							</td>
%						}

						<td class="smaller">
							<a class="plain block" href="/index/tourn/postings/entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $entry->id %>">
								<% $entry->name %>
							</a>
						</td>

						<td class="smaller">
							<a class="plain block" href="/index/tourn/postings/entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $entry->id %>">
								<% $entry->code %>
							</a>
						</td>

						<td class="smaller">
							<% $entry->school->short_name %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

	</div>



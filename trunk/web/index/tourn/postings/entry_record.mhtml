<%args>
	$entry_id
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id);
	my $event = $entry->event;
	my $tourn = $event->tourn;

	my $switch; 

</%init>

	<& sidebar.mas, tourn_id => $tourn->id, event_id => $event->id &>

	<div class="left huge">

        <h2>
			<% $entry->name %> Record
        </h2>

        <& ../tourn_header.mas, tourn => $tourn &>

		<h4>Pairings</h4>

		<table cellpadding="4" cellspacing="1">

%		my @panels = $m->comp('/funclib/entry_panels.mas', entry => $entry, published => 1);
%		my %seen = (); 
%		@panels = grep { ! $seen{$_->id} ++ } @panels;

%		foreach my $panel (@panels) {

%			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);
%			my $opp = Tab::Entry->retrieve($panel->opp) if $panel->opp;
%			my $side = "Aff" if $panel->side == 1;
%			$side = "Neg" if $panel->side == 2;
%			$side = "Bye" if $panel->bye;

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					<% $panel->round->realname %>
				</td>
				
				<td class="smaller">
					<% ($panel->room) ? $panel->room->name : "" %>
				</td>

				<td>
					<% $side %>
				</td>

				<td>
%					foreach my $judge (@judges) { 
						<% ucfirst substr($judge->first,0,2) %> <% ucfirst $judge->last %>
%					}
				</td>

			</tr>

%		}

		</table>

		<h4>Results</h4>

		<table cellpadding="4" cellspacing="1">

%		my @results = $m->comp('/funclib/entry_panels.mas', entry => $entry, post_results => 1);
%		my %rseen = (); 
%		@results = grep { ! $rseen{$_->id} ++ } @results;

%		foreach my $panel (@results) { 

%			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);

%			if (scalar @judges > 1) {

				<tr class="yellowrow">
					<td colspan="10">
					</td>
				</tr>

%			}
%			my $opp = Tab::Entry->retrieve($panel->opp) if $panel->opp;
%			my $side = "Aff" if $panel->side == 1;
%			$side = "Neg" if $panel->side == 2;
%			$side = "Bye" if $panel->bye;

			<tr class="<% ($switch % 2) ? "oddrow" : "evenrow" %>">

				<td rowspan="<% scalar @judges %>">
					<% $panel->round->realname %>
				</td>

				<td rowspan="<% scalar @judges %>">
					<% $side %>
				</td>

%				my $notfirst;
%				foreach my $judge (@judges) { 
		
%					if ($notfirst++)  {
						<tr class="<% ($switch % 2) ? "oddrow" : "evenrow" %>">
%					}

%					my @scores = $m->comp('/funclib/panel_scores.mas', panel => $panel, judge => $judge, entry => $entry);
%           		my %scores_by_recipient =();

%           		foreach my $score (@scores) {   
%						push @{$scores_by_recipient{$score->student->id}}, $score if $score->student && $score->student->id; 
%           		}

					<td class="fixed nowrap">
						<% ucfirst $judge->last %>, <% ucfirst $judge->first %>
					</td>

					<td>
%						foreach my $score (@scores) { 
							<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
%						}
					</td>

%					foreach my $student ($entry->students) { 

%						if ($side eq "Bye" || $panel->round->post_results == 2) {
		
							<td colspan="<% 2 * scalar $entry->students %>"></td>

%						} else {
	
							<td>
								<% $student->last %>
							</td>

%							foreach my $score (@{$scores_by_recipient{$student->id}}) { 
	
								<td>	
									<% $score->value %>
								</td>	

%							}

%						}

%					}

					</tr>
%					$switch++;
%				}


%		}

		</table>

		<h4>Live Updates</h4>

		<div class="liblrow rightalign padmore">
			<form action="/index/tourn/updates/entry_follow.mhtml" method="post">
			<input type="hidden" name="entry_id" value="<% $entry->id %>">
			<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
				<input type="submit" class="thin" value="Subscribe to Live Updates">
			</form>
		</div>


	</div>


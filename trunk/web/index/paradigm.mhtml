<%args>
	$account          => undef
	$judge_account_id => undef
	$search_first     => undef
	$search_last      => undef
</%args>
<%init>

	my $tz = $account->tz if $account;
	$tz = "UTC" unless $tz;

	my $judge_account = Tab::Account->retrieve($judge_account_id) if $judge_account_id;

	my @searches;

	my $num_results;

	if ($search_first || $search_last) { 
	
		if ($search_first && $search_last) { 

			Tab::Account->set_sql( both => "
				select distinct *
				from account
				where first like ? 
				and last like ? 
				and paradigm is not null
			");

			@searches = Tab::Account->search_both($search_first."%", $search_last."%");

		} elsif ($search_first) {

			Tab::Account->set_sql( first => "
				select distinct *
				from account
				where first like ? 
				and paradigm is not null
			");

			@searches = Tab::Account->search_first($search_first."%");

		} elsif ($search_last) {

			Tab::Account->set_sql( last => "
				select distinct *
				from account
				where last like ? 
				and paradigm is not null
			");

			@searches = Tab::Account->search_last($search_last."%");

		}

		$judge_account = $searches[0] if scalar @searches == 1;
		$num_results = scalar @searches;

	}

</%init>


	<div class="left huge">

%		if ($judge_account) { 

%			my $changed = $judge_account->paradigm_timestamp;
%			$changed->set_time_zone($tz) if $changed;

			<h2><% $judge_account->first." ".$judge_account->last %>'s Paradigm</h2>

%			if ($changed) { 
				<div class="padless oddrow rightalign explain">
					Last changed <% Tab::nicedt($changed) %> <% Tab::tzname($tz) %>
				</div>
%			}


			<div class="paradigm">
				<% $judge_account->setting("paradigm") %>
			</div>

			<a name="judging"></a>
			
			<h4>Full Judging Record</h4>

			<& "/funclib/tablesorter.mas", table => "sortme" &>

			<table cellpadding="3" cellspacing="1" width="100%" id="sortme"> 

			<thead>
		
			<tr class="yellowrow">

				<th class="smallish">Tournament</th>
				<th class="smallish">Date</th>
				<th class="smallish">Event</th>
				<th class="smallish">Rd</th>
				<th class="smallish">Aff</th>
				<th class="smallish">Neg</th>
				<th class="smallish">Decision</th>																
			</tr>
			
			</thead>
			
			<tbody class="smallish">

<%perl>

			Tab::Ballot->columns(TEMP => qw/win/);
			Tab::Ballot->set_sql( ballots_by_judge => "
				select ballot.*, ballot_value.value as win
				from ballot, judge, ballot_value, panel, round
				where ballot.judge=judge.id
				and judge.account=$judge_account
				and ballot_value.ballot=ballot.id
				and ballot_value.tag='ballot'
				and panel.id=ballot.panel
				and round.id=panel.round
				and round.published>0
				and round.post_results>0
				order by ballot.panel asc
			");

			my @ballots = Tab::Ballot->search_ballots_by_judge();
			my $aff; my $neg; my $panel=0; my $decision;
			my $switch; my $winner; my $winside;

			foreach my $ballot (@ballots) {

				if ( $ballot->panel != $panel and $panel > 0 ) {

					my $round = $ballot->panel->round;
					my $tourn =  $round->event->tourn;
					my $date = $tourn->start;

</%perl>
				<tr>

					<td>
						<% $tourn->name %>
					</td>

					<td>
						<% Tab::shortdate($date) %>
					</td>

					<td>
						<% $round ? substr($round->event->name, 0, 10) : ""%>
					</td>

					<td>
%						my $name = $round->realname;
%						$name =~ s/Round//g;
						<% $round ? substr($name, 0, 5) : ""%>
					</td>

					<td>
						<% $aff %>
					</td>

					<td>
						<% $neg %>
					</td>

					<td>
						<% $decision %>
%						if ($round->type eq "elim" or $round->type eq "final" ) {					
							<br />(<% $winner ? $winner->code." wins" : "No winner recorded" %> wins)
%						}					
					</td>
				</tr>

<%perl>
					$aff=""; $neg=""; $decision="";
				}
				if ( $ballot->side == 1 ) { $aff=$ballot->entry->code; }
				if ( $ballot->side == 2 ) { $neg=$ballot->entry->code; }				
				if ( $ballot->side == 1 and $ballot->win ==1 ) { $decision="AFF-".$ballot->entry->code; }
				if ( $ballot->side == 2 and $ballot->win ==1 ) { $decision="NEG-".$ballot->entry->code;; }
				($winner, $winside) = $m->comp('/funclib/panel_winner.mas', panel => $ballot->panel);
				$panel=$ballot->panel;				
			}		
</%perl>
			</tbody>
				
			</table>
			
%		} elsif (@searches) { 

			<h2>Pick one</h2>

			<p>Your search for <% $search_first %> <% $search_last %> returned <% $num_results %> results:</p>

%			foreach my $search (@searches) { 
				
				<a class="blue thirdspan nowrap smallish padmore" href="paradigm.mhtml?judge_account_id=<% $search->id %>">
					<% $search->first." ".$search->last %>
				</a>

%			}

%		} else { 

			<h2>Judge Paradigms</h2>

			<p>Search for a judge at right to read paradigms</p>

%			unless (@searches) { 
%				if ($search_first || $search_last) {
					<p class="explain centeralign">
						Your search for <% $search_first %> <% $search_last %> returned no judges with paradigms.  Please
						try again.   
					</p>
%				}
%			}

%		}

	</div>

	<div class="right small">


%		if ($judge_account) { 

			<div class="sidenote">

				<h4>Intel on <% $judge_account->last %></h4>

				<a href="/user/tourn/show_past_prefs.mhtml?judge_account_id=<% $judge_account->id %>" class="blue block">
					View Past Ratings
				</a>

				<a href="#judging" class="blue block">
					View Judging Record
				</a>

			</div>

%		}

	
		<div class="sidenote">

			<h4>Search Judges:</h4>

			<form action="paradigm.mhtml">

			<div class="oddrow block smallish">
				<input type="text" name="search_first" placeholder="First name" size="25">
			</div>

			<div class="oddrow block smallish">
				<input type="text" name="search_last" placeholder="Last name" size="25">
			</div>

			<div class="liblrow rightalign">
				<input type="submit" value=" Go ">
				</form>
			</div>

		</div>

	</div>




<%args>	
	$from => undef
	$league
	$year => undef
</%args>
<%init>

	my $now = DateTime->now(time_zone => $league->timezone);

	$year = $now->year unless $year;

	my $start_year;
	my $end_year;

	if ($now->month < 7)  {
		$start_year = $year - 1;
		$end_year = $year;
	} else { 

		$start_year = $year;
		$end_year = $year + 1;

	}

	my $begin = DateTime->new( 
		year => $start_year,
		month => 7,
		day  => 01 );

	my $stop = DateTime->new(
		year => $end_year,
		month => 6,
		day => 30 );

	my @all_tournaments = Tab::Tournament->search( league => $league->id, approved => 1 );

	my @tournaments;

	foreach my $at (@all_tournaments) { 
		push (@tournaments, $at) if ($at->start > $begin && $at->end < $stop);
	}

	@tournaments = sort {$a->start <=> $b->start } @tournaments;

	my @all_schedules = Tab::Schedule->search( league => $league->id );
	my @schedules;
	
	foreach my $as (@all_schedules) { 
		push (@schedules, $as) if ($as->start > $begin && $as->end < $stop);
	}

	@schedules = sort {$a->start <=> $b->start } @schedules;

</%init>

<table cellpadding="4" cellspacing="1" width="100%">

	<tr>
		<td colspan="5">
			<h3><% $league->short_name %> Schedule for <% $start_year."-".$end_year %></h3>
		</td>
	</tr>

	<tr>
		<th>Tournament</th>
		<th>Dates</td>
		<th colspan="2">Registration</th>
	</tr>

%	my $switch;

% 	foreach my $tournament (@tournaments) { 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

			<td style="font-size: 90%;">
				<a href="tournament.mhtml?tourn_id=<%$tournament->id%>"><% $tournament->name %></a>
				<br>at
%				foreach my $site ($tournament->sites) { 
					<% $site->name %>
%				}
			</td>

			<td>
				<% &Tab::niceshortdate($tournament->start->set_time_zone($tournament->league->timezone))%>
				<% ($tournament->start->mdy ne $tournament->end->mdy) 
						? "-<br> ". &Tab::niceshortdate($tournament->end->set_time_zone($tournament->league->timezone))
						: "" %>
			</td>

%			if ($tournament->reg_start && $tournament->reg_end) { 

%				unless ($tournament->reg_start->mdy('/') eq $tournament->reg_end->mdy('/') ) { 

					<td>
						<% &Tab::niceshortdate($tournament->reg_start->set_time_zone($tournament->league->timezone))%>
					</td>

					<td>
						<% &Tab::niceshortdt($tournament->reg_end->set_time_zone($tournament->league->timezone))%>
					</td>

% 				} else { 

					<td></td>
					<td></td>
%				}

% 			}


%		}

		</tr>

	</table>

<table cellpadding="6" cellspacing="0" width="100%">
<tr><td colspan="5"><h3>Other events of interest</h3></td></tr>

% foreach my $schedule (@schedules) {

%		my $s_start = $schedule->start;
%		my $s_end = $schedule->end;
% 		$s_start->set_time_zone($league->timezone);
% 		$s_end->set_time_zone($league->timezone);

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

		<td>
			<a href="other.mhtml?schedule_id=<% $schedule->id %>">
				<% $schedule->name %>
			</a>
		</td>

		<td>
			<% $schedule->location %>
		</td>

		<td>
			<% $s_start->mdy('/') %> <% ($s_start->mdy ne $s_end->mdy) ? " - ".$s_end->mdy('/') : "" %>
		</td>

	</tr>

% }

</table>

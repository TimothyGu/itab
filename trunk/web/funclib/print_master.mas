<%args>
	$panel_id
	$judge_id
	$chair => undef
	$filename
</%args>
<%perl>

	my $filepath = $Tab::file_root."/tmp/".$filename;

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	my $event = $panel->round->event;
	my $tourn = $event->tourn;

	my $whatto = $event->judge_group->setting("master_ballot");

	my $strip = HTML::Strip->new();

	my $points;
	if ($panel->round->tb_set) { 
		foreach my $tb ($panel->round->tb_set->tiebreaks) {
			$points++ if $tb->name eq "points";
		}
	}

	open (TEXOUT, ">>$filepath.tex");

	unless ($event->setting("ballot_type") eq "cfl") { 

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT "{\\Large ".$event->abbr." ".$panel->letter." - ";
		print TEXOUT "Judge: ";
		print TEXOUT &Tab::texify($judge->school->code)  if $judge->school;
		print TEXOUT &Tab::texify("Hire") unless $judge->school;
		print TEXOUT " ";
		print TEXOUT &Tab::texify($judge->code)." - " unless $judge->judge_group->setting("no_codes");
		print TEXOUT "\\Huge ".&Tab::texify($judge->first." ".$judge->last)."}";
		print TEXOUT "\\ \n";
		print TEXOUT " \\end{flushright} \n  \\medskip \n";

	   	print TEXOUT "\\begin{center}\n";
		print TEXOUT "{\\Large ".&Tab::texify($tourn->name)." } \\\\ \n";

		if ($chair) { 
			print TEXOUT "\\bigskip\n {\\Large\\bf CHAIR MASTER BALLOT }\\\\ \n";
		} else {
			print TEXOUT "\\bigskip\n {\\Large\\bf MASTER BALLOT }\\\\ \n";
		}

		print TEXOUT "\\end{center} \n";

		print TEXOUT "\\renewcommand{\\arraystretch}{1.3}\n";
		print TEXOUT "\\begin{center}\n";
#	   	print TEXOUT "\\begin{tabular}{llll}\n";
		print TEXOUT "\\begin{tabular}{p{.5in}p{2.0in}p{.5in}p{3.0in}}\n";
		print TEXOUT "{\\small\\bf Event}: & ".$event->name." & ";
		print TEXOUT "{\\small\\bf Round:} & ".$panel->round->name;
		print TEXOUT " (". &Tab::texify($panel->round->label).")" if $panel->round->label;
		print TEXOUT " \\\\ \n ";
		print TEXOUT "{\\small\\bf Room:} & ";
		print TEXOUT ($panel->room->id) ? &Tab::texify($panel->room->name) : "NO ROOM LISTED ";
		print TEXOUT " & ";

		my $roundstart = $panel->round->timeslot->start;
		$roundstart->set_time_zone($tourn->tz);
		my $roundend = $panel->round->timeslot->end;
		$roundend->set_time_zone($tourn->tz);

		print TEXOUT "{\\small\\bf Time:} & ";
		print TEXOUT $roundstart->hour_12.":";
		print TEXOUT $roundstart->strftime('%M')." ";
		print TEXOUT $roundstart->strftime('%p')." to ";

		print TEXOUT $roundend->hour_12.":";
		print TEXOUT $roundend->strftime('%M')." ";
		print TEXOUT $roundend->strftime('%p')." \\\\ \n ";

		print TEXOUT "\\end{tabular}\n \\end{center} \n \\medskip \n";
		print TEXOUT "\\begin{center} \n \\large \n";
		print TEXOUT "\\renewcommand{\\arraystretch}{2.2} \n" if $event->type eq "speech";
		print TEXOUT "\\renewcommand{\\arraystretch}{1.5} \n" if $event->type eq "congress";
		print TEXOUT "\\begin{tabular}{|p{4.5in}|p{.75in}|p{.5in}|} \n" if $event->type eq "speech" && not defined $points;
		print TEXOUT "\\begin{tabular}{|p{4in}|p{.75in}|p{.5in}|p{.5in}|} \n" if $event->type eq "speech" && defined $points;
		print TEXOUT "\\begin{tabular}{|p{.5in}|p{2in}|p{3in}|p{.5in}|} \n" if $event->type eq "congress";
		print TEXOUT "\\hline ";
		print TEXOUT " Title/Question &" if $event->type eq "speech" && $whatto eq "titles";
		print TEXOUT " Name &" if ($whatto eq "name_schcode" || $whatto eq "names" || $whatto eq "first") && $event->type ne "Congress";
		print TEXOUT " Entry & School \\\\ \\hline \n" if $event->type eq "congress";

		print TEXOUT " Entry ";
		print TEXOUT " & ";

		if (defined $points && $event->type eq "speech") {
			print TEXOUT " Rank & Points \\\\ \\hline \n";
		} else {
			print TEXOUT " Rank \\\\ \\hline \n";
		}
		
		my $count;

		my $doubled;

		foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) {

			my $doublestars;
			foreach (1 .. scalar $m->comp("/funclib/entry_double.mas", entry => $entry, round => $panel->round)) {
				$doublestars .= "*";
			}
			$doubled++ if $doublestars;

			print TEXOUT Tab::texify($entry->name." ".$entry->school->short_name) if $event->type eq "congress";

			if ($whatto eq "first") { 
				foreach my $student ($entry->students) { 
					print TEXOUT Tab::texify($student->first." ");
				}
			}

			print TEXOUT Tab::texify($entry->name) if $whatto eq "name_schcode" || $whatto eq "names";

			print TEXOUT " & ";
			print TEXOUT Tab::texify($entry->code);
			print TEXOUT Tab::texify($doublestars);
			print TEXOUT " & ";
			print TEXOUT " & " if defined $points && $event->type eq "speech";
			print TEXOUT " \\\\ \\hline \n";
			$count++;
		}

		#Fill in extra spaces, up to 7.
		while ($count < 7) {
			print TEXOUT " & " if $event->type eq "congress";
			print TEXOUT " & " if $points && $event->type eq "speech";
			print TEXOUT " & & \\\\ \\hline \n ";
			$count++;
		}

		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\medskip \n ";
		print TEXOUT "\\end{center}\n";


		print TEXOUT "* These students are double (or triple, etc) entered.  Please accomodate late arrivals, or allow them to leave early.\n "if $doubled;

		print TEXOUT "\\medskip \n "if $doubled;
		print TEXOUT "\\break \n " if $doubled;
		print TEXOUT "\\small \n";
		print TEXOUT "\\flushleft \n";

		if ($chair) { 

			my $message = $tourn->setting("chair_ballot_message");
			$message = $tourn->setting("ballot_message") unless $message;
			$message = $strip->parse( $message );

			print TEXOUT "\\smallskip \n ";
			print TEXOUT &Tab::texify($message)."\n";

			my $notfirst;

			foreach my $oj ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {
				next if $oj->id == $judge->id;
				print TEXOUT "\\vspace*{.5in}\n \\normalsize {\\bf Other judges:} " unless $notfirst;
				print TEXOUT $oj->code." ".$oj->last." ";
				$notfirst++;
			}

		} else {
			my $message = $tourn->setting("ballot_message");
			$message = $strip->parse( $message );
			print TEXOUT &Tab::texify($message)."\n";
		}

		print TEXOUT "\\normalsize \n";

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT $panel->id."\n";;
		print TEXOUT " \\end{flushright} \n  \\medskip \n";
	}

	if ($event->setting("ballot_type") eq "cfl") { 

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT "{\\Large ".$panel->round->event->abbr." ".$panel->letter." - ";
		print TEXOUT &Tab::texify("(".$judge->school->region->code.")")." " if $tourn->setting("ncfl");
		print TEXOUT &Tab::texify($judge->school->code)." " unless $tourn->setting("ncfl");
		print TEXOUT &Tab::texify($judge->code)." - ";
		print TEXOUT "\\Huge ".&Tab::texify($judge->first." ".$judge->last)."}";
		print TEXOUT "\\\\ \n";
		print TEXOUT " \\end{flushright} \n  \\medskip \n";

	   	print TEXOUT "\\begin{center}\n";
		print TEXOUT "{\\large ".&Tab::texify($tourn->name)." } \\\\ \n";

		if ($judge->chair) {
			print TEXOUT "\\bigskip\n {\\Large\\bf CHAIR MASTER BALLOT }\\\\ \n";
		} else {
			print TEXOUT "\\bigskip\n {\\Large\\bf ".&Tab::texify(uc($event->name))." MASTER BALLOT }\\\\ \n";
		}

		print TEXOUT "\\end{center} \n";
		print TEXOUT "Rules of Procedure:\n\n";

		my $text = $event->setting("ballot_rules");
		$text = $strip->parse( $text );
		print TEXOUT &Tab::texify($text)."\n";
		print TEXOUT "\\renewcommand{\\arraystretch}{1.3}\n";
		print TEXOUT "\\begin{center}\n";
#	   	print TEXOUT "\\begin{tabular}{llll}\n";
		print TEXOUT "\\begin{tabular}{p{.5in}p{1.0in}p{.5in}p{1.5in}p{.5in}p{1.5in}}\n";
		print TEXOUT "{\\small\\bf Round:} & ".$panel->round->name;
		print TEXOUT " (". &Tab::texify($panel->round->label).")" if $panel->round->label;
		print TEXOUT "& {\\small\\bf Room:} & ";
		print TEXOUT ($panel->room->id) ? &Tab::texify($panel->room->name) : "NO ROOM";
		print TEXOUT " & ";

		my $roundstart = $panel->round->timeslot->start;
		$roundstart->set_time_zone($tourn->tz);
		my $roundend = $panel->round->timeslot->end;
		$roundend->set_time_zone($tourn->tz);

		print TEXOUT "{\\small\\bf Time:} & ";
		print TEXOUT $roundstart->hour_12.":";
		print TEXOUT $roundstart->strftime('%M')." ";
		print TEXOUT $roundstart->strftime('%p')." to ";

		print TEXOUT $roundend->hour_12.":";
		print TEXOUT $roundend->strftime('%M')." ";
		print TEXOUT $roundend->strftime('%p')." \\\\ \n ";

		print TEXOUT "\\end{tabular}\n \\end{center} \n \\medskip \n";
		print TEXOUT "\\begin{center} \n \\large \n";
		print TEXOUT "\\renewcommand{\\arraystretch}{2.2} \n" if $event->type eq "speech";
		print TEXOUT "\\renewcommand{\\arraystretch}{1.5} \n" if $event->type eq "congress";
		print TEXOUT "\\begin{tabular}{|p{4.5in}|p{.75in}|p{.5in}|} \n" if $event->type eq "speech" && not defined $points;
		print TEXOUT "\\begin{tabular}{|p{4in}|p{.75in}|p{.5in}|p{.5in}|} \n" if $event->type eq "speech" && defined $points;
		print TEXOUT "\\begin{tabular}{|p{.5in}|p{2in}|p{3in}|p{.5in}|} \n" if $event->type eq "congress";

		print TEXOUT "\\hline ";

		if ($event->type eq "speech") {
			if ($whatto eq "titles") {
				print TEXOUT " Title/Question & ";
			} else { 
				print TEXOUT " Name & ";
			}
		}

		print TEXOUT " Code &";

		print TEXOUT " Entry & School & Rank \\\\ \\hline \n" if $event->type eq "congress";

		if (defined $points) {
			print TEXOUT " Rank & Points \\\\ \\hline \n" if $event->type eq "speech";
		} else {
			print TEXOUT " Rank \\\\ \\hline \n" if $event->type eq "speech";
		}
		
		my $count;
		my $doubled;

		foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) {

			my $doublestars;

			foreach (1 .. scalar $m->comp("/funclib/entry_double.mas", entry => $entry, round => $panel->round)) {
				$doublestars .= "*";
			}
			$doubled++;

			print TEXOUT Tab::texify($entry->name) if $event->type eq "congress";

			print TEXOUT Tab::texify($entry->name) if $whatto eq "name_schcode" && $event->type ne "congress";

			print TEXOUT Tab::texify($entry->name) if $whatto eq "names" && $event->type ne "congress";

			print TEXOUT " & ";

			print TEXOUT $entry->code;
			print TEXOUT &Tab::texify($doublestars);
			print TEXOUT " & ";
			print TEXOUT " & " if defined $points && $event->type eq "speech";
			print TEXOUT " \\\\ \\hline \n";
			$count++;
		}

		#Fill in extra spaces, up to 7.
		while ($count < 7) {
			print TEXOUT " & " if $event->type eq "congress";
			print TEXOUT " & " if $points && $event->type eq "speech";
			print TEXOUT " & & \\\\ \\hline \n ";
			$count++;
		}

		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\medskip \n ";
		print TEXOUT "\\end{center}\n";

		if ($judge->chair) {
			my $message = $tourn->setting("chair_ballot_message");
			$message = $tourn->setting("ballot_message") unless $message;
			$message = $strip->parse( $message );

			print TEXOUT &Tab::texify($message)."\n";
			print TEXOUT "\n\\small {\\bf Other judges:} ";
			print TEXOUT "\\vspace*{.5in}\n \\normalsize {\\bf Other judges:} ";

			foreach my $oj ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {
				next if $oj->id == $judge->id;
				print TEXOUT $oj->code." ".&Tab::texify($oj->last)." ";
			}

			print TEXOUT "\\normalsize\n";

		} else {
			my $message = $tourn->setting("ballot_message");
			$message = $strip->parse( $message );
			print TEXOUT &Tab::texify($message)."\n";
		}

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT $panel->id."\n";
		print TEXOUT " \\end{flushright} \n  \\medskip \n";
	}

	close (TEXOUT);

</%perl>

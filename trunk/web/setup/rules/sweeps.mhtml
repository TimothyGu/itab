<%args>
	$tourn
	$set_id => undef
</%args>
<%init>

	my $switch;
	my (%cume_settings) = $m->comp("/funclib/tourn_cume_sweeps.mas", tourn => $tourn);
	my (%place_settings) = $m->comp("/funclib/tourn_place_sweeps.mas", tourn => $tourn);
    my $numero = keys %cume_settings;

</%init>

	<& sidebar.mas, tourn => $tourn, chosen => "sweeps", set_id => $set_id &>

	<div class="left huge">

		<h2>Team Awards/Sweepstakes </h2>

%		if ($set_id) { 

%			my $set = Tab::SweepSet->retrieve($set_id);

			<div class="left half">

				<h4><% $set->name %> sweep rules</h4>

				<span class="oddrow block greynohover">

					<form action="sweep_set_save.mhtml" method="post">

					<span class="inline">
						<input type="text" name="name" value="<% $set->name %>" size="20">
					</span>

					<span class="smaller inline" style="margin-top: 1px; margin-left: 15px;">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="submit" class="thin" value="Save">
					</span>

					</form>

				</span>

				<h4>Limits</h4>

					<form action="sweep_limits.mhtml" method="post">
					<input type="hidden" name="set_id" value="<% $set->id %>">

					<span class="oddrow block greynohover rightalign">

						<span class="smallish">
							Limit on entries counted overall
						</span>

						<span class="smallishspan">
							<input type="number" min="0" max="999" size="4" name="entries" value="<% $set->rule("entries") %>" >
						</span>
					</span>

					<span class="oddrow block greynohover rightalign">

						<span class="smallish">
							Limit on entries counted per event
						</span>

						<span class="smallishspan">
							<input type="number" min="0" max="999" size="4" name="event_entries" value="<% $set->rule("event_entries") %>" >
						</span>

					</span>

					<span class="oddrow block greynohover rightalign">

						<span class="smallish">
							Limit on how many events to count
						</span>

						<span class="smallishspan">
							<input type="number" min="0" max="999" size="4" name="events" value="<% $set->rule("events") %>" >
						</span>

					</span>

					<span class="oddrow block greynohover rightalign">

						<span class="smallish">
							Wildcard entries counted past limits
						</span>

						<span class="smallishspan">
							<input type="number" min="0" max="999" size="4" name="wildcards" value="<% $set->rule("wildcards") %>" >
						</span>

					</span>

					<div class="liblrow rightalign clear martop" style="border-top: 5px solid white;"> 
						<input type="submit" class="thin" value=" Save Limits ">
						</form>
					</div>

			</div>

			<div class="right half">

				<h4>Events in ruleset</h4>

%				my %used = ();
%				my $switch;

%				foreach my $event (sort {$a->name cmp $b->name} $set->events) { 

%					$used{$event->id}++;

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block smallish padless">
						<span class="medbigspan">
							<% $event->name %>
						</span>
						<span class="schemat centeralign">
							<a class="dkred padless block" href="sweep_event_rm.mhtml?event_id=<% $event->id %>&set_id=<% $set->id %>">
								Remove
							</a>
						</span>
					</span>
%				}

				<span class="oddrow block liblrow smallish padless">

					<form action="sweep_event_add.mhtml" method="post">
					<input type="hidden" name="set_id" value="<% $set->id %>">

					<span class="schemat" style="margin-left: 15px;">
						Add event:
					</span>

					<span class="medbigspan rightalign">

						<select name="event_id" onchange='this.form.submit()' class="fixedsmall">

							<option value="">Select to add</option>
							 
%							foreach my $event ($m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 
%								next if $used{$event->id};
								<option value="<% $event->id %>">
									<% $event->name %>
								</option>
%							}
						</select>
					</span>

					<noscript>
					<span class="smallspan">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="submit" class="thin" value="Save">
					</span>
					</noscript>
					</form>

				</span>
				
			</div>

			<br style="clear: both;" />
		

			<br style="clear: both;" />

%			if ($set->rules) { 
				<h4>Rules in set</h4>
%			}

%			undef $switch;

			<table cellpadding="4" cellspacing="1" width="100%">

%				foreach my $rule (sort {$a->tag cmp $b->tag} $set->rules) { 

%					my $tag = $rule->tag;

%					next if $tag eq "events";
%					next if $tag eq "entries";
%					next if $tag eq "event_entries";
%					next if $tag eq "wildcards";
%					my $index = index($tag, 'rev_');

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td>
							<% $switch %>.
						</td>

						<td class="smallish">
%							if ($rule->value && $index != 0 ) { 
								<% $rule->value %> point<% $rule->value == 1 ? "" : "s" %> for
%							}
						</td>

						<td class="smallish">
							<% $tag eq "points_per_prelim" ? "Prelim round appearance" : "" %>
							<% $tag eq "points_per_elim" ? "Elim round appearance" : "" %>
							<% $tag eq "points_per_final" ? "Final round appearance" : "" %>
							<% $tag eq "rev_per_elim_rank" ? "6 minus each rank in elim rounds" : "" %>
							<% $tag eq "rev_per_final_rank" ? "6 minus each rank in the final round" : "" %>
							<% $tag eq "rev_per_prelim_rank" ? "6 minus each rank in prelim rounds" : "" %>
							<% $tag eq "rev_per_elim_place" ? "6 minus placement in elim rounds" : "" %>
							<% $tag eq "rev_per_final_place" ? "6 minus placement in the final round" : "" %>
							<% $tag eq "rev_per_overall_place" ? "6 minus placement overall" : "" %>
							<% $tag eq "debate_win" ? "Prelim win (debate)" : "" %>
							<% $tag eq "place" ? Lingua::EN::Numbers::Ordinate::ordinate($rule->place)." place overall" : "" %>
							<% $tag eq "cume" ? "Prelim cumulative ranks of ".$rule->place : "" %>
							<% $tag eq "manual" ? "Count manually-entered sweeps points (under Tabulation)" : "" %>
						</td>

						<td class="centeralign">
							<a class="dkred block" href="sweep_rule_rm.mhtml?rule_id=<% $rule->id %>">
								DELETE
							</a>
						</td>

					</tr>
%				}

			</table>

			<br style="clear: both;" />

			<h4>
				Add new rule:
			</h4>
			
			<table cellpadding="4" cellspacing="1" width="100%">

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						Points Per Round Participated In
					</td>

					<td>
						Type:
						<select name="tag">
							<option value="points_per_prelim">Prelim Round</option>
							<option value="points_per_elim">Elim Round</option>
							<option value="points_per_final">Final Round</option>
						</select>
					</td>

					<td>
						Points: <input type="number" name="points" size="5" min="1" max="3">
					</td>

					<td>
						<input type="submit" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<td>
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="points" value="1">
						Count reverse points (6-rank) for
					</td>

					<td colspan="2">
						<select name="tag">
							<option value="rev_per_prelim_rank">Each Rank in Prelim Rounds</option>
							<option value="rev_per_elim_rank">Each Rank in Elim Rounds</option>
							<option value="rev_per_final_rank">Each Rank in the Final Round</option>
							<option value="rev_per_elim_place">Placement in each Elim Round</option>
							<option value="rev_per_final_place">Placement in the Final Round</option>
							<option value="rev_per_overall_place">Placement Overall</option>
						</select>
					</td>

					<td>
						<input type="submit" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						Give points for a debate win
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="debate_win">
					</td>

					<td>
					</td>

					<td>
						Points:
						<input type="number" name="points" max="99" min="1" size="5">
					</td>

					<td>
						<input type="submit" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						Give points for prelim cumulative score
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="cume">
					</td>

					<td>
						Score:
						<input type="number" name="place" max="99" min="1" size="5">
					</td>

					<td>
						Points:
						<input type="number" name="points" max="99" min="1" size="5">
					</td>

					<td>
						<input type="submit" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						Give points for final overall placement
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="place">
					</td>

					<td>
						Place:
						<input type="number" name="place" max="99" min="1" size="5">
					</td>

					<td>
						Points:
						<input type="number" name="points" max="99" min="1" size="5">
					</td>

					<td>
						<input type="submit" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td colspan="3">
						Manually entered points (under Tab -> Sweeps)
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="manual">
					</td>

					<td>
						<input type="submit" value="Add">
						</form>
					</td>

				</tr>

			</table>

%		} else { 

			<h4>Choose a set at right</h4>

%		}

	</div>


<%args>
	$tourn_id
	$housing_message => undef
</%args>
<%perl>

	my $tourn = Tab::Tournament->retrieve($tourn_id);


	$tourn->method->housing_message($housing_message);
	$tourn->method->update;


 	my @days = $tourn->days;
   	my $day_before = $days[0]->clone;
   	$day_before->subtract( days => 1);
   	push (@days, $day_before);

   	foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

		my $housing;

		my @housings = Tab::HousingSlots->search( tournament => $tourn->id, night => $day); 
		$housing = shift @housings if @housings;

		my $key = "slots_".$day->ymd;
		my $slots = $ARGS{$key};

		if ($slots) { 

			if ($housing) { 

				$housing->slots($slots);
				$housing->update;

			} else { 

				$housing = Tab::HousingSlots->create({
					tournament => $tourn->id,
					slots => $slots,
					night => $day
				});

			}

		} else { 

			if ($housing) { 
				$housing->delete;
			}

		}

	}

	my $msg = "Housing changes have been saved";
	$m->redirect("edit.mhtml?msg=$msg");

</%perl>

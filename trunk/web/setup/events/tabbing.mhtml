<%args>
	$tourn
	$event_id => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

 	my @groups = sort{$a->name cmp $b->name} $tourn->judge_groups;

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	$m->redirect("edit.mhtml") unless $event;

	my $switch;

</%init>

    <script type="text/javascript"> 
		function showMe (it,box) { 
			var vis = (box.checked) ? "none" : "block"; 
			document.getElementById(it).style.display = vis;
		} 
    </script>

    <div class="left huge">

        <h2><% $event->name %></h2>

        <& tabnav.mas, event => $event, whoami => "tabbing" &>

        <h4>Tabulation Settings</h4>
    
		<form action="tabbing_save.mhtml" method="post">
		<input type="hidden" name="event_id" value="<% $event->id %>">

		<div style="margin-bottom: 10px;" class="yellowrow">

			<span class="bigspan">
				Master Ballot style
			</span>

			<span class="biggishspan rightalign">

				<select name="ballot_type" class="fixedmed">
					<option value="normal" <% ($event && $event->setting("ballot_type") eq "normal") ? "selected" : "" %>>
						Plain
					</option>

					<option value="rules" <% ($event && $event->setting("ballot_type") eq "rules") ? "selected" : "" %>>
						List Rules (Enter Below)
					</option>
				</select>
			</span>

		</div>

%		unless ($event && ($event->type eq "speech" || $event->type eq 'congress')) { 

			<div style="margin-bottom: 10px;" class="evenrow">
				
				<span class="bigspan">
					Tiebreak set for speaker awards:
				</span>

				<span class="biggishspan rightalign">
%					my $set = $event->setting("speaker_tbset") if $event;
					<select name="speaker_tbset" class="fixedmed nowrap">
						<option value="">None</option>
%						foreach my $tb_set (Tab::TiebreakSet->search( tourn => $tourn->id)) { 
							<option value="<% $tb_set->id %>" <% $tb_set->id == $set ? "selected" : "" %>>
								<% $tb_set->name %>
							</option>
%						}
					</select>
				</span>

			</div>
%		}


%		undef $switch;
		<div class="half inline">

			<h4>Pairing/Sectioning</h4>

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="twofifty">
					<label for="live_updates">
						Use live updates (Text/Emails)
					</label>
				</span>
				<span class="smallishspan centeralign">
					<input type="checkbox" id="live_updates" name="live_updates" value="1" <% ($event) ? ($event->setting("live_updates")) ? 'checked' : '' : '' %>>
				</span>
			</div>

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="twofifty">
					<label for="allow_judge_own">
						Judges may judge their own school
					</label>
				</span>
				<span class="smallishspan centeralign">
					<input type="checkbox" id="allow_judge_own" name="allow_judge_own" value="1" <% ($event) ? ($event->setting("allow_judge_own")) ? 'checked' : '' : '' %>>
				</span>
			</div>
						
			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="twofifty">
					<label for="no_first_years">
						Block first year out judges
					</label>
				</span>
				<span class="smallishspan centeralign">
					<input type="checkbox" id="no_first_years" name="no_first_years" value="1" <% ($event) ? ($event->setting("no_first_years")) ? 'checked' : '' : '' %>>
				</span>
			</div>

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="onesixty">
					Section labels
				</span>
				<span class="medspan rightalign">
					<select name="panel_labels" class="fixedtiny">
						<option value="numbers">Numbers</option>
						<option <% $event->setting("panel_labels") eq "letters" ? "selected" : "" %> value="letters">Letters</option>
					</select>
				</span>
			</div>


%			if ($event->type eq "wudc") { 

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty wrap">
						<label for="avoid_school_hits">
							Avoid pairing same-school entries 
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" id="avoid_school_hits" name="avoid_school_hits" value="1" <% ($event) ? ($event->setting("avoid_school_hits")) ? 'checked' : '' : '' %>>
					</span>
				</div>

% 			}


% 			if ($event->type eq "congress" || $event->type eq "speech") { 

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="min_panel_size">
							Minimum <% $event->type eq "speech" ? "section" : "chamber" %> size
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="text" class="thin" name="min_panel_size" value="<% ($event) ? $event->setting("min_panel_size") : "0" %>" size="5">
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="max_panel_size">
							Maximum <% $event->type eq "speech" ? "section" : "chamber" %> size
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="text" class="thin" name="max_panel_size" value="<% ($event) ? $event->setting("max_panel_size") : "0" %>" size="5">
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="default_panel_size">
							Default <% $event->type eq "speech" ? "section" : "chamber" %> size
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="text" class="thin" name="default_panel_size" value="<% ($event) ? $event->setting("default_panel_size") : "0" %>" size="5">
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="school_percent_limit">
							Limit a school to this % of sections
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="text" class="thin" name="school_percent_limit" value="<% ($event) ? $event->setting("school_percent_limit") : "0" %>" size="5">
					</span>
				</div>


%				my $elim_method = $event->setting("elim_method");

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<span class="onesixty">
						Elim snake adjustment
					</span>

					<span class="medspan rightalign">

						<select name="elim_method" class="fixedtiny">

							<option value="snake" 
								<% ($event->setting("elim_method") eq "snake") ? "selected" : "" %>> 
								None: do not adjust for same-school hits
							</option>
		
							<option value="snake_school" 
								<% ($event->setting("elim_method") eq "snake_school") ? "selected" : "" %>> 
								Seeds: Adjust among entries with similar prelim seed (max 2 places)
							</option>

							<option value="snake_school_rank" 
								<% ($event->setting("elim_method") eq "snake_school_rank") ? "selected" : "" %>> 
								Tiebreak: Adjust among entries tied in the 1st tiebreaker
							</option>

							<option value="snake_school_prelim_cume" 
								<% ($event->setting("elim_method") eq "snake_school_prelim_cume") ? "selected" : "" %>> 
								Prelim Cume: Adjust among entries tied in prelim cume ranks
							</option>

							<option value="snake_school_overall_cume" 
								<% ($event->setting("elim_method") eq "snake_school_overall_cume") ? "selected" : "" %>> 
								Overall Cume: Adjust among entries tied in overall cume ranks
							</option>
		
							<option value="snake_school_force" 
								<% ($event->setting("elim_method") eq "snake_school_force") ? "selected" : "" %>> 
								Force: Force-adjust no matter tiebreakers; closer seeds first.
							</option>

							<option value="ky_semis_snake" 
								<% ($event->setting("elim_method") eq "ky_semis_snake") ? "selected" : "" %>> 
								Kentucky States: 3 way semi snake, then adjust for schools
							</option>

						</select>
					</span>
				</div>
							

% 			}

% 			if ($event->type eq "congress") { 

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="pair_seeds">
							Pair prelims based on seeding
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" name="pair_seeds" id="pair_seeds" value="1" <% ($event) ? ($event->setting("pair_seeds")) ? 'checked' : '' : '' %>>
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="parli_ballot">
							Parli fills 1 ballot for all prelims
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" name="parli_ballot" id="parli_ballot" value="1" <% ($event) ? ($event->setting("parli_ballot")) ? 'checked' : '' : '' %>>
					</span>
				</div>


				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="separate_codes">
							Use separate school codes
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" name="separate_codes" id="separate_codes" value="1" <% ($event) ? ($event->setting("separate_codes")) ? 'checked' : '' : '' %>>
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="points_later">
							Enter speaker points after ranks
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" name="points_later" id="points_later" value="1" <% ($event) ? ($event->setting("points_later")) ? 'checked' : '' : '' %>>
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="truncate_fill">
							Auto-fill blanks as truncate rank
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input  type="checkbox" name="truncate_fill" id="truncate_fill" value="1" <% ($event) ? ($event->setting("truncate_fill")) ? 'checked' : '' : '' %>>
					</span>
				</div>

% 			}

% 			if ($event->type ne "congress" && $event->type ne "speech" && $event->type ne "wudc") { 

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="round_robin">
							Round Robin format
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" name="round_robin" id="round_robin" value="1" <% ($event) ? ($event->setting("round_robin")) ? 'checked' : '' : '' %> onclick="showMe('norr', this)">
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="no_side_constraints">
							Flip for sides in all rounds (PF)
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input  type="checkbox" name="no_side_constraints" id="no_side_constraints" value="1" <% ($event) ? ($event->setting("no_side_constraints")) ? 'checked' : '' : '' %>>
					</span>
				</div>

				<div id="norr" style="display: <% $event->setting("round_robin") ? "none" : "block" %>;">

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="pullup_repeat">
							Allow repeat pullups by same team
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input  type="checkbox" name="pullup_repeat" id="pullup_repeat" value="1" <% ($event) ? ($event->setting("pullup_repeat")) ? 'checked' : '' : '' %>>
					</span>
				</div>

%				my $pullup_method = $event->setting("pullup_method");

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="onesixty">
						Pullup method
					</span>
					<span class="medspan rightalign">
						<select name="pullup_method" class="fixedtiny">
							<option value="sop" <% $pullup_method eq "sop" ? "selected" : "" %>>Worst SOP (Seed + Opp Seed.  Recommended)</option>
							<option value="oppwin" <% $pullup_method eq "oppwin" ? "selected" : "" %>>Pullup has worst opponents (based on record)</option>
							<option value="middle" <% $pullup_method eq "middle" ? "selected" : "" %>>Pull from middle of bracket below</option>
							<option value="lowseed" <% $pullup_method eq "lowseed" ? "selected" : "" %>>Worst seed from bracket below</option>
						</select>
					</span>
				</div>

%				my $powermatch = $event->setting("powermatch");

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="onesixty">
						Powermatch method
					</span>
					<span class="medspan rightalign">
						<select name="powermatch" class="fixedtiny">
							<option value="sop" <% $powermatch eq "sop" ? "selected" : "" %>>SOP (Seed + Opp Seed)</option>
							<option value="seed" <% $powermatch eq "seed" ? "selected" : "" %>>Seeds Only</option>
						</select>
					</span>
				</div>

%				my $seed_presets = $event->setting("seed_presets");

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="onesixty">
						Assign presets
					</span>
					<span class="smallishspan centeralign">
						<select name="seed_presets" class="fixedtiny">

							<option value="0" <% $seed_presets ? "" : "selected" %> >
								Randomly
							</option>

							<option value="all" <% $seed_presets eq "all" ? "selected" : "" %> >
								Hit All Seed Categories
							</option>

							<option value="inverse" <% $seed_presets eq "inverse" ? "selected" : "" %> >
								Hit Inverse Seeds (1 hits 2&amp;3; 3 hits 1&amp;4)
							</option>

							<option value="balance" <% $seed_presets eq "balance" ? "selected" : "" %> >
								Balance seeds of presets to same total
							</option>

							<option value="protect" <% $seed_presets eq "protect" ? "selected" : "" %> >
								Power Protect (1 hits 6, 2 hits 5)
							</option>

						</select>
					</span>
				</div>

				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="region_constraints">
							Constrain regions (presets & judging)
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input  type="checkbox" name="region_constraints" id="region_constraints" value="1" <% ($event) ? ($event->setting("region_constraints")) ? 'checked' : '' : '' %>>
					</span>
				</div>

% 			}

%			unless ($event->type eq "speech") { 
							
				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="forbid_repeat_judging">
							Forbid repeat judging
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" id="forbid_repeat_judging" name="forbid_repeat_judging" value="1" <% ($event) ? ($event->setting("forbid_repeat_judging")) ? 'checked' : '' : '' %>>
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="forbid_repeat_prelims">
							Forbid repeat judging in prelims
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" id="forbid_repeat_prelims" name="forbid_repeat_prelims" value="1" <% ($event) ? ($event->setting("forbid_repeat_prelims")) ? 'checked' : '' : '' %>>
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="forbid_repeat_prelim_side">
							Forbid repeat judging on same side
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" id="forbid_repeat_prelim_side" name="forbid_repeat_prelim_side" value="1" <% ($event) ? ($event->setting("forbid_repeat_prelim_side")) ? 'checked' : '' : '' %>>
					</span>
				</div>

% 			}

		</div>

		<div class="half inline">

%			undef $switch;
			
			<h4>Results</h4>

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="twofifty">
					<label for="online_ballots">
						Online Ballot Entry
					</label>
				</span>
				<span class="smallishspan centeralign">
					<input type="checkbox" id="online_ballots" name="online_ballots" value="1" <% ($event) ? ($event->setting("online_ballots")) ? 'checked' : '' : '' %>>
				</span>
			</div>

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="twofifty">
					Minimum speaker points
				</span>
				<span class="smallishspan centeralign">
					<input type="text" class="thin" name="min_points" value="<% ($event) ? $event->setting("min_points") : "0" %>" size="5">
				</span>
			</div>


			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="twofifty">
					Maximum speaker points
				</span>
				<span class="smallishspan centeralign">
					<input type="text" class="thin" name="max_points" value="<% ($event) ? $event->setting("max_points") : "100" %>" size="5">
				</span>
			</div>

%			my $increments = $event->setting("point_increments") if $event;

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="onesixty">
					Point increments
				</span>
				<span class="medspan rightalign">
					<select name="point_increments" class="fixedtiny">

						<option value="whole" <% ($event && $increments eq "whole") ? "selected" : "" %>>
							Whole
						</option>

						<option value="half" <% ($event && $increments eq "half") ? "selected" : "" %>>
							Half
						</option>

						<option value="fourths" <% ($event && $increments eq "fourths") ? "selected" : "" %>>
							.25
						</option>

						<option value="tenths" <% ($event && $increments eq "tenths") ? "selected" : "" %>>
							.10
						</option>

					</select>
				</span>
			</div>

%			unless ($event->type eq "wudc") { 

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="no_lpw">
							Forbid low-point wins
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" name="no_lpw" value="1" <% ($event && $event->setting("no_lpw")) ? "checked" : "" %>>
					</span>
				</div>

				<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<span class="twofifty">
						<label for="point_ties">
							Allow tied points
						</label>
					</span>
					<span class="smallishspan centeralign">
						<input type="checkbox" id="point_ties" name="point_ties" value="1" <% ($event) ? ($event->setting("point_ties")) ? 'checked' : '' : '' %>> 
					</span>
				</div>
%			}

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<span class="onesixty">
					Recognize top novices
				</span>

				<span class="medspan rightalign">

%					my $top_novice = $event->setting("top_novice");

					<select name="top_novice" class="fixedtiny">

						<option value="none" <% ( $top_novice eq "none") ? "selected" : "" %>>
							None
						</option>

						<option value="top" <% ( $top_novice eq "top") ? "selected" : "" %>>
							Overall
						</option>

						<option value="noelim" <% ( $top_novice eq "noelim") ? "selected" : "" %>>
							Non-advancing
						</option>
					</select>
				</span>
			</div>

			<div class="optionblock <% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				<span class="twofifty wrap">
					<label for="honorable_mentions">	
						Recognize tied non-advancers (honorable mentions)
					</label>
				</span>
				<span class="smallishspan centeralign">
					<input type="checkbox" id="honorable_mentions" name="honorable_mentions" value="1" <% ($event) ? ($event->setting("honorable_mentions")) ? 'checked' : '' : '' %>> 
				</span>
			</div>

		</div>

		<div class="liblrow block rightalign">
			<input type="submit" value="Save Tabbing Settings">
			</form>
		</div>

	</div>
		
	<div class="right small">
		<& menu.mas, tourn => $tourn, whoami => "tabbing", event_id => ($event) ? $event->id : "" &>		
	</div>

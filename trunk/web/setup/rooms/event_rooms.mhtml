<%args>
	$tourn
	$event_id
	$err => undef
</%args>
<%init> 

	my $event = Tab::Event->retrieve($event_id);
	my $switch;

	my @sites = $m->comp("/funclib/event_sites.mas", event => $event);

	# Save a ton of bad DB queries later plz. 
	my %event_abbr_by_id = ();
	foreach my $event ($m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 
		$event_abbr_by_id{$event->id} = $event->abbr;
	}

	my @available;
	my @preferred;
	my @reserved;
	my @blocked;
	my @otherwise_reserved;

	my %room_pools = ();
	my %other_pools =(); 

	foreach my $pool ($m->comp("/funclib/tourn_room_pools.mas", tourn => $tourn)) { 

		if ($pool->reserved) { 
			push @{$room_pools{$pool->room->id."_reserved"}}, $pool->event->id;
		} else { 
			push (@{$room_pools{$pool->room->id."_preferred"}}, $pool->event->id) if $event_abbr_by_id{$pool->event->id};
		}
	}

	my $count;

	foreach my $site (@sites) { 

		ROOM:
		foreach my $room (sort {$a->name cmp $b->name} $site->rooms) { 

			my $unavailable;

			if ($room->inactive > 1) {
				push @blocked, $room;
				next ROOM;
			}

			$count++;

			foreach $event_id (@{$room_pools{$room->id."_reserved"}}) {
				$unavailable++;
				next unless $event_id == $event->id;
				push @reserved, $room;
			}

			foreach my $preferred (@{$room_pools{$room->id."_preferred"}}) { 

				if ($preferred == $event->id) { 
					$unavailable++;
					push @preferred, $room;
				} else { 
					$other_pools{$room->id} .= "," if $other_pools{$room->id};
					$other_pools{$room->id} .= $event_abbr_by_id{$preferred};
					push @available, $room;
				}

				next ROOM;
			}

			#And then, the rest.
			push @available, $room unless $unavailable;

		}
	}

	my $res_count = scalar @reserved;
	my $pref_count = scalar @preferred;

</%init>

    <style>

		ul#reserved { 
			background-color: #feeeee;
		}

		ul#preferred { 
			background-color: #fefeee;
		}

		ul#available{ 
			background-color: #eee;
		}

        ul.drop { 
			list-style-type	: none; 
			margin			: 0; 
			padding			: 0; 
			float			: left; 
			background		: #fafafa; 
			padding			: 3px; 
			width			: 170px;
			min-height		: <% ($count * 25) %>px;
		}

        ul.drop li { 
			margin			: 4px; 
			padding			: 3px; 
			padding-left	: 4px;
			width			: 155px; 
		}
		
    </style>

    <script>

	    $(function(drop) {

    		$( "#reserved" ).sortable({
				connectWith: "ul",
				scroll: "true",
				disableSelection: "true",
				opacity: 0.6,
				revert:  "true",
				receive: function(event, ui) { 

					$.post("/setup/rooms/event_rooms_save.mhtml",{ event_id: "<% $event->id %>", type : "r", room_id: ui.item.attr("id") });

					ui.item.removeClass("sort-available");
					ui.item.removeClass("sort-preferred");
					ui.item.toggleClass("sort-reserved");
    		
				}
			});

    		$( "#preferred" ).sortable({
				connectWith: "ul",
				scroll: "true",
				disableSelection: "true",
				opacity: 0.8,
				revert:  "true",
				receive: function(event, ui) { 

					$.post("/setup/rooms/event_rooms_save.mhtml",{
						event_id: "<% $event->id %>",
						type : "p",
						room_id: ui.item.attr("id")
					});

					ui.item.removeClass("sort-available");
					ui.item.removeClass("sort-reserved");
					ui.item.toggleClass("sort-preferred");

				}
			});

    		$( "#available" ).sortable({
				connectWith: "ul",
				disableSelection: "true",
				opacity: 0.7,
				revert:  "true",
				scroll: "true",
				receive: function(event, ui) { 
					$.post("/setup/rooms/event_rooms_save.mhtml",{
						event_id: "<% $event->id %>",
						type : "a",
						room_id: ui.item.attr("id")
					});

					ui.item.removeClass("sort-preferred");
					ui.item.removeClass("sort-reserved");
					ui.item.toggleClass("sort-available");
				}
			});

			$( "#preferred" ).bind( "sortreceive", updatecount);
			$( "#reserved" ).bind( "sortreceive", updatecount);
			$( "#available" ).bind( "sortreceive", updatecount);

			function updatecount() { 
				var res_array = $( "#reserved").sortable("toArray");
				var pref_array = $( "#preferred").sortable("toArray");

				var x=document.getElementById('roomcounts').rows;
				var y=x[2].cells;
				y[1].innerHTML=res_array.length;

				var z=document.getElementById('roomcounts').rows;
				var q=z[3].cells;
				q[1].innerHTML=pref_array.length;
			};

   		});

    </script>
	
	<& sidebar.mas, tourn => $tourn, myevent => $event, res_count => $res_count, pref_count => $pref_count &>

	<div class="left huge">

%		if ($event) { 

			<h2>Rooms for <% $event->name %></h2>

%			unless (@sites) { 

				<p>You must first <a href="/setup/schedule/sked.mhtml">schedule rounds</a> for this event before assigning rooms</p>

%			} else { 

			<div style="float: left; width: 33%;">

				<h5>Use only for <% $event->abbr %> <% $res_count %></h5>
		
				<div class="sortable">

					<ul id="reserved" class="drop">

%						foreach my $room (@reserved) { 
							<li class="sort-reserved" id="<% $room->id %>">

								<span class="sorting">
									<% substr($room->name,0,20) %>
								</span>

								&nbsp;

%								if ($other_pools{$room->id}) { 

									<span class="sortcat">
										<% $other_pools{$room->id} %>
									</span>

%								}

							</li>
%						}
					</ul>

				</div>

			</div>

			<div style="float: left; width: 33%; margin-left: 3px;">

				<h5>Prefer for <% $event->abbr %><% $pref_count %></h5>

				<div class="sortable">

					<ul id="preferred" class="drop">
%						foreach my $room (@preferred) { 
							<li class="sort-preferred" id="<% $room->id %>">

								<span class="sorting">
									<% substr($room->name,0,20) %>
								</span>

								&nbsp;

%								if ($other_pools{$room->id}) { 
									<span class="sortcat">
										<% $other_pools{$room->id} %>
									</span>
%								}
							</li>
%						}
					</ul>

				</div>

			</div>

			<div style="float: left; width: 33%; margin-left: 2px;">

				<h5>Available</h5>

				<div class="available">
					<ul class="drop" id="available">

%						foreach my $room (@available) { 

							<li class="sort-available" id="<% $room->id %>">

								<span class="sorting">
									<% substr($room->name,0,20) %>
								</span>

								&nbsp;

%								if ($other_pools{$room->id}) { 
									<span class="sortcat">
										<% $other_pools{$room->id} %>
									</span>
%								}

							</li>
%						}

					</ul>


				</div>

			</div>
%		} 

%		}

	</div>



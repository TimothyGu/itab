<%args>
	$circuit
	$tourn
	$group_id
	$obligation_before_strikes => 0
	$coach_ratings => 0
	$conflicts => 0
	$ask_paradigm => 0
	$entry_strikes => 0
	$cumulate_mjp => 0
	$school_strikes => 0
	$prefs => 0
	$deadline => 0
	$deadlinetime => 0
	$strike_start => 0
	$strike_start_time => 0
	$strike_end => 0
	$strike_end_time => 0
	$tz
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id);
	$tz = $tourn->tz unless $tz;

    my $deadlinedt = Tab::dtme($deadline,$deadlinetime) if $deadline;
	$deadlinedt->set_time_zone($tz) if $deadlinedt;

    my $strike_startdt = Tab::dtme($strike_start,$strike_start_time) if $strike_start;
    my $strike_enddt = Tab::dtme($strike_end,$strike_end_time) if $strike_end;

	$strike_startdt->set_time_zone($tz) if $strike_startdt;
	$strike_enddt->set_time_zone($tz) if $strike_enddt;

	my $judge_deadline = $tourn->setting("judge_deadline");
	$judge_deadline = $tourn->reg_end unless $judge_deadline;
	$judge_deadline->set_time_zone($tz);

	my $err;

	# Throw an error if the deadline is after the overall tournament deadline

	if ($deadlinedt && $deadlinedt > $judge_deadline) { 

		$err = "You have set a judge deadline for this group AFTER the overall
		tournament deadline ".Tab::niceshortdt($judge_deadline).".  It must be before to be meaningful.";
		$m->redirect("/setup/judges/ratings.mhtml?group_id=$group_id&err=$err");

	}

	$deadlinedt = $judge_deadline->clone unless $deadlinedt;

	if ($deadlinedt && $strike_startdt < $deadlinedt) { 

		$err = "You cannot open strikes before the judge deadline, else chaos would surely ensue";
		$m->redirect("/setup/judges/ratings.mhtml?group_id=$group_id&err=$err");
	}

	#Throw an error if the date is bad & there are strikes
	if ( ($entry_strikes || $school_strikes) && (not defined $strike_startdt || not defined $strike_enddt) ) { 

		$err = "You cannot permit strikes or ratings without also setting dates
		for them to open and close.  Try again.";
		$m->redirect("/setup/judges/ratings.mhtml?group_id=$group_id&err=$err");
	}

	if ( ($entry_strikes || $school_strikes) && ($prefs && $prefs ne "community")) { 

		$err = "You cannot offer both judge preferencs AND strikes.  Strikes
		are part of the preferencing systems; use conflicts if you're looking
		to allow teams to mark judges who should not judge them. ";
		$m->redirect("/setup/judges/ratings.mhtml?group_id=$group_id&err=$err");

	}

	$group->setting("obligation_before_strikes", $obligation_before_strikes);
	$group->setting("coach_ratings", $coach_ratings);
	$group->setting("conflicts", $conflicts);
	$group->setting("ask_paradigm", $ask_paradigm);

	$group->setting("prefs", $prefs);

	$group->setting("school_strikes", $school_strikes);
	$group->setting("entry_strikes", $entry_strikes);

	$group->setting("cumulate_mjp", $cumulate_mjp);

	$group->setting("deadline", "date", $deadlinedt);
	$group->setting("strike_start", "date", $strike_startdt);
	$group->setting("strike_end", "date", $strike_enddt);

	my $msg = "Group ".$group->name." ratings settings have been updated";

	$m->redirect("$Tab::url_prefix/setup/judges/ratings.mhtml?group_id=$group_id&msg=$msg&err=$err");

</%init>


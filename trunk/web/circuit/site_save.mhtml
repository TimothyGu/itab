<%args>
	$name
	$dropoff
	$host_email => undef
	$directions => undef
	$site_id => undef;
	$circuit
</%args>
<%init>
	
	my $err;

	my @hosts = Tab::Account->search( email => $host_email) if $host_email;

	my $host = $hosts[0] if @hosts;

	if ($site_id)  { 

		my $site = Tab::Site->retrieve($site_id);
	
		$site->name($name);
		$site->dropoff($dropoff);
		$site->host($host->id) if $host;
		$site->directions($directions);
		$site->update;
		$err = "Changes saved to site ".$site->name;
	
		$m->redirect("/circuit/site_edit.mhtml?err=$err&site_id=$site_id");

	} else {  

		my $site = Tab::Site->create( { 
			name => $name,
			dropoff => $dropoff,
			circuit => $circuit->id,
			directions => $directions
		});

		$site->host($host->id) if $host;
		$site->update;

		$err = "New site ".$site->name." added to your circuit.";

		$m->redirect("/circuit/sites.mhtml?err=$err");
	}


</%init>

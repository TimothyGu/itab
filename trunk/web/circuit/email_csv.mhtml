<%args>
	$circuit
	$account
	$session
</%args>
<%init>

	my @chapters = $circuit->members;

	my $filename = "/tmp/CircuitContacts-".$circuit->short_name."-".$session->id.".csv";
	my $filepath = $Tab::file_root.$filename;

	open (CSVOUT, ">$filepath");

	print CSVOUT "Chapter,";
	print CSVOUT "First,";
	print CSVOUT "Last,";
	print CSVOUT "Email,";
	print CSVOUT "Phone\n";

	foreach my $chapter (@chapters) { 

		next unless $chapter && $chapter->coaches;

		foreach my $coach ($chapter->coaches) { 

			print CSVOUT &Tab::texify($chapter->name).",";
			print CSVOUT &Tab::texify($coach->first).",";
			print CSVOUT &Tab::texify($coach->last).",";
			print CSVOUT &Tab::texify($coach->email).",";
			print CSVOUT &Tab::texify($coach->phone)."\n";

		}

	}

    $m->redirect($Tab::url_prefix.$filename);

</%init>

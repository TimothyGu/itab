<%args>
	$circuit
	$account
	$title
	$link
	$text
	$news_id
	$attach => undef
	$main_site => undef
	$active => undef
</%args>
#/
<%init>

	my $news = Tab::News->retrieve($news_id) if $news_id;
	chomp $text;
	my $now = DateTime->now;
	$now->set_time_zone($tourn->tz);

	my @is_admin = Tab::CircuitAdmin->search( account => $account->id, circuit => $circuit->id );

	unless ($account->site_admin || @is_admin) { 
		$m->print("
			<h4>Error:</h4><p><b>Only site admins or circuit 
				officials may edit the website. </b></p>");
		$m->abort;
	}

	chomp $title;

	my $err;

if ($news)  { 

	$news->title($title);
	$news->active($active);
	$news->text($text);
	$news->main_site($main_site);
	$news->edited_by($account->id);
	$news->edited_on($now);
	$news->update;

	$err = "Changes to ". $news->title ."saved";


} else {  

	$news = Tab::News->create({ 
		title => $title,
		author => $account->id,
		posted => $now,
		text => $text,
		active => $active,
		circuit => $circuit->id,
		main_site => $main_site,
		link => $link
	});

	$err = "Article ". $news->title ." created ";

}

    if ($attach) {
        my $req = Apache2::Request->new($r);
        my $upload = $req->upload("attach");
        my $filename  = $upload->filename;
        $filename =~ s/.*[\/\\](.*)/$1/;
        $filename =~ s/\ //g;
        $filename =~ s/\'//g;  # '  stupid vim
        my $filepath = "$Tab::file_root/files/".$circuit->id."/articles/".$news->id;
        my $garbage = `rm -f $filepath`;
        $garbage = `mkdir -p $filepath`;
        my $filetemp = $upload->tempname;
        $garbage = `cp $filetemp $filepath/$filename`;
        $news->file($filename);
        $news->update;
	}

	$m->redirect("$Tab::url_prefix/circuit/news_edit.mhtml?news_id=".$news->id."&err=$err");

</%init>


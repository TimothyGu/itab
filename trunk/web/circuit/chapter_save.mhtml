<%args> 
	$circuit
	$account
	$chapter_id => undef
	$name
	$code => undef
	$state => undef
	$active => undef
	$membership => undef
	$full_member => undef
	$region_id => undef
</%args>
<%init>

	my $chapter;

	$chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	if ($chapter_id) { 

		$chapter->name($name);
		$chapter->state($state);
		$chapter->update;	

	} else {

		$chapter = Tab::Chapter->create({ 
			name => $name,
			state => $state
		});

	}

	my @cls = Tab::ChapterCircuit->search( circuit => $circuit->id, chapter => $chapter->id );

	my $cl = shift @cls if @cls;

	foreach (@cls) { $_->delete; } # THERE CAN BE ONLY ONE!

	# Join the chapter to the circuit. 

	if ($cl) { 

		$cl->code($code);
		$cl->update;

	}

	$m->redirect("$Tab::url_prefix/circuit/chapter_edit.mhtml?chapter_id=$chapter_id");
		
</%init>

<%args>
	$group_id
	$diocese_id
	$judge_id => undef
	$chapter_id => undef
	$first => undef
	$last => undef
	$cell => undef
	$gender => undef
	$notes => undef
	$save => undef
	$cfl_tab_first => undef
	$cfl_tab_second => undef
	$cfl_tab_third => undef
</%args>
<%init>

	my $msg;

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my $tourn = $group->tournament;

	my $diocese = Tab::Region->retrieve($diocese_id);

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my $school = $chapter->school($tourn);

	unless ($school) {

		$school = Tab::School->create({
			tournament => $tourn->id,
			chapter => $chapter_id,
			name => $chapter->name,
			region => $diocese->id,
			code => $chapter->code($tourn->circuit)
		});

	}

	my @classes = $group->classes;

	my $judge;

	if ($judge_id) { 

		$judge = Tab::Judge->retrieve($judge_id);

		$judge->school($school->id);
		$judge->first($first);
		$judge->last($last);
		$judge->cell($cell);
		$judge->gender($gender);
		$judge->notes($notes);
		$judge->cfl_tab_first($cfl_tab_first);
		$judge->cfl_tab_second($cfl_tab_second);
		$judge->cfl_tab_third($cfl_tab_third);
		$judge->update;
	
		$msg = "Changes to Judge $first $last saved ";

	} else { 

		if ($first && $last && $cell) { 

			$judge = Tab::Judge->create({
				tournament => $tourn->id,
				judge_group => $group_id,
				school => $school->id,
				first => $first,
				last => $last,
				cell => $cell,
				notes => $notes,
				cfl_tab_first => $cfl_tab_first,
				cfl_tab_second => $cfl_tab_second,
				cfl_tab_third => $cfl_tab_third,
				gender => $gender,
				active => 1,
			});

			$msg = "Judge $first $last added to the tournament";

		} else { 

			my $err = "You did not fill in all required info.  We need first name, last name, and cell phone at minimum";
			$m->redirect("$Tab::url_prefix/user/diocese/judge_edit.mhtml?group_id=".$group->id."&diocese_id=$diocese_id&err=$err");
	
		}

	}

	foreach my $class (@classes) {

		my $judge_class = $judge->class($class);

		my $qual = $ARGS{$class->id};

		if ($judge_class) { 

			$judge_class->qual($qual);
			$judge_class->update;

		} else {

			$judge_class = Tab::JudgeClass->create({
				tournament => $tourn->id,
				judge => $judge->id,
				class => $class->id,
				qual => $qual
			});

		}

	}

	if ($save eq "Save and Return To Roster") {

		$m->redirect("$Tab::url_prefix/user/diocese/judges_enter.mhtml?group_id=".$group->id."&diocese_id=$diocese_id&msg=$msg");

	} else { 

		$m->redirect("$Tab::url_prefix/user/diocese/tab_edit.mhtml?group_id=".$group->id."&diocese_id=$diocese_id&msg=$msg");

	}

</%init> 


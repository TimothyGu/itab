<%args>
	$account
	$judge_id
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	my $diocese_id = $judge->school->region->id;

	my $tourn = $judge->tournament;

	my $group = $judge->judge_group;

	my $school = $judge->school;

	my $msg = "Judge ".$judge->first." ".$judge->last." has been dropped.";

	if ($account->id == $judge->school->region->director->id || $account->site_admin) { 
	
		my @quals = Tab::JudgeClass->search(judge => $judge->id);

		foreach my $q (@quals) { 
			$q->delete;
		}

		my $regline = $account->first." ".$account->last." dropped judge ".$judge->code;

		my $change = Tab::Change->create({
			tournament => $tourn->id,
			school => $school->id,
			type => "registration",
			regline => $regline
		}) if $tourn->method->track_reg_changes;

		$judge->delete;

	} 

	my $remaining = scalar $school->comps;
	my $judges = scalar $school->judges;

	if ($remaining == 0 && $judges == 0) {
		$school->delete;
	}


	$m->redirect("$Tab::url_prefix/user/diocese/judges_enter.mhtml?group_id=".$group->id."&diocese_id=$diocese_id&msg=$msg");

</%init>

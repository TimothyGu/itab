<%args>
	$event_id 
	$diocese_id
</%args>
<%init> 

	my $diocese = Tab::Region->retrieve($diocese_id);

	my $event = Tab::Event->retrieve($event_id);

	my $tourn = $event->tournament;

    my @entries = sort {$a->id <=> $b->id} $diocese->event_comps($event);

	my $name;
	my $msg;
	my $err;

	my $now = DateTime->now;

	$now->set_time_zone($tourn->league->timezone);

	foreach my $tag (1 .. $diocese->quota) { 

		my $entry = shift @entries;

		my $student_first = $ARGS{"student_first_".$tag};
		my $student_last = $ARGS{"student_last_".$tag};
		my $student_gender = $ARGS{"student_gender_".$tag};

		next unless $student_first && $student_last;

		my $partner_first = $ARGS{"partner_first_".$tag};
		my $partner_last = $ARGS{"partner_last_".$tag};
		my $partner_gender = $ARGS{"partner_gender_".$tag};

		my $ada = $ARGS{"ada_".$tag};
		my $drop = $ARGS{"drop_".$tag};

		my $chapter_id = $ARGS{"chapter_id_".$tag};
		my $chapter = Tab::Chapter->retrieve($chapter_id);
		my $school = $chapter->school($tourn);

		unless ($school) { 

	        $school = Tab::School->create({
   	        	tournament => $tourn->id,
            	chapter => $chapter_id,
            	name => $chapter->name,
				region => $diocese->id,
            	code => $chapter->code($tourn->league)
	        });

		}

		if ($entry) {

			my $student = $entry->student;

			$student->first($student_first);
			$student->last($student_last);
			$student->gender($student_gender);
			$student->chapter($chapter->id);
			$student->update;

			$name = $student_last;

			my $partner;

			if ($partner_last) {
				$partner = $entry->partner;
				$partner->first($partner_first);
				$partner->last($partner_last);
				$partner->gender($partner_gender);
				$partner->chapter($chapter->id);
				$partner->update;
				$name = $name . " and $partner_last ";
			}

			if ($drop) { 

				$entry->delete;

			} else {
	

				$entry->school($school->id);
				$entry->name($name);
				$entry->ada($ada);
				$entry->student($student->id);
				$entry->partner($partner->id) if $partner_first;
				$entry->update;

			}

		} else { 

			my $event = Tab::Event->retrieve($event_id);

			my $student = Tab::Student->create({ 
				first => $student_first,
				gender => $student_gender,
				last => $student_last,
				chapter => $chapter->id
			});

			$name = $student_last;

			my $partner;

			if ($partner_last) { 
				$partner = Tab::Student->create({ 
					first => $partner_first,
					last => $partner_last,
					gender => $partner_gender,
					chapter => $chapter->id
				});

				$name = $name ." $partner_last";
			}

			next if ($event->team == 2 && ( not defined $partner ));

			my $entry = Tab::Comp->create({ 
				tournament => $tourn->id,
				student => $student->id,
				event => $event_id,
				ada => $ada,
				school => $school->id,
				registered_at => $now,
				name => $name
			});

			if ($partner_last) { 
				$entry->partner($partner->id);
				$entry->update;
			}

		}
		
		$msg .= "$name entered.<br />" unless $drop;
		$err .= "$name dropped from tournament.<br />" if $drop;
	
	}

	$m->redirect("$Tab::url_prefix/user/diocese/event_enter.mhtml?diocese_id=".$diocese->id."&event_id=".$event->id."&msg=$msg&err=$err");

</%init>

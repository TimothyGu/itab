<%args>
	$league
	$chapter_id => undef
	$diocese_id => undef
	$tourn_id => undef
	$name => undef
</%args>
<%init>

	my $chapter;
	$chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($name) { 

		$m->print("<p>You must enter a school name</p>");
		$m->abort();
	}

	$name =~ s/&/and/g;
	$name = ucfirst($name);

	if ($chapter_id) { 

		$chapter->name($name);
		$chapter->update;	

		my @membership = Tab::ChapterLeague->search( chapter => $chapter_id, league => $league->id);
		$membership[0]->region($diocese_id);
		$membership[0]->update;

	} else {

		$chapter = Tab::Chapter->create({ 
			name => $name,
		});

		my $cl = Tab::ChapterLeague->create({ 
			chapter => $chapter->id,
			league  => $league->id
		});

		$cl->region($diocese_id) if $diocese_id;
		$cl->update;
	
	}

	$m->redirect("$Tab::url_prefix/user/diocese/chapter_edit.mhtml?chapter_id=".$chapter->id."&tourn_id=".$tourn_id);
		
</%init>


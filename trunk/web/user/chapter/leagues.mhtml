<%args>
	$chapter_id
	$account
	$session
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	$m->comp("/user/chapter/auth.mas", chapter => $chapter, account => $account, session => $session);

	my %circuit_member = ();

	my @ljs = sort {$a->circuit->name cmp $b->circuit->name} $chapter->circuit_joins;

	my $switch;

</%init>

	<div class="left huge"> 
	
		<& /user/tabbar.mas, chapter => $chapter, whoami => "circuit" &>

%		if (@ljs) { 
			
			<h2>Circuits: <% $chapter->name %></h2>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">

					<th>
						Circuit
					</th>

					<th>
						Membership
					</th>

					<th class="smaller">
					</th>

				</tr>

%				foreach my $lj (@ljs) { 

%					next unless $lj->active;
%					my $circuit = $lj->circuit;

%					$circuit_member{$circuit->id}++;

%					next if ($circuit->diocese_based || $circuit->active < 1 );

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>			

						<td class="smaller">
							<% $circuit->name %>
						</td>

						<td class="smaller">

							<% ($lj->full_member) ? "" : "Tournaments Only" %>

%							if ($lj->membership) { 
								<% $lj->membership->name %>		
								<% ($lj->membership->dues > 0) ? "(\$".$lj->membership->dues.")" : "" %>		
%							}

%							if ($circuit->region_based && $circuit->regions && $lj->region) { 
								<% $lj->region->name %> region
%							}

						</td>

						<td class="smaller">

							<a href="circuit_leave.mhtml?lj_id=<% $lj->id %>" class="whiteblock">
								Leave Circuit
							</a>

						</td>

					</tr>

%				}

			</table>

%		} else { 

			<h2>Joining Circuits</h2>

			<p class="smallish">
				All tournaments on tabroom.com are part of a circuit.  The
				circuits on tabroom.com are listed below.
			</p>
			
			<p class="smallish">
				Click "Join Circuit" to fully join.  You will be able to
				register for tournaments, and will recieve emails about the
				circuit.  You may also be billed for membership dues.  This is
				best for joining a state or local circuit.
			</p>

			<p class="smallish">
				Click "Tournaments Only" if you want to register for
				tournaments, but don't want Circuit emails or to be a dues
				paying member.  Some circuits are run entirely on a 
				tournament-only basis.
			</p>

			<p class="smallish">
				Register for tournaments without organized circuits on tabroom
				by joining "Invitationals: High School" for tournaments with
				high school competitors, or "Invitationals: College" for
				tournaments for college student competitors (not high school
				tournaments hosted by colleges; those are under High School).
			</p>

			<p class="smallish">
				If you don't know what circuit your tournament is in, check 
				front page of Tabroom.com.  Click on the tournament and
				the circuit will be listed at right.
			</p>

%		}

		<h3>Circuits You Can Join</h3>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr class="liblrow">

				<th>
					Circuit
				</th>

				<th class="smaller">
					State
				</th>

				<th class="smaller" colspan="2">
					Click to join:
				</td>

			</tr>

%		foreach my $circuit (sort {$a->name cmp $b->name} Tab::Circuit->search( active => 1 )) {  

%			next if $circuit->diocese_based;
%			next if $circuit_member{$circuit->id};

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>			

				<td class="smaller">
					<% $circuit->name %>
				</td>

				<td class="smallctr">
					<% $circuit->state %>
				</td>

				<td class="smaller">
%					if ($circuit->tourn_only) { 
						<a class="whiteblock" href="circuit_join.mhtml?type=to&circuit_id=<% $circuit->id %>&chapter_id=<% $chapter->id %>">
							Tournaments Only
						</a>
%					}
				</td>

				<td class="smaller">
%					if ($circuit->full_members) { 
						<a class="whiteblock" href="circuit_join.mhtml?type=full&circuit_id=<% $circuit->id %>&chapter_id=<% $chapter->id %>">
							Join Circuit
						</a>
%					} 
				</td>

			</tr>

%		}

		</table>

	</div>

	<div class="right small"> 

		<& /user/menu.mas, chapter => $chapter, account => $account &> 

	</div>

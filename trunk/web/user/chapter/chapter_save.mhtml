<%args> 
	$chapter_id => undef
	$name => undef
	$state => undef
	$new => undef
	$account
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	$state = uc($state);

    unless ($name) {
        $m->print("<p>You must enter a school name</p>");
        $m->abort();
    }

    unless ($state) {
        $m->print("<p>You must enter a two-letter state code</p>");
        $m->abort();
    }

	# just prevent headaches with latex later
	$name =~ s/&/and/g;

	if ($chapter_id) { 

		$chapter->name($name);
		$chapter->state($state);
		$chapter->update;	

	} else {

		$chapter = Tab::Chapter->create({ 
			name => $name,
			state => $state
		});

		my $chapter_access = Tab::ChapterAccess->create({
			chapter => $chapter->id,
			account => $account->id
		})




	}

	$m->redirect("$Tab::url_prefix/user/chapter/chapter_welcome.mhtml?chapter_id=".$chapter->id."&new=$new") if $new;

	$m->redirect("$Tab::url_prefix/user/chapter/settings.mhtml?chapter_id=".$chapter->id);
		
</%init>

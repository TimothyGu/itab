<%args>
	$entry_id => undef
	$judge_id => undef
	$position => undef
</%args>
<%init>

	Tab::debuglog("Yo $entry_id $judge_id $position");

	return unless $entry_id && $judge_id && $position;
	$position++;

	my @judges = Tab::Judge->search_same_group($judge_id);
	my %judge_by_id = ()
	foreach my $judge (@judges) { 
		$judge_by_id{$judge->id} = $judge;
	}

	my @ratings = Tab::Rating->search( entry => $entry_id, type => "entry")
	
	foreach my $rating (@ratings) {
		next unless $rating->judge->id == $judge_id;
		$rating->ordinal($position);
		$rating->update;
	}

	@ratings = sort {$a->ordinal <=> $b->ordinal} @ratings;

	my %rating_by_judge = ();
	my %judges_at_rating = ();

	my $total_rounds;
	my $rounds_before;

	$total_rounds = scalar @judges unless $total_rounds;
	my $count;

	RATING:
	foreach my $rating (@ratings) { 

		$count++;
	
		my $judge = $judge_by_id{$rating->judge->id};
		my $percentile = ( ($rounds_before + 1) / $total_rounds) * 100;
	
		$rounds_before += $judge->obligation;
		$rounds_before += $judge->hired;

		my $rating = $rating_by_judge{$judge->id};

		$rating->ordinal($count);
		$rating->percentile($percentile);
		$rating->update;

	}

</%init>


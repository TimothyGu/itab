<%args>
	$school
	$group_id => undef 
	$entry_id => undef
	$prefs => undef
	$account
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id) if $group_id;
	my $tourn = $school->tourn;
	my %ratings_by_judge = ();
	my %conflicts_by_id = ();

	use POSIX;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $strike_end = $group->setting("strike_end");
	my $now = DateTime->now;
	my $read_only++ if $strike_end < $now;

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;
	$group = $entry->event->judge_group unless $group;

	my $switch;
	
	my %total_by_tier = ();

    my %rating_name = (); 
    foreach my $tier ($group->rating_tiers) { 
        $rating_name{$tier->id} = $tier->name;
    }   
    my %coach_rating_by_judge = (); 
    foreach my $rating ($m->comp("/funclib/group_ratings.mas", group => $group, type => "coach")) { 
        $coach_rating_by_judge{$rating->judge->id} = $rating_name{$rating->rating_tier->id};
    }   

	my @judges = Tab::Judge->search( judge_group => $group->id, active => 1 );

	my $has_max;
	my $has_min;

</%init>


	<div class="left huge">

%		unless ($prefs) {
			<h2><% $school->short_name %> at the <% $tourn->name %></h2>
			<& /user/enter/menubar.mas, school => $school, whoami => "ratings" &>
%		}

%		unless ($entry) { 

			<h3>Judge Ratings in <% $group->name %> </h3>
			<p>Choose a competitor to continue</p>

%		} else { 

<%perl>
			my @tiers = Tab::RatingTier->search( 	judge_group => $group->id, type => "mpj" );
			@tiers = sort {$a->name cmp $b->name} @tiers;

			my %tiername_by_id = ();

			foreach (@tiers) { 
				$tiername_by_id{$_->id} = $_->name; 
				$has_max++ if $_->max;
				$has_min++ if $_->min;
			}

			@judges = Tab::Judge->search( judge_group => $group->id, active => 1 );

			@judges = sort {$a->last cmp $b->last} @judges;
			@judges = sort {$a->school->short_name cmp $b->school->short_name} @judges;

			my @conflicts = $m->comp("/funclib/entry_conflicts.mas", entry => $entry);
			my @school_conflicts = $m->comp("/funclib/school_conflicts.mas", school => $school);

			foreach (@conflicts, @school_conflicts) { $conflicts_by_id{$_->judge->id} = $_; }

			my @ratings = Tab::Rating->search( entry => $entry->id, type => "entry");

			foreach my $rating (@ratings) {
				$ratings_by_judge{$rating->judge->id} = $rating->rating_tier->id;
			}

			@judges = sort { $tiername_by_id{$ratings_by_judge{$a}} cmp $tiername_by_id{$ratings_by_judge{$b}} } @judges;


</%perl>
		
			<& /funclib/tablesorter.mas, table => "tiers", hover => "yes" &>

			<h4>Rate <% $group->abbr %> Judges for <% $entry->name %></h4>

%			if ($read_only) { 
				<p class="explain">Pref deadline was <% Tab::nicedt($strike_end) %> (Timezone: <% $tz %>).  
%			} 

			<div class="noscroll">

%			unless ($read_only) { 
				<form action="tiered_prefs_save.mhtml" method="post">
				<input type="hidden" name="entry_id" value="<% $entry->id %>">
				<input type="hidden" name="school_id" value="<% $entry->school->id %>">
				<input type="hidden" name="group_id" value="<% $group->id %>">
%			} 

			<table cellpadding="5" cellspacing="1" width="100%" class="hoverme" id="tiers">

				<thead>

				<tr class="yellowrow">

					<th>
						First
					</th>
					<th>
						Last
					</th>

					<th>
						School
					</th>

%					if ($group->setting('coach_ratings')) { 
	
						<th class="smaller">
							Ex
						</th>

%					}

					<th>
						Your Rating
					</th>

				</tr>

				</thead>

				<tbody>

%				my $total;
%				my $ratings;

%				foreach my $judge (@judges) { 

%					next if $judge->school->id == $entry->school->id;
%					next if $conflicts_by_id{$judge->id};

%					$total++;

					<tr <% ($switch++ % 2) ? "class=\"oddhover\"" : "class=\"evenhover\""%> >	

						<td class="last smallish padless">
%							if ($judge->account && $judge->account->paradigm) { 
								<a class="white block" href="/index/paradigm.mhtml?account_id=<% $judge->account->id %>" targe="_blank">
%      	                   	} else { 
    	         				<a class="white block" href="http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>" target="_blank">
%                  			}   
								<% $judge->first %>
							</a>
						</td> 

						<td class="last smallish padless">
%							if ($judge->account && $judge->account->paradigm) { 
	                   			<a class="white block" href="/index/paradigm.mhtml?account_id=<% $judge->account->id %>" targe="_blank">
%      	                  	} else { 
    	                 		<a class="white block" href="http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>" target="_blank">
%                          	}   
								<% $judge->last %>
							</a>
						</td>
						
						<td class="smaller padless">
							<span class="medspan nowrap">
							<% ($judge->school && $judge->school->id) ? $judge->school->short_name." ".$judge->school->chapter->state : "Hire "%>
							</span>
						</td>

%						if ($group->setting('coach_ratings')) { 
							<td class="smallish padless">
								<% $coach_rating_by_judge{$judge->id} %>
							</td>
%						}

						<td class="smallish padless">
							<span style="display: none;">
%								foreach my $tier (@tiers) {
									<% $tier->id == $ratings_by_judge{$judge->id} ? $tier->name : "" %>
%								}
							</span>

%							if ($read_only) { 
%								foreach my $tier (@tiers) {
									<% $tier->id == $ratings_by_judge{$judge->id} ? $tier->name : "" %>
%								}  
%							}  else { 

%								foreach my $tier (@tiers) {

%									$ratings++ if $ratings_by_judge{$judge->id};
%									$total_by_tier{$tier->id}++ if ($tier->id == $ratings_by_judge{$judge->id});

									<span style="width: 40px; display: inline-block; border-right: 1px dotted #ccc;">
										<label for="<% $tier->id."_".$judge->id %>" style="display: block">
											<input type="radio" name="<% $judge->id %>" class="<% $tier->id %>"
												<% ($tier->id == $ratings_by_judge{$judge->id}) ? "checked" : "" %> 
												value="<% $tier->id %>" id="<% $tier->id."_".$judge->id %>">
											<% $tier->name %>
										</label>
									</span>
%								}
%							} 

						</td>

					</tr>

%				}

				</tbody>

			</table>

			</div>

%			unless ($read_only) { 
				<span class="block liblrow rightalign">
					<input type="submit" value="Save Ratings">
				</span>
%			}

%		}

	</div>

    <div class="right small">

		<& sidebar.mas, school => $school, whoami => "entry_ratings", group_id => $group->id, entry_id => $entry_id,  nodiv => 1 &>

%		if ($group && $entry) { 

			<div class="sidenote">
<%perl>

	        my @ratable_judges;

    	    foreach my $judge (@judges) {
    	        next if $judge->school->id == $school->id;
    	        next if $conflicts_by_id{$judge->id};
    	        push (@ratable_judges, $judge);
    	    }

			undef($switch);
</%perl>
			<h4>
				Guide
			</h4>

			<span class="smaller halfspan nowrap">
				<% scalar @ratable_judges %> total judges (besides yours)
			</span>

			<table cellpadding="2" cellspacing="1" width="100%">

				<tr class="yellowrow">

					<th class="smaller">
						Tier
					</th>

%					if ($has_max) { 
						<th class="smallctr">
							Max
						</th>
%					}

%					if ($has_min) { 
						<th class="smallctr">
							Min
						</th>
%					}

					<th class="smallctr">
					</th>

				</tr>

%				foreach my $tier (sort {$a->name cmp $b->name} Tab::RatingTier->search( judge_group => $group->id, type => "mpj")) {

					<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	


						<th class="smallctr">
							<% ($tier->strike) ? "Strike" : $tier->name %>
						</td>

%						if ($tier->max) { 
							<td class="smaller" align="center">
								<% ($tier->max > 0 ) ? ceil( $tier->max * scalar @ratable_judges / 100) : "" %>
							</td>
%						}

%						if ($tier->min) { 
							<td class="smaller" align="center">
								<% ($tier->min > 0 ) ? ceil( $tier->min * scalar @ratable_judges / 100) : "" %>
							</td>
%						}

						<td class="smaller" align="center">
							<% $total_by_tier{$tier->id} %>
						</td>
						

					</tr>

%				}

%				unless ($read_only) { 
					<tr class="liblrow">
						<td colspan="4" class="rightalign">
							<input name="only" class="skinny" type="submit" value="Save & Update Ratings">
							</form>
						</td>
					</tr>
%				}

			</table>

%			if ($group->setting("cumulate_mjp")) { 
%			}

%			if ($entry && scalar $school->entries( event => $entry->event->id ) > 1 && not defined $read_only) {

				<p>Clone <% $entry->name %>'s prefs to:</p>

				<span class="grey block rightalign padno">
					<form action="clone.mhtml" method="post">
					<input type="hidden" name="clone_id" value="<% $entry->id %>">
					<input type="hidden" name="school_id" value="<% $entry->school->id %>">

					<select name="entry_id" class="fixedsmall">
%						foreach my $other ($entry->school->entries( event => $entry->event->id )) { 
%							next if $entry->id == $other->id;
%							next if $entry->dropped;
							<option value="<% $other->id %>"><% $other->name %></option>
%						}
					</select>

					<input type="submit" class="thin" value="Go">
					</form>
				</span>

%			}

			</div>

%		}

	</div>

<%args>
	$account
	$judge_id => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	if ($judge && $judge->account->id != $account->id) { 
		my $name = $account->last;
		$m->print("That judge is not you.  Stop messing around, $name");
		$m->abort;
	}

	my @judges = $account->judges unless $judge;
	push (@judges, $judge) if $judge;

	my @panels = $m->comp("/funclib/account_panels.mas", account => $account);
	my @done_panels = $m->comp("/funclib/account_panels.mas", account => $account, done => 1);

	my $switch;
	my $now = DateTime->now;

</%init>

	<& /user/menu.mas, account => $account &>

	<div class="huge left">

%		foreach my $judge (@judges) { 

%		next if $judge->judge_group->tourn->end < $now;

		<h4><% $judge->judge_group->name %> at <% $judge->judge_group->tourn->name %> </h4>

		<table cellpadding="5" cellspacing="1">

%			if ($judge->judge_group->setting("rounds_per")) { 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<td>
						Prelims Obligation:
					</td>
					<td>
						<% $judge->obligation %>
					</td>
	
					<td>
						Hired Rounds
					</td>
					<td>
						<% $judge->hired %>
					</td>
				</tr>
%			}

%			unless  ($judge->judge_group->setting("no_codes")) { 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						Judge Code
					</td>

					<td>
						<% $judge->code %>
					</td>

				</tr>

%			}
%		}

		</table>

%		if (@panels) { 
			<br />
			<h4>Pending Rounds:</h4>
%			undef $switch;
%		}
		
		<table cellpadding="5" cellspacing="1">

%			foreach my $panel (@panels) { 

%				next unless $panel->judge;

%				my $judge = Tab::Judge->retrieve($panel->judge);
%				my $tourn = $judge->judge_group->tourn;
%				my @entries = $m->comp('/funclib/panel_entries.mas', panel => $panel);


				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						<% $panel->round->event->abbr %> <% $panel->round->realname %>
					</td>

					<td class="smallish">
						<% $panel->room ? $panel->room->name : "No Room Listed" %> 
					</td>

					<td class="smallish">
						<% Tab::nicetime($panel->round->timeslot->start->set_time_zone($tourn->tz)) %>
					</td>

					<td class="smallish">
%						foreach my $entry (@entries) { 
							<span class="biggerspan nowrap" style="padding-bottom: 5px">
								<% $entry->side ? $entry->side == 1 ? "Aff" : "Neg" : "" %>
								<% $entry->name %> 
							</span>
							<br />
%						}
					</td>

					<td class="centeralign">
						<a class="dkgreen block" href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">
							ENTER
						</a>
					</td>

				</tr>

%			}

%			if (@done_panels) { 

%				undef $switch;

				<tr>
					<td colspan="6">
						<br />
						<h4>Previously Entered Results:</h4>
					</td>
				</tr>

%				undef $switch;

%			}

%			foreach my $done (@done_panels) { 

%				my $judge = Tab::Judge->retrieve($done->judge) if $done->judge;
%				my @entries = $m->comp('/funclib/panel_entries.mas', panel => $done);

%				my @scores = $m->comp('/funclib/panel_scores.mas', panel => $done, judge => $judge);
%				my %scores_by_recipient =();
%				foreach my $score (@scores) {  push @{$scores_by_recipient{$score->student->id}}, $score if $score->student && $score->student->id; }

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						<% $done->round->event->abbr %> <% $done->round->realname %>
					</td>

					<td class="nowrap" colspan="4">

						<table cellpadding="2" cellspacing="1">

%						foreach my $entry (@entries) { 

							<tr>

								<td class="med nowrap">
									<% $entry->name %>  
								</td>

								<td class="med nowrap">
									<% $entry->side ? $entry->side == 1 ? "Aff" : "Neg" : "" %>
								</td>

								<td class="med nowrap">

%									foreach my $score (@scores) { 
%										next if $score->student > 0;
%										next unless $score->ballot->entry->id == $entry->id;
										<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
										<% $score->tag eq "rank" ? $score->value : "" %>
										<% $score->tag eq "points" ? $score->value : "" %>
%									}

								</td>

%								foreach my $student ($entry->students) { 
%									my @scores = @{$scores_by_recipient{$student->id}} if $student->id && $scores_by_recipient{$student->id};
%									next unless @scores;
								
									<td class="med nowrap">

										<% $student->last %>:

%										my $notfirst;
%										foreach my $score (@scores) { 
											<% $notfirst++ ? "-" : "" %>
											<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
											<% $score->tag eq "rank" ? $score->value : "" %>
											<% $score->tag eq "points" ? $score->value : "" %>
%										}
								
									</td>

%								}

							</tr>

%						}

						</table>

					</td>

				</tr>

%			}

		</table>

		<p class="explain" style="margin-top: 25px;">
			Note: You cannot edit past ballots; you can only view them.  Once
			you have confirmed a ballot, you must contact the tournament
			officials to make changes.
		</p>


	</div>


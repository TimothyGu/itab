<%args>
	$school
	$group_id => undef 
	$comp_id => undef
	$account
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id) if $group_id;
	my $comp = Tab::Comp->retrieve($comp_id) if $comp_id;
	my $tourn = $school->tournament;

	use POSIX;
	my $now = DateTime->now;
	
</%init>

	<h2><% $school->name %> at the <% $tourn->name %></h2>

	<& /user/tourn/entry/menubar.mas, school => $school, whoami => "ratings" &>

    <div id="rightsmall">

		<& sidebar.mas, school => $school, whoami => "comp_ratings", group_id => $group_id &>

%		if ($group) { 

%			if ($comp && scalar $school->comps( event => $comp->event->id ) > 1) {

				<hr />

				<h5 style="font-size: 80%; letter-spacing: 0px;"> Clone another's strikes:</h5>

				<table cellpadding="3" cellspacing="1" width="100%">

					<tr class="evenrow">
						<td>
							<form action="/user/tourn/entry/ratings/clone_strikes.mhtml" method="post">
							<input type="hidden" name="comp_id" value="<% $comp->id %>">
							<input type="hidden" name="school_id" value="<% $comp->school->id %>">

							<select name="clone_id">
%								foreach my $other ($comp->school->comps( event => $comp->event->id )) { 
%									next if $comp->id == $other->id;
%									next if $comp->dropped;
									<option value="<% $other->id %>"><% $other->team_name %></option>
%								}
							</select>
						</td>

						<td class="right">
							<input type="submit" class="skinny" value="  Copy ">
							</form>
						</td>
					</tr>

				</table>

%			}

			<br />

			<h5>Limit: <% $group->comp_strikes %> Strikes </h5>

%		}

	</div>

	<div class="left huge">

%		unless ($comp) { 

			<h3>Judge Strikes in <% $group->name %> </h3>
			<p>Choose a competitor to continue</p>

%		} else { 
			
			<h3>Strikes for <% $comp->team_name %> </h3>

<%perl>

			my @judges = Tab::Judge->search( judge_group => $group->id, active => 1 );
			@judges = sort {$a->last cmp $b->last} @judges;
			@judges = sort {$a->school->name cmp $b->school->name} @judges;

			my @conflicts = $comp->conflicts;
			my %conflicts_by_id = ();
			foreach (@conflicts) { $conflicts_by_id{$_->judge->id} = $_; }
	
			my @strikes = $comp->strikes;
			my %strikes_by_id = ();

			my $bank = $group->comp_strikes;

			foreach (@strikes) { 
				$strikes_by_id{$_->judge->id} = $_; 
				$bank--;
			}

			@judges = sort { $strikes_by_id{$b->id} <=> $strikes_by_id{$a->id} } @judges;

			my $switch;

</%perl>

			<table cellpadding="4" width="100%">

				<tr class="liblrow">

					<th>
						Judge
					</th>
	
					<th>
						School
					</th>

%					if ($group->coach_ratings) { 
						<th>
							Exp
						</th>
%					}

					<th>
						Notes
					</th>

%					if ($group->bins) {
						<th>
							Constraints 
						</th>
%					}

					<th>
						Strike
					</th>

				</tr>

%				foreach my $judge (@judges) {

%					next if $judge->school && $judge->school->id == $comp->school->id;

%					if ($strikes_by_id{$judge->id}) { 
		
						<tr <% ($switch++ % 2) ? "class=\"redrow\"" : "class=\"lirdrow\"" %>>

%					} elsif ($conflicts_by_id{$judge->id}) { 
						
						<tr class="yellowrow">

%					} else { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%					}

					<td>
						<a class="whiteblock" href="http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>" target="_blank">
							<% $judge->first." ".$judge->last %>
						</a>
		
					</td>
				
					<td class="smaller">
						<% ($judge->school->id) ? $judge->school->name.", ".$judge->school->chapter->state : "Hire" %>
					</td>

%					if ($group->coach_ratings) { 
						<td class="smallctr">
							<% $judge->print_ratings %>
						</td>
%					}
				
					<td>
						<% $judge->special %>
					</td>

%					if ($group->bins) {

						<td class="smaller">
%							foreach my $bin ($group->bins) { 
								<% ($bin->strike($judge)) ? "No rounds ".$bin->name : "" %>
%							}
						</td>

%					}

					<td align="center">

%						if ($conflicts_by_id{$judge->id}) { 

							<a class="noblock">Conflict</a>

%						} else { 

							<a class="whiteblock" href="comp_strike_switch.mhtml?school_id=<% $comp->school->id %>&judge_id=<% $judge->id %>&comp_id=<% $comp->id %>">
								<% ($strikes_by_id{$judge->id}) ? "Unstrike" : ($bank > 0) ? "Steee-rike!" : "" %>
							</a>

%						}

					</td>

					</tr>	

%				}	

			</table>

%		}	

	</div>


<%args>
	$school
	$group_id
	$entry_id => undef
	$err => undef
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id);
	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;

	use POSIX;

	my $tourn = $group->tournament;

	my @judges = sort {$a->last cmp $b->last} $group->judges(active => 1);
	@judges = sort {$a->school->name cmp $b->school->name} @judges;

	my @conflicts;
	my @school_conflicts;
	my %conflicts_by_id = ();
	my %school_conflicts_by_id = ();

	if ($entry) { 

		# Get the list of existing strikes.
		@conflicts = $entry->conflicts("only");
		foreach (@conflicts) { $conflicts_by_id{$_->judge->id} = $_; }

		# Get the school specific strikes
		@school_conflicts = $school->conflicts($group);
		foreach (@school_conflicts) { $school_conflicts_by_id{$_->judge->id} = $_; }

	} else { 

		# Get the list of existing strikes.
		@conflicts = $school->conflicts($group);
		foreach (@conflicts) { $conflicts_by_id{$_->judge->id} = $_; }

	}

	my $switch;

</%init>

    <h2><% $school->name %> at the <% $tourn->name %></h2>

    <& /user/tourn/entry/menubar.mas, school => $school, whoami => "ratings" &>

	<div class="right small">

		<& sidebar.mas, school => $school, whoami => "entry_ratings" &>

		<h4><% $group->abbr %> Conflicts</h4>

		<a class="<% ($entry_id) ? "red block" : "chosenblock" %>" href="conflicts.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>">
			School-wide conflicts
		</a>

%		foreach my $entry ($school->group_entries($group)) { 
			<a class="<% ($entry_id == $entry->id) ? "chosenblock" : "blue block" %>" 
				href="conflicts.mhtml?entry_id=<% $entry->id %>&school_id=<% $school->id %>&group_id=<% $group->id %>">
				Conflicts just for <% $entry->team_name %>
			</a>
%		}

		<p style="font-size: 80%; font-style: smaller;">
			Conflicts are for judges who should not judge your program because
			of lack of neutrality, such as alums of your school, former
			coaches, etc.  These are not strikes.
		</p>

	</div>

	<div class="left huge"> 
	
		<h2>Judge Conflicts</h2>

		<p>Click on "No Conflict" or "Conflicted" to change conflict status</p>

		<table cellpadding="5" width="100%">

			<tr class="liblrow">

				<th>
					Judge
				</th>

				<th>
					School
				</th>


				<th>
					Conflict
				</th>

			</tr>

%			foreach my $judge (@judges) {

%				next if $judge->school && $judge->school->id == $school->id;

%				if ($conflicts_by_id{$judge->id}) { 

					<tr <% ($switch++ % 2) ? "class=\"redrow\"" : "class=\"lirdrow\"" %>>

%				} elsif ($school_conflicts_by_id{$judge->id}) { 

					<tr class="yellowrow"> 

%				} else { 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%				}

					<td>
						<% $judge->first." ".$judge->last %>
					</td>
					
					<td>
						<% ($judge->school->id) ? substr ($judge->school->name,0,30).", ".$judge->school->chapter->state : "Tournament Hire" %>
					</td>
					
					<td align="center">

%						if ($entry && $school_conflicts_by_id{$judge->id}) { 

							<a class="noblock"> School Conflict</a>


%						} else { 

							<a class="white block" href="conflict_switch.mhtml?judge_id=<% $judge->id %>&entry_id=<% $entry_id %>&school_id=<% $school->id %>">
								<% ($conflicts_by_id{$judge->id}) ? "Conflicted" : "No Conflict" %>
							</a>

%						} 

					</td>

				</tr>

%			}	

		</table>

	</div>


<%args>
	$email => undef
</%args>
<%init>

	unless ($email) { 

		$m->print("You must enter an email address to get your account password.  Hit back and try again");
		$m->abort;

	}

	use MIME::Lite;

	my @accounts = Tab::Account->search( email => $email );

	my $err;

	unless (@accounts)  {

		$err = "There is no account in the system with that email.  Please be sure you spelled it correctly.";

		$m->redirect("$Tab::url_prefix/user/login/iforgot.mhtml?err=$err");

	}

	my $account = shift @accounts if @accounts;

#	foreach (@accounts) { $_->delete; }

	# Generate a hash against the uid
	my $id = $account->id;

	# Generate a random authentication string to send to the user
	my $key =  $m->comp("/funclib/generate_randomstring.mas", length => 30);

	my $expires = DateTime->now;
	$expires->add(hours => '2');

	$account->change_pass_key($key);
	$account->change_deadline($expires);
	$account->update;
	
	my $url = "$Tab::url_prefix/user/login/confirm.mhtml?id=$id&key=$key";

	my $message_text = "

    Someone, hopefully you, has asked to reset your Tabroom.com password.

    If you would like to reset your password, please click on this link,
    or copy & paste it into your web browser:

    $url

    Once there, you will be able to change your Tabroom.com account
    password.  This link will expire in a couple hours.

    If you have any questions, please let us know.

    -- Tabroom.com
    requests\@tabroom.com

";

	# creating new "base"-object for an email
	my $msg = MIME::Lite->new(
	    From => 'Tabroom.com Password Reset <requests@tabroom.com>',
	    To   => $account->email,
	    Subject => 'Your Tabroom.com Password Reset',
	    Type    => "TEXT",
	    Data    => $message_text
	);

# 	add the graphs:
# 		my $sendfile_ug = "/tmp/usage-graph.png";
# 		my $sendfile_uug = "/tmp/user-usage-graph.png";
# 		my $sendfile_uwug = "/tmp/user-week-usage-graph.png";
# 		my $mime_filetype = "image/png";

#		$msg->attach(
#		    Type     => $mime_filetype,
#		    Encoding => "base64",
#		    Path     => $sendfile_ug,
#		    Filename => "TotalUsage.png"
#		);

	# set type of delivery to smtp (not local delivery as usual)
	MIME::Lite->send('smtp', $Tab::smtp_server, Timeout=>60);
	$msg->send;

</%init>

	<div class="left huge">
	
		<h2>Check your email</h2>
	
		<p>You have been emailed instructions on how to achieve truth,
		enlightenment, and broader awareness of all that is good</p>
	
		<p>Or, you've gotten a method of resetting your password.</p>
	
		<P>Gosh, what a disappointment it'll be if you only end up with the
		latter.</p>
	
	</div>
	
	<div id="rightsmall">

		<a class="chosenblock" href="<% $Tab::url_prefix %>">Return to Home Page</a>
	
	</div>
	

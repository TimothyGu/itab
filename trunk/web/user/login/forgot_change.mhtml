<%args>
	$id => undef
	$key
	$pass1
	$pass2
</%args>
<%init> 

	$m->abort unless $id;

	my $now = DateTime->now();
	my $account = Tab::Account->retrieve($id);

	my $err;

	unless ($account->change_deadline && $account->change_pass_key) { 

		$err = "Either something is wrong with the system, or you're pulling shenanigans.";

	} elsif ($account->change_deadline && $account->change_deadline->epoch < $now->epoch) {

		$err = "That access code has expired.  Please send another email and try again.";

	} elsif ($account->change_pass_key != $key) { 

		$err = "The access key is not valid.  Please send another and try again";

	} elsif ($pass1 ne $pass2) { 

		$err = "The two passwords you listed did not match" 

	}

	$m->redirect("/user/login/forgot.mhtml?err=$err") if $err;

	my $md5_salt = $m->comp("/funclib/generate_randomstring.mas");

	my $passhash = Crypt::PasswdMD5::unix_md5_crypt($pass1,$md5_salt);

	$account->passhash($passhash);

	$account->update;
	
	my $msg = "Your password has been changed.  You may now log in.";

	$m->redirect("/user/login/login.mhtml?username=".$account->email."&msg=$msg");

</%init>


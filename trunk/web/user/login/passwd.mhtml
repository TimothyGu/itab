<%args>
	$oldpass
	$newpass
	$repeatpass
	$account
	$circuit
</%args>
<%init>

	use Crypt::PasswdMD5;
	my $md5_salt = $m->comp("/funclib/generate_randomstring.mas");

	my $err;

	$err = "The two passwords you listed did not match" unless $newpass eq $repeatpass;


    my $db_password = $account->passhash;
    my $verify_password = unix_md5_crypt($oldpass,$db_password);

	$err = "Old password was not correct" unless $db_password eq $verify_password;

	if ($err) { 
		$m->redirect("$Tab::url_prefix/user/login/profile.mhtml?err=$err");
	}

	my $now = DateTime->now;

	my $passhash = unix_md5_crypt($newpass,$md5_salt);
	$account->password_timestamp($now);
	$account->passhash($passhash);
	$account->update;

	Tab::log("PASSWORD CHANGE: Account ID ".$account->id." (".$account->email.") password was changed from IP address ".$ENV{REMOTE_ADDR});
	
	$m->comp("/funclib/ldap_account.mas", account => $account);

	my $msg = "Your password has been changed";

	$m->redirect("$Tab::url_prefix/user/login/profile.mhtml?msg=$msg");


</%init>



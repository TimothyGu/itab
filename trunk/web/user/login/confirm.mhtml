<%args>
	$id
	$key
</%args>
<%init> 

	my $now = DateTime->now();

	my $account = Tab::Account->retrieve($id);

	unless ($account) { 
		$m->redirect("/");
	}

	my $err;

	unless ($account->change_deadline && $account->change_pass_key) { 

		$err = "Either something is wrong with the system, or you're pulling shenanigans.";

	} elsif ($account->change_deadline->epoch < $now->epoch) {

		$err = "That access code has expired.  Please send another email and try again.";

	} elsif ($account->change_pass_key != $key) { 

		$err = "The access key is not valid.  Please send another and try again";

	}

	$m->redirect("$Tab::url_prefix/user/login/iforgot.mhtml?err=$err") if $err;

</%init>

	<div class="left huge">

		<h2>Change <% $account->email %>'s password</h2>

		<center>

		<table cellpadding="8" cellspacing="1" width="75%">

			<tr class="palerow">

				<td>
					Enter a new password:
				</td>

				<td>
					<form action="forgot_change.mhtml" method="post">
					<input type="hidden" name="key" value="<% $key %>">
					<input type="hidden" name="id" value="<% $id %>">
					<input type="password" name="pass1" value="" onfocus='value=""'>
				</td>

			</tr>

			<tr class="palerow">

				<td>
					Repeat the password
				</td>

				<td>
					<input type="password" name="pass2" value="">
				</td>

			</tr>

			<tr class="palerow">

				<td colspan="2" class="right">
					<input type="submit" value="  Save New Password  ">
					</form>
				</td>

			</tr>

		</table>

		</center>

	</div>

	<div class="right small">


	</div>


<%args>
	$account
	$name => undef
	$circuit_id => undef
	$start => undef
	$end => undef
	$reg_start => undef
	$reg_starttime => "05:00 P"
	$reg_end => undef
	$reg_endtime => undef
	$drops => undef
	$dropstime => undef
	$judge => undef
	$judgetime => undef
	$frozen => undef
	$frozentime => undef
	$fines => undef
	$finestime => undef
</%args>
<%init>
	my $return;

	my $circuit = Tab::Circuit->retrieve($circuit_id);

	my $startdt = Tab::dateme($start);
	my $enddt = Tab::dateme($end);

	my $reg_startdt = Tab::dtme($reg_start,$reg_starttime);
	my $reg_enddt = Tab::dtme($reg_end,$reg_endtime);
	my $dropsdt = Tab::dtme($drops,$dropstime) if $drops;
	my $judgedt = Tab::dtme($judge,$judgetime) if $judge;
	my $frozendt = Tab::dtme($frozen,$frozentime) if $frozen;
	my $finesdt = Tab::dtme($fines,$finestime) if $fines;

	unless ($reg_startdt) { 
		$return .= "You must set a date and time for registration to open. ".$reg_start." ".$reg_startdt."<br/>";
		Tab::log($return);
	}

	unless ($reg_enddt) { 
		$return .= "You must set a date and time for registration to close.".$reg_end;
		Tab::log($return);
	}

	if ($return) { 
		$m->redirect("deadlines.mhtml?name=$name&circuit_id=$circuit_id&start=$start&end=$end&fullmsg=$return");
	}

	$dropsdt = $reg_enddt->clone unless $dropsdt;
	$judgedt = $reg_enddt->clone unless $judgedt;
	$frozendt = $reg_enddt->clone unless $frozendt;
	$finesdt = $reg_enddt->clone unless $finesdt;

	my $switch;

</%init>

	<div class="left huge">

		<form action="save.mhtml" method="post">
		<input type="hidden" name="name" value="<% $name %>">
		<input type="hidden" name="circuit_id" value="<% $circuit_id %>">

		<input type="hidden" name="start" value="<% DateTime::Format::MySQL->format_datetime($startdt) %>">
		<input type="hidden" name="end" value="<% DateTime::Format::MySQL->format_datetime($enddt) %>">

		<input type="hidden" name="reg_start" value="<% DateTime::Format::MySQL->format_datetime($reg_startdt) %>">
		<input type="hidden" name="reg_end" value="<% DateTime::Format::MySQL->format_datetime($reg_enddt) %>">

		<input type="hidden" name="frozen" value="<% DateTime::Format::MySQL->format_datetime($frozendt) %>">
		<input type="hidden" name="fines" value="<% DateTime::Format::MySQL->format_datetime($finesdt) %>">
		<input type="hidden" name="judge" value="<% DateTime::Format::MySQL->format_datetime($judgedt) %>">
		<input type="hidden" name="drops" value="<% DateTime::Format::MySQL->format_datetime($dropsdt) %>">

		<h2>Tournament Location & Rules </h2>
	
		<table cellpadding="5" cellspacing="1" width="100%">

			<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %> >

				<th>
					Choose an Existing Location.  This function will auto-import rooms:
				</th>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %> >

				<td class="right">
					<select name="site_id">

						<option value="">------------------------------------</option>

%						foreach my $site (sort {$a->name cmp $b->name} ($circuit->sites)) { 
							<option value="<% $site->id %>">
								<% $site->name %> <% ($site->host) ? "(Host: ".$site->host->first." ".$site->host->last.")" : "" %>
							</option>
%						}

					</select>
				</td>

			</tr>

			<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >
				<th>
					Or enter a new name, if your location isn't listed:
				</th>
			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >
				<td colspan="2" align="right">
					<input type="text" name="location_name" value="" size="35">
				</td>
			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th colspan="2">
					Copy rules & events from a past tournament:
				</th>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >


				<td class="right" colspan="2">

					<select name="copy_tournament_id">

%						my $then = DateTime->now;
%						$then->subtract(years => 2);

%						my @my_tourns = $account->tournaments;
%						my @other_tourns = $circuit->tournaments;
%						my %used_tournaments;

%						@my_tourns = sort {$b->start->epoch <=> $a->start->epoch} @my_tourns;
%						@other_tourns = sort {$b->start->epoch <=> $a->start->epoch} @other_tourns;

						<option value="">------------------------------------</option>
						<option value="">-------Your Past Tournaments:-------</option>

%						foreach my $tourn (@my_tourns) { 
%							next if $tourn->start->epoch < $then->epoch;
							<option value="<% $tourn->id %>">
								<% $tourn->start->year %> <% $tourn->name %>
							</option>
%							$used_tournaments{$tourn->id}++;
%						}

						<option value="">--------Others' Tournaments:--------</option>

%						foreach my $tourn (@other_tourns) { 
%							next if $tourn->start->epoch < $then->epoch;
%							next if $used_tournaments{$tourn->id};
							<option value="<% $tourn->id %>">
								<% $tourn->start->year %> <% $tourn->name %>
							</option>
%						}


					</select>
				</td>

			</tr>


			<tr class="liblrow">

				<td colspan="4" class="right">
					<input class="blue" type="submit" value="  Save Tournament ">
					</form>
				</td>

			</tr>
		
		</table>

	</div>

	<% undef($switch) %>

	<div id="rightsmall">

		<h3>Tournament Info:</h3>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Name:
				</td>

				<td class="smaller"> 
					<% $name %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller">
					Director:
				</th>

				<td class="smaller">
					<% $account->first." ".$account->last %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Start:
				</td>

				<td class="smaller">
					<% $startdt->mdy %>
				</td>

			</tr>
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					to:
				</td>
				
				<td class="smaller">
					<% $enddt->mdy %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Circuit:
				</td>

				<td class="smaller">
					<% $circuit->name %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Registration Opens
				</td>
				
				<td class="smaller">
					<% Tab::niceshortdt($reg_startdt) %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Entries Due
				</td>
				
				<td class="smaller">
					<% Tab::niceshortdt($reg_enddt) %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Judges Due
				</td>
				
				<td class="smaller">
					<% Tab::niceshortdt($judgedt) %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Fees/Burdens Frozen
				</td>
				
				<td class="smaller">
					<% Tab::niceshortdt($frozendt) %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Fines Apply
				</td>
				
				<td class="smaller">
					<% Tab::niceshortdt($finesdt) %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<th class="smaller"> 
					Drops/Names Deadline
				</td>
				
				<td class="smaller">
					<% Tab::niceshortdt($dropsdt) %>
				</td>

			</tr>

		</table>

	</div>


<%args>
	$circuit
	$account
	$email_id => undef;
</%args>
<%init>

	my $email = Tab::Email->retrieve($email_id) if $email_id;

	my $now = DateTime->now;

	my @tourns = $circuit->tourns;

	my $switch;

	my $year = $now->year;
	$year-- if $now->month < 8;
	my $limit_date = $year."-07-01";
	my $limit = DateTime::Format::MySQL->parse_date($limit_date);

</%init>

	<& menu.mas, circuit => $circuit, whoami => "compose", year => $year &>

	<& /funclib/editor.mas &>

	<div class="huge left">

		<h2>Send email</h2>

		<table width="100%" cellpadding="3" cellspacing"1">

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<td width="100%">
				Subject:
			</td>

			<td class="rightalign">
				<form action="email_send.mhtml" method="post"> 
				<input type="hidden" name="circuit_id" value="<% $circuit->id %>">
				<input type="text" name="subject" size="50" value="<% ($email) ? $email->subject : "" %>" >
			</td>

		</tr>

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	
			<td>
				<label for="all">
				Send to all <% $circuit->abbr %> members:
				</label>
			</th>
	
			<td>
				<input id="all" type="checkbox" name="members" value="1">
			</td>
	
		</tr>
	
%		foreach my $tourn (sort {$b->start->epoch <=> $a->start->epoch} @tourns) { 
	
%			next if $tourn->end && $tourn->end->epoch < $limit->epoch;
% 			next if $tourn->reg_start && $tourn->reg_start->epoch > $now->epoch;
	
% 			my $tourn_key = "tourn_".$tourn->id;
	
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	
				<td>
					<label for="<% $tourn->id %>">
					Send to <% $tourn->name %> entrants
					</label>
				</td>
	
				<td>
					<input id="<% $tourn->id %>" type="checkbox" name="<% $tourn_key %>" value="1">
				</td>
	
			</tr>
% 		}
	
	

		<tr>
			<td colspan="2">
				<h4>Email text:</h4>
			</td>
		</tr>

		<tr>
			<td colspan="2" class="centeralign">
				<textarea name="content" cols="55" rows="10"><% ($email) ? $email->content : "" %></textarea>
			</td>
		</tr>

		<tr>
			<td colspan="2" class="rightalign">
				<input type="submit" value="   Send Email   ">
				</form>
			</td>
		</tr>

	</table>

	</div>

<%args>
	$account
	$league
	$tourn
	$name
	$results => undef
</%args>
<%init>

	my @is_admin = Tab::LeagueAdmin->search( account => $account->id, league => $league->id );

	# Allow tournament directors to edit their tournaments and upload results. 
	# This is an ugly hack.  I like it!  Smooches to Janjan.
	push (@is_admin, 1) if $tourn->director->id == $account->id;

	unless ($account->site_admin || @is_admin) { 
		$m->print("
			<h4>Error:</h4><p><b>Only site admins or league officials may edit the website. </b></p>");
		$m->abort;
	}

	my $result_file = Tab::ResultFile->create({  tournament => $tourn->id });

    if ($results) {
        my $req = Apache2::Request->new($r);
        my $upload = $req->upload("results");
        my $filename  = $upload->filename;
        $filename =~ s/.*[\/\\](.*)/$1/;
        $filename =~ s/\ //g;
        $filename =~ s/\'//g;  # '  stupid vim
        my $filepath = "$Tab::file_root/public_site/results/".$league->id."/".$tourn->id."/files/".$result_file->id;
		`rm -f $filepath`;
		`mkdir -p $filepath`;
        my $filetemp = $upload->tempname;
      	`cp $filetemp $filepath/$filename`;

		$result_file->filename($filename);
	}

	$result_file->name($name);
	$result_file->update;

	my $msg = "Result file uploaded";

	$m->comp("publish_index.mas", tourn => $tourn);

	$m->redirect("$Tab::url_prefix/results/publish.mhtml?msg=$msg");

</%init>


<%args>
	$tourn
	$school_id => undef
	$session
	$debug => 1
</%args>

<%init>

	my @schools = sort{$a->chapter->name cmp $b->chapter->name} 
		$tourn->schools unless $school_id;

	push (@schools, Tab::School->retrieve($school_id)) if $school_id;

	$m->comp("prep_ballots.mas", tourn => $tourn);

    $m->comp("sweep_entries.mas", tourn => $tourn, no_prep => 1);

	my %finalists_by_event;
		
	foreach my $event ($m->comp("/funclib/tourn_events.mas", tourn => $tourn)( type => "speech")) { 

		my @finalists = $m->comp(
       		"order_entries.mas",
       		tourn => $tourn,
			basis => "final",
			event => $event,
			no_prep => 1,
			finals_only => "1");

		push (@{$finalists_by_event{$event->id}}, @finalists);

	}

	my $basename = "/tmp/school-reports-school-$school_id-".$session->id if $school_id;
	$basename = "/tmp/school-reports-tourn-".$tourn->id."-".$session->id unless $school_id;
    my $filename = $Tab::file_root."".$basename;
    my $garbage = `rm -f $filename.*`;

    open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";

\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=.7in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}

\\begin{document}
\\small

EOF

my $tabular_row = "\\begin{tabular}{p{.35in}p{.35in}p{1.5in}p{.35in}p{3.25in}p{.5in}}\n";

foreach my $school (@schools) { 

	my %entries_counted = $m->comp("school_count.mas", school => $school, tourn => $tourn);

	my $school_points;


	foreach my $entry ($school->entries) {

	   	$school_points = $school_points + $entry->sweeps_points if $entries_counted{$entry->id};

    }


	print TEXOUT "\\begin{center}\n";

	print TEXOUT "\\begin{tabular}{c}\n";
	print TEXOUT "{\\Large ".&Tab::texify($school->name) ."'s scores at ".&Tab::texify($tourn->name)."} \\\\ \n";
	print TEXOUT "{\\large Total Points: $school_points }\\\\ \n" if $school_points;
	print TEXOUT "\\end{tabular} \n\\newline \n";
	print TEXOUT "\\end{center}\n";

	print TEXOUT $tabular_row;
	print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\]\n";
    print TEXOUT "Code & Event & Name & Pts & Results & Place \\\\ \n";
	print TEXOUT "\\end{tabular} \n\\newline \n";
	print TEXOUT "\\small\n";

	my $switch; 


	COMP:
	foreach my $entry (sort {$a->code <=> $b->code} $school->entries) {

		next if $entry->waitlist == 1|| $entry->dropped == 1;

		my @ballots = Tab::Ballot->search_ordered_by_round($entry->id); 
		next COMP unless @ballots;

		print TEXOUT $tabular_row;
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

		print TEXOUT $entry->code." & ";
		print TEXOUT $entry->event->abbr." & ";

		print TEXOUT Tab::texify($entry->team_name);

		print TEXOUT  "*" if $entry->event->team == 1 && $entry->student->novice;
		print TEXOUT  "*" if $entry->event->team == 2 && ($entry->student->novice || ($entry->partner && $entry->partner->novice));

		print TEXOUT " & ";
		print TEXOUT ($entries_counted{$entry->id}) ? "{\\bf".$entry->sweeps_points."}" : $entry->sweeps_points unless $entry->dropped;
		print TEXOUT "DROP" if $entry->dropped;
		print TEXOUT " & ";

		if ($entry->event->type eq "speech") {

			foreach my $ballot (@ballots) { 

				print TEXOUT $ballot->rank."/".$ballot->points;

				print TEXOUT " \\emph{(".$ballot->real_rank."/".$ballot->real_points.") }" 
					if $ballot->real_rank != $ballot->rank;

				print TEXOUT " ";

			}

		}

		print TEXOUT " & ";

		my $entry_rank;
		my $rank;

		foreach my $finalist (@{$finalists_by_event{$entry->event->id}}) {
			$rank++;
			next if $finalist->id != $entry->id;
			$entry_rank = $rank;
		}	

		print TEXOUT "{\\bf ".$entry_rank if $entry_rank;

		print TEXOUT "st }" if $entry_rank == 1;
		print TEXOUT "nd }" if $entry_rank == 2;
		print TEXOUT "th }" if $entry_rank != 2 && $entry_rank != 1 && $entry_rank > 0;

		print TEXOUT "\\end{tabular} \n\\newline \n";

	}


	print TEXOUT "\\newpage \n" if scalar (@schools) > 1;
}

print TEXOUT "\\end{document}\n";
close TEXOUT;

`cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
`rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;
$m->redirect($Tab::url_prefix."".$basename.".pdf");

</%init>


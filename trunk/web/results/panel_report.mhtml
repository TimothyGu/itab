<%args>
	$account
	$event_id => undef
	$round_name => undef
	$panel_letter => undef
	$tourn
	$circuit
</%args>
<%init>

	my @rounds = Tab::Round->search( event => $event_id, name => $round_name );

	my $round = shift @rounds;

	my @panels = Tab::Panel->search( round => $round->id,
									letter => $panel_letter) if $round;

	my $panel = shift @panels;

</%init>

<h3>Panel report</h3>

<form action="panel_report.mhtml" method="post"> 

<table cellpadding="5" width="100%">

<tr>
	<th>Event:</th>
	
	<td>
		<select name="event_id">
%	foreach my $event (sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_events.mas", tourn => $tourn)(type => "speech")) { 
			<option value="<% $event->id %>" <% ($event->id == $event_id) ? "selected" : "" %>>
				<% $event->name %>
			</option>
%	}
	</td>

	<th>Round:</th>

	<td>
		<select name="round_name">
%		foreach my $roundnum ($tourn->min_round .. $tourn->max_round) { 
			<option value="<% $roundnum %>" <% ($roundnum == $round_name) ? "selected" : "" %>>
			<% $roundnum %>
			</option>
%		}
		</select>
	</td>

	<th>Letter:</th>

	<td>
		<select name="panel_letter">
%		foreach my $panellet ($tourn->min_panel_letter .. $tourn->max_panel_letter) { 
			<option value="<% $panellet %>" 
				<% ($panel_letter eq $panellet) ? "selected" : "" %>>
			<% $panellet %>
			</option>
%		}
		</select>

	</td>

	<td><input  type="submit" value="View Panel"></td>

	</tr>
	</form>

	</table>

<h4></h4>

<% ($panel) ? "" : "<p>No panel found: please search again</p>" %>

% if ($panel) { 

<p>Panel <% $panel->letter %>, 
	Round <% ($panel->round->label) ? $panel->round->label : $panel->round->name %>
	of <% $panel->event->name %>
	<% ($account->site_admin) ? $panel->id : ""%></p>


<table cellpadding="5" width="100%">

%my $switch;


<tr class="bluerow">
	<th>Competitor</th>
%#	<th>School</th>
	<th>Speaks</th>
	<th>Rank in Round</th>

%	my @judges = sort {$a->code <=> $b->code} $panel->judges;

%	foreach my $judge (@judges) { 
	<th>J <% $judge->code %></th>
% 	}	
	<th>Cume</th>
	<th>Recips</th>
</tr>

%	foreach my $comp ($panel->comps) { 
%	$switch++;
	<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

	<th style="text-align: center;">
		(<a href="<% $Tab::url_prefix %>/register/comp_edit.mhtml?comp_id=<% $comp->id %>"><% $comp->code %></a>)
	</td>

%#	<td><% $comp->school->name %> 
%#		<% ($circuit->diocese_based) ? "(". $comp->school->region->code .")" : "" %></td>
	<td><% $switch %></td>

%	my $cume;
%	my $recips;
%	my $first;

<td>

%	foreach my $judge (@judges) { 
		
%		my @ballots = Tab::Ballot->search( 
%						panel => $panel->id,
%						comp => $comp->id,
%						judge => $judge->id);
%		my $ballot = shift @ballots;

		<% (not defined $first) ? $ballot->rankinround : "" %>

%		$first++;
%		$cume = $cume + $ballot->rank;
%		$recips = $recips + (1 / $ballot->rank) if $ballot->rank;

		<td><% $ballot->rank %> 
			<% ($tourn->method->tiebreaks(tiebreaker => "points") ) ? "/ ".$ballot->points : "" %>
			<% ($ballot->rank != $ballot->real_rank) ? "(".$ballot->real_rank.")" : ""%>
		</td>

% 		}

	</td>

	<td><% $cume %></td>
	<td><% $recips %></td>

	</tr>

% 	}

</table>

% }





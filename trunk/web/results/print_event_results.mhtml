<%args>
	$tourn
	$event_id => undef	
	$basis => undef
	$session
	$circuit
	$order => "speaker"
	$debug => undef
</%args>
<%init>

	unless ($basis) { 

		my $err = "You have not selected an ordering basis for that results sheet.  Please choose one of prelim, elims or finals for the ordering of contestants";

		$m->redirect("printouts.mhtml?err=$err");

	}

	use POSIX;

    my $now = DateTime->now;

	my @events = $tourn->events( type => "speech" ) unless $event_id;

	push (@events, Tab::Event->retrieve($event_id)) if $event_id;

	if ($circuit->diocese_based) { 
		push (@events, $tourn->events( type => "congress" )) unless $event_id;
	}

	my $event_abbr = "ALL";
	$event_abbr = $events[0]->abbr if $event_id;

	my $event_name = "All Events";
	$event_name = $events[0]->name if $event_id;

    my $filename = "Results-".$event_abbr."-".$session->id;
    my $filepath = $Tab::file_root."/tmp/";

    system "/bin/rm -rf $filepath"."$filename.*";
    open (TEXOUT, ">>$filepath"."$filename.tex");

    print TEXOUT <<"EOF";

\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=1in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}

EOF
    print TEXOUT "\\fancyhead[RO]{\\LARGE ".&Tab::texify($tourn->name).": ".&Tab::texify($event_name)."}\n";
    print TEXOUT "\\fancyfoot[L]{\\footnotesize Printed by Tabroom.com at ".Tab::niceshortdt($now)."}\n";

    print TEXOUT <<"EOF";

\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.2}

\\setlength{\\headsep}{0.10in}      

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}
\\addtolength{\\voffset}{-.2in}

\\begin{document}

EOF
	
    close TEXOUT;

	foreach my $event (sort {$a->name cmp $b->name} @events) {

		$m->comp("speech/print_prelims_ordered.mas", event => $event, filepath => $filepath, filename => $filename)
			if $event->type eq "speech" && $basis eq "prelim";

		$m->comp("speech/print_prelims_by_code.mas", event => $event, filepath => $filepath, filename => $filename)
			if $event->type eq "speech" && $basis eq "prelim_only";

		$m->comp("print_speech_results.mas", 
					event => $event, 
					filepath => $filepath, 
					filename => $filename, 
					order => $order,
					basis => $basis) 
			if $event->type eq "speech" && $basis ne "prelim" && $basis ne "prelim_only";

		if ($event->type eq "congress") { 

			$m->comp("print_congress_results.mas", 
					event => $event, 
					filename => $filename, 
					filepath => $filepath, 
					order => $order,
					basis => $basis);

		}

	}

	open (TEXOUT, ">>$filepath"."$filename.tex");
    print TEXOUT "\\end{document}\n";
    close TEXOUT;

    `cd $filepath; $Tab::latex_path $filename.tex;`;
    `cd $filepath; $Tab::latex_path $filename.tex;`;
    `cd $filepath; $Tab::dvipdfm_path $filename.dvi;`;
#	system "cd $filepath; /bin/rm -rf $filename.tex $filename.log $filename.dvi $filename.aux" unless $debug;
    $m->redirect("$Tab::url_prefix/tmp/$filename.pdf");


</%init>

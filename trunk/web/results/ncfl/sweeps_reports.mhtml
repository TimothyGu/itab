<%args>
	$tourn
	$session
	$event_id
</%args>
<%init>

	my @events;

	if ($event_id eq "all") { 
	
		@events = sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_events.mas", tourn => $tourn);
		@events = sort {$a->type cmp $b->type} $m->comp("/funclib/tourn_events.mas", tourn => $tourn);

	} else { 

		push (@events, Tab::Event->retrieve($event_id));

	}

    my $filename = "CompetitorSweeps-$event_id-".$tourn->id."-".$session->id;
    my $filepath = $Tab::file_root."/tmp/".$filename;
	my $garbage = `rm -f $filepath.*`;

    $m->comp("/results/prep_ballots.mas", tourn => $tourn);

	open (CSV, ">$filepath.csv");

	print CSV "\"Code\",\"Name\",\"School\",\"Diocese Code\",\"Speech Ranks\",\"Debate Wins\",\"Debate Losses\",\"Sweeps Points\"\n";

	close CSV;

	foreach my $event (@events) { 
		$m->comp( "csv_event_sweeps.mhtml",  event => $event, filepath => $filepath );
	}

    $m->redirect("$Tab::url_prefix/tmp/$filename.csv");

</%init> 


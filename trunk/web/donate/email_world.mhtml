<%args>


</%args>
<%init>

	use Apache2::Connection;

	my $account = Tab::Account->retrieve(1);

	my $c = $r->connection;
	my $remote_ip = $c->remote_ip();

	unless ($remote_ip == "65.47.146.14") {
		$m->print("No.  Piss off & go away");
		$m->abort;
	}

	my $start_date = DateTime->new( 
		year 	=> 2010,
		month 	=> 07,
		day 	=> 01,
		hour	=> 00,
		minute 	=> 00,
		second 	=> 00
	);

	my @tournaments = Tab::Tournament->search_where({ 
		start => { '>',  DateTime::Format::MySQL->format_datetime($start_date) },
	});

	my @leagues = Tab::League->retrieve_all;

	my @directors;

	foreach my $tourn (@tournaments) { 
		push (@directors, $tourn->director);
	}

	foreach my $league (@leagues) { 
		push (@directors, $league->admins);
	}

    my %seen = ();
	@directors = grep { ! $seen{$_->id} ++ } @directors;
	
	my $from = "Chris Palmer <donate\@tabroom.com>";
	my $subject = "Please support Tabroom.com's new server";

	my $body = '				https://www.tabroom.com/donate 

Greetings folks --

You are getting this email because you hosted (or at least tinkered around with) a tournament on Tabroom.com in the past school year. 

First, you may or may not know that I have an email list that I use to announce changes; about once every month or so.  If you are interested in subscribing, do so here: 

http://www.tabroom.com/mailman/listinfo/tabroom-users

Second, tabroom.com needs a new server, and I\'d like to ask the community to contribute towards the new one.

I offer tabroom.com free as a service to the forensics community.  The machine it\'s hosted on is around 5 years old, and the increased traffic of Tabroom.com is starting to overwhelm it. Tabroom.com hosted 642 tournaments in 2010-11, up from 309 the year before.  Buying a new server out of pocket is a bit further than I can afford to provide this service to debate, on top of the time & energy it takes. 

So I\'m asking you to help!  A contribution of $10-25 for a lone tournament or $100 for a state league should get me the $2000-2500 Tabroom.com needs. I\'ll refund any contributions over the needed amount. And if you\'ve given me money gifts in the past year as thanks, know that I\'ve already put it into the fund, so you shouldn\'t double-donate.

If you can pitch in, go to https://www.tabroom.com/donate for more information.  Thank you!

-Chris Palmer
';

	foreach my $director (@directors) { 
		next if ($director->id == 1107 || $director->id == 1240);
#		$m->print($director->first." ".$director->last." ".$director->email." <br />");
		$m->comp( "/funclib/send_email.mas", from => $account, to => $director, subject => $subject, body => $body );

	}

    use Text::Wrap;
    $Text::Wrap::columns = 72;
    $body =  wrap('', '', $body);

</%init>

	<pre>
		<% $body %>
	</pre>

<%args>
	$site_id
</%args>
<%init>

	Tab::Room->set_sql( duped_rooms => "
		select distinct room.*
		from room, room as second
		where room.name = second.name
		and room.site = ? 
		and room.site = second.site
		and room.id != second.id
		order by room.name, room.id");

	my @dupes = Tab::Room->search_duped_rooms($site_id);

	my %dupes_by_name = ();

	foreach my $dupe (@dupes) { 
		push (@{$dupes_by_name{$dupe->name}}, $dupe);
	}

	Tab::Room->set_sql(panel_dupe => "update panel set room = ? where room = ?");
	Tab::Room->set_sql(strike_dupe => "update room_strike set room = ? where room = ?");
	Tab::Room->set_sql(pool_dupe => "update room_pool set room = ? where room = ?");

	foreach my $name (keys %dupes_by_name) { 

		my @rooms = (@{$dupes_by_name{$name}});
		next unless @rooms;

		my $master = shift @rooms;
		next unless @rooms;

		foreach my $other (@rooms) { 
			Tab::Room->sql_panel_dupe->execute($master->id, $other->id);
			Tab::Room->sql_strike_dupe->execute($master->id, $other->id);
			Tab::Room->sql_pool_dupe->execute($master->id, $other->id);

			$other->delete;
		}

	}

</%init>

	<p>Dupes removed.  Or you just blew up the database.  Your funeral</p>


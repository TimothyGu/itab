<%args>
	$account
	$circuit_id => undef
	$name
	$short_name
	$state => undef
	$active => undef
	$url
	$timezone 
	$hosted_site => undef
	$full_members => 0
	$tourn_only => 0
	$public_email => undef	
	$apda_seeds => undef	
	$track_bids => undef
	$region_based => undef
	$diocese_based => undef
</%args>
<%init>

	my $err;

	# Check if the user is a site admin or is an admin of that circuit. 

	my @circuit_access = Tab::CircuitAdmin->search( circuit => $circuit_id, account => $account->id) if $circuit_id;

	unless ($account->site_admin || @circuit_access) { 

		$err = "Only site admins or circuit administrators may make changes to circuits";
		$m->redirect("$Tab::url_prefix/accounts/index.mhtml?err=$err");

	}

	#Save new information if it is a circuit that exists

	if ($circuit_id) { 

		my $circuit = Tab::Circuit->retrieve($circuit_id);

		$circuit->name($name);
		$circuit->short_name($short_name);
		$circuit->state($state);
		$circuit->active($active);
		$circuit->approved($active);
		$circuit->url($url);
		$circuit->hosted_site($hosted_site);
		$circuit->full_members($full_members);
		$circuit->tourn_only($tourn_only);
		$tourn->tz($timezone);
		$circuit->public_email($public_email);
		$circuit->apda_seeds($apda_seeds);
		$circuit->track_bids($track_bids);
		$tourn->setting("regions")($region_based);
		$tourn->setting("ncfl")($diocese_based);
		$circuit->update;

		$err = "Circuit information has been updated";
		$m->redirect("$Tab::url_prefix/circuit/circuit_view.mhtml?circuit_id=$circuit_id&err=$err");

	} else {   # Create a new circuit. 

		my $circuit = Tab::Circuit->create({
			name => $name,
			short_name => $short_name,
			url => $url,
			approved => '1',
			hosted_site => $hosted_site,
			full_members => $full_members,
			tourn_only => $tourn_only,
			timezone => $timezone,
			public_email => $public_email,
			apda_seeds => $apda_seeds,
			track_bids => $track_bids,
			region_based => $region_based,
			diocese_based => $diocese_based
		});

		$circuit_id = $circuit->id;

		$err = "Circuit $name has been created";
		$m->redirect("$Tab::url_prefix/circuit/circuit_view.mhtml?circuit_id=$circuit_id&err=$err");


	}  # end of if circuit_id


</%init>



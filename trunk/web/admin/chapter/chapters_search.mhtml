<%args>
	$account	
	$search_value => undef
	$circuit_id => undef
	$err => undef
	$sort_by => "name"
</%args>
<%init>

	my $circuit = Tab::Circuit->retrieve($circuit_id) if $circuit_id;

	my @chapters;

	my $search = "%".$search_value."%";
	@chapters = Tab::Chapter->search_like( name => $search) unless $circuit;
	@chapters = Tab::Chapter->search_circuit_and_name( $circuit_id, $search ) if $circuit;

    #uniq
    my %seen = ();
    @chapters = grep { ! $seen{$_->id} ++ } @chapters;

	@chapters = sort {$a->id <=> $b->id} @chapters;
	@chapters = sort {$a->name cmp $b->name} @chapters;

	if ($sort_by eq "state") { 
		@chapters = sort {$a->state cmp $b->state} @chapters;
	}

</%init>

%	if ($circuit) { 

		<& "display_circuit.mas", chapters => \@chapters, circuit => $circuit, search_value => $search_value, sort_by => $sort_by &>

%	} else { 

		<& "display_name.mas", chapters => \@chapters, search_value => $search_value &>
%	}

	<& chapter_menu.mas &>

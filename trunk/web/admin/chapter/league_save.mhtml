<%args>
	$chapter_id
	$account
	$session
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);
	
	my $err;

	LEAGUE:
	foreach my $league (Tab::League->retrieve_all) { 

		my $cl = $chapter->league_membership($league);

		unless ($cl) { 

			next LEAGUE unless $league->create_own_account;
			next LEAGUE unless $ARGS{$league->id."_active"};
			
			$cl = Tab::ChapterLeague->create({
				league => $league->id,
				chapter => $chapter->id
			});

			$err .= " <br />You joined the ".$league->name;

		}

		$cl->region($ARGS{$league->id."_region"});
		$cl->active($ARGS{$league->id."_active"});
		$cl->full_member($ARGS{$league->id."_full_member"});
		$cl->membership($ARGS{$league->id."_membership"});
		$cl->update;

		if ($league->region_based) { 
			$err .= " <br />WARNING:  You must choose a region to join the ".$league->short_name unless $ARGS{$league->id."_region"};
		}

		if ($league->memberships) { 
			$err .= " <br />WARNING:  You must choose a membership type to join the ".$league->short_name unless $ARGS{$league->id."_membership"};
		}

	}

	$err .= " <br />League memberships updated.";

	$m->redirect("/admin/chapter/leagues.mhtml?chapter_id=".$chapter->id."&err=$err");

</%init>

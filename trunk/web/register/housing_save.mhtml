<%args>
	$comp_id
	$tourn
</%args>
<%perl>

	my $comp = Tab::Entry->retrieve($comp_id);
	my $now = DateTime->now();
	
	foreach my $student ($comp->members) { 

		my $gender = $ARGS{"gender_".$student->id};
		$student->gender($gender);
		$student->update;

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $day_before = $days[0]->clone;
   	$day_before->subtract( days => 1);
   	push (@days, $day_before);

   	foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

			my $request = $ARGS{"request_".$student->id."_".$day->ymd};
			my $waitlist = $ARGS{"waitlist_".$student->id."_".$day->ymd};

			my $existing_req = $student->housing($tourn, $day);

			if ($request) {
		
				$existing_req = Tab::Housing->create({
					tournament => $tourn->id,
					student => $student->id,
					type => "student",
					requested => $now,
					night => $day
				}) unless $existing_req;

				$existing_req->waitlist($waitlist);
				$existing_req->update;

			} else { 

				$existing_req->delete if $existing_req;

			}
		}
	}

	$m->redirect("$Tab::url_prefix/register/entry/edit.mhtml?comp_id=$comp_id");


</%perl>

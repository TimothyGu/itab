<%args>
	$tourn
</%args>
<%init>

	Tab::Judge->set_sql( preffed_by_school => "
		select distinct judge.*
		from judge, rating, entry
		where judge.id = rating.judge
		and rating.entry =  entry.id
		and entry.school = ? 
	");

	my @pref_groups;

	my %group_schools = ();

	foreach my $group ($tourn->groups) { 
		if ($group->setting('prefs')) { 
			push (@pref_groups, $group);
		}
	}


</%init>

	<& "menu.mas", tourn => $tourn, whoami => "prefs" &>

	<div class="left huge">

		<& /funclib/tablesorter.mas, table => "sortme" &>

		<h2>Pref status</h2>

		<table cellpadding="4" cellspacing="1" id="sortme">

			<thead>

				<tr class="yellowrow">

					<th class="smaller" colspan="2">
						Entry
					</th>

					<th class="smaller">
						School
					</th>

					<th class="smaller">
						Tot
					</th>

					<th class="smaller">
						Pref
					</th>

					<th class="smaller">
						Cnfl
					</th>

					<th class="smaller">
						Left
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $group (@pref_groups) { 

%					my @judges = $group->judges( active => 1);

%					foreach my $event ($group->events) { 

%						foreach my $entry (sort {$a->name cmp $b->name} $event->entries( dropped => 0, waitlist => 0, unconfirmed => 0)) { 

%							my @rated = $m->comp("/funclib/judge_entry_rating.mas", entry => $entry, type => "rated");
%							my @conflicts = $m->comp("/funclib/judge_entry_rating.mas", entry => $entry, type => "conflicted");

%							my %used;
%							foreach my $conf (@conflicts) {
%								$used{$conf->id}++;
%							}
%							my @real_rated;

%							foreach my $rate (@rated) {
%								push @real_rated, $rate unless $used{$rate->id};
%							}

%							my $left = scalar @judges - (scalar @conflicts + scalar @real_rated);

							<tr <% $left > 0 ? 'class="lirdrow"' : "" %>>

								<td class="smallish">
									<a class="plain padno block" href="/register/entry/prefs.mhtml?entry_id=<% $entry->id %>">
										<% $entry->code %>
									</a>
								</td>

								<td class="smallish medspan">
									<a class="padno plain block" href="/register/entry/prefs.mhtml?entry_id=<% $entry->id %>">
										<% $entry->name %>
									</a>
								</td>
									
								<td class="smallish medpsan">
									<% $entry->school->short_name %>
								</td>

								<td class="centeralign smallish">
									<% scalar @judges %>
								</td>

								<td class="centeralign smallish">
									<% scalar @real_rated %>
								</td>

								<td class="centeralign smallish">
									<% scalar @conflicts %>
								</td>

								<td class="centeralign smallish">
									<% scalar @judges - (scalar @conflicts + scalar @real_rated) %>
								</td>

							</tr>

%						} 
%					}

%				}

			</tbody>

		</table>

	</div>


<%args>
	$tourn
	$account
	$session
</%args>
<%init>

	my $filename = "Judges-".$tourn->name."-".$session->id;


    my $tz = $tourn->tz;
    $tz = "UTC" unless $tz;
    my $now = DateTime->now->set_time_zone($tz);

	$filename =~ s/[\W_]//g;
	my $filepath = $Tab::file_root."/tmp/".$filename;
	my $garbage = `rm -f $filepath.*`;

	my $ncfl++ if $tourn->setting("ncfl");

	open (CSVOUT, ">$filepath.csv");

	print CSVOUT "DioCode,Diocese," if $ncfl;
	print CSVOUT "School,";
	print CSVOUT "SchoolCode," unless $ncfl;
	print CSVOUT "Judge Code,";
	print CSVOUT "First Name,";
	print CSVOUT "Last Name\n";

	my @judges = $m->comp("/funclib/tourn_judges.mas", tourn => $tourn, code => 1) unless $ncfl;
	@judges = $m->comp("/funclib/tourn_judges.mas", tourn => $tourn, by_region => 1) if $ncfl;

	my @regions = $m->comp("/funclib/tourn_regions.mas", tourn => $tourn);

	my %dio_codes = map {$_->id => $_->code} @regions;
	my %dio_names = map {$_->id => $_->name} @regions;

	my @schools = $tourn->schools;
	my %school_region = map {$_->id => $_->region->id} @schools;
	my %school_name = map {$_->id => $_->name} @schools;
	my %school_code = map {$_->id => $_->name} @schools unless $ncfl;

	foreach my $judge (@judges) { 

		print CSVOUT '"';

		if ($ncfl) { 
			print CSVOUT $dio_codes{$school_region{$judge->school->id}}.'","';
			print CSVOUT $dio_names{$school_region{$judge->school->id}}.'","';
		}

		print CSVOUT $school_name{$judge->school->id}.'","';
		print CSVOUT $school_code{$judge->school->id}.'","' unless $ncfl;

		print CSVOUT $judge->code.'","';
		print CSVOUT $judge->first.'","';
		print CSVOUT $judge->last.'"'."\n";

	}

	close CSVOUT;

	$m->redirect("$Tab::url_prefix/tmp/$filename.csv");

</%init>

<div id="content">

<p><% $filename %></p>

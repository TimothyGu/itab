<%args>
	$id
	$value
</%args>
<%flags>
	inherit => undef
</%flags>
<%init>

	my $err;

	my $entry = Tab::Entry->retrieve($id);

	my $code_setting = $entry->event->setting("code_style");

	if ($value && $value ne $entry->code) { 

		my @existing;

		if ($code_setting eq "school_number" || $code_setting eq "initials" || $code_setting eq "register" ) {
		
			@existing = Tab::Entry->search( code => $value, school => $entry->school->id );

		} else { 

			@existing = Tab::Entry->search( code => $value, tourn => $entry->tourn->id );

		}
	
		if (@existing) { 
	
			my $err = "An entry with speaker code $value already exists";
			$m->print('<script type="text/javascript" language="javascript"> $(document).ready(function() { $.jGrowl("'.$err.'", { header: "Nope", life: 8000, theme: "warning", position: "top-left", sticky: true });}); </script>');

			$m->print($entry->code);
		
		} else { 
	
			$entry->code($value);
			$entry->update;

			my $msg = "Code changed to $value";
			$m->print('<script type="text/javascript" language="javascript"> $(document).ready(function() { $.jGrowl("'.$msg.'", { header: "All set", life: 4000  }); }); </script>');
			$m->print($value);
	
		}

	}

	return;

		
</%init>

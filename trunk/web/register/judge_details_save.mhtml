<%args>
	$judge_id
	$school_id
	$cellphone => undef
	$alt_id => undef
	$paradigm => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);
	my $group = $judge->judge_group;
	my $tourn = $group->tournament;

	my $school = Tab::School->retrieve($school_id);

	my $msg;

	if ($group->coach_ratings) { 

		my $missing_rating;
		my $done;

		foreach my $subset ($group->qual_subsets) { 

			$done++;

			my $qual_id = $ARGS{$subset->id};
			my $qual = Tab::Qual->retrieve($qual_id);

			$missing_rating++ unless $qual;
			next unless $qual;

			my $jr = $judge->rating($subset); 

			if ($jr) { 

				$jr->qual($qual->id);
				$jr->update;

			} else { 

				$jr = Tab::Rating->create({
                    tournament => $tourn->id,
                    judge => $judge_id,
                    subset => $subset->id,
                    qual => $qual->id,
					type => "coach"
                });

			}

		}

		unless ($done) { 

			my $qual_id = $ARGS{"qual"};
			my $qual = Tab::Qual->retrieve($qual_id);

			$missing_rating++ unless $qual;
			next unless $qual;

			my $jr = $judge->rating; 

			if ($jr) { 

				$jr->qual($qual->id);
				$jr->update;

			} else { 

				$jr = Tab::Rating->create({
                    tournament => $tourn->id,
                    judge => $judge_id,
                    qual => $qual->id,
					type => "coach"
                });

			}

		}

		if ($missing_rating) { 

			my $err = "You must rate the judge in every category";
			$m->redirect("judge_details.mhtml?school_id=$school_id&judge_id=$judge_id&err=$err");

		}

	}

	$judge->cell($cellphone);
	$judge->update;

	my $uber = $judge->uber;
	$uber->cell($cellphone);
	$uber->update;

	$msg = "Judge ".$judge->first." ".$judge->last." entered";

	$m->redirect("school_judges.mhtml?school_id=$school_id&group_id=".$group->id."&msg=$msg");

</%init>


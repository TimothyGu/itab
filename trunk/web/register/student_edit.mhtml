<%args>
	$circuit
	$student_id => undef
	$tourn
	$event_id => undef
	$comp_id => undef
	$school_id => undef
	$err => undef
</%args>
<%init>

#	if ($circuit->diocese_based && $comp_id) {
#		$m->redirect("$Tab::url_prefix/register/diocese_entry_edit.mhtml?comp_id=$comp_id");
#	}

	my $student = Tab::Student->retrieve($student_id);

	#Find the chapter either passed to me, or given as part of the student.
	#Barf if we don't have one.

	my $school = Tab::School->retrieve($school_id) if $school_id;
	my $event = Tab::School->retrieve($event_id) if $event_id;
	my $chapter = $school->chapter if $school;
	$chapter = $student->chapter if $student;

	$school = $chapter->school($tourn) unless $school;

	$m->abort("<p>No school information came across. Please try again</p>") unless $chapter;

	#Default year is this school year, if there isn't one already

	my $now = DateTime->now;
	my $year = $now->year;
	$year++ if $now->month > 6;
	
	
</%init>

%	my $name;


	<div class="left huge">

		<h2>
			<% ($student) ? "Edit ".$student->first." ".$student->last : "Create Student in ". $name %>
		</h2> 

		<table cellpadding="7" width="100%" border="0">

%			my $switch;
	
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
				<th>
					First Name:
					<form action="student_save.mhtml" method="post"> 
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<input type="hidden" name="student_id" value="<% $student_id %>">
					<input type="hidden" name="event_id" value="<% $event_id %>">
					<input type="hidden" name="comp_id" value="<% $comp_id %>">
				</th>

				<td>
					<input type="text" name="first" value="<% ($student) ? $student->first : "" %>">
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Last Name:
				</th>

				<td>
					<input type="text" name="last" value="<% ($student) ? $student->last : "" %>">
				</td>
				
			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
				<th>
					Phonetic:
				</th>
				
				<td>
					<input type="text" name="phonetic" value="<% ($student) ? $student->phonetic : "" %>">
				</td>
				
			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Graduation Year:
				</th> 
				
				<td>
					<input type="text" name="grad_year" value="<% ($student) ? $student->grad_year : $year %>">
				</td> 
				
			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
				<th>
					Novice:
				</th>
				
				<td>
					<input type="checkbox" name="novice" value="1" <% ($student) ? ($student->novice) ? "checked" : "" : "" %> >
				</td>
				
			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
				<th>
					Gender
				</th>
				
				<td>
					<input type="radio" name="gender" value="F" <% ($student) ? ($student->gender eq "F") ? "checked" : "" :""%> >Female
					<input type="radio" name="gender" value="M" <% ($student) ? ($student->gender eq "M") ? "checked" : "" :""%> >Male	
				</td>
			</tr> 
			
			<tr class="liblrow">

				<td align="right" colspan="2">
					<input  type="submit" value="Save Student">
					</form>
				</td>
				
			</tr>

		</table> 

	</div>

	<div class="right small">

%		if ($circuit->diocese_based) { 

			<a class="blue block" href="diocese/entry.mhtml?diocese_id=<% $school->region->id %>">
				Return to <% $school->region->name %>'s Entry
			</a>

%		}

%		if ($school) { 

			<a class="blue block" href="entries.mhtml?school_id=<% $school->id %>">
				Return to <% $school->short_name %>'s Entry
			</a>

%		}

		<h4>Entries</h4>

%			if ($student) { 

%			foreach my $comp ($student->entries($tourn)) { 

				<a class="blue block" href="/register/entry/edit.mhtml?comp_id=<% $comp->id %>">
					View/Edit
					<% $comp->code %> in <% $comp->event->name %>
					<% ($comp->waitlist) ? "Waitlisted" : "" %>
					<% ($comp->dropped) ? "Dropped" : "" %>
				</a>

%			}

		<hr>

		<a class="blue block" href="/register/student_print.mhtml?student_id=<% $student->id %>">
			Print Student Dance Card
		</a>

%		}

%	unless ($circuit->diocese_based) { 

		<h3>Student Record & Bids</h3>

		<table cellpadding="5" width="95%">

%    		my @results = $student->results if $student;
%    		@results = sort {$b->tournament->start->epoch <=> $a->tournament->start->epoch} @results;

%			$switch = 1;

% 			foreach my $result (@results) {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >
				
					<td class="smaller">
						<% substr($result->tournament->name,0,25)." ".$result->tournament->start->year %>
					</td>
					
					<td class="smaller">
						<% $result->event->abbr %>
					</td>
					
					<td class="smaller">
						<% $result->rank %>
					</td>
					
					<td class="smaller">
						<% $result->results_bar %>
					</td>
					
					<td class="smaller">
						<% ($result->bid) ? "Bid" : "" %>
					</td>
			    </tr>

% 			}

		</table>

% 	}




<%args> 
	$session
	$circuit
	$tourn
	$account
</%args>
<%init>

    my @students = $tourn->students;
    my @judges = $tourn->judges;
    my @schools = $tourn->schools;
	my @regions = $tourn->regions;

	my $filename = $Tab::file_root."/tmp/tourn-stats-".$tourn->id."-".$session->id;

	my $now = DateTime->now;	
	$now->set_time_zone($tourn->tz);
	
	my $garbage = `rm -f $filename.*`;
	open (TEXOUT, ">$filename.tex");

	my $texheader = "
			\\documentclass[11pt]{letter}
			\\usepackage{fullpage}
            \\usepackage{colortbl}
			\\usepackage{multirow}
			\\usepackage[hmargin=1in,vmargin=1.25in]{geometry}
			\\usepackage{helvet}
			\\pagestyle{empty}
			\\renewcommand{\\familydefault}{\\sfdefault}
			\\renewcommand{\\arraystretch}{1.5}
			\\begin{document}
			\\addtolength{\\textwidth}{1in}
			\\addtolength{\\voffset}{-.5in}";

	print TEXOUT $texheader;

	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\begin{tabular}{p{1.5in}p{4.75in}} \n  ";
	print TEXOUT "{\\bf Circuit:} & {\\raggedright ".&Tab::texify($circuit->name)."} \\\\ \n ";
	print TEXOUT "{\\bf Tournament:} & ".&Tab::texify(substr($tourn->name,0,30))." \\\\ \n ";
	print TEXOUT "{\\bf Printed:} & ". $now->day_abbr." ".$now->month_name." ".$now->day.", ".$now->year." ".$now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p')."\\\\ \\hline \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{2.5in}p{3.75in}}\n";
	print TEXOUT "\\multicolumn{2}{l}{\\bf Overall Statistics }\\\\ \n";
	print TEXOUT "\\hline \n";

	my $switch;	

	if ($circuit->diocese_based || $circuit->region_based) { 

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT "Total number of Dioceses" if $circuit->diocese_based;
		print TEXOUT "Total number of regions" if $circuit->region_based;
		print TEXOUT " & ". scalar @regions." \\\\ \n";

	}

	print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
	print TEXOUT "Total number of schools & ".scalar @schools." \\\\ \n";
	print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
	print TEXOUT "Total number of students & ".scalar @students." \\\\ \n";
	print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
	print TEXOUT "Total number of judges & ".scalar @judges." \\\\ \n";
	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\medskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{2.5in}p{3.75in}}\n";
	print TEXOUT "\\multicolumn{2}{l}{\\bf Entry numbers by event }\\\\ \n";
	print TEXOUT "\\hline \n";
	foreach my $event ($m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT $event->name." & ".scalar $event->active_entries." \\\\ \n";;
	}
	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\medskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{2.5in}p{3.75in}}\n";
	print TEXOUT "\\multicolumn{2}{l}{\\bf Judge numbers by group }\\\\ \n";
	print TEXOUT "\\hline \n";
	foreach my $group ($tourn->groups) { 
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT $group->name." & ".scalar $group->judges." \\\\ \n";;
	}
	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\medskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{2.5in}p{3.75in}}\n";
	print TEXOUT "\\multicolumn{2}{l}{\\bf Judge numbers by pool }\\\\ \n";
	print TEXOUT "\\hline \n";

	foreach my $pool ($tourn->pools) { 
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT $pool->name." & ".scalar $pool->judges." \\\\ \n";;
	}
	print TEXOUT "\\end{tabular}\n";


	open (TEXOUT, ">>$filename.tex");
	print TEXOUT "\\end{document} \n";
	close TEXOUT;

	$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;

	`rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;

	$m->redirect("$Tab::url_prefix/tmp/tourn-stats-".$tourn->id."-".$session->id.".pdf");

</%init>

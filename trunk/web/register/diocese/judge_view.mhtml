<%args>	
	$tourn
	$diocese_id => undef
	$judge_id => undef
	$group_id => undef
	$elim_group_id => undef
	$account
	$err => undef
</%args>

<%init>
	unless ($judge_id || ($tourn && $diocese_id)) {
		my $err = "You have not input the needed parameters to call that function";
	}

	my $judge;
	my $diocese;
	my $group;

	# Populate the defaults here depending if we have an existing or new judge

	if ($judge_id) {
		$judge = Tab::Judge->retrieve($judge_id); 
		$diocese = $judge->school->region;
		$tourn  = $judge->tournament;
		$group = $judge->judge_group;
	} else { 
		$diocese = Tab::Region->retrieve($diocese_id);
		$group = Tab::JudgeGroup->retrieve($group_id);
	}

	$diocese_id = $diocese->id;

	# Check authorization of user to see this diocese

#    unless ($account->id == $diocese->director->id || $account->email eq 'palmer@massforensics.org') {
#        my $err = "You are not authorized to edit ". $diocese->name ;
#        $m->redirect("$Tab::url_prefix/prereg/dioceses.mhtml?err=$err");
#    }

	# General tournament and diocese info.
	my @chapters = sort {$a->name cmp $b->name} $diocese->chapters;

</%init>

<p align="center"><font color="red"><% $err %></font></p>

%# Header changes if it's an existing or new judge

<table width="100%">

<tr>
	<td width="100%">
	<form action="judges.mhtml" method="post">
	<input type="hidden" name="diocese" value="<% $diocese_id %>">
	<input type="hidden" name="tourn_id" value="<% $tourn->id %>">

% 	if ($judge) { 
		<h3>Edit <% $judge->first." ". $judge->last %>, Judge in <% $judge->judge_group->name %>
		<% ($account->site_admin) ? $judge->id : "" %>
% 	} else { 
		<h3>Create new <% $group->name %> judge
% 	}

    </h3>
	</td>
	
	<td>
		<input class="blue" type="submit" value="Return to <% $diocese->name %>'s Judges">
		</form>
	</td>

	</tr>

</table>


<table cellpadding="3" width="100%" cellspacing="0" border="0">

<tr>
<td valign="top" width="65%">

<table cellpadding="5" cellspacing="1" width="100%" border="0"> 

%# Input judge personal info; name, school, etc.

<form action="judge_save.mas" method="post">
<input type="hidden" name="group_id" value="<% $group->id %>">

% if ($judge) { 
	<input type="hidden" name="judge_id" value="<% $judge->id %>">
% } 

<input type="hidden" value="<% $tourn->id %>" name="tourn_id">
<input type="hidden" value="<% $diocese->id %>" name="id">

%	my $switch;

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	<td>First name:</td>
	<td colspan="2">
	<input type="text" size="20" value="<% ($judge) ? $judge->first : "" %>" name="first">
	</td>
</tr>

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	<td>Last name:</td>
	<td colspan="2">
	<input type="text" size="20" value="<% ($judge) ? $judge->last : ""%>" name="last">
	</td>
</tr>

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	<td>School:</td>
	<td colspan="2">
	<select name="chapter_id">
% 		foreach my $chapter (@chapters) { 
			<option value="<% $chapter->id %>" 
			<% ($judge) ? ($judge->school->chapter->id == $chapter->id ) ? "selected" : "" : "" %> >
			<% $chapter->name %></option> 
%		}

	</select>
	</td>
</tr>

%	my @pools = Tab::Pool->search( prelim => 1, tournament => $tourn->id );

%	if (@pools && $group->name eq "Speech" ) { 

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		<td>Prelim Site:</td>
		<td colspan="2">
		<select name="pool_id">
%	 	foreach my $pool (@pools) { 
			<option value="<% $pool->id %>" 
				<% 	($judge) ? 
					($judge->prelim_pool) ?  
					($judge->prelim_pool->id == $pool->id ) ? 
						"selected" : "" : "" : "" %> ><% $pool->name %>
				<% ($pool->site) ? " at ".$pool->site->name : "" %>
			</option> 
%		}
		</select>
		</td>
	</tr>
%	}

<tr>
	<td colspan="3"><h4></h4></td>
</tr>

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	<td colspan="3">
	Indicate strikes with other dioceses or schools, or any special requirements:
	</td>
</tr>

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	<th>
		Notes:
	</th>
	<td colspan="3">
		<input type="text" name="notes" size="35" value="<% ($judge) ? $judge->notes : "" %>">
	</td>
</tr>


%# If we're using the qualification system, and it's not a Tab assignment, we 
%# must rate each judge in each event class corresponding with this judge group

% if ($tourn->method->judge_quality_system && $group->tab_room != 1 && $group->classes) { 

	<tr>
	<td colspan="3"><h4>Qualifications:</h4></td></tr>

% 	my @quals = $tourn->quals;

% 	foreach my $qual (sort {$a->name cmp $b->name} @quals) { 
%		next if $qual->name eq "P" and $group->name ne "Congress";

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			<td><b><% $qual->name %>:</b></td>
			<td colspan="2"><% $qual->description %></td>
		</tr>
% 	}

	<tr><td colspan="3"><h4></h4></td></tr>

% foreach my $class ($group->classes) { 

%  my $my_qual;
%  if ($judge) { 
%		my @jc = Tab::JudgeClass->search(judge => $judge->id, class => $class->id);
%		my $my_qual_obj = $jc[0]->qual;
% 		$my_qual = $my_qual_obj->id if $my_qual_obj;
%  } else {
%     	$my_qual = $tourn->method->default_qualification->id;
%  }

% my @events = $class->events;

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
<td><b><% $class->name %></b>
</td>
<td colspan="1"> Events: 
% my $i;
% foreach my $event (@events) { 
% if ($i) {
,
% }
<% $event->name %>
% $i++
% } 
</td>
<td>
<select name="class_qual_<%$class->id %>">

% foreach my $qual (sort {$a->name cmp $b->name} @quals) { 

%	next if $qual->name eq "P" and $group->name ne "Congress";

	<option value="<% $qual->id %>" <% ($qual->id == $my_qual) ? 'selected' : '' %>>
	<% $qual->name %>
	</option>
% }
</select>
</tr>

% }


% }

%#  If this is a Tab assignment, then instead we have 1-3rd preferences on 
%#  Tab room assignments. 

% if ($group->tab_room == 1) { 

<tr><td colspan="4"><h4>Tab Room Preference:</h4></td></tr>

<tr><td>First Choice:</td>

	<td>
	<select name="cfl_tab_first">
% if ($judge) { 
	<& /prereg/tab_choices.mas, select => $judge->cfl_tab_first &>
% } else { 
	<& /prereg/tab_choices.mas &>
% }
	</select></td>

</tr>
<tr><td>Second Choice:</td>

	<td>
	<select name="cfl_tab_second">
% if ($judge) { 
	<& /prereg/tab_choices.mas, select => $judge->cfl_tab_second &>
% } else { 
	<& /prereg/tab_choices.mas &>
% }
	</select></td>

</tr>
<tr><td>Third Choice:</td>

	<td>
	<select name="cfl_tab_third">
% if ($judge) { 
	<& /prereg/tab_choices.mas, select => $judge->cfl_tab_third &>
% } else { 
	<& /prereg/tab_choices.mas &>
% }
	</select></td>

</tr>

% }


<%perl>

	my @already_alted = Tab::Judge->search_where( 
						judge_group => $group->id, 
						alt_group => { '!=', 0 },
						id => {'!=', $judge_id} );

	my @already_here;

	foreach my $aa (@already_alted) { 
		
		push (@already_here, $aa) if $aa->school->region->id == $diocese_id;

	}

	if ($group->ask_alts && (scalar @already_here < $group->alt_max)) { 

</%perl>

<tr><td colspan="3"><h4></h4></td></tr>

<tr>
	<td colspan="3">
	<p>You may designate 1 <% $group->name %> judge to judge an alternate event
	as well; the tournament will assign them to either <% $group->name %> or
	their other event as needed.  This will meet your <% $group->name %> judge
	burden <b>and</b> reduce your burden for the alternate event by 1 judge.

	If the judge only wants to judge <% $group->name %>, choose no Alternate
	group; the judge will then reduce your <% $group->default_alt_reduce->name %> 
	obligation by 1 judge.
	</p>
	</td>
</tr>

	<tr class="evenrow">
	<th colspan="2">Alternate Group:</th>
	<td colspan="2"><select name="alt_group">

	<option value="">---None Selected----</option>
% 	foreach my $og (sort {$a->name cmp $b->name} $tourn->groups) { 
%		next if $og->id == $group->id;
%		next if $og->tab_room;
		<option value="<% $og->id %>" <% ($judge) ? ($judge->alt_group) ? 
		($judge->alt_group->id == $og->id) ? "selected" : "" : "" : ""%> ><% $og->name %></option>
% 	}
	</td>
	</tr>

% } # end of if ask-alts

<tr>
<td colspan="3" align="right">
<input class="blue" type="submit" value="Save Judge">
</td>
</form>

</tr>
</table>

</td>

% if ($judge) { 
% unless ($group->tab_room == 1 ) { 

<td width="35%" valign="top" style="border: 1px solid black;">

<h4>Outround Assignments:</h4>

<%perl>	

	# Figure out if the judge is already in an elim pool; if so we're
	# only going to show that judge group for elims.  Otherwise we go
	# with the input.
	my @judge_pools = $judge->elim_pools;
	my $enforce_elim_group;
	my $elim_group = Tab::JudgeGroup->retrieve($elim_group_id) if $elim_group_id;

	if (@judge_pools) { 

		my $jp = shift @judge_pools;
		my @groups = $jp->groups;
		$elim_group = shift @groups;
		$enforce_elim_group++ if $elim_group;
	} 

</%perl>

<table cellpadding="5" cellspacing="1" border="0" width="100%">

%	if ($enforce_elim_group) { 

	<tr class="dkblrow">
		<th colspan="3">Judge is judging <% $elim_group->name %> in elims</th>
	</tr>

%	} else { 

	<tr class="dkblrow">
		<td colspan="3" style="padding: 8px;">
		<form action="judge_view.mhtml" method="post">
		<input type="hidden" name="judge_id" value="<% $judge->id %>">
		Select group for elim round assignments:</td>
	</tr>

	<tr>
	<td colspan="2">
		<select name="elim_group_id"> 
%		foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) { 
%		next if $group->tab_room;
%		next unless $group->elim_pools;
			<option value="<% $group->id %>" <% ($elim_group && $elim_group->id == $group->id) || ($group->id == $judge->judge_group->id)  ? "selected" : "" %>>
			<% $group->name %></option>
%		}
		</select>
	</td>

	<td align="right">
		<input class="blue" type="submit" value="Select">
		</form>
	</td>
	</tr>

%	}

%	if ($elim_group) { 

%    my ($judge_burden, $burden_met, $pool_warning, $elim_warning)
%	    = $m->comp("/funclib/judge_obligations.mas", id => $diocese->id, group_id => $group->id);

	<tr>
		<th colspan="3">
		<form action="elim_save.mas" method="post">
		<input type="hidden" value="<% $judge->id %>" name="judge_id">
		<input type="hidden" value="<% $elim_group->id %>" name="elim_group_id">
		Select elim rounds: <% ($account->site_admin) ? $elim_group_id : "" %>
		</th>
	</tr>

%	my $switch;

%	foreach my $pool (sort {$b->percent <=> $a->percent} $elim_group->elim_pools) { 
%		my @pool = $pool->judges($diocese);
		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		<td><% $pool->name %></td>
		<td align="center">(<% scalar @pool %>/<% POSIX::ceil($judge_burden * $pool->percent * .01) %>)</td>
		<td align="center">
			<input type="checkbox" name="<% $pool->id %>" class="largecheck" value="1"
			<% ($judge->in_pool($pool)) ? "checked" : "" %>	
			>
		</td>
		</tr>
%	}

	<tr class="bluerow">
	<td colspan="3" align="right">
		<input class="blue" type="submit" value="Save Pools">
		</form>
	</td>
	</tr>


% 	}
</table>
% }

<br>
<br>

<h4>Add another judge in:</h4>

<table cellpadding="4" cellspacing="1" width="100%" border="0">
<tr>
<td>
<form action="judge_view.mhtml" method="post">
<input type="hidden" name="id" value="<% $diocese_id %>">
<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
<select name="group_id">
%	foreach my $jg (sort {$a->name cmp $b->name} $tourn->groups) { 
	<option value="<% $jg->id %>" <% ($jg->id eq $group->id) ? "selected" : "" %> >
		<% $jg->name %></option>
% } 
</select></td>
	
	<td align="right">
	<input class="blue" type="submit" value="Next">
	</td>

</tr>
</form>
</table>


<br>
<br>

<h4>Delete Judge:</h4>

<p>Warning: this is permanent.  If you mistakenly delete this judge you will
have to re-enter all information for this judge again. </p>

<form action="judge_rm.mas" method="post">
<input type="hidden" value="<% $judge_id %>" name="judge_id">
<center>
<input class="blue" type="submit" value="Delete Judge" class="button">
</form>
</td>
</tr>

</table>
<br>

%}

% if ($tourn->judge_policy) { 

<h3>Judge Requirements for <% $tourn->name %> </h3>


% my $blurb = $tourn->judge_policy;
% $blurb =~ s/\n/\n<BR>/g;	
<p><blockquote><% $blurb %></blockquote></p>

%	} 

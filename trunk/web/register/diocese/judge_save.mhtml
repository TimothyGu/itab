<%args>
	$group_id
	$diocese_id
	$judge_id => undef
	$chapter_id => undef
	$pool_id => undef
	$first => undef
	$alt_group => 0
	$last => undef
	$gender => undef
	$notes => undef
	$save => undef
</%args>
<%init>

	my $msg;

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my $tourn = $group->tournament;

	my $diocese = Tab::Region->retrieve($diocese_id);

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my $school = $chapter->school($tourn);

	unless ($school) {

		$school = Tab::School->create({
			tournament => $tourn->id,
			chapter => $chapter_id,
			name => $chapter->name,
			region => $diocese->id,
			code => $chapter->code($tourn->league)
		});

	}

	my @classes = $group->classes;

	my $judge;

	if ($judge_id) { 

		$judge = Tab::Judge->retrieve($judge_id);

		$judge->school($school->id);
		$judge->first($first);
		$judge->alt_group($alt_group);
		$judge->last($last);
		$judge->gender($gender);
		$judge->prelim_pool($pool_id);
		$judge->notes($notes);
		$judge->update;
	
		$msg = "Changes to Judge $first $last saved ";

	} else { 

		if ($first && $last && $gender) { 

			$judge = Tab::Judge->create({
				tournament => $tourn->id,
				judge_group => $group_id,
				school => $school->id,
				first => $first,
				alt_group => $alt_group,
				last => $last,
				notes => $notes,
				gender => $gender,
				prelim_pool => $pool_id,
				active => 1,
			});

			$msg = "Judge $first $last added to the tournament";

		} else { 

			my $err = "You did not fill in all required info.  All fields except for Notes are needed.  Try again.";

			$m->redirect("$Tab::url_prefix/user/diocese/judge_edit.mhtml?group_id=".$group->id."&diocese_id=$diocese_id&err=$err");
	
		}

	}

	foreach my $class (@classes) {

		my $judge_class = $judge->class($class);

		my $qual = $ARGS{$class->id};

		if ($judge_class) { 

			$judge_class->qual($qual);
			$judge_class->update;

		} else {

			$judge_class = Tab::JudgeClass->create({
				tournament => $tourn->id,
				judge => $judge->id,
				class => $class->id,
				qual => $qual
			});

		}

	}

	$m->redirect("$Tab::url_prefix/register/diocese/judge_edit.mhtml?judge_id=".$judge->id."&diocese_id=$diocese_id&msg=$msg");

</%init> 


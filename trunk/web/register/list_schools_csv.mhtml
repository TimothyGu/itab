<%args>
	$circuit
	$tourn
	$session
</%args>
<%init>

	my @schools = sort {$a->chapter->name cmp $b->chapter->name} $tourn->schools;

	my $filename = "Schools-At-".$circuit->short_name."-tourn".$tourn->id."-".$session->id;
	my $filepath = $Tab::file_root."/tmp/".$filename;

	my $now = DateTime->now;	
	$now->set_time_zone($tourn->tz);
	
	my $garbage = `rm -f $filepath.*`;
	open (TEXOUT, ">$filepath.csv");
	
		print TEXOUT "Diocese Code,Diocese Name,School Name,Entries,Judges\r\n" if $circuit->diocese_based;

	foreach my $school (sort {$a->name cmp $b->name} @schools) { 

		if ($circuit->diocese_based) { 
			print TEXOUT "\"".&Tab::texify($school->region->code)."\",\"" if $school->region;
			print TEXOUT &Tab::texify($school->region->name)."\",\"" if $school->region;
			print TEXOUT &Tab::texify($school->name)."\",\"";
			print TEXOUT scalar $school->entries."\",\"";
			print TEXOUT scalar $school->judges."\"\r\n";
		} else { 
			print TEXOUT "\"".&Tab::texify($school->name)."\",\"";
			print TEXOUT &Tab::texify($school->code)."\",\"";
			print TEXOUT &Tab::texify($school->region->code)."\",\"" if $circuit->region_based && $school->region;
			print TEXOUT &Tab::texify($school->chapter->state)."\r\n";
		}
	}

	$m->redirect("$Tab::url_prefix/tmp/".$filename.".csv");

</%init>


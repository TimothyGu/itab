<%args>
	$tourn
	$daystring => undef
</%args>
<%init>

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $day_before = $days[0]->clone;
	$day_before->subtract( days => 1);
	unshift(@days, $day_before);

	my @schools = $tourn->schools;
	my %schools_by_chapter = ();

	foreach my $sch (@schools) {
		$schools_by_chapter{$sch->chapter->id} = $sch;
	}

	my %tba_by_school = ();

	my $day;

</%init>

	<& /funclib/tablesorter.mas, table => "housing" &>

	<div class="left huge">

		<h2>Housing requests for <% $tourn->name %></h2>

<%perl>

	if ($daystring) { 

		my $day = Tab::dtme($daystring);

		my @housing = Tab::HousingSlots->search( night => $day->ymd, tourn => $tourn->id );
		next unless @housing;

		my $total_granted = 0;
		my $total_waitlisted = 0;

		my @reqs = Tab::Housing->search( night => $day->ymd, tourn => $tourn->id );

		foreach my $req (@reqs) { 
			$total_granted++ unless $req->waitlist;
			$total_waitlisted++ if $req->waitlist;
		}

</%perl>

		<span class="spacey" style="width: 220px;">
			<h4 style="padding-top: 7px;">
				<% $day->day_abbr." ".$day->month_name." ".$day->day %>
			</h4>
		</span>
		
		<span class="spacey rightalign" style="font-size: 90%; width: 400px;">
			<% $housing[0]->slots %> slots,
			<% $total_granted %> Housed,
			<% $total_waitlisted %> Waitlist 
		</span>

		<table cellpadding="4" cellspacing="1" width="100%" id="housing">

			<thead>

			<tr class="yellowrow">

				<th class="smaller">
					First
				</th>

				<th class="smaller">
					Last
				</th>

				<th class="smaller">
				</th>
					
				<th class="smaller">
				</th>
					
				<th class="smaller">
					Ev.
				</th>
						
				<th class="smaller">
					School
				</th>
					
				<th class="smaller">
					Req'd On
				</th>

				<th class="smaller">
					WL
				</th>
					
				<th class="nosort">
				</td>

			</tr>

			</thead>
			<tbody>
					
<%perl>

	@reqs = sort {$a->requested->epoch <=> $b->requested->epoch} @reqs;

	my $switch; 

	REQ:
	foreach my $request (@reqs) { 

		my @entries; 

		$tba_by_school{$request->school->id}++ if $request->tba;
		next REQ if $request->tba;

		if ($request->type eq "student") { 

			@entries = $m->comp("/funclib/student_entries.mas", student => $request->student, tourn => $tourn);

			unless ($request->student->chapter && @entries) { 
				$request->delete;
				next REQ;
			}

		}

</%perl>

		<tr>

%		if ($request->type eq "student") { 

			<td class="smaller">
				
				<a name="<% $request->id %>">

				<a class="white block" href="/register/entry/student_edit.mhtml?student_id=<% $request->student->id %>">
					<% $request->student->first %>
				</a>
			</td>

			<td class="smaller">
				<a class="white block" href="/register/entry/student_edit.mhtml?student_id=<% $request->student->id %>">
					<% $request->student->last %>
				</a>
			</td>

			<td class="smaller centeralign">
				<% $request->student->gender %>
			</td>

			<td class="smaller centeralign">
				Ent.
			</td>

			<td class="smaller centeralign">
%				foreach my $entry (@entries) { 
					<a class="white block" href="/register/entry/edit.mhtml?entry_id=<% $entry->id%>">
						<% $entry->event->abbr %><% ($entry->waitlist) ? "-WL" : "" %>
					</a>
%				}
			</td>

			<td class="smaller">
%				my $school = $request->school;
%				$school = $schools_by_chapter{$request->student->chapter->id} unless $school;

				<a class="white block" href="/register/school/housing.mhtml?school_id=<% $school->id %>">
					<% $school->name %> <% $school->chapter->state ? "(".$school->chapter->state.")" : "" %>
				</a>

			</td>

			<td class="smaller">
				<% &Tab::niceshortdt($request->requested->set_time_zone($tourn->tz)) %>
			</td>



%			if ($request->waitlist) { 
				
				<td class="smaller centeralign">
					<a class="dkred block" href="switch.mhtml?req_id=<% $request->id %>">
						YES
					</a>
				</td>

%			} else { 

				<td class="smaller centeralign">
					<a class="dkgreen block" href="switch.mhtml?req_id=<% $request->id %>">
						NO
					</a>
				</td>
%			}	

%			my $warn = "Delete housing for ".$request->student->first." ".$request->student->last."?  This cannot be undone";

			<td class="smaller centeralign">
				<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &> href="delete.mhtml?req_id=<% $request->id %>">
					DEL
				</a>
			</td>

%		} 

%		if ($request->judge) { 

%			unless ($request->judge->judge_group) { 
%				$request->delete;
%				next REQ;
%			}

			<td class="smaller">
			
				<a name="<% $request->id %>">

				<a class="white block" href="/register/judge/edit.mhtml?judge_id=<% $request->judge->id %>">
					<% $request->judge->first %>
				</a>
			</td>

			<td class="smaller">
				<a class="white block" href="/register/judge/edit.mhtml?judge_id=<% $request->judge->id %>">
					<% $request->judge->last %>
				</a>
			</td>

			<td class="smaller centeralign">
				<% $request->judge->gender %>
			</td>

			<td class="smaller centeralign">
				Jud.
			</td>

			<td class="smaller centeralign">
				<a class="white block" href="/register/judge/edit.mhtml?judge_id=<% $request->judge->id %>">
					<% $request->judge->judge_group->abbr %>
				</a>
			</td>

			<td class="smaller">
				<a class="white block" href="/register/school/housing.mhtml?school_id=<% ($request->judge->school) ? $request->judge->school->id : ""%>">
					<% ($request->judge->school) ? $request->judge->school->name : "" %>
				</a>
			</td>

			<td class="smaller">
				<% &Tab::niceshortdt($request->requested->set_time_zone($tourn->tz)) %>
			</td>

			<td class="smaller centeralign">

%				if ($request->waitlist) { 
					<a class="dkred block" href="switch.mhtml?req_id=<% $request->id %>">YES</a>
%				} else { 
					<a class="dkgreen block" href="switch.mhtml?req_id=<% $request->id %>">NO</a>
%				}	

			</td>

			<td class="smaller centeralign">
				<a class="dkred block" href="delete.mhtml?req_id=<% $request->id %>">DEL</a>
			</td>

%			}

		</tr>
		
%		}
			
		</tbody>

		</table>

%	} #end of foreach my $day

	</div>

	<div class="right small">

		<div class="sidenote">

			<h4>Housing</h4>

%			foreach my $oday (@days) { 
				<a class="<% $oday eq $day ? "dk" : "" %>blue block" href="index.mhtml?daystring=<% Tab::pickerdate($oday)%>">
					<% Tab::nicedate($oday) %>
				</a>
%			}

			<a href="print.mhtml" class="blue block" style="margin-top: 15px;">
				Print Housing Roster
			</a>

			<a href="csv.mhtml" class="blue block">
				Download Housing Spreadsheet
			</a>
	
		</div>

%		if (keys %tba_by_school) { 

			<div class='sidenote'>

				<h4>TBA Housing Slots</h4>

%				foreach my $school_id (keys %tba_by_school) { 
%					my $school = Tab::School->retrieve($school_id);
					<a class="blue block" href="/register/school/housing.mhtml?school_id=<% $school_id %>">
						<% $school->name %>:  <% $tba_by_school{$school_id} %> slots
					</a>
%				}

			</div>

%		}

	</div>




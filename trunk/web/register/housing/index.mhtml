<%args>
	$tourn
	$sort_by => undef
</%args>
<%init>

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $day_before = $days[0]->clone;
	$day_before->subtract( days => 1);
	push (@days, $day_before);

	my @schools = $tourn->schools;
	my %schools_by_chapter = ();

	foreach my $sch (@schools) {
		$schools_by_chapter{$sch->chapter->id} = $sch;
	}

</%init>

	<div class="right small">

		<div class="sidenote">

			<h4>Housing</h4>

			<a href="print.mhtml" class="blue block">
				Print Housing Roster
			</a>

			<a href="csv.mhtml" class="blue block">
				Download Housing Spreadsheet
			</a>
	
		</div>

	</div>


	<div class="left huge">

		<h2>Housing requests for <% $tourn->name %></h2>

<%perl>

		foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

			my @housing = Tab::HousingSlots->search( night => $day->ymd, tourn => $tourn->id );
			next unless @housing;

			my $total_granted = 0;
			my $total_waitlisted = 0;

			my @reqs = Tab::Housing->search( night => $day->ymd, tourn => $tourn->id );

			foreach my $req (@reqs) { 
				$total_granted++ unless $req->waitlist;
				$total_waitlisted++ if $req->waitlist;
			}

</%perl>

			<span class="spacey" style="width: 220px;">
				<h4 style="padding-top: 7px;">
					<% $day->day_abbr." ".$day->month_name." ".$day->day %>
				</h4>
			</span>
		
			<span class="spacey rightalign" style="font-size: 90%; width: 400px;">
				<% $housing[0]->slots %> slots,
				<% $total_granted %> Housed,
				<% $total_waitlisted %> Waitlist 
			</span>

		<table cellpadding="4" cellspacing="1" width="100%">

			<tr class="yellowrow">

				<th class="smaller">
					Name
				</th>

				<th class="smaller">
					G
				</th>
					
				<th class="smaller">
					Type
				</th>
					
				<th class="smaller">
					Event
				</th>
						
				<th class="smaller">
					School
				</th>
					
				<th class="smaller">
					Requested On
				</th>

				<th class="smaller">
					Waitlist?
				</th>
					
				<th class="smaller">
				</td>

			</tr>
					
<%perl>

	@reqs = sort {$a->requested->epoch <=> $b->requested->epoch} @reqs;

	@reqs = sort {$a->name cmp $b->name} @reqs if $sort_by eq "name";

	@reqs = sort {$a->school->name cmp $b->school->name} @reqs if $sort_by eq "school";

	@reqs = sort {$b->waitlist <=> $a->waitlist} @reqs if $sort_by eq "waitlist";

	my $switch; 

	REQ:
	foreach my $request (@reqs) { 

		my @entries; 

		if ($request->type eq "student") { 

			@entries = $m->comp("/funclib/student_entries.mas", student => $request->student, tourn => $tourn);

			unless ($request->student->chapter && @entries) { 
				$request->delete;
				next REQ;
			}

		}

</%perl>

		<a name="<% $request->id %>">

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

%		if ($request->type eq "student") { 

			<td>
				<a class="white block" href="<% $Tab::url_prefix %>/register/entry/student_edit.mhtml?student_id=<% $request->student->id %>">
					<% $request->student->last.", ".$request->student->first %>
				</a>
			</td>

			<td align="center">
				<% $request->student->gender %>
			</td>

			<td class="smaller">
				Entry
			</td>

			<td class="smaller" align="center">
%				foreach my $entry (@entries) { 
					<a class="white block" href="<% $Tab::url_prefix %>/register/entry/edit.mhtml?entry_id=<% $entry->id%>">
						<% $entry->event->abbr %><% ($entry->waitlist) ? "-WL" : "" %>
					</a>
%				}
			</td>

			<td class="smaller">
%				if ($request->school) { 
					<a href="/register/index.mhtml?school_id=<% $request->school->id %>">
						<% $request->school->name %>
					</a>
%				}
			</td>

			<td class="smaller">
				<% &Tab::niceshortdt($request->requested->set_time_zone($tourn->tz)) %>
			</td>



%			if ($request->waitlist) { 
				
				<td class="centeralign">
					<a class="dkred block" href="switch.mhtml?req_id=<% $request->id %>">
						YES
					</a>
				</td>

%			} else { 

				<td class="centeralign">
					<a class="dkgreen block" href="switch.mhtml?req_id=<% $request->id %>">
						NO
					</a>
				</td>
%			}	

%			my $warn = "Delete housing for ".$request->student->first." ".$request->student->last."?  This cannot be undone";

			<td class="centeralign">
				<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &> href="delete.mhtml?req_id=<% $request->id %>">
					Remove
				</a>
			</td>

%		} 

%		if ($request->judge) { 

%			unless ($request->judge->judge_group) { 
%				$request->delete;
%				next REQ;
%			}

			<th>
				<a href="<% $Tab::url_prefix %>/register/judge_edit.mhtml?judge_id=<% $request->judge->id %>">
				<% $request->judge->last.", ".$request->judge->first %>
				</a>
			</th>

			<td class="smaller">
				Judge
			</td>

			<td align="center" class="smaller">
				<a href="<% $Tab::url_prefix %>/register/judge_edit.mhtml?judge_id=<% $request->judge->id %>"><% $request->judge->judge_group->abbr %></a>
			</td>

			<td class="smaller">
				<a href="/register/index.mhtml?school_id=<% ($request->school) ? $request->school->id : ""%>">
					<% ($request->school) ? $request->school->name : "" %>
				</a>
			</td>

			<td class="smaller">
				<% &Tab::niceshortdt($request->requested->set_time_zone($tourn->tz)) %>
			</td>

			<td align="center">
				<% $request->judge->gender %>
			</td>

			<td align="center">
%				if ($request->waitlist) { 

					Y </td>

					<td class="smaller" align="center"> 
						(<a href="<% $Tab::url_prefix %>/register/housing-unwl.mhtml?req_id=<% $request->id %>">Un-waitlist</a>)

%				} else { 
					N </td>
					<td align="center">
						(<a href="<% $Tab::url_prefix %>/register/housing-wl.mhtml?req_id=<% $request->id %>">Waitlist</a>)
%				}	

				</td>

			<td>
				(<a href="<% $Tab::url_prefix %>/register/housing-rm.mhtml?sort_by=<% $sort_by %>&req_id=<% $request->id %>">Remove</a>)
			</td>

%			}

		</tr>
		
%		}

		</table>

%	} #end of foreach my $day

	</div>


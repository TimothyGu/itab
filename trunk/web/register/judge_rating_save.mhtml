<%args>
	$tourn
	$judge_id
	$account
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);
	my $group = $judge->judge_group;

	my $msg = "Ratings saved";

	if ($group->qual_subsets) { 

		foreach my $subset ($group->qual_subsets) { 
	
			my @judge_ratings = Tab::Rating->search(
				judge => $judge->id,
				subset => $subset->id,
				type => "coach"
			);

			my $notfirst;

			JR:
			foreach my $jr (@judge_ratings) { 

				if ($notfirst) { 
					$jr->delete;
					next JR;
				} else { 
					$jr->qual($ARGS{$subset->id."_rating"});
					$jr->update;
					$notfirst++;
				}

			}

			unless ($notfirst) { 
				Tab::Rating->create({
					judge => $judge->id,
					tournament => $tourn->id,
					type => "coach",
					qual => $ARGS{$subset->id."_rating"},
					subset => $subset->id
				});
			}

		}

	} else {


		my @judge_ratings = Tab::Rating->search(
			judge => $judge->id,
			type => "coach"
		);

		my $notfirst;

		JR:
		foreach my $jr (@judge_ratings) { 

			if ($notfirst) { 
				$jr->delete;
				next JR;
			} else { 
				$jr->qual($ARGS{"rating"});
				$msg .= " ".$ARGS{"rating"};
				$jr->update;
				$notfirst++;
			}
		}

		unless ($notfirst) { 

			Tab::Rating->create({
				judge => $judge->id,
				tournament => $tourn->id,
				type => "coach",
				qual => $ARGS{"rating"},
			});

		}

		$msg .= " $notfirst ";

	}


	$m->redirect("$Tab::url_prefix/register/judge_edit.mhtml?msg=$msg&judge_id=$judge_id");

</%init>


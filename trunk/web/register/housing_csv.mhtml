<%args>
	$tourn
	$session
</%args>
<%init>

my $tourn_id = $tourn->id;
my $session_id = $session->id;

`mkdir $Tab::file_root/tmp/housing-export-$tourn_id-$session_id`;

open (HOUSING, ">$Tab::file_root/tmp/housing-export-$tourn_id-$session_id/Housing.csv");

print HOUSING "Name,Type,Event,School,Requested,Gender,Waitlist\r\n";

my @days = $tourn->days;
my $day_before = $days[0]->clone;
$day_before->subtract( days => 1);
push (@days, $day_before);

foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

	my @reqs = Tab::Housing->search( night => $day->ymd, tournament => $tourn->id );
	next unless @reqs;

	print HOUSING $day->day_abbr." ".$day->month_name." ".$day->day."\r\n";

	foreach my $request (sort {$a->requested->epoch <=> $b->requested->epoch} @reqs) {

		if ($request->student) { 

			my $student = $request->student;
			
			my @entries = $student->entries($tourn);

			my $yes;

			foreach my $entry (@entries) { 
				$yes++ unless $entry->dropped;
			}

			next unless $yes;

			my $date = $request->requested;
			$date->set_time_zone($tourn->league->timezone);

			print HOUSING "\"".$student->first." ".$student->last."\"";
			print HOUSING ",student,\"";

			my $school;

			foreach my $entry (@entries) { 
				print HOUSING $entry->event->abbr." ";
				$school = $entry->school;
			}

			print HOUSING "\",".$school->name.",";
			print HOUSING "\"".$date->mdy." ".$date->hms."\",";
			print HOUSING $student->gender.",";
			print HOUSING "YES" if $request->waitlist;
			print HOUSING "\r\n";

		} else {

			my $judge = $request->judge;
			my $date = $request->requested;
			$date->set_time_zone($tourn->league->timezone);

			print HOUSING "\"".$judge->first." ".$judge->last."\"";
			print HOUSING ",judge,\"";

			print HOUSING $judge->judge_group->abbr." ";
			print HOUSING "\",".$judge->school->name.",";
			print HOUSING "\"".$date->mdy." ".$date->hms."\",";
			print HOUSING $judge->gender.",";
			print HOUSING "YES" if $request->waitlist;
			print HOUSING "\r\n";

		}

	}

}

close HOUSING;

$m->redirect("$Tab::url_prefix/tmp/housing-export-$tourn_id-$session_id/Housing.csv");

</%init>

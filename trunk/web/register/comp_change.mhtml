<%args>
	$comp_id
	$school_id
	$code => undef
</%args>
<%init>

	my $err;

	my $comp = Tab::Comp->retrieve($comp_id);

	if ($school_id && $school_id != $comp->school->id) { 
		$comp->school($school_id);
		$err .= "Competitor school changed <br />";
	}


	if ($code && $code != $comp->code) { 

		my @existing = Tab::Comp->search( code => $code, tournament => $comp->school->tournament->id );
	
		if (@existing) { 
	
			my $err = "A competitor with speaker code $code already exists";
			$m->redirect("$Tab::url_prefix/register/comp_edit.mhtml?err=$err&comp_id=$comp_id");
		
		} else { 
	
			$comp->code($code);
			$err .= "Competitor code changed to $code <br />";
	
		}

	}

	$comp->student($ARGS{$comp->student->id}) if $comp->student;
	$comp->partner($ARGS{$comp->partner->id}) if $comp->partner;

	$comp->partner($ARGS{"partner"}) if $comp->event->team == 2 && not defined $comp->partner;

	$comp->update;
	
	$m->redirect("$Tab::url_prefix/register/comp_edit.mhtml?err=$err&comp_id=$comp_id");
		
</%init>

<%args>
	$event_id
	$tourn
	$account
	$circuit
	$debug => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id); 

	unless ($event->tournament->id eq $tourn->id) { 
		my $err = "That event does not belong to your tournament";
		$m->redirect("$Tab::url_prefix/register/index.mhtml?err=$err");
	}


	my $subject = "Waitlist for ".$event->name." cleared";
	my $message = "The ".$tourn->name." is pleased to notify you\r\n";
	$message .= "that all your waitlisted students in ".$event->name." \r\n";
	$message .= "have been admitted to the tournament: \r\n \r\n";

	$message .= "\r\n\r\n******WARNING:******\r\n";
	$message .= "Students in this entry may now be double-entered.  Please make sure \r\n";
	$message .= "that their double-entry is not in conflict with tournament \r\n";
	$message .= "rules as the result of getting off the waitlist in this event. \r\n";

	if ($tourn->method->housing)  {
		$message .= "\r\n\r\n";
		$message .= "If you were waitlisted for housing, this did not remove your \r\n";
		$message .= "entry from the housing waitlist; only the entry waitlist.\r\n";
	}

	$message .= "\r\n \r\n";
	$message .= "Cheers,\r\n";
	$message .= "   ".$account->first." ".$account->last."\r\n";
	$message .= "   ".$tourn->name."\r\n ";

    $message .= " \r\n \r\n --- \r\n ";
    $message .= " This message was auto-generated by the Tabroom.com software\r\n";
    $message .= "  at ".$Tab::url_prefix.". on behalf of the ". $tourn->name ."\r\n";
	   		 
	foreach my $school ($event->waitlist_schools) { 

		my @accounts = $school->chapter->coaches;

	    foreach my $sendto (@accounts) {
			$m->comp( "/funclib/send_email.mas", from => $account, to => $sendto, subject => $subject, body => $message );
		}

	}

	Tab::Event->set_sql(clear_waitlist => " update entry set waitlist = 0 where event = ".$event->id);
	Tab::Event->sql_clear_waitlist->execute;

	my $msg = $event->abbr." waitlist cleared.  The coaches have been notified by email";
	$m->redirect("$Tab::url_prefix/register/waitlist.mhtml?event_id=".$event->id."&msg=$msg");

</%init>

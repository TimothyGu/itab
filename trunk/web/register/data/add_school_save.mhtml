<%args>
	$tourn
	$chapter_id => undef
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);
	my @already = Tab::School->search( chapter => $chapter_id, tourn => $tourn->id);

	if (@already) { 
		my $err = $chapter->name." is already entered in your tournament.  Try again";
		$m->redirect("add_school.mhtml?err=$err");
	}

	unless ($chapter) { 
		my $err = "That chapter was not found for some reason.  Please try again";
		$m->redirect("add_school.mhtml?err=$err");
	}

	my @circuits = $m->comp("/funclib/tourn_circuits.mas", tourn => $tourn);

	my $msg;
	my $school;


	unless (@already) { 

		my $school_code;
		my $region_id;

		my $codes = $tourn->setting("school_codes");

		if ($codes eq "incremental") { 

			Tab::School->set_sql(highest_code => "select max(code) from school where tourn = ? and code not in (\"BJ\", \"DQ\")");
			my $value = Tab::School->sql_highest_code->select_val($tourn->id);

			$value++ if $value;
			$value = $tourn->setting("first_school_code") unless $value;
			$value = "AA" unless $value; 

			$value++ if $value eq "DQ";
			$value++ if $value eq "BJ"; 

			$value++ if $value eq 69;
			$value++ if $value eq 666; 

			$school_code = $value;
			$school_code = "DQ" if $chapter->id == 2660;
			$school_code = "BJ" if $chapter->id == 330;


		} elsif ($codes eq "circuit") { 

			my $circuit = $tourn->circuits->first;
			my ($cc) = Tab::ChapterCircuit->search( circuit => $circuit->id, chapter => $chapter->id ) if $circuit;
			$school_code = $cc->code if $cc;
			$region_id = $cc->region->id if $cc->region;

		} elsif ($codes eq "shortname") { 

			$school_code = $m->comp("/funclib/school_codename.mas", school => $chapter);
		}   

		$school = Tab::School->create({
			chapter => $chapter->id,
			tourn => $tourn->id,
			name => $chapter->name,
			region => $region_id,
			code => $school_code,
		});

		$m->comp('/funclib/chapter_conflicts.mas', school => $school);
		$msg = "School ".$chapter->name." has been added to your tournament entry";

	}

	$m->redirect("$Tab::url_prefix/register/data/add_school.mhtml?msg=$msg");


</%init>

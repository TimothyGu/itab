<%args>
	$event_id
	$codestart => undef
	$sort_by
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);

	$event->setting('code_start', $codestart) if $codestart;

	Tab::Entry->set_sql( code_clear => " update entry set code = 0 where event = ?  ");
	Tab::Entry->sql_code_clear->execute($event->id);

	my @entries = $event->entries;

	if ($sort_by eq "Randomly") { 
		my $i = scalar(@entries);
		my $j;
		foreach my $item (@entries)
		{	 --$i;
			$j = int rand ($i+1);
			next if $i == $j;
			@entries [$i,$j] = @entries[$j,$i];
	   }	
	}

	@entries = sort {$a->name cmp $b->name} @entries if $sort_by eq "Name";
	@entries = sort {$a->school->name cmp $b->school->name} @entries if $sort_by eq "School" || $sort_by eq "Randomly";
	@entries = sort {$a->id <=> $b->id} @entries if $sort_by eq "Register";

	if ($sort_by eq "Diocese" || $sort_by eq "Region") { 
		@entries = sort {$a->school->name cmp $b->school->name} @entries;
		@entries = sort {$a->school->region->code cmp $b->school->region->code} @entries;
		@entries = sort {length($a->school->region->code) <=> length($b->school->region->code)} @entries;
	}

	foreach my $entry (@entries) { 
		$entry->code($m->comp("/funclib/entry_code.mas", entry => $entry));
		$entry->update;
	}

	my $msg = "Codes for ".$event->name." reshuffled";
	$m->redirect("/register/data/entry_recode.mhtml?msg=$msg");

</%init>

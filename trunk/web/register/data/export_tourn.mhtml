<%args>
	$tourn
</%args>
<%init>
	my $tourn_id = $tourn->id;
	open (FILE, ">$Tab::file_root/tmp/tourn-$tourn_id-save.tab");

	my @accounts = Tab::Account->retrieve_all;
	my @a_fields = $accounts[0]->columns;

	foreach (@accounts) {
		print_fields ($_, "account", @a_fields);
	}

	my @chapter = Tab::Chapter->retrieve_all;
	my @se_fields = $chapter[0]->columns;

	foreach (@chapter) { 
		print_fields ($_, "chapter", @se_fields);
	}

	my @chapter_admin = Tab::ChapterAdmin->retrieve_all;
	my @aa_fields = $chapter_admin[0]->columns;
	foreach (@chapter_admin) {
		print_fields ($_, "chapter_admin", @aa_fields);
	}

	my @school_access = Tab::ChapterAccess->retrieve_all;
	my @sa_fields = $school_access[0]->columns;
	foreach (@school_access) { 
		print_fields ($_, "school_access", @sa_fields);
	}

	my @student = Tab::Student->retrieve_all;
	my @student_fields = $student[0]->columns;
	foreach (@student) {
		print_fields ($_, "student", @student_fields);
	}

	my @tourn_classes = $tourn->columns;
	print_fields ($tourn, "tournament", @tourn_classes);
	
	my $location = $tourn->location;
	my @loc_fields = $location->columns;
	print_fields ($location, "location", @loc_fields);
	
	my @rooms = $location->rooms;
	foreach my $room  (@rooms) { 
	
		my @blocks = $room->blocks;
		
		foreach my $block (@blocks) { 
			my @fields = $block->columns;
			print_fields ($block, "roomblock", @fields);
		}
		
		my @fields = $room->columns;
		print_fields ($room, "room", @fields);
	}
	
	my @changes = $tourn->changes;
	
	foreach my $change (@changes) { 
		my @fields = $change->columns;
		print_fields ($change, "change", @fields);
	}	
	
	my @groups = $tourn->groups;
	
	foreach my $group (@groups) { 
		
		my @judges = $group->judges;
		
		foreach my $judge (@judges) { 
		
			my @strikes = $judge->strikes;
		
			foreach my $strike (@strikes) {
				my @fields = $strike->columns;
				print_fields ($strike, "strike", @fields);
			}	
		
			my @judge_classes = $judge->judge_classes;

			foreach my $judge_class (@judge_classes) {
				my @fields = $judge_class->columns;
				print_fields ($judge_class, "judge_class", @fields);
			}	
		
			my @fields = $judge->columns;
			print_fields ($judge, "judge", @fields);
		}
		
		my @fields = $group->columns;
		print_fields ($group, "group", @fields);
	}
	
	
	my @settings = $tourn->settings;
	
	foreach my $setting (@settings) { 
		my @fields = $setting->columns;
		print_fields ($setting, "setting", @fields);
	}
	
	my @regions = $tourn->regions;
	
	foreach my $region (@regions) { 
		my @fields = $region->columns;
		print_fields ($region, "region", @fields);
	}
	
# CFL Dioceses 

	if ($circuit->diocese_based) { 
	
		my @dioceses = Tab::Region->search( diocese => 1);
		foreach my $diocese (@dioceses) { 
			my @fields = $diocese->columns;
			print_fields ($diocese, "diocese", @fields);			
		}
	}


	my @flights = $tourn->flights;
	
	foreach my $flight (@flights) { 
		my @fields = $flight->columns;
		print_fields ($flight, "flight", @fields);
	}
	
	my @timeslots = $tourn->timeslots;
	
	foreach my $timeslot (@timeslots) { 
		my @fields = $timeslot->columns;
		print_fields ($timeslot, "timeslot", @fields);
	}

	my @quals = $tourn->quals;
	
	foreach my $qual (@quals) { 
		my @fields = $qual->columns;
		print_fields ($qual, "qual", @fields);
	}	 
	
	my @schools = $tourn->schools;
	
	foreach my $school (@schools) { 
		
		my @fines = $school->fines;
		
		foreach my $fine (@fines) { 
			my @fields = $fine->columns;
			print_fields ($fine, "fine", @fields);
		}		
		
		my @fields = $school->columns;
		print_fields ($school, "school", @fields);
	}
	
	my @classes = $tourn->classes;
	
	foreach my $class (@classes) {
		my @fields = $class->columns;
		print_fields ($class, "class", @fields);	
	
		my @events = $class->events;
		foreach my $event (@events) {
			my @fields = $event->columns;
			print_fields ($event, "event", @fields);	
		
			my @entries = $event->entries;
			
			foreach my $entry (@entries) { 
				my @fields = $entry->columns;
				print_fields ($entry, "entry", @fields);	
			}
			
			my @rounds = $event->rounds;
			
			foreach my $round (@rounds) { 
				my @fields = $round->columns;
				print_fields ($round, "round", @fields);			

				my @panels = $round->panels;			
				
				foreach my $panel (@panels) {
					my @fields = $panel->columns;
					print_fields ($panel, "panel", @fields);			
				
					my @ballots = $panel->ballots;
	
					foreach my $ballot (@ballots) {
						my @fields = $ballot->columns;
						print_fields ($ballot, "ballot", @fields);			
					}
				
				}
			
			}

		}	

	}
	
	 
sub print_fields {
	my ($obj, $name, @fields) = @_;
	print FILE "\"$name\"";
	foreach my $field (@fields) {
		next if $field eq "password";
		my $value = $obj->$field;
		print FILE ",\"$value\""
	}
	print FILE "\n";
}


	close FILE;

	`$Tab::bzip2 $Tab::file_root/tmp/tourn-$tourn_id-save.tab`;
	`mv $Tab::file_root/tmp/tourn-$tourn_id-save.tab.bz2 $Tab::file_root/tmp/tourn-$tourn_id-save.tbo`;

	$m->redirect("$Tab::url_prefix/tmp/tourn-$tourn_id-save.tbo");


</%init>



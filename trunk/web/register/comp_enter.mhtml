<%args>
	$league
	$account
	$event_id
	$school_id
	$err => undef
</%args>

<%init>
	my $school = Tab::School->retrieve($school_id);
	my $event = Tab::Event->retrieve($event_id);	
	my $tourn = $event->tournament;

	my @already_entered = Tab::Comp->search( 
			school => $school_id, 
			event => $event_id, 
			dropped => 0);

	my @dropped = Tab::Comp->search(
            school => $school_id,
            event => $event_id,
            dropped => 1);

	my $caphit;
	
	$caphit++ if (
		((scalar @already_entered) >= ($event->school_cap)) && 
		($event->school_cap > 0) );

	$caphit++ if (
		((scalar Tab::Comp->search(event => $event->id, dropped => 0)) >= 
			($event->cap)) && ($event->cap > 0)) ;

	my @tourn_acc = Tab::AccountAccess->search( account => $account->id, tournament => $tourn->id);

	push (@tourn_acc, $account->id) if $tourn->director->id == $account->id;

	my @league_admin = Tab::LeagueAdmin->search( account => $account->id, league => $league->id );

   	my $chapter = $school->chapter;
    my @acc = Tab::ChapterAccess->search( 
		account => $account->id, chapter => $chapter->id );

    my $region = $chapter->region($league) if $league->region_based;

    unless (@acc || $account->site_admin || @tourn_acc || @league_admin || 
	($region && $region->director && $region->director->id  == $account->id)) {
        $m->print("
		<h3>Error:</h3><center><br><br><p><b>
		You are not authorized to edit ". $chapter->name ."</p></b>");
        $m->abort;
    }

	my @clean_students = $m->comp("/funclib/students_evententer.mas", 
			event => $event, 
			league => $league, 
			tourn => $tourn, 
			chapter => $chapter);

	@clean_students = sort {ucfirst($a->last) cmp ucfirst($b->last)} @clean_students;
	
</%init>

    <& menubar.mas, school => $school, whoami => "judges", tourn => $tourn &>

	<div id="leftbignb">

		<h3>
			<% $event->name %>
		</h3>

		<table cellpadding="4" cellspacing="1"  width="100%">

%		my $first_dropped;
%		my $switch;

% 		foreach my $already (@already_entered, @dropped) { 

% 			if ($already->dropped == 1 && not defined $first_dropped) { 

				</table>
	
				<h4>Dropped Entries:</h4>
				<table cellpadding="4" cellspacing="1" width="100%">

% 				$first_dropped++;

% 			}

% 	if ($event->team == 1) { 	

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<td>
				<a class="whiteblock" href="/register/comp_edit.mhtml?event_id=<% $already->event->id%>&comp_id=<%$already->id %>">
					<% $already->code %>
				</a>
			</td>

			<td>
				<a class="whiteblock" href="/register/student_edit.mhtml?event_id=<% $already->event->id%>&student_id=<% $already->student->id %>">
					<% $already->student->first %> <% $already->student->last %>
				</a>
			</td>
			
			<td>
				<a class="whiteblock" href="comp_<% ($already->dropped == 1) ? "un" : "" %>drop.mas?comp_id=<% $already->id %>&from=comp_enter">
					<% ($already->dropped == 1) ? "Undrop" : "Drop" %>
				</a>
			</td>

% 			if ($already->dropped == 1)  {

				<td>
					<a class="whiteblock" href="comp_rm.mas?comp_id=<% $already->id %>&from=comp_enter">
						Delete
					</a>
				</td>

%			}

		</tr>
%	}

%	if ($event->team == 2) { 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<td>
				<a class="whiteblock" href="/register/comp_edit.mhtml?event_id=<% $already->event->id%>&comp_id=<%$already->id %>">
				<% $already->code %>
				</a>
			</td>

		    <td>
				<a class="whiteblock" href="/register/student_edit.mhtml?event_id=<% $already->event->id%>&student_id=<% $already->student->id %>">
					<% $already->student->first %> <% $already->student->last %>
				</a>
			</td>
			
			<td align="center">
				&
			</td>
			
			<td>
				<a class="whiteblock" href="/register/student_edit.mhtml?event_id=<% $already->event->id%>&student_id=<% $already->partner->id %>">
					<% $already->partner->first %> <% $already->partner->last %>
				</a>
			</td>

			<td>
				<a class="whiteblock" href="comp_<% ($already->dropped == 1) ? "un" : "" %>drop.mas?comp_id=<% $already->id %>&from=comp_enter">
					<% ($already->dropped == 1) ? "Undrop" : "Drop" %>
				</a>
			</td>

% 			if ($already->dropped == 1)  {

				<td>
					<a class="whiteblock" href="comp_rm.mas?comp_id=<% $already->id %>&from=comp_enter">
						Delete
					</a>
				</td>

%			}
			
		</tr>
%	}

% if ($event->team == 3) { 

<form action="<% ($already->dropped == 1) ? "comp_undrop.mas" : "comp_drop.mas" %>" method="post">
<input type="hidden" name="comp_id" value="<% $already->id %>">
<input type="hidden" name="from" value="comp_enter"> 
<tr>
	<td><% $already->code %>.</td>
    <td><% $already->name %>
	<a href="<% $Tab::url_prefix %>/prereg/already_enter.mhtml?already_id=<% $already->id %>"><% scalar $already->members %> Students</a></td>

	<td><input class="blue" type="submit" value="<% ($already->dropped == 1) ? "Undrop" : "Drop" %>"></td>
	</form>
	<% ($already->dropped == 1) ? "
		<form action=\"comp_rm.mas\" method=\"post\">
		<input type=\"hidden\" name=\"comp_id\" value=\"".$already->id."\"> 
		<input type=\"hidden\" name=\"from\" value=\"comp_enter\"> 
		<td>
		<input type=\"submit\" value=\"Delete\"></td>
		</form>
		" : "" %>
</tr>
</form>

%	}

% } #end of foreach my already

		</table>

	</div>

	<div id="rightsmall">

		<a class="blueblock" href="entries.mhtml?school_id=<% $school->id %>&tourn_id=<% $tourn->id %>">
			Return to <% $school->name %>
		</a>

		<br />

% 		if (@clean_students || $event->team == 3)  { 

  			<h4>New entry</h4>

%			if ($caphit) { 
				<p class="warning">
					Warning: Cap hit
				</p>
% 			}
	
			<table cellpadding="5" width="100%" cellspacing="1">

% 			if ($event->team == 1) {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						1:
					</td>
			
					<td>
						<form action="comp_save.mas" method="post">
						<input type="hidden" name="event_id" value="<% $event->id %>">
						<input type="hidden" name="school_id" value="<% $school->id %>">

						<select name="student_id">
%   						foreach my $student (@clean_students) { 
								<option value="<%$student->id%>">
									<% $student->first." ".$student->last %>
								</option>
%   						}
						</select>

					</td>
				</tr>
				
				<tr class="liblrow">
					<td class="right" colspan="2">
						<input class="blue" type="submit" value="  Enter  ">
						</form>
					</td>
				</tr>
%			} 

% 			if ($event->team == 2) { 

%				undef($switch);

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						<form action="comp_save.mas" method="post">
						<input type="hidden" name="event_id" value="<% $event->id %>">
						<input type="hidden" name="school_id" value="<% $school->id %>">
				 		1:
					</td>
			
					<td>
						<select name="student_id">
	
%							foreach my $student (@clean_students) { 
								<option value="<%$student->id%>">
									<% $student->first." ".$student->last %>
								</option>
%   						}

						</select>
					</td>

				</tr>

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						2:
					</td>
			
					<td>
						<select name="partner_id">
%   						foreach my $student (@clean_students) { 
								<option value="<%$student->id%>">
									<% $student->first." ".$student->last %>
								</option>
%   						}
						</select>
					</td>

				</tr>

% 				if ($league->apda_seeds) { 
				
					<tr>
						<td>
							Seeding:
						</td>
						
						<td>
							<select name="apda_seed">
								<option value="4">None</option>
								<option value="1">Full</option>
								<option value="2">Half</option>
								<option value="3">Free</option>
							</select>
						</td>
					</tr> 
					
					<tr>
						<td>
							Designation:
						</td>
						
						<td>
							<input type="text" name="name" size="3">
						</td>
					</tr>
	
% 				}

				<tr class="liblrow">
					<td colspan="2" align="right">
						<input class="blue" type="submit" value="Enter">
						<form>
					</td>
				</tr>
% 			} 

% 			if ($event->team == 3) { 
	
				<tr>
					<td>
						Team name:
					</td> 
					
					<td>
						<form action="comp_save.mas" method="post">
						<input type="hidden" name="event_id" value="<% $event->id %>">
						<input type="hidden" name="school_id" value="<% $school->id %>">
						<input type="text" size="30" name="name">
					</td> 
					
					<td>
						<input class="blue" type="submit" value="Enter">
						</form>
					</td> 
				</tr>

% 			}
		
		</table>

% 		} else { 

			<h4>No Further Entry Permitted</h4>
	
			<p>
				There are no more students who can enter this event cleanly.
			</p>
% 		} 

		<br />

		<a class="redblock" href="/register/student_edit.mhtml?school_id=<% $school_id %>&event_id=<% $event_id %>">
			Add Students To School
		</a> 

	</div>


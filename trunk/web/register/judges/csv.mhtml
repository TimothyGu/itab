<%args>
	$league
	$tourn
	$account
	$session
	$group_id => 0
</%args>
<%init>

	my @groups = $tourn->groups unless $group_id;
	push (@groups, Tab::JudgeGroup->retrieve($group_id)) if $group_id;

	@groups = sort {$a->abbr cmp $b->abbr} @groups;

	my $string = $groups[0]->abbr if $group_id;
	$string = "all-groups" unless $group_id;

	my $filename = $Tab::file_root."/tmp/judges-".$string."-".$session->id;
	my $garbage = `rm -f $filename.*`;

	open (CSVOUT, ">$filename.csv");

	print CSVOUT "Group,";
	print CSVOUT "Code,";
	print CSVOUT "Group," unless $group_id;
	print CSVOUT "DioCode," if $league->diocese_based;
	print CSVOUT "Diocese," if $league->diocese_based; 
	print CSVOUT "RegCode," if $league->region_based;
	print CSVOUT "Region," if $league->region_based;
	print CSVOUT "Schcode," unless $league->diocese_based;
	print CSVOUT "School,";
	print CSVOUT "First,Last,";
	print CSVOUT "Rating,";

	print CSVOUT "Active,";
	print CSVOUT "Notes,";
	print CSVOUT "Special Duty\n";

	foreach my $group (@groups) { 

		my @judges = sort {$a->code <=> $b->code} $group->judges;
		@judges = sort {$a->active <=> $b->active} @judges;

		foreach my $judge (@judges) { 

			print CSVOUT &Tab::texify($judge->judge_group->abbr).",";
			print CSVOUT &Tab::texify($judge->code).",";
			print CSVOUT &Tab::texify($group->abbr)."," unless $group_id;

			if ($league->region_based && $judge->school && $judge->school->region) { 
				print CSVOUT &Tab::texify($judge->school->region->name).",";
				print CSVOUT &Tab::texify($judge->school->region->code).",";
			}

			if ($league->diocese_based) { 
				print CSVOUT &Tab::texify($judge->school->region->code).",";
				print CSVOUT &Tab::texify($judge->school->region->name).",";
			} else { 
				print CSVOUT &Tab::texify($judge->school->code).",";
			}

			print CSVOUT "\"".&Tab::texify($judge->school->name)."\",";
			print CSVOUT &Tab::texify($judge->first).",";
			print CSVOUT &Tab::texify($judge->last).",";

			if ($group->coach_ratings) { 
		
				print CSVOUT "\"";
				my $notfirst;

				if ($group->qual_subsets) { 
					foreach my $subset ($group->qual_subsets) {
						my $rating = $judge->rating($subset);
						next unless $rating;
						print CSVOUT "-" if $notfirst;
						print CSVOUT $rating->name;
						$notfirst++;
					}
				} else { 
					my $rating = $judge->rating;
					print CSVOUT $rating->name if $rating;
				}
	
				print CSVOUT "\",";
			} else {

				print CSVOUT ",";

			}
		
			print CSVOUT "Y," if $judge->active;
			print CSVOUT "N," unless $judge->active;
	
			print CSVOUT "\"".&Tab::texify($judge->notes)."\",";
			print CSVOUT "\"".&Tab::texify($judge->special),"\"\n";

		}

	}

	close CSVOUT;

	$m->redirect("$Tab::url_prefix/tmp/judges-".$string."-".$session->id.".csv");

</%init>

<div id="content">

<p><% $filename %></p>

<%args>
	$session
	$tourn
	$circuit
	$debug => undef
</%args>
<%init>

	$debug = 1;

	my $path = $Tab::file_root."/tmp/judgecards-".$tourn->id."-".$session->id."/";
	my $masterfile  = $path."judgecards-all";

	my $master_string;

	system "/bin/mkdir -p $path";

	my @dioceses = sort {$a->code cmp $b->code} $tourn->regions;
	@dioceses = sort {length($a->code) <=> length($b->code)} @dioceses;

	foreach my $diocese (@dioceses) { 

		my $filename = $diocese->code."-judgecards";
		my $filepath = $path.$filename;

		my $garbage = `rm -f $filepath.*`;
		open (TEXOUT, ">$filepath.tex");

	print TEXOUT <<"EOF";
\\documentclass[10pt]{report}
\\usepackage{fullpage}
\\usepackage{times}
\\usepackage{nopageno}
\\usepackage{colortbl}
\\usepackage[hmargin=.5in,vmargin=.75in]{geometry}
\\renewcommand{\\arraystretch}{1.4}
\\begin{document}
\\begin{center}
EOF

		close TEXOUT;

		my $switch;

		foreach my $judge (sort{$a->code <=> $b->code} $diocese->judges($tourn)) {


			$m->comp("/funclib/judge_info_card.mas", 
				judge_id => $judge->id, 
				filename => $filepath);

			unless ($switch++ % 2) {
		
				open (TEXOUT, ">>$filepath.tex");
				print TEXOUT " - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  \\\\ \n";
				close TEXOUT;

			}

			last if $switch > 10;
		}
	
		open (TEXOUT, ">>$filepath.tex");
		print TEXOUT "\\end{center}\n";
		print TEXOUT "\\end{document}\n";
		close TEXOUT;

		$garbage = `cd $path; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
		#`rm -f $filepath.tex $filepath.log $filepath.dvi $filepath.aux`;

		$master_string .= " $filename.pdf";

	}

	system `cd $path; $Tab::gs_path -dNOPAUSE -sDEVICE=pdfwrite -sOUTPUTFILE=$masterfile.pdf -dBATCH $master_string`;

	system "$Tab::logger $Tab::gs_path $master_string " if $debug;

	$m->redirect("$Tab::url_prefix/tmp/judgecards-".$tourn->id."-".$session->id."/judgecards-all.pdf")

</%init>

<%args> 
	$tourn
	$circuit
	$chapter_id => undef
	$school_id => undef
	$account
	$err => undef
</%args>

<%init>
	use POSIX;

	my $chapter;
	my $school;

	unless ($school_id || $chapter_id) { 
		$err = "You have accessed the registration page incorrectly.  Please try again.";
		$m->redirect("$Tab::url_prefix/register/registration.mhtml?err=$err");
	}

	if ($chapter_id) { 

		$chapter = Tab::Chapter->retrieve($chapter_id);

	}

	if ($school_id) {
		
		$school = Tab::School->retrieve($school_id);
		$chapter = $school->chapter;

	}

	my $region = $chapter->region($circuit) if $circuit->region_based;

	my @events = $m->comp("/funclib/tourn_events.mas", tourn => $tourn);
	@events = sort { $a->name cmp $b->name } @events;
	my @groups = sort {$a->name cmp $b->name} $tourn->groups;

</%init>

<p><font color="red"><% $err %></font></p>

<table width="100%">
<td width="100%">
<h3><% $school->chapter->name %>'s entry in <% $tourn->name %></h3>
</td>

% if ($circuit->diocese_based) { 
<form action="diocese_schools.mhtml" method="post">
<input type="hidden" name="diocese" value="<% $school->region->id %>">
<td><input  type="submit" value="Return to Diocese"></td>
</form>
% } else { 
<form action="registration.mhtml" method="post">
<input type="hidden" name="school_id" value="<% $school_id %>">
<td><input  type="submit" value="Return to School"></td>
</form>
% }

</table>


<form action="comp_enter.mhtml" method="post"> 
<input type="hidden" name="school_id" value="<% $school->id %>">

<div id="halfpage" style="float: left; border-right: 1px solid black;">

<h4>Students</h4>

<table cellpadding="3" border="0" width="100%">

<td align="right">Add/Edit:</td>
<td><select name="event_id">
%	foreach my $event (@events) { 
	<option value="<% $event->id %>"><% $event->name %></option>
% }
	</select></td>
	<td align="right"><input  type="submit" value="Add/Edit"></td>
</td>
</tr>
</form>
</table>

<table cellpadding="6" border="0" width="100%" cellspacing="0">


% my $switch;

%	my $total_comps;

% foreach my $event (@events) { 

% my @comps = Tab::Comp->search( 
%			event => $event->id, 
%			school => $school->id );
%	next unless @comps;

%	$total_comps = $total_comps + scalar @comps;

% $switch++;
<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

<th><a id="<% $event->id %>" name="<%$event->id%>"><% $event->abbr %>:</th>

%	my $notfirst;

% 	@comps = sort { $a->student->last cmp $b->student->last } @comps;

% 	foreach my $comp (@comps) { 
%		my $student = $comp->student;

%		if ($notfirst) { 
%			$switch++;
			<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			<td></td>
%		}

%		$notfirst++;
		<td><% $comp->code %></td>
		
%	if ($event->team == 1 || $event->team == 2) { 
		<td>
		<a href="<% $Tab::url_prefix %>/register/student_edit.mhtml
			?event_id=<% $event->id %>&student_id=<% $student->id %>">
		<% ($event->team == 1) ? $student->first : "" %>
		<% $student->last %></a> 
%  }

%	if ($event->team == 2) { 
		& <a href="<% $Tab::url_prefix %>/register/student_edit.mhtml?
			event_id=<% $event->id %>&student_id=<% $comp->partner->id %>">
		<% $comp->partner->last %></a> </td>
% 	}

%	if ($event->team == 3) { 
		<td><% $comp->name %></td>
% }

		<td><% ($comp->waitlist) ? "Waitlist" : "" %>
			<% ($comp->dq) ? "Disqualified" : "" %>
			<% ($comp->dropped) ? "Dropped" : "" %> </td>
		<td>
		(<a href="<% $Tab::url_prefix %>/register/entry/edit.mhtml
			?comp_id=<% $comp->id %>">Edit</a>)</td>

% if ($comp->dropped) { 
		<td>
		(<a href="<% $Tab::url_prefix %>/register/comp_undrop.mas?comp_id=<% $comp->id %>&from=list">Undrop</a>)
		</td>
% 	} else { 
		<td>
		(<a href="<% $Tab::url_prefix %>/register/comp_drop.mas?comp_id=<% $comp->id %>&from=list">Drop</a>)
		</td>
% }

		</tr>
%   }
%}


<tr><td colspan="6"><h4></h4></td></tr>

</table>
</div>

<div id="halfpage" style="float: right;">

<h4>Judges</h4>

<table cellpadding="3" border="0" width="100%">
<form action="judge_add.mhtml" method="post">
<input type="hidden" name="school_id" value="<% $school->id %>">
<td align="right">Add:</td>
<td><select name="group_id">
%	foreach my $group (@groups) { 
	<option value="<% $group->id %>"><% $group->name %></option>
% }
	</select></td>
	<td align="right"><input  type="submit" value="Add"></td>
</td>
</tr>
</form>
</table>

<table cellpadding="5" width="100%" border="0">

<%perl>

foreach my $group (@groups) { 

#	my $judge_obligation = $m->comp("/funclib/judge_obligation.mas", 
#			circuit => $circuit,
#			group => $group,
#			school => $school);

	my @useful_judges = $m->comp("/funclib/useful_judges.mas",
			group => $group,
			school => $school);

	my @useless_judges = $m->comp("/funclib/useless_judges.mas",
			group => $group,
			school => $school);

	next unless @useful_judges || @useless_judges;

</%perl>

<tr>

% $switch = 0;

% $switch++;
<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
<th><% $group->abbr %>:</td>

% my $notfirst;
	
% foreach my $judge (@useful_judges) { 


%	if ($notfirst) {
% 		$switch++;
		<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		<td></td>
%	}

	<td><% $judge->code %></td>
	<td><% $judge->first." ".$judge->last%></td>
	<td>(<a href="judge_edit.mhtml?judge_id=<% $judge->id %>">Edit</a>)</td>
	<td>(<a href="judge_drop.mhtml?judge_id=<% $judge->id %>">Drop</a>)</td>
	</tr>

%	$notfirst++;

% } 

% foreach my $judge (@useless_judges) { 

%	if ($notfirst) { 
		<tr><td></td>
%	}

%	$notfirst++;

	<td><% $judge->code %></td>
	<td><% $judge->first." ".$judge->last%></td>
	<td><b>Warning: Useless Judge, Not Qualified In Anything</b></td>
	<td>(<a href="judge_edit.mhtml?judge_id=<% $judge->id %>">Edit</a>)</td>
	<td>(<a href="judge_drop.mhtml?judge_id=<% $judge->id %>">Drop</a>)</td>
	</tr>
% } 

% 	if ($group->track_judge_hires) { 

	<& "/prereg/hire_requests.mas", school => $school, group => $group &>

% 	}


% }  #end of foreach group
<tr><td colspan="6"><h4></h4></td></tr>

</table>
</div>

%	my $height = 35 * $total_comps;
%	$height = 400 if $height < 400;


<div id="body" style="height: <% $height %>px;"></div>

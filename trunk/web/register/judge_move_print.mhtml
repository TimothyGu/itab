<%args>
	$circuit
	$tourn
</%args>
<%init>

	my @moved_judges = Tab::Change->search( 
			tournament => $tourn->id, 
			type => "judge", {order_by => 'timestamp'});

	my %sortpanels = ();
	
	foreach my $mj (@moved_judges) { 
		$sortpanels{$mj->id} = $mj->moved_from if $mj->moved_from;
		$sortpanels{$mj->id} = $mj->panel if $mj->panel;
	}


	@moved_judges = sort {eval{$a->panel->id} <=> eval{$b->panel->id}} @moved_judges;
	@moved_judges = sort {$sortpanels{$a->id}->letter cmp $sortpanels{$b->id}->letter} @moved_judges;
	@moved_judges = sort {$b->timestamp->epoch <=> $a->timestamp->epoch} @moved_judges;
	@moved_judges = sort {$a->panel <=> $b->panel} @moved_judges;

	my $switch;

</%init>

<table width="100%">

<tr>

<td width="100%">
	<h3>Judges Moved</h3>
</td>

<td>
	<form action="clear_judge_moves.mas" method="post">
	<input type="submit" value="Clear All Judge Move Records">
	</form>
</td>

</table>

<table cellpadding="4" cellspacing="1" width="99%">

<tr class="liblrow"> 
	<th>Judge</th>
	<th>Name</th>
	<th></th>
	<th>Event</th>
	<th>Round</th>
	<th>Section</th>
	<th width="20%">Room</th>
	<th>Fine?</th>
	<th colspan="2">Time Made</th>
	<th>Clear Record</th>
</tr>

%	foreach my $move (@moved_judges) { 

%		next unless $move->judge->id;

%		my $timestamp = $move->timestamp;
%  		$timestamp->set_time_zone($tourn->tz);

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%		if ($move->panel) { 

			<th style="text-align: center;">
%				if ($move->judge) { 
					(<a href="<% $Tab::url_prefix %>/register/judge_edit.mhtml?judge_id=<% $move->judge->id %>"><% ($move->judge && $move->judge->school) ? $move->judge->school->code : "" %> <% ($move->judge) ? $move->judge->code : "" %></a>)
%				}
			</th>

			<td>
%				if ($move->judge) { 
					<% $move->judge->first." ".$move->judge->last %>
%				}
			</td>

			<th style="padding-left: 10px;">
				Add:
			</th>

			<td align="center">
				<% ($move->panel->round) ? $move->panel->round->event->abbr : "" %>
			</td>

			<td align="center">
				<% ($move->panel->round) ? $move->panel->round->name : "" %>
			</td>

			<td align="center">
				<% $move->panel->letter %>
			</td>

			<td align="center">
				<% ($move->panel->room) ? $move->panel->room->name : "" %>
			</td>

			<td>
			</td>

%		} elsif ($move->moved_from) { 

			<th style="padding-left: 10px;">
				Remove:
			</th>

			<td colspan="2">
				<% $move->regline %>
			</td>

			<td align="center">
				<% ($move->moved_from->round) ? $move->moved_from->round->event->abbr : "" %>
			</td>

			<td align="center">
				<% ($move->moved_from->round) ?  $move->moved_from->round->name : "" %>
			</td>

			<td align="center">
				<% $move->moved_from->letter %>
			</td>

			<td align="center">
				<% ($move->moved_from->room) ? $move->moved_from->room->name : "" %>
			</td>

			<td align="center">
%				if ($circuit->diocese_based && $move->judge && $move->judge->school) { 
					<a href="<% $Tab::url_prefix %>/register/dio_invoice.mhtml?diocese_id=<% $move->judge->region->id %>">
%				} elsif ($move->judge->school) { 
					<a href="<% $Tab::url_prefix %>/register/school_invoice.mhtml?schoo_id=<% $move->judge->school->id %>">
%				}

				<% ($move->fine) ? "Fine: ".$move->fine->amount : "" %></a>
			</td>

%		}

    <td>
%   if ($timestamp) {
%       $timestamp->set_time_zone($tourn->tz);
        <% ($timestamp) ? $timestamp->month."/".$timestamp->day." </td><td>
            ". $timestamp->hour_12.":".$timestamp->strftime('%M')." 
            ".$timestamp->strftime('%p') : "" %>
%   }
    </td>

    <th style="text-align: center">
	        (<a href="change_rm.mas?change_id=<% $move->id %>">Clear</a>)
	</td>


	

	</tr>

%	}

</table>




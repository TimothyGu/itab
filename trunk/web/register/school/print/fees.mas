<%args>
	$school
	$filename
</%args>
<%init>

	my $filepath = $Tab::file_root."/tmp/".$filename;

	use POSIX;

	my $tourn  = $school->tourn;

    my $now = DateTime->now;
    $now->set_time_zone($tourn->tz);

	my ($total, $feline_ref) = $m->comp("/funclib/school_fees.mas", school_id => $school->id);

	my @felines = @{$feline_ref};

	my $owed = $total - $school->paid;

	my $name;

	if ($owed > 0) { $name = "Invoice"; } else { $name = "Receipt"; }

	open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "{\\LARGE\\bf Tournament Fees ". $name." }\\\\ \n";

	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT " \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\small\n";

	print TEXOUT "\\begin{tabular}{p{1in}p{2.75in}p{1in}p{2in}}\n";

	print TEXOUT "{\\bf School:} & ". &Tab::texify($school->name) ." & ";
	print TEXOUT "{\\bf Entry Number:} & ".sprintf('%05d', $school->id) ."\\\\ \n";

	print TEXOUT "{\\bf Tournament:} & ". &Tab::texify($tourn->name) ." & ";
	print TEXOUT "{\\bf Circuits:} & ";

	foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn, circuit => 1)) { 
		print TEXOUT &Tab::texify($circuit->abbr)." ";
	}

	print TEXOUT " \\\\ \n";

	print TEXOUT "{\\bf Contacts:} & ";

	foreach my $contact ($m->comp("/funclib/tourn_admins.mas", tourn => $tourn, contact => 1)) { 
		print TEXOUT &Tab::texify($contact->first." ".$contact->last." ");
	}

	print TEXOUT " & ";

	print TEXOUT "{\\bf $name Printed:} & ";
	print TEXOUT $now->month."/".$now->day."/".$now->year." ";
	print TEXOUT $now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p')." \\\\ \n";

	print TEXOUT "\\end{tabular} \n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT " \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";


	print TEXOUT <<'EOF';
\tt
\begin{tabular}{p{4.75in}p{1.75in}}
\rowcolor[rgb]{1,.95,.95} Category or Item & Fee \\
\end{tabular}
\newline
EOF

my $warn;
my $count = 1;

foreach my $line (sort { $a->{"warn"} <=> $b->{"warn"} } @felines) {

	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";

	if ($line->{"warn"}) { 

		print TEXOUT "\\\\ \n" unless $warn;
		$warn++;
		print TEXOUT "\\rowcolor[rgb]{1,.75,.75}\[5.5pt\]\[5.5pt\]\n" if $line->{"warn"};

	} else { 
	    print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($count++ % 2);
	}

	print TEXOUT &Tab::texify($line->{'name'})." & ";
	print TEXOUT "\\\$".sprintf ("%.2f", $line->{'fee'}) if $line->{'fee'};
	print TEXOUT "\\\\ \n \\end{tabular}\n";
	print TEXOUT "\\newline\n";
}

if ($warn) { 

	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT "{\\bf       Please clear up the warnings and problems above to get an accurate invoice total.\n }";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

} else { 

	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";
    print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT '{\\bf TOTAL: } & \\$'. sprintf ("%.2f", $total)." \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";
	print TEXOUT '{\\bf PAID: } & \\$'. sprintf ("%.2f", $school->paid)." \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";
    print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT '{\\bf AMOUNT DUE: } & \\$'. sprintf ("%.2f", $owed)." \n " if $owed > 0;
	print TEXOUT '{\\bf PAID IN FULL, THANK YOU! } & \\$0.00 '."\n" unless $owed > 0;
	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\newline\n";

}

	print TEXOUT "\\sf\n";

	my $message = $tourn->setting("invoice_message");
	my $strip = HTML::Strip->new();
	$message = $strip->parse($paradigm);
	$message =~ s/[^[:ascii:]]//g;
	$message =~ s/^\s+//; 
	$message =~ s/\s+$//;
	my $newline = "\\newline\n";
	$message = Tab::texify($paradigm);
	$message =~ s/\R/$newline/g;

	if ($message) { 

		print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
		print TEXOUT " \\\\ \n";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";
		print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
		print TEXOUT $message if $message; 
		print TEXOUT " \\\\ \n";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";

	}

close TEXOUT;

</%init>

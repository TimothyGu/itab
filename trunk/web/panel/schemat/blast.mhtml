<%args>
	$tourn
	$round_id => undef
	$confirm => undef
	$message => undef
	$motion => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id) if $round_id;
	my $event = $round->event;

	if ($confirm) { 

		unless ($round) { 
			my $msg = "Pick a round plz";
			$m->redirect("/register/index.mhtml?msg=$msg");
		}

		my $preset = 1 unless $m->comp('/funclib/round_entries.mas', round => $round);

		if ( $event->type eq "speech" ) { 
			$m->comp("blast_speech.mas", round => $round, message => $message);
		}

		if ( $event->type eq "congress" ) { 
			$m->comp("blast_congress.mas", round => $round);
		}

		if ( $event->type eq "wudc" ) { 
			$m->comp("blast_wudc.mas", round => $round, message => $message, incl_motion => $motion);
		}

		if ( $event->type eq "debate" || $event->type eq "policy" || $event->type eq "ld" || $event->type eq "pf") { 
			$m->comp("blast_debate.mas", round => $round, message => $message);
		}

		my $tz = $tourn->tz;
		$tz = "UTC" unless $tz;
		my $now = DateTime->now( time_zone => $tz);

		$round->blasted($now);
		$round->update;

		my $msg = "Email and text notices sent for round ".$round->label;
		$m->redirect("show.mhtml?round_id=".$round->id."&msg=$msg");

	}


</%init>

	<div class="left huge">

		<h2>Blast Pairing</h2>

		<p>This will send individual email and text assignments to all the students in <% $round->realname %> of <% $round->event->name %></p>

		<form action="blast.mhtml">
		<input type="hidden" name="round_id" value="<% $round->id %>">

		<span class="block evenrow">
			Include a short message to recipients: 
			<input type="text" name="message" maxlength="50" size="40" style="margin-left: 30px;">
		</span>

%		if ($round->event->type eq "wudc") { 
			<div class="whitenohover padmuchmore centeralign">

				<span class="namespan">
					<label for "include">
						Include Motion:
					</label>
				</span>

				<span class="hundo">
					<input type="checkbox" class="largecheck" name="motion" id="include" value="1">
				</span>

				<span class="bigspan">
					<% $round->motion %>
				</span>

			</div>
%		}

		<span class="liblrow block rightalign">
			<input type="submit" name="confirm" value="Send email/text blast" placeholder="Max 50 characters">
			</form>
		</span>

	</div>

	<div class="right small">

		<div class="sidenote">

			<h4>Share & Enjoy</h4>

			<a class="blue block" href="show.mhtml?round_id=<% $round->id %>">
				Show Pairing
			</a>

			<a class="blue block" href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>">	
				Print Pairing
			</a>

			<a class="blue block" href="print_ballots.mhtml?round_id=<% $round->id %>">	
				Print Ballots
			</a>

			<a class="<% $round->published ? "dkgreen" : "blue"  %> block" href="publish.mhtml?round_id=<% $round->id %>">	
				Web: <% $round->published ? "PUBLISHED" : "NOT PUBLISHED" %>
			</a>

%			if ($event->type eq "wudc") { 
				<a class="<% $round->motion_published ? "dkgreen" : "blue"  %> block" href="publish.mhtml?round_id=<% $round->id %>&type=motion">	
					Motion on Web: <% $round->motion_published ? "PUBLISHED" : "NOT PUBLISHED" %>
				</a>
%			}



%			if ($round->type eq "elim" || $round->type eq "final") { 
				<a class="<% $round->listed ? "dkgreen" : "blue"  %> block" href="clearing.mhtml?round_id=<% $round->id %>">	
					Clearing list: <% $round->listed ? "PUBLISHED" : "NOT PUBLISHED" %>
				</a>
%			}

			<a class="dkblue block" href="blast.mhtml?round_id=<% $round->id %>">
				Send Email/text blast
			</a>

			<form action="post_results.mhtml" method="post">
			<input type="hidden" name="round_id" value="<% $round->id %>">

			<span class="noline block plain">

				<span class="leftfloat inline" style="padding-left: 1px;">
					Web Results
				</span>

				<span class="rightfloat inline padno">
					<select name="post" class="fixedtiny" onchange='this.form.submit()'>
						<option value="0" <% $round->post_results ? "" : "selected" %> >Not Public</option>
						<option value="1" <% $round->post_results == 1 ? "selected" : "" %>>Only <% $event->type eq "speech" || $event->type eq "congress" ? "Ranks" : "Win/Loss"%></option>
						<option value="2" <% $round->post_results == 2 ? "selected" : "" %>>Full Results</option>
					</select>

				<noscript>
					<input type="submit" value="Go" class="skinny">
				</noscript>
				</form>
				</span>
			</span>


		</div>

		<div class="sidenote">
			
			<h4>Change & Destroy</h4>

%				my $warn = "Danger, Will Robinson! You are about to repanel this round entirely.  Are you sure?";

				<a class="yellow block" <& "/funclib/confirm.mas", warn => $warn &> href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>">
					Re-pair this round entirely
				</a>

%				$warn = "Danger, Will Robinson! You are about to dump all the judges and re-assign them.  Are you sure?";
				<a class="yellow block"  <& "/funclib/confirm.mas", warn => $warn &>  href="/panel/round/judges.mhtml?round_id=<% $round->id %>">
					Re-pair this round's judges
				</a>

%				$warn = "Danger, Will Robinson! You are about to dump all the rooms and re-assign them.  Are you sure?";
				<a class="yellow block" <& "/funclib/confirm.mas", warn => $warn &> href="/panel/round/rooms.mhtml?round_id=<% $round->id %>">
					Re-pair this round's rooms
				</a>

%				if ($m->comp('/funclib/round_unbalanced.mas', round => $round) ) {
					<a class="dkgreen block" href="/panel/pair/rebalance.mhtml?round_id=<% $round->id %>" style="margin-top: 8px;">
						Rebalance this round
					</a>
%				}

%				$warn = "You are about to delete this ENTIRE ROUND.  You cannot get it back.  Please, for the love all that is good and holy, be certain you mean this";
				<a class="dkred block" style="margin-top: 8px;" <& "/funclib/confirm.mas", warn => $warn &> href="round_dump.mhtml?round_id=<% $round->id %>">
					Dump this round
				</a>
	
		</div>

		<div class="sidenote">

			<h4>Stats & Data</h4>

			<a class="blue block" href="show.mhtml?round_id=<% $round->id %>&done=1">
				Show Results
			</a>

			<span class="thirdblock">
				Paired:
			</span>

			<span class="twothirdblock">
				<% $round->created ? &Tab::nicedt($round->created->set_time_zone($tourn->tz)) : "Not recorded" %>
			</span>

			<span class="thirdblock">
				Finished: 
			</span>
			<span class="twothirdblock">
				<% $round->completed ? &Tab::nicedt($round->completed->set_time_zone($tourn->tz)) : "Not recorded" %>
			</span>

			<span class="thirdblock">
				Blasted:
			</span>
			<span class="twothirdblock">
				<% $round->blasted ? &Tab::nicedt($round->blasted->set_time_zone($tourn->tz)) : "Not yet blasted" %>
			</span>

		</div>

	</div>


<%args> 	
	$tourn
	$account
	$site_id => undef;
</%args> 
<%init> 

	my $site = Tab::Site->retrieve($site_id) if $site_id;

	my @sites;

	if ($site) { 

		push (@sites, $site);

	} else { 

		@sites = $m->comp("/funclib/tourn_sites.mas", tourn => $tourn);
	}

	
</%init> 

	<h2>Rooms Master:</h2>

	<table cellpadding="3" width="100%" cellspacing="1" border="0">

% 	foreach my $site (@sites) { 

<%perl>

		my @rooms = sort {$a->name cmp $b->name} $site->rooms;
		next unless @rooms;

		my @timeslots = sort { $a->start <=> $b->start } $site->timeslots_with_panels($tourn);
		my @panels = $site->panels($tourn);

		my %panels_by_ts_and_room = ();

		foreach my $panel (@panels) { 
			push (@{$panels_by_ts_and_room{$panel->timeslot->id."-".$panel->room->id}}, $panel);
		}

</%perl>

		<tr>
			<td align="center" colspan="110">
				<h3>
					<% $site->name %>
				</h3>
			</td>
		</tr>

		<tr class="liblrow">

			<th class="smaller" >
				Room
			</th>

			<th class="smaller">
				Notes
			</th>

%			foreach my $ts (@timeslots) { 
				<th class="smaller">
					<% $ts->name %>
				</th>
% 			}

		</tr>

<%perl>

		my %room_blocks = ();

		foreach my $room (@rooms) { 

			foreach my $block ($room->blocks(type => "timeslot")) { 

				my $block_key = $room->id."-".$block->timeslot->id;
				$room_blocks{$block_key}++;

			}
		}

</%perl>

%	my $switch;

%	ROOM:
% 	foreach my $room (@rooms) { 

%		my $block = "white block" if $switch % 2;
%		$block = "white block" unless $switch % 2;

%		if ($room->inactive) { 
			<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%		} else { 
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%		}

			<td class="smaller">
				<% $room->name %>
			</td>

			<td class="smaller">
				<% $room->notes %>
			</td>

% 			my @special = Tab::RoomBlock->search(room => $room->id, type => "special" ); 

%			if (@special) { 

				<th colspan="<% (scalar @timeslots) + 1 %>">
					<% $special[0]->special %>
				</th>
% 			}

% 			foreach my $ts (@timeslots) {

%    			my @panels = @{$panels_by_ts_and_room{$ts->id."-".$room->id}} if $panels_by_ts_and_room{$ts->id."-".$room->id};
%				my $block_key = $room->id."-".$ts->id;

				<td class="smaller">
%					foreach my $panel (@panels) {
%						next unless $panel->round->timeslot->id == $ts->id;
						<a class="<% $block %>" href="/panel/panel_selectroom.mhtml?backto=master&panel_id=<% $panel->id %>"><% $panel->event->abbr." ".$panel->letter %></a>
%  					}
		
					<% ($room_blocks{$block_key}) ? " <b>BLOCK</b> " : "" %>

				</td>

% 			}
		
			</tr> 
			
%	 	}  

%	}

</table>

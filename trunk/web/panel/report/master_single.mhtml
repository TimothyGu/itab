<%args> 
	$tourn
	$panel_id
	$session
</%args>
<%perl>

	my $panel = Tab::Panel->retrieve($panel_id);

	my $session_id = $session->id;
	my $filepath = $Tab::file_root."/tmp/";
	my $filename = "masters-".$panel_id."-".$session->id;
	my $whole_file = $filepath.$filename;
	my $garbage = `rm -f $filename.*`;

    open (TEXOUT, ">$whole_file.tex");

    print TEXOUT <<"EOF";
\\documentclass[10pt]{report}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{nopageno}
\\usepackage[hmargin=1.0in,vmargin=.5in]{geometry}
\\pagestyle{empty}
\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.5}
\\begin{document}
\\addtolength{\\hoffset}{-.1in}
EOF

	close TEXOUT;

	foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {
		$m->comp("/funclib/print_master.mas", judge_id => $judge->id, panel_id => $panel_id, filename => $filepath.$filename);
    	open (TEXOUT, ">>$whole_file.tex");
		print TEXOUT "\\pagebreak \n";
		close TEXOUT;
	}

    open (TEXOUT, ">>$whole_file.tex");

	print TEXOUT "\\end{document} \n";
	close TEXOUT;

	$garbage = `cd $filepath; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
   `rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;
	$m->redirect("$Tab::url_prefix/tmp/$filename.pdf");

</%perl>

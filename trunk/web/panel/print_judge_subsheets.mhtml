<%args>
	$circuit
	$event_id
	$timeslot_id
	$tourn
	$session
</%args>
<%init>

	use POSIX;

	my $now = DateTime->now;
	$now->set_time_zone($circuit->timezone);
	
	my $tourn_id = $tourn->id;

	my @events;
	if ($event_id eq "all") { 
		@events = $m->comp("/funclib/tourn_events.mas", tourn => $tourn);
	} else {
		my $event = Tab::Event->retrieve($event_id);
		push (@events, $event);
		$event_id = $event->abbr;
	}

 	my @timeslots;
	if ($timeslot_id eq "all") { 
		@timeslots = $tourn->timeslots;
	} else {
		push (@timeslots, Tab::Timeslot->retrieve($timeslot_id));
	} 

	@events = sort {$a->name cmp $b->name} @events;

	#Set up the filename and the needed trace files

     my $filename 
		= $circuit->short_name."-subsheets-".$timeslot_id."-".$event_id."-".$tourn->id."-".$session->id;
	 my $filepath = $Tab::file_root."/tmp/";
     my $garbage = `rm -f $filepath.$filename.*`;
     open (TEXOUT, ">$filepath"."$filename.tex");

	print TEXOUT <<'EOF';
\documentclass[10pt]{letter}
\usepackage{fullpage}
\usepackage{multirow}
\usepackage{colortbl}
\usepackage[hmargin=1in,vmargin=1.25in]{geometry}
\usepackage{helvet}
\renewcommand{\familydefault}{\sfdefault}
\renewcommand{\arraystretch}{1.4}
\begin{document}
\addtolength{\textwidth}{1in}
\addtolength{\voffset}{-.5in}
\begin{center}
EOF

    print TEXOUT "\\medskip\n";
    print TEXOUT "\\begin{tabular}{cccc}\n";
	print TEXOUT "\\multicolumn{4}{c}{\\Large Judge Substititon Sheets}\\\\ \n";
    print TEXOUT "\\small {\\bf Tournament}: & \\small ".&Tab::texify($tourn->name)." & ";
    print TEXOUT "\\small {\\bf Printed}: & \\small ". $now->day_abbr." ".$now->month_name." ".$now->day.", ".$now->year." ".$now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p')." \\\\ \n";
    print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\end{center}\n";

	close TEXOUT;

	foreach my $event (@events) { 

		foreach my $timeslot (@timeslots) { 
		
			my @rounds = Tab::Round->search( timeslot => $timeslot->id, event => $event->id );

			next unless @rounds;

			foreach my $round (@rounds) {

			    $m->comp("print_subsheet.mas",
	        	    round_id => $round->id,
	       			filename => $filename,
	           		filepath => $filepath,
	            	circuit => $circuit);
	
			} # end of foreach round

		} # end of foreach timeslot

	} # end of foreach event

    open (TEXOUT, ">>$filepath"."$filename.tex");
	print TEXOUT "\\end{document} \n";
	close TEXOUT;

	$garbage = `cd $filepath; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
#	$garbage = `cd $filepath; rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;
    $m->redirect("$Tab::url_prefix/tmp/$filename.pdf");

</%init>

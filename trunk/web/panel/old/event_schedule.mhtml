<%args>
	$account
	$event_id
	$tourn
	$circuit
	$err => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	my @sites = $m->comp("/funclib/tourn_sites.mas", tourn => $tourn);
	my $switch;

</%init>

	<table cellpadding="0" cellspacing="0">

		<tr>

			<td width="100%">
				<h3>Rounds scheduled for <% $event->name %></h3>
			</td>

			<td style="padding-right: 5px;">
				<form action="all_schedules.mhtml" method="post">
				<input  type="submit" value="Return to Schedules">
				</form>
			</td>

			<td>
				<form action="schemat/show.mhtml" method="post">
				<input type="hidden" name="event_id" value="			<% $event->id %>">
				<input  type="submit" value="Return to Schematic">
				</form>
			</td>

		</tr>

	</table>

	<table cellpadding="6" cellspacing="1" border="0" width="100%">

%		if ($event->rounds) { 

			<tr class="liblrow">

				<th style="text-align: center;">
					#
				</th>

				<th>
					Label
				</th>

				<th>
					Type
				</th>

				<th>
					Timeslot
				</th>

%				if (scalar (@sites) > 1) { 

					<th>
						Location
					</th>
%				}

%				if ($tourn->pools) { 

					<th class="smaller">
						Judge<br />Pool
					</th>
%				}

				<th>
					NFY
				</th>
					
				<th>
					PRE
				</th>
					
				<th>
				</th> 

			</tr>

%		}

%		if ($event->rounds) { 

			<form action="round_save.mhtml" method="post">
			<input type="hidden" name="event_id" value="<% $event->id %>">

%		}

%		foreach my $round ($event->rounds) {

%			# sort {$a->timeslot->start->epoch <=> $b->timeslot->start->epoch} $event->rounds) 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 
				
				<th style="text-align:center;">
					<a href="schemat/show.mhtml?round_id=<% $round->id %>&event_id=<% $event->id %>">
						<% $round->name %>
					</a>
				</th> 
				
				<td>
					<input type="text" name="<% $round->id %>_label" value="<% $round->label %>" size="6">
				</td> 
				
				<td>
					<select name="<% $round->id %>_type">

						<option value="prelim" <% ($round->type eq "prelim") ? "selected" : "" %> >
							Prelim
						</option>

						<option value="elim" <% ($round->type eq "elim") ? "selected" : "" %> >
							Elim
						</option>
						
						<option value="final" <% ($round->type eq "final") ? "selected" : "" %> >
							Final
						</option>
					</select>
				</td> 
				
				<td>

					<select name="<% $round->id %>_timeslot_id">
%						foreach my $ts ( sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots) { 
							<option value="<% $ts->id %>" <% ($round->timeslot) ? ($ts->id == $round->timeslot->id) ? "selected" : "" : "" %> > 
								<% $ts->name %>
							</option>
%						} 
					</select>

				</td>

%				if (scalar (@sites) > 1) { 
					
					<td class="smaller">

						<select name="<% $round->id %>_site_id">

							<option value="">
								None
							</option>

%							foreach my $site ($m->comp("/funclib/tourn_sites.mas", tourn => $tourn)) { 
					
								<option value="<% $site->id %>" <% ($round->site) ? ($site->id == $round->site->id) ? "selected" : "" : "" %> >
									<% substr($site->name,0,20) %>
								</option>
%							} 
						</select>
					</td>

%				} else { 

					<input type="hidden" name="<% $round->id %>_site_id" value="<% $round->site->id %>">

%				}

%				if ($tourn->pools) { 
				
					<td class="smaller">
						<select name="<% $round->id %>_pool_id">

							<option value="">
								None
							</option>

%							foreach my $pool ($tourn->pools) { 

								<option value="<% $pool->id %>" <% ($round->pool) ? ($pool->id == $round->pool->id) ? "selected" : "" : "" %> >
									<% substr($pool->name, 0, 15) %>
								</option>

%							}
						
						</select>

					</td>
%				} 

				<td>
					<input type="checkbox" value="1" name="<% $round->id %>_no_first_year" <% $round->no_first_year ? "checked" : "" %>>
				</td>
				
				<td>
					<input type="checkbox" value="1" name="<% $round->id %>_preset" <% $round->preset ? "checked" : "" %>>
				</td>

				
				<td align="center" class="smaller">

					(<a href="<% $Tab::url_prefix %>/panel/round_edit.mhtml?round_id=<% $round->id %>">Panels</a>)
					
					<h4></h4> 
					
					(<a href="<% $Tab::url_prefix %>/panel/round_rm.mhtml?round_id=<% $round->id %>">Delete</a>)

				</td> 
				
			</tr>

%		}

%		if ($event->rounds) { 
			
			<tr> 

				<td colspan="10" align="right">
					<input  type="submit" value="Save All Changes">
					</form>
				</td>

			</tr>
%		}

		<tr class="liblrow">

			<th style="text-align: center;">
				#
			</th> 
			
			<th>
				Label
			</th>
			
			<th>
				Type
			</th>
			
			<th>
				Timeslot
			</th>

%			if (scalar (@sites) > 1) { 

				<th>
					Location
				</th>

%			}

%			if ($tourn->pools) { 

				<th class="smaller">
					Judge<br />Pool
				</th>
%			}

			<th>
				NFY
			</th>

			<th>
				PRE
			</th>

			<th></th>

		</tr> 
		
		<tr class="bluerow"> 

			<th>
				<form action="round_save.mhtml" method="post"> 
				<input type="hidden" name="event_id" value="<% $event->id %>">
				<input type="hidden" value="1" name="add_new"> 
				+
			</th> 
			
			<td>
				<input type="text" name="new_label" size="6">
			</td> 
			
			<td>
				<select name="new_type">

					<option value="prelim">
						Prelim
					</option> 
					
					<option value="elim">
						Elim
					</option>
					
					<option value="final">
						Final
					</option>

				</select>
			</td> 
			
			<td>
				<select name="new_timeslot_id">

%					foreach my $timeslot (sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots) { 

						<option value="<% $timeslot->id %>">
							<% substr($timeslot->name,0,15) %>
						</option>

%					}

				</select>
			</td>

%			if (scalar (@sites) > 1) { 
				
				<td>
					<select name="new_site_id">

%						foreach my $site (sort {$a->name <=> $b->name} $m->comp("/funclib/tourn_sites.mas", tourn => $tourn)) { 

							<option value="<% $site->id %>">
								<% substr($site->name,0,15) %>
							</option>

%						}
	
					</select>
				</td>

%			} elsif(@sites) { 

				<input type="hidden" name="new_site_id" value="<% $sites[0]->id %>">
%			}

%	if ($tourn->pools) { 
	<td>
	<select name="new_pool_id">
		<option value="">No pool</option>
%		foreach my $pool (sort {$a->name <=> $b->name} $tourn->pools) { 
			<option value="<% $pool->id %>"><% substr($pool->name,0,15) %></option>
%		}
		</select></td>
%	}

	<td><input type="checkbox" value="1" name="new_no_first_year"></td>
	<td><input type="checkbox" value="1" name="new_preset"></td>

	<td align="center">
		<input type="submit"  value="Add">
		</form>
	</td>


</tr>
	</table>	

<table cellpadding="5" cellspacing="1" width="100%">
<tr>
<td width="65%">

<h4>* Key:</h4>

<table width="100%" cellpadding="4" cellspacing="1">

<tr>
	<td>NFY: No first year judges</td>
</tr>

<tr>
	<td>PRE: Round is a preset elim</td>
</tr>

</table>

</td>


</td>
</tr>
</table>

</div>


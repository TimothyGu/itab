<%args>
	$circuit
	$tourn
	$debug => undef
</%args>
<%init>

	use POSIX;
	my $switch;

</%init>

	<div class="right small">

	</div>

	<div class="left huge">

		<h2>Panel All Prelims/Presets</h2>

		<form action="do_it_all_baby.mhtml" method="post">

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr class="bluerow">
				<th>
					Event
				</th>

				<th class="smaller">
					Slots
				</th>

				<th class="smaller">
					Rooms
				</th>

				<th>
					Number of Sections
				</th>

				<th class="smaller">
					Panel?
				</th>

			</tr>


<%perl>
			EVENT:
			foreach my $event (sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 

				next if $event->panels( type => "prelim");
				next if $event->type eq "debate";
				next unless $event->entries;

				if ($event->type eq "speech") { 

	   				my $num_competitors = $event->count;

   				 	my $minpanelsize = $tourn->method->min_panel_size;
    				my $maxpanelsize = $tourn->method->max_panel_size;
			
					unless ($minpanelsize > 0 && $maxpanelsize > 0) { 
						my $err = "You must first set minimum and maximum panel sizes before attempting to section";
						$m->redirect("$Tab::url_prefix/setup/method_edit.mhtml?err=$err");
					}

    			my $defaultpanelsize = $tourn->method->default_panel_size;

    			my $max_panel_number = ceil($num_competitors / $minpanelsize);
    			my $min_panel_number = ceil($num_competitors / $maxpanelsize);


					$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
							if ($num_competitors / $minpanelsize) < $min_panel_number;

					$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
						if $min_panel_number && (($num_competitors / $min_panel_number) < $min_panel_number);


</%perl>

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<th class="smaller">
							<% $event->name %>
						</th>

						<td class="centeralign">	
							<% $num_competitors %>
						</td>

		                <td align="center">
		                    <% scalar $event->room_pool %>
		                </td>

						<td>
<%perl>

						my $last_panel_size;

						foreach my $num_panels ($min_panel_number .. $max_panel_number) {

							next unless $num_panels > 0;

	     					my $panel_size = ceil($num_competitors/$num_panels);
    	   					my $competitors_if_panels_full = $num_panels * $panel_size;
							my $num_short_panels = $competitors_if_panels_full - $num_competitors;
							my $num_full_panels = $num_panels - $num_short_panels;
								
							next if $num_short_panels < 0 or $num_full_panels <= 0; 
							
							$defaultpanelsize = $panel_size 
								if ($last_panel_size > $defaultpanelsize && $panel_size < $defaultpanelsize); 
								
							$last_panel_size = $panel_size;

</%perl>

							<span style="min-height: 25px; padding-top: 5px;  width: 35px; float: left; text-align: right;">
							<%$num_panels %>
							</span>
							
							<span style="min-height: 25px; padding-top: 5px; width: 20px; float: left;">
								<input style="margin-right: 20px;" 
										type="radio" 
										name="num_of_panels_<% $event->id %>" 
										value=" <% $num_panels %> "
										<% ($panel_size == $defaultpanelsize) ? 'checked' : '' %>>
							</span>

%						}

						</td>

						<td align="center">
							<input type="checkbox" name="do_<% $event->id %>" value="1" "checked">
						</td>

					</tr>

%				}

%				if ($event->type eq "congress") { 

<%perl>

			   		my $num_competitors = $event->count;

    				my $minchambersize = $tourn->method->min_chamber_size;
					$minchambersize = 15 unless $minchambersize;

    				my $maxchambersize = $tourn->method->max_chamber_size;
					$maxchambersize = 30 unless $maxchambersize;
    
					my $defaultchambersize = $tourn->method->default_chamber_size;	
    				my $max_chamber_number = ceil($num_competitors / $minchambersize);
	    			my $min_chamber_number = ceil($num_competitors / $maxchambersize);


					$defaultchambersize = ceil($num_competitors / $min_chamber_number) 
						if ($num_competitors / $minchambersize) < $min_chamber_number;


</%perl>
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<th class="smaller">
							<% $event->name %>
						</th>
						
						<td class="centeralign">	
							<% $num_competitors %>
						</td>

		                <td align="center">
		                    <% scalar $event->room_pool %>
		                </td>
						
						<td>
<%perl>

						foreach my $num_chambers ($min_chamber_number .. $max_chamber_number) {
    		 			my $chamber_size = ceil($num_competitors/$num_chambers);
       					my $competitors_if_chambers_full = $num_chambers * $chamber_size;
       					my $num_short_chambers = $competitors_if_chambers_full - $num_competitors;
       					my $num_full_chambers = $num_chambers - $num_short_chambers;
       					next if $num_short_chambers < 0 or $num_full_chambers <= 0;

</%perl>
							<span style="width: 35px; float: left; text-align: right;">
							<%$num_chambers %>
							</span>
							
							<span style="width: 20px; float: left;">
								<input style="margin-right: 20px;" 
										type="radio" 
										name="num_of_panels_<% $event->id %>" 
										value=" <% $num_chambers %> "
										<% ($chamber_size == $defaultchambersize) ? 'checked' : '' %>>
							</span>

%						}


						</td>
			
						<td align="center">
							<input type="checkbox" name="do_<% $event->id %>" value="1" "checked">
						</td>

					</tr>
%				}

%			}

			<tr class="redrow">
			
				<th colspan="5" style=" text-align: right;">
					Assign rooms automatically: <input type="checkbox" name="rooms" value="1">
				</td> 
			</tr>

			<tr class="lirdrow">
				<th colspan="5" style=" text-align: right;">
					Assign judges automatically: <input type="checkbox" name="judges" value="1">
				</td> 
			</tr> 
			
			<tr class="bluerow">
				<td colspan="5" align="right">
					<input type="submit"  value="      Panel All Events      ">
					</form>
				</td> 
			</tr>
		
		</table>

	</div>

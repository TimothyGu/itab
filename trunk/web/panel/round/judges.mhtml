<%args>
	$round_id
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id);
	my @panels = sort {$a->letter cmp $b->letter} $round->panels;

	Tab::Ballot->set_sql( 
		update ballot
		set judge = ?
		where panel = ?
		and judge = 0
	);

	foreach my $panel (@panels) { 

		my @judges = $m->comp("/funclib/clean_judges.mas", panel => $panel);

		next if scalar @judges == $panel->judges;

		my $judge = shift @judges;

		my @others = $m->comp("/funclib/panel_judges.mas");

		if (@others) { 

			my $sample = shift @others;

			my @ballots = Tab::Ballot->search( panel => $panel->id, judge => $sample->id);

			foreach my $ballot (@ballots)  {
				my $new = $ballot->copy;
				$ballot->audit(0);
				$ballot->collected("");
				$ballot->collected_by(0);
				$ballot->cat_id("");
				$ballot->chair("");
				$ballot->judge($judge->id);
				$ballot->update;
			}

		
		} else { 

			Tab::Ballot->sql_update_ballot->execute($judge->id, $panel->id);


		}


		$panel->update;
	}

	my $msg = "Judges have been assigned";

	$m->redirect("/panel/schemat/show.mhtml?round_id=$round_id&msg=$msg");


</%init>

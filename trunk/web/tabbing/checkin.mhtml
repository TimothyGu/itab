<%args>
	$tourn
	$account
	$session
	$timeslot_id => undef
	$tz
</%args>
<%init>

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;

</%init>

	<div class="left huge">

%		if ($timeslot) { 

<%perl> 
			my @judges = $timeslot->judges;
			my @ballots = $timeslot->ballots;
			my @panels = $timeslot->panels;

			my %judges_by_id = ();
			my %panels_by_id = ();


			foreach my $judge (@judges) { 
				$judges_by_id{$judge->id} = $judge;
			}

			foreach my $panel (@panels) { 
				$panels_by_id{$panel->id} = $panel;
			}

			my %done_ballots = ();

</%perl>

			<h2>Ballots in timeslot <% $timeslot->name %></h2>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr>

					<td width="50%" valign="top" class="ballot">

						<h3>Out:</h3>

%						foreach my $ballot (@ballots) {

%							next if $done_ballots{$ballot->judge->id."-".$ballot->panel->id};
%							next unless $ballot->collected_by < 1;

							<a class="red block" href="check_in_ballot.mhtml?ballot_id=<% $ballot->id %>">
								<% $panels_by_id{$ballot->panel->id}->event->abbr %>
								<% $panels_by_id{$ballot->panel->id}->letter %>
								----------
								<% ($ballot->judge && $judges_by_id{$ballot->judge->id}->school) ? $judges_by_id{$ballot->judge->id}->school->code : "" %> 
								<% $ballot->judge ?  $judges_by_id{$ballot->judge->id}->code : "" %> 
								<% $ballot->judge ? $judges_by_id{$ballot->judge->id}->last : "" %> 
							</a>

%							$done_ballots{$ballot->judge->id."-".$ballot->panel->id}++;

%						}

					</td>

					<td width="50%" valign="top" class="ballot">

						<h3>In:</h3>

%						foreach my $ballot (@ballots) {

%							next if $done_ballots{$ballot->judge->id."-".$ballot->panel->id};
%							next unless $ballot->collected_by > 0;

							<a class="blue block" href="check_in_ballot.mhtml?ballot_id=<% $ballot->id %>">
								<% $judges_by_id{$ballot->judge->id}->code %> 
								<% $judges_by_id{$ballot->judge->id}->last %> 
								---
								<% $ballot->collected_by->last %> at
								<% Tab::nicetime($ballot->collected->set_time_zone($tz))%>
							</a>

%							$done_ballots{$ballot->judge->id."-".$ballot->panel->id}++;

%						}



					</td>

				</tr>

			</table>


%		}

	</div>

	<div id="rightsmall">

		<h3>Timeslots:</h3>

%		foreach my $ts (sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots) {

			<a href="checkin.mhtml?timeslot_id=<% $ts->id %>" 
				class="<% ($ts->checked) ? "red block" : "blue block" %>">
				<% $ts->name %>:
				<% $ts->checked %> left
			</a>

%		}

	</div>

	<div style="clear: both;">


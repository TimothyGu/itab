<%args>
	$tourn
	$account
	$session
	$timeslot_id => undef
	$entry_only => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	my $ncfl++ if $tourn->setting("ncfl");

	my $session_group = $session->judge_group;

    if ($session_group && $session_group->tourn != $tourn) { 
        $session->judge_group("");
        $session->update;
        undef $session_group;
    }   

    unless ($session_group) { 
        my @all_groups = $tourn->groups;
        if (scalar @all_groups == 1) { 
            $session_group = shift @all_groups;
            $session->judge_group($session_group->id);
            $session->update;
        }   
    }   


</%init>

	<div class="left huge">

%		if ($timeslot) { 

<%perl>

			my $flighted;
		
			my $dbh = Tab::DBI->db_Main();

			my $uncollected_sth = $dbh->prepare("
				select distinct panel.id, judge.id, judge.code, judge.first, judge.last, panel.flight, event.abbr
				from panel, ballot, judge, round, event
				where round.timeslot = $timeslot_id
				and panel.round = round.id
				and panel.id = ballot.panel
				and ballot.judge = judge.id
				and event.type != \"wudc\"
				and ballot.collected_by = 0
				and ballot.audit = 0
				and round.event = event.id
				group by panel.id, judge.id
				order by judge.code, judge.last, panel.flight
			");

			$uncollected_sth->execute();

			my @uncollected_panels;
			my %panel_flight;
			my %panel_judgecode;
			my %panel_judgename;
			my %panel_event;

			while (my ($panel, $judge, $code, $first, $last, $flight, $abbr)  = $uncollected_sth->fetchrow_array() ) {
				my $key = $panel."-".$judge;
				push @uncollected_panels, $key;
				$panel_flight{$key} = $flight;
				$panel_event{$key} = $abbr;
				$panel_judgecode{$key} = $code;
				$panel_judgename{$key} = $first." ".$last;

				$flighted++ if $flight > 1;
			}

			my $collected_sth = $dbh->prepare("
				select distinct panel.id, judge.id, judge.code, judge.first, judge.last, panel.flight, event.abbr
				from panel, ballot, judge, round, event
				where round.timeslot = $timeslot_id
				and panel.round = round.id
				and panel.id = ballot.panel
				and ballot.judge = judge.id
				and event.type != \"wudc\"
				and ballot.collected_by != 0
				and ballot.audit = 0
				and round.event = event.id
				group by panel.id, judge.id
				order by judge.code, judge.last, panel.flight
			");

			$collected_sth->execute();

			my @collected_panels;

			while (my ($panel, $judge, $code, $first, $last, $flight, $abbr)  = $collected_sth->fetchrow_array() ) {
				my $key = $panel."-".$judge;
				push @collected_panels, $key;
				$panel_flight{$key} = $flight;
				$panel_judgecode{$key} = $code;
				$panel_judgename{$key} = $first." ".$last;
				$panel_event{$key} = $abbr;
				$flighted++ if $flight > 1;
			}


			my $rooms_sth = $dbh->prepare("
				select distinct panel.id, room.name
				from panel, room, round
				where round.timeslot = $timeslot_id
				and panel.round = round.id
				and panel.room = room.id
				order by panel.id
			");

			$rooms_sth->execute();

			my %panel_room;

			while (my ($panel, $room)  = $rooms_sth->fetchrow_array() ) {
				$panel_room{$panel} = $room;
			}

</%perl>

		<h2>Ballots in timeslot <% $timeslot->name %></h2>

			<div class="half left">

				<h4>Out:</h4>

%				foreach my $panel (@uncollected_panels) { 

%					my ($panel_id, $judge_id) = split (/-/, $panel);

					<a class="noline ltyellow block smallish nowrap" href="checkin_switch.mhtml?judge_id=<% $judge_id %>&panel_id=<% $panel_id %>">

%						if ($flighted) { 
							<span class="evensmallerspan padno inline nowrap">
								<% $panel_flight{$panel} %>
							</span>
%						}

						<span class="evensmallerspan padno inline nowrap">
							<% $panel_event{$panel} %>
						</span>

						<span class="schemat padno inline  nowrap" style="margin-left: 6px; width: 80px;">
							<% $panel_room{$panel_id} %>
						</span>

						<span class="editspan padno inline " style="margin-left: 6px;">
							<% $panel_judgecode{$panel} ? $panel_judgecode{$panel} : "" %>
							<% $panel_judgename{$panel} %>
						</span>

					</a>
%				}

			</div>

			<div class="half right">

				<h4>Collected & Unentered:</h4>

%				foreach my $panel (@collected_panels) { 

%					my ($panel_id, $judge_id) = split (/-/, $panel);

					<a class="noline green block smallish nowrap" href="checkin_switch.mhtml?judge_id=<% $judge_id %>&panel_id=<% $panel_id %>">

%						if ($flighted) { 
							<span class="evensmallerspan padno inline nowrap">
								<% $panel_flight{$panel} %>
							</span>
%						}

						<span class="evensmallerspan padno inline nowrap">
							<% $panel_event{$panel} %>
						</span>

						<span class="schemat padno inline  nowrap" style="margin-left: 6px; width: 80px;">
							<% $panel_room{$panel} %>
						</span>

						<span class="editspan padno inline " style="margin-left: 6px;">
							<% $panel_judgecode{$panel} ? $panel_judgecode{$panel} : "" %>
							<% $panel_judgename{$panel} %>
						</span>

					</a>
%				}

			</div>

%		}

	</div>

	<div class="right small">
	
		<div class="plainnote">

%			if ($entry_only) {
				<a href="confirm.mhtml" class="blue block">Confirm Round Starts</a>
				<a href="checkin.mhtml" class="dkblue block">Collect Ballots</a>
				<a href="index.mhtml" class="blue block">Enter Ballots</a>
				<br />
%			}

			<span class="bluenohover block centeralign" style="margin-bottom: 2px;">
				<form action="limit.mhtml" method="post">
				<input type="hidden" name="from" value="checkin">
				<input type="hidden" name="timeslot" value="<% $timeslot_id %>">
				<select name="group_id" onchange='this.form.submit()' class="fixedsmall notfirst">
					<option value="">Choose judge group:</option>
%					foreach my $other_group ($tourn->groups) { 
						<option value="<% $other_group->id %>" <% ($session_group && $other_group->id == $session_group->id) ? "selected" : "" %>>
							<% $other_group->name %>
						</option>
%					}
				</select>
				</form>
			</span>

%			my @timeslots = $tourn->timeslots;
%			@timeslots = $m->comp("/funclib/group_timeslots.mas", group => $session_group) if $session_group;

			<h4>Timeslots:</h4>

%			foreach my $ts (sort {$a->start->epoch <=> $b->start->epoch} @timeslots) {

%				my @outstanding = $m->comp("/funclib/timeslot_judges.mas", timeslot => $ts, status => "uncollected");

				<a href="checkin.mhtml?timeslot_id=<% $ts->id %>" class="<% $ts->id == $timeslot_id ? "dk" : ""%><%(@outstanding) ? "yellow block" : "green block" %>">
					<% $ts->name %>:
					<% scalar @outstanding %> left
				</a>

%			}
		</div>

	</div>


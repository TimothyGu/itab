<%args>
	$tourn
	$account
	$panel_id => undef
</%args>
<%init>

	my $panel;

	if ($panel_id) { 
		$panel = Tab::Panel->retrieve($panel_id);
	}

	$m->abort unless $panel;
	my $unaudited;

	my $wudc++ if $panel->round->event->type eq "wudc";

	my $min = $panel->round->event->setting('min_points') if $panel;
	my $max = $panel->round->event->setting('max_points') if $panel;

	my $pts = $panel->round->event->setting('point_increments') if $panel;
	my $step = 1 if $pts eq "whole";
	$step = .5 if $pts eq "half";
	$step = .1 if $pts eq "tenths";
	$step = .25 if $pts eq "fourths";

	$min = 0 unless $min;
	$max = 100 unless $max;

	my $access = Tab::TournAdmin->search( tourn => $tourn->id, account => $account->id )->first;

	if ($access && $access->no_setup) { 
		$m->print("<p>You do not have access to that function</p>");
		$m->abort();
	}
	
</%init>

	<div class="right small">
	
		<div class="sidenote">

			<h4>Other functions</h4>

			<a href="/panel/schemat/show.mhtml?round_id=<% $panel->round->id %>" class="blue block">
				View <% $panel->round->realname %> Schematic 
			</a>
		
			<hr>
	
			<a href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>" class="blue block">
				View/Edit Panel <% $panel->letter %>
			</a>

		</div>

	</div>

	<div class="left huge">

		<h2>Panel Card</h2>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr class="liblrow">

				<th>
					<% $panel->round->event->abbr %>
				</th>

				<th>
					Section <% $panel->letter %>
				</th>

				<th>
					<% $panel->round->realname %>
				</th>

				<th>
					Room <% ($panel->room) ? $panel->room->name : "" %>
				</th>

			</tr>

		</table> 

		<hr>

		<table cellpadding="4" cellspacing="1" width="100%">

%			my $switch;

%			foreach my $judge (sort {$a->code <=> $b->code} $m->comp('/funclib/panel_judges.mas', panel => $panel)) { 

%			next if $wudc &! $judge->chair;

				<tr>
					<td colspan="5">

						<h4>
							<% $wudc ? "Chair" : "" %> Judge <% $judge->code ." ".$judge->first." ".$judge->last %>
						</h4>

						<form action="panel_save.mhtml" method="post">
						<input type="hidden" name="panel_id" value="<% $panel->id %>">
						<input type="hidden" name="judge_id" value="<% $judge->id %>">
					</td>

				</tr>


				<tr class="yellowrow">
						
					<th>
						Entry
					</th>

					<th>
						Rank
					</th>

					<th>
						Points
					</th>

%              		if ($tourn->setting("mfl_time_violation") > 0) {
						<th>
							Overtime
						</th>
%					}

%					if ($tourn->setting("noshows_never_break") > 0) {
						<th>
							Noshow
						</th>
%					}

				</tr>

%				foreach my $entry ($m->comp('/funclib/panel_entries.mas', panel => $panel)) { 

%					my @ballots = Tab::Ballot->search( judge => $judge->id, entry => $entry->id, panel => $panel->id );
%					next unless @ballots;
%					my $ballot = shift @ballots;
%					$unaudited++ unless $ballot->audit;

%					my $rank;
%					my $points;
%					my %student_points = ();

%					foreach my $value ($ballot->ballot_values) {
%						$rank = $value->value if $value->tag eq "rank";
%						$points = $value->value if $value->tag eq "points";
%						$student_points{$value->student->id} = $value->value if $value->tag eq "points" && $value->student;
%					}


%          			my $block = "white block";
                    	
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td style="padding-left: 15px;">
							<a href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>" class="<% $block %>" tabindex="-1">
								<% $entry->code %> <% $entry->name %>
							</a>
						</td>

						<td>
							<input type="number" name="rank_<% $ballot->id %>" size="5" value="<% $rank %>" min="0" max="100">
						</td>

						<td>
%							if ($wudc) { 

%								foreach my $student ($entry->students) { 
									<span class="medspan">
										<% $student->last %>
									</span>

									<span class="smallishspan">
										<input type="number" name="points_<% $student->id %>" size="5" value="<% $student_points{$student->id} %>" step="<% $step %>"
											min="<% $min %>" max="<% $max %>">
									</span>

									<br style="clear: both;">
%								}

%							} else { 
								<input type="number" name="points_<% $ballot->id %>" size="5" value="<% $points %>" min="0" max="100">
%							} 
						</td>


%                  		if ($tourn->setting("mfl_time_violation") > 0) {
							<td>
								<input type="checkbox" name="tv_<% $ballot->id %>" value="1" <% ($ballot->tv) ? "checked" : "" %>>
							</td>
%						}

%						if ($tourn->setting("noshows_never_break") > 0) {
							<td align="center">
								<input type="checkbox" name="noshow_<% $ballot->id %>" value="1" <% ($ballot->noshow) ? "checked" : "" %>>
							</td>
%						}

					</tr>


%				}

				<tr class="liblrow">
	
					<td align="center">
						<label for="complete_<% $judge->id %>">
						Entry complete?
						<input type="checkbox" name="audit_<% $judge->id %>" value="1" id="complete_<% $judge->id %>"
							<% $unaudited ? "" : 'checked="checked"' %>>
						</label>
					</td>

					<td colspan="4" class="rightalign">
						<input type="submit" value="  Save Changes  " >
						</form>
					</td>

				</tr>
%			}	

		</table>

%		if ($wudc) { 
	
			<h5>Panelists:
%			foreach my $judge (sort {$a->code <=> $b->code} $m->comp('/funclib/panel_judges.mas', panel => $panel)) { 
%				next if $judge->chair;
				<% $judge->first." ".$judge->last %>
%			}	
			</h5>
%		}

	</div> 

	<br style="clear: both;">

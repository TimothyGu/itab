<%args>
	$round_id
</%args>
<%init>

	use List::Util 'shuffle';

	my $round = Tab::Round->retrieve($round_id);

	foreach my $existing ($m->comp("/funclib/round_values.mas", round => $round)) { 
		$existing->delete;
	}

	my $counter;
	my $judges;

	foreach my $panel ($round->panels) { 

		foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
			$judges++;
			$counter++;

			my @ballots = shuffle(Tab::Ballot->search( panel => $panel->id, judge => $judge->id )); 

			my $rank;

			BALLOT:
			foreach my $ballot (@ballots) { 

				$rank++;	

				foreach my $student ($ballot->entry->students) { 

					my $points = int(rand(100));

					Tab::BallotValue->create({
						ballot => $ballot->id,
						tag => "points",
						student => $student->id,
						value => $points
					});

				} 
			
				Tab::BallotValue->create({
					ballot => $ballot->id,
					tag => "rank",
					value => $rank
				});

			}

			foreach my $ballot (@ballots) { 
				$ballot->audit(1);
				$ballot->update;
			}

		}

	}

	my $err = "Without assigning judges there are no fake ranks or points.  Assign judges and try again please" unless $judges;
	my $msg = "$counter Ranks faked for round ".$round->realname if $judges;
	$m->redirect("/panel/schemat/show.mhtml?round_id=$round_id&msg=$msg&err=$err");

</%init>


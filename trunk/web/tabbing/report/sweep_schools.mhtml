<%args>
	$tourn
	$sweep_set_id => undef
	$what => undef
</%args>
<%init>

	if ($what eq "Print") { 
		$m->redirect("sweep_schools_print.mhtml?sweep_set_id=$sweep_set_id");
	}
	
	my @sweep_sets;

	my $ncfl++ if $tourn->setting("ncfl");
	
	my $master_set = Tab::SweepSet->retrieve($sweep_set_id);
	push @sweep_sets, $master_set;

	my @children = $master_set->children;

	if (@children) { 
		my %used;
		$used{$master_set->id}++;

		while (@children) { 
			my $take = shift @children;
			next if $used{$take->id};
			push @children, $take->children;
			push @sweep_sets, $take;
			$used{$take->id}++;
		}
	}

	my %event_by_id = ();
	foreach my $event ($tourn->events) {
		$event_by_id{$event->id} = $event->abbr;
	}

	my %points_by_school = ();
	my %count_by_school = ();
	my %countstring_by_school = ();
	my %entries_by_school = ();
	
	my %school_events_used = ();

	foreach my $set (@sweep_sets) { 

		Tab::debuglog("Doing rule ".$set->name);

		next unless $set->rules;

		my ($pointsref, $entref) = $m->comp("/tabbing/results/sweeps/sweep_tourn.mas", tourn => $tourn, sweep_set_id => $set->id);

		my @entries = sort { ${$pointsref}{$b->id} <=> ${$pointsref}{$a->id}} @{$entref};

		my $events = $set->rule("events");
		my $entries_rule = $set->rule("entries");
		my $wildcards = $set->rule("wildcards");
		my $event_entries = $set->rule("event_entries");

		my %school_entries = ();
		my %school_event_entries = ();
		my %school_events = ();
		my %school_wildcards = ();

		my @events = $set->events;
		my %use_event = ();

		foreach (@events) { $use_event{$_->id}++ unless $_->setting("omit_sweeps"); }

		foreach my $ent (@entries) { 

			my $school_id = $ent->school->id;

			my $log++ if $school_id == 40810;

			next unless ${$pointsref}{$ent->id};
			$entries_by_school{$school_id}++;

			my $event_id = $ent->event->id;

			next unless $use_event{$event_id};

			next if 
				$entries_rule && 
				( $school_entries{$school_id} >= $entries_rule ) && 
				( $wildcards < 1 || $school_wildcards{$school_id} >= $wildcards );

			next if ( 
				( ($events && $school_events{$school_id} >= $events) || 
					($event_entries && $school_event_entries{$school_id."-".$event_id} >= $event_entries) 
				) && 
					($wildcards < 1 || $school_wildcards{$school_id} >= $wildcards )  
			);

			if (	
					($entries_rule && ($school_entries{$school_id} >= $entries_rule)) ||
					($events && $school_events{$school_id} >= $events ) || 
					($event_entries && $school_event_entries{$school_id."-".$event_id} >= $event_entries) 
				) {

				 $school_wildcards{$school_id}++;

			} else { 

				$school_entries{$school_id}++;
				$school_events{$school_id}++ unless $school_events_used{$school_id."-".$event_id};
				$school_event_entries{$school_id."-".$event_id}++;
				$school_events_used{$school_id."-".$event_id}++;

			}

			$count_by_school{$school_id}++;
			$countstring_by_school{$school_id} .= $ent->code.": ".${$pointsref}{$ent->id}."\n";

			$points_by_school{$school_id} += ${$pointsref}{$ent->id};

		}

	}

</%init>

	<& menu.mas, whoami => 'schools' &>

	<div class="left huge">

		<h2>School Sweeps <% $master_set->name %></h2>

		<& /funclib/tablesorter.mas, table => "sortme" &>

		<table cellpadding="4" cellspacing="1" id="sortme">

			<thead>
				<tr class="yellowrow">

					<th>
					</th>

					<th>
						School
					</th>

%					if ($ncfl) { 
						<th class="smaller">
							Diocese
						</th>
%					} else { 
						<th>
							State
						</th>
%					} 


					<th>
						Entries
					</th>

					<th style="line-height: 12px;" class="smallish">
						Entries <br /> Counted
					</th>

					<th>
						Points
					</th>

				</tr>

			</thead>

			<tbody>

%				my $count = 1;

%				foreach my $school (sort {$points_by_school{$b->id} <=> $points_by_school{$a->id}} $tourn->schools) { 

%					next unless $points_by_school{$school->id};
			
					<tr>

						<td>
							<% $count++ %>.
						</td>

						<td>	
							<% $school->short_name %>
						</td>

						<td>
							<% $ncfl ? $school->region->name : $school->chapter ? $school->chapter->state : "" %>
						</td>

						<td>
							<% $entries_by_school{$school->id} %>
						</td>

						<td>
							<span title="<% $countstring_by_school{$school->id} %>">
								<% $count_by_school{$school->id} %>
							</span>
						</td>

						<td>
							<% $points_by_school{$school->id} %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

	</div>


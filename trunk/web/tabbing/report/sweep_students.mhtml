<%args>
	$tourn
	$what => undef
	$sweep_set_id => undef
</%args>
<%init>

	if ($what eq "Print") { 
		$m->redirect("sweep_schools_print.mhtml?sweep_set_id=$sweep_set_id");
	}

	my $sweep_set;
	my $pointsref;
	my $entref;

	if ($sweep_set_id) { 
		($pointsref, $entref) = $m->comp("/tabbing/results/sweeps/sweep_tourn.mas", tourn => $tourn, sweep_set_id => $sweep_set_id);
		$sweep_set = Tab::SweepSet->retrieve($sweep_set_id);
	} else { 
		($pointsref, $entref) = $m->comp("/tabbing/results/sweeps/sweep_tourn.mas", tourn => $tourn);
	}

	my %points_by_student = ();
	my %count_by_student = ();
	my %entstring_by_student = ();

	my @entries = sort { ${$pointsref}{$b->id} <=> ${$pointsref}{$a->id}} @{$entref};

	my @students;

	foreach my $set ($tourn->sweep_sets) {

		my @events = $set->events;
		my %use_event = ();

		foreach (@events) { 
			$use_event{$_->id}++ unless $_->setting("omit_sweeps");   
		}

		my $count;

		foreach my $ent (@entries) { 

			next unless ${$pointsref}{$ent->id};
			next unless $use_event{$ent->event->id};

			foreach my $student ($ent->students) { 
				$count_by_student{$student->id}++;
				$entstring_by_student{$student->id} .= $ent->code." ";
				$points_by_student{$student->id} += ${$pointsref}{$ent->id};
				$student->school($ent->school->short_name);
				$student->entry($ent->code);
				push @students, $student;
			}

		}
	}

	my %seen = (); 
	@students = grep { ! $seen{$_->id} ++ } @students;

</%init>

	<& menu.mas, whoami => 'students' &>

	<div class="left huge">

		<h2>Student Sweeps<% $sweep_set ? ": ".$sweep_set->name : "" %></h2>

		<& /funclib/tablesorter.mas, table => "sortme" &>

		<table cellpadding="4" cellspacing="1" id="sortme">

			<thead>
				<tr class="yellowrow">

					<th>
					</th>

					<th>
						Student
					</th>

					<th>
						School
					</th>

					<th>
						Entries Counted
					</th>

					<th>
						Points
					</th>

				</tr>

			</thead>

			<tbody>

%				my $count = 1;

%				foreach my $student (sort {$points_by_student{$b->id} <=> $points_by_student{$a->id}} @students) { 

%					next unless $points_by_student{$student->id};
			
					<tr>

						<td>
							<% $count++ %>.
						</td>

						<td>	
							<% $student->last ? $student->first." ".$student->last : $student->entry %>
						</td>

						<td>
							<% $student->school %>
						</td>

						<td>
							<% $count_by_student{$student->id} %>
						</td>

						<td>
							<% $points_by_student{$student->id} %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

	</div>


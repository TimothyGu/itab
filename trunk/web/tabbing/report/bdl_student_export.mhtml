<%args>
	$tourn
	$session
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
    my $now = DateTime->now(time_zone => $tz);    

	my $circuit = $tourn->circuits->first;

	my $name = $circuit->name;
	$name =~ s/[\W_]//g;

    my $filename = "NAUDL-StudentsUpload-$name-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 
    
    open (CSVOUT, ">>$filepath.csv");
	print CSVOUT "circuitname,teamid,teamlevel,teamname,globalcompid,compname,firstname,lastname,studentschoolid,birthdate,graduationyear,gender,ethnicity\n";

	my @students = $m->comp("/funclib/circuit_students.mas", circuit => $circuit, tourn => $tourn);

	my $circuit_name = $circuit->name;

	foreach my $student (@students) { 
		print CSVOUT $circuit_name.",".$student->code.",".$student->event.",".$student->chapter.",".$student->id.",",$student->first." ".$student->last.",".$student->first.",".$student->last.",".$student->region.",,".$student->grad_year.",".$student->gender.",,\n";
	}

	close CSVOUT;

	$m->redirect("$Tab::url_prefix/tmp/$filename.csv");

</%init>

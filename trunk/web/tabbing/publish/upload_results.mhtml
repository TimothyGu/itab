<%args>
	$tourn
	$label    => undef
	$posting  => undef
	$event_id => undef
	$publish  => 0
</%args>
<%init>

	my $msg;

	my $now = DateTime->now;

	if ($posting) {

		my $file = Tab::File->create({
			tourn     => $tourn->id,
			uploaded  => $now,
			result    => 1,
			published => $publish
		});

		$file->event($event_id) unless $event_id eq "all";

       	my $req = Apache2::Request->new($r);
       	my $upload = $req->upload("posting");
        my $filename  = $upload->filename;
        $filename =~ s/.*[\/\\](.*)/$1/;
        $filename =~ s/\ //g;
       	$filename =~ s/\'//g;  # '  stupid vim
       	my $filepath = "$Tab::file_root/files/tourns/".$tourn->id."/results/".$file->id;
       	my $garbage = `rm -f $filepath`;
       	$garbage = `mkdir -p $filepath`;
       	my $filetemp = $upload->tempname;
       	$garbage = `cp $filetemp $filepath/$filename`;

		system $Tab::s3_cmd." put $filepath/$filename ".$Tab::s3_bucket."/tourns/".$tourn->id."/results/".$file->id."/";

		$label = ucfirst($filename) unless $label;

		$file->label($label);
       	$file->name($filename);
       	$file->update;

		$msg = "Results Posting ".$label." has been uploaded";
   	}

	$m->redirect("index.mhtml?msg=$msg");
		
</%init>

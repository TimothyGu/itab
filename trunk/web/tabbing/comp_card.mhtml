<%args>
	$tourn
	$comp_id => undef
	$code => undef
	$circuit
</%args>
<%init>

	my $comp;

	if ($comp_id) { 
		$comp = Tab::Comp->retrieve($comp_id);
	}

    my $points++ if $tourn->method->tiebreaks(tiebreaker => "points");
	
	if ($code) { 
	
		my @comps = Tab::Comp->search( code => $code, tournament => $tourn->id );

		my $err = "No competitors found with speaker code $code" unless @comps;
		$m->redirect("comp_card.mhtml?err=$err") unless @comps;

		$comp = $comps[0];
		$comp_id = $comp->id;	
	}
	
</%init>

	<div id="rightsmall">

		<h3>Search for competitor:</h3>

		<table cellpadding="2" width="100%">

			<tr class="evenrow">
				<td>
					<form action="comp_card.mhtml" method="post">
					<input type="text" name="code" size="5" value="Code" onfocus="value=''"> 
				</td> 

				<td align="center">
					<input class="blue" type="submit" value="Search">
					</form>
				</td> 

			</tr>

			<tr>
				<td>
					<form action="comp_name_search.mhtml" method="post">
					<input type="text" name="last_name" size="15" value="Last Name" onfocus="value=''">
				</td> 
				
				<td align="center">
					<input class="blue" type="submit" value="Search"> 
					</form>
				</td>

			</tr>

		</table>

% 		if ($comp) {
		
			<hr>

			<a href="/register/comp_edit.mhtml?comp_id=<% $comp->id %>" class="red block">
				View/Edit Competitor <% $comp->code %>
			</a>

			<hr>


%			foreach my $panel (sort {$a->round->name <=> $b->round->name} $comp->panels) { 

				<a class="red block" href="panel_card.mhtml?panel_id=<% $panel->id %>">	
					View/Edit <% $panel->round->realname." Section ".$panel->letter %>
				</a>

%			}

%		}

	</div>

	<div class="left huge">

		<h2>Competitor Card Edit</h2>

% 		if ($comp) {

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">

					<th>
						<% $comp->code %>
					</th>

					<th>
						<% $comp->event->abbr %>
					</th>

					<th>
						<% $comp->team_name %>
					</th>

					<th>
						<% $comp->school->short_name %>
					</th>

					<% ($comp->school->region) ? "<th>".$comp->school->region->name." (".$comp->school->region->code.") </th>" : "" %>

				</tr>

			</table> 

			<hr>

			<table cellpadding="4" cellspacing="1" width="100%">

%				my $switch;

%				foreach my $panel (sort {$a->round->name <=> $b->round->name} $comp->panels) { 

					<tr>
						<td colspan="5">
	
							<h3>
								<% $panel->round->realname %> Section <% $panel->letter %>
								<% ($panel->room) ? "Room ".$panel->room->name : "" %>
							</h3>

							<form action="comp_card_save.mhtml" method="post">
							<input type="hidden" name="comp_id" value="<% $comp->id %>">
							<input type="hidden" name="panel_id" value="<% $panel->id %>">
						</td>

					</tr>
					
					<tr class="lirdrow">
						
						<th>
							Judge
						</th>

						<th>
							Rank
						</th>

%						if ($points) { 
							<th>
								Points
							</th>
%						}

%                  		if ($tourn->method->mfl_time_violation > 0) {
							<th>
								Overtime
							</th>
%						}

%						if ($tourn->method->noshows_never_break > 0) {

							<th>
								Noshow
							</th>
%						}

					</tr>

%					foreach my $judge ($panel->judges) { 

%						my @ballots = Tab::Ballot->search( 
%								judge => $judge->id, panel => $panel->id, comp => $comp->id );
%						next unless @ballots;
%						my $ballot = shift @ballots;

%  		         		my $block = "grey block" unless $switch % 2;
%           			$block = "whiteblock" if $switch % 2;
                    	
						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td style="padding-left: 15px;">
								<a href="/register/judge_edit.mhtml?judge_id=<% $judge->id %>" class="<% $block %>">
								<% $judge->code %> <% $judge->last %>
							</td>

							<td>
								<input type="number" name="rank_<% $ballot->id %>" size="5" value="<% $ballot->real_rank %>">
							</td>

%							if ($points) { 
								<td>
									<input type="number" name="points_<% $ballot->id %>" size="5" value="<% $ballot->real_points %>">
								</td>
%							}

%                   		if ($tourn->method->mfl_time_violation > 0) {
								<td>
									<input type="checkbox" name="tv_<% $ballot->id %>" value="1" <% ($ballot->tv) ? "checked" : "" %>>
								</td>

%							}

%							if ($tourn->method->noshows_never_break > 0) {

								<td align="center">
									<input type="checkbox" name="noshow_<% $ballot->id %>" value="1" <% ($ballot->noshow) ? "checked" : "" %>>
								</td>

%							}

						</tr>


%					}

					<tr class="liblrow">
						<td colspan="3" align="right">
							<input type="submit" value="  Save Changes  " class="blue">
							</form>
						</td>
					</tr>
%				}	

			</table>

%		} #end of if comp

	</div> 

	<br style="clear: both;">

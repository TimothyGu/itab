<%args>
	$tourn
	$judge_id => undef
</%args>
<%init>


	$m->abort unless $judge_id;
	my $judge = Tab::Judge->retrieve($judge_id);
	$m->abort unless $judge;

	my @pools = $judge->judge_group->pools; 

	foreach my $pool ($judge->pools) { 
		push @pools, $pool->judge_group->pools;
	}

	my %seen = (); 
	@pools = grep { ! $seen{$_->id} ++ } @pools;

	POOL:
	foreach my $pool (sort {$a->id <=> $b->id} @pools) { 

		if ($ARGS{$pool->id}) { 

			next POOL if Tab::PoolJudge->search( judge => $judge->id, pool => $pool->id);

			my $type = "prelim";
			$type = "elim" if $pool->burden;

			Tab::PoolJudge->create({
				judge => $judge->id,
				pool => $pool->id,
				type => $type
			});

			$judge->setting("prelim_pool", $pool->id) if $type eq "prelim";

		} else { 

			foreach my $pj (Tab::PoolJudge->search( judge => $judge->id, pool => $pool->id)) { 
				$pj->delete;
			}

		}
	}

	my $msg = "Pools saved";

	$m->redirect("edit.mhtml?judge_id=$judge_id&msg=$msg");

</%init>

